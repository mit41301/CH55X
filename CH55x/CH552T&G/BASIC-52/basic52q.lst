
C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 1





        8051 Macro Assembler   C 5 1 A S M   V 1.2
        ==========================================



        Source File:     basic52q.asm
        Object File(s):  basic52q.hex
        List File:       basic52q.lst



 Line    I  Addr Code           Source

    1:                          $mod51
    2:                          ;                                       
    3:                          ; WCH CH552T/G 対応バージョン
    4:                          ;   Internal Clock 24MHz, CPU Clock(Fsys
    5:                          ;   Timer2 を UART0 のシリアルポート用ク
    6:                          ;   シリアルポートの自動速度認識機能が正
    7:                          ;
    8:                          ;***************************************
    9:                          ;*                                      
   10:                          ;*                    MCS-BASIC-52 V1.31
   11:                          ;*                           12/1986 til
   12:                          ;*       The original source code of V1.
   13:                          ;*            Intel Corporation, Embedde
   14:                          ;*                             is public
   15:                          ;*                                      
   16:                          ;***************************************
   17:                          ;
   18:                          ;***************************************
   19:                          ;* General alterations made by D. Wulf, 
   20:                          ;* e-mail: Detlef.Wulf@onlinehome.de    
   21:                          ;***************************************
   22:                          ;
   23:                          ;  The following general alterations are
   24:                          ;
   25:                          ;  - The original source code had 2 file
   26:                          ;    been incorporated into this file fo
   27:                          ;
   28:                          ;  - All absolute and relativ jumps and 
   29:                          ;    with labels.
   30:                          ;
   31:                          ;  - All machine code in the original so
   32:                          ;    by the menomics.
   33:                          ;
   34:                          ;  - One routine in the source was diffe
   35:                          ;    by the ROM code.
   36:                          ;
   37:                          ;  - Some "ORG" statements between BASIC
   38:                          ;    out.
   39:                          ;
   40:                          ;  - To get room for new code the "ego m
   41:                          ;    (Remarked with "Sorry")
   42:                          ;
   43:                          ;  - To get more room for new code the "

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 2



 Line    I  Addr Code           Source

   44:                          ;    (Remarked with "get room")
   45:                          ;
   46:                          ;***************************************
   47:                          ;* Bugfixes for MCS-52-BASIC from D. Kar
   48:                          ;* e-mail: dankarmann@lucent.com        
   49:                          ;***************************************
   50:                          ;
   51:                          ;  - Corrected Intel bug to allow BASIC 
   52:                          ;    command extensions to work.
   53:                          ;    (Remarked as Karmann 1)
   54:                          ;
   55:                          ;  - Corrected Intel bug to that discard
   56:                          ;    F, FP, FPR and FPRO and followed by
   57:                          ;    (Remarked as Karmann 2)
   58:                          ;
   59:                          ;***************************************
   60:                          ;* Bugfix and performance for MCS-52-BAS
   61:                          ;* D. Mudric and Z. Stojsavljevic descip
   62:                          ;* Elektor Electronics magazine german i
   63:                          ;***************************************
   64:                          ;
   65:                          ;  - Modifications to the unprocess a BA
   66:                          ;    (Remarked as Elektor 1)
   67:                          ;
   68:                          ;  - Modifications to the floating point
   69:                          ;    (Remarked as Elektor 2)
   70:                          ;
   71:                          ;  - HEX to BIN performance improvements
   72:                          ;    (Remarked as Elektor 3)
   73:                          ;
   74:                          ; The same article describes a fix for t
   75:                          ; the fixes did not work.
   76:                          ;
   77:                          ; The multiplicaton underflow bug is now
   78:                          ;    (Remarked as Wulf 1)
   79:                          ;
   80:                          ;***************************************
   81:                          ;* Change UV-EPROM to EEPROM programming
   82:                          ;* e-mail: r.skowronek@kfa-juelich.de   
   83:                          ;***************************************
   84:                          ;
   85:                          ; This altered section of code writes th
   86:                          ; EEPROM just like the ROM resident Basi
   87:                          ; The EEPROM is connected just like a RA
   88:                          ; and gets it's adresses from the real a
   89:                          ; difference from the normal setup is th
   90:                          ; P1.4, which supplies the program pulse
   91:                          ; can be located in externally ROM and i
   92:                          ; EEPROMs!
   93:                          ; (Remarked as Skowronek)
   94:                          ;
   95:                          ; The original code from R. Skowronek di
   96:                          ; this feature is added by D. Wulf.
   97:                          ; Memory is now limited to 32K bytes RAM
   98:                          ; would change the EEPROM.
   99:                          ;

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 3



 Line    I  Addr Code           Source

  100:                          ;***************************************
  101:                          ;* Change timer 0 from 13 bit to 16 bit 
  102:                          ;* from D. Wulf 1/2000                  
  103:                          ;***************************************
  104:                          ;
  105:                          ; The max. value for XTAL is now 7862747
  106:                          ; Dallas 80C320 high speed / low power m
  107:                          ; The defaut crystal value is still 1105
  108:                          ; XTAL or patch the souce code at
  109:                          ;
  110:                          ;	17F1H = 11
  111:                          ;	17F0H = 05
  112:                          ;	17EFH = 92
  113:                          ;	17EEH = 00
  114:                          ;
  115:                          ; with a new crystal value.
  116:                          ; (Remarket as Wulf 2)
  117:                          ;
  118:                          ;***************************************
  119:                          ;* New baudrate detection from D. Wulf 1
  120:                          ;***************************************
  121:                          ;
  122:                          ; The new baudrate detection uses timer 
  123:                          ; the code loop timing. So the Dallas 80
  124:                          ; used. Also at higher clock speeds the 
  125:                          ; (Remarked as Wulf 3)
  126:                          ;
  127:                          ;***************************************
  128:                          ;* New processor type detection from D. 
  129:                          ;***************************************
  130:                          ;
  131:                          ; A new reset routine detects the proces
  132:                          ; used with the following controllers:
  133:                          ;
  134:                          ; 8032, 87C52#, Dallas 80C320, 80515*#, 
  135:                          ; 80537*, 80575 or similars.
  136:                          ;
  137:                          ; - On processor types marked with the "
  138:                          ;   baudrates, depending on the crystal 
  139:                          ; - The processor types marked with the 
  140:                          ;   V1.3 can be located there, because i
  141:                          ;
  142:                          ; (Remarked as Wulf 4)
  143:                          ;
  144:                          ;***************************************
  145:                          ;* OPBYTE 43H for POP from H.-J. Boehlin
  146:                          ;* e-mail: H-Boehling@gmx.de            
  147:                          ;***************************************
  148:                          ;
  149:                          ; A feature of BASIC-52 is the ability t
  150:                          ; representing commands or instructions 
  151:                          ; routines. For using system routines in
  152:                          ; operation bytes (for more information 
  153:                          ; In the original souce code is no OPCOD
  154:                          ; stack and store in a variable.
  155:                          ; With BASIC-52 V1.3 you can use OPBYTE 

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 4



 Line    I  Addr Code           Source

  156:                          ; "POP" statement.
  157:                          ; (Remarked as Boehling 1)
  158:                          ;
  159:                          ;***************************************
  160:                          ;* Reset millisecond counter on "TIME=" 
  161:                          ;***************************************
  162:                          ;
  163:                          ; The command "TIME=0" now zeros the mil
  164:                          ; returns with zero.
  165:                          ; (Remarked as Boehling 2)
  166:                          ;
  167:                          ;***************************************
  168:                          ;* New command "ERASE" by H.-J. Boehling
  169:                          ;***************************************
  170:                          ;
  171:                          ; To erase an EEPROM (fill 16K byte up t
  172:                          ; "ERASE" is implemented. It takes 2 min
  173:                          ; (Remarked as Boehling 3)
  174:                          ;
  175:                          ;***************************************
  176:                          ;* Correct "ASC(x)" bug by D. Wulf 2/200
  177:                          ;***************************************
  178:                          ;
  179:                          ; BASIC-51 V1.1 gives erroneous results 
  180:                          ; one of the following signs : *, +, -, 
  181:                          ; BASIC-51 V1.3 returns the correct valu
  182:                          ; (Remarked as Wulf 5)
  183:                          ;
  184:                          ;***************************************
  185:                          ;***************************************
  186:                          ; To indicate the new version the start 
  187:                          ; *MCS-51(tm) BASIC V1.1* to
  188:                          ; *MCS-BASIC-52 V1.31*
  189:                          ;
  190:                          ; H.-J. Boehling, D. Wulf 11/26/2001
  191:                          ;***************************************
  192:                          ;
  193:           N      00C8    T2CON	EQU	0C8H ; This three lines are ne
  194:           N      00CC    TL2	EQU	0CCH ; MCS-51 Family Cross Assem
  195:           N      00CD    TH2	EQU	0CDH ; from W.W. Heinz (e-mail: 
  196:                          ;
  197:                          ;=== CH552 Added =====
  198:           N      00C9    T2MOD		EQU	0C9H	; T2MOD define
  199:           N      00B9    CLOCK_CFG	EQU	0B9H	; System clock config
  200:           N      00A1    SAFE_MOD	EQU	0A1H	; Safe mode control re
  201:                          ;=====================
  202:                          ;
  203:                          	;**************************************
  204:                          	;
  205:                          	; TRAP VECTORS TO MONITOR
  206:                          	;
  207:                          	; RESET TAG (0AAH) ---------2001H
  208:                          	;
  209:                          	; TAG LOCATION (5AH) ------ 2002H
  210:                          	;
  211:                          	; EXTERNAL INTERRUPT 0 ---- 2040H

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 5



 Line    I  Addr Code           Source

  212:                          	;
  213:                          	; COMMAND MODE ENTRY ------ 2048H
  214:                          	;
  215:                          	; SERIAL PORT ------------- 2050H
  216:                          	;
  217:                          	; MONITOR (BUBBLE) OUTPUT - 2058H
  218:                          	;
  219:                          	; MONITOR (BUBBLE) INPUT -- 2060H
  220:                          	;
  221:                          	; MONITOR (BUBBLE) CSTS --- 2068H
  222:                          	;
  223:                          	; GET USER JUMP VECTOR ---- 2070H
  224:                          	;
  225:                          	; GET USER LOOKUP VECTOR -- 2078H
  226:                          	;
  227:                          	; PRINT AT VECTOR --------- 2080H
  228:                          	;
  229:                          	; INTERRUPT PWM ----------- 2088H
  230:                          	;
  231:                          	; EXTERNAL RESET ---------- 2090H
  232:                          	;
  233:                          	; USER OUTPUT-------------- 4030H
  234:                          	;
  235:                          	; USER INPUT -------------- 4033H
  236:                          	;
  237:                          	; USER CSTS --------------- 4036H
  238:                          	;
  239:                          	; USER RESET -------------- 4039H
  240:                          	;
  241:                          	; USER DEFINED PRINT @ ---  403CH
  242:                          	;
  243:                          	;**************************************
  244:                          	;
  245:                          	;**************************************
  246:                          	;
  247:                          	; MCS - 52  -  8K BASIC VERSION 1.3
  248:                          	;
  249:                          	;**************************************
  250:                          	;
  251:      0000 61 8B          	AJMP	CRST		;START THE PROGRAM
  252:      0002 37             	ADDC	A,@R1
  253:                          	;
  254:           N      0003    	ORG	3H
  255:                          	;
  256:                          	;**************************************
  257:                          	;
  258:                          	;EXTERNAL INTERRUPT 0
  259:                          	;
  260:                          	;**************************************
  261:                          	;
  262:      0003 20 31 2D       	JB	DRQ,STQ 	;SEE IF DMA IS SET
  263:      0006 C0 D0          	PUSH	PSW		;SAVE THE STATUS
  264:      0008 02 40 03       	LJMP	4003H		;JUMP TO USER IF NOT SET
  265:                          	;
  266:           N      000B    	ORG	0BH
  267:                          	;

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 6



 Line    I  Addr Code           Source

  268:                          	;**************************************
  269:                          	;
  270:                          	;TIMER 0 OVERFLOW INTERRUPT
  271:                          	;
  272:                          	;**************************************
  273:                          	;
  274:      000B C0 D0          	PUSH	PSW		;SAVE THE STATUS
  275:      000D 20 2E 10       	JB	C_BIT,STJ	;SEE IF USER WANTS INTERRU
  276:      0010 02 40 0B       	LJMP	400BH		;EXIT IF USER WANTS INTERRU
  277:                          	;
  278:           N      0013    	ORG	13H
  279:                          	;
  280:                          	;**************************************
  281:                          	;
  282:                          	;EXTERNAL INTERRUPT 1
  283:                          	;
  284:                          	;**************************************
  285:                          	;
  286:      0013 20 12 2B       	JB	INTBIT,STK
  287:      0016 C0 D0          	PUSH	PSW
  288:      0018 02 40 13       	LJMP	4013H
  289:                          	;
  290:                          	;
  291:           N      001B    	ORG	1BH
  292:                          	;
  293:                          	;**************************************
  294:                          	;
  295:                          	;TIMER 1 OVERFLOW INTERRUPT
  296:                          	;
  297:                          	;**************************************
  298:                          	;
  299:      001B C0 D0          	PUSH	PSW
  300:      001D 02 1F 78       	LJMP	CKS_I
  301:                          	;
  302:      0020 02 19 02       STJ:	LJMP	I_DR		;DO THE INTERRUPT
  303:                          	;
  304:                          	;**************************************
  305:                          	;
  306:                          	;SERIAL PORT INTERRUPT
  307:                          	;
  308:                          	;**************************************
  309:                          	;
  310:           N      0023    	ORG	23H
  311:                          	;
  312:      0023 C0 D0          	PUSH	PSW
  313:      0025 20 1F 1C       	JB	SPINT,STU	;SEE IF MONITOR EANTS INTE
  314:      0028 02 40 23       	LJMP	4023H
  315:                          	;
  316:           N      002B    	ORG	2BH
  317:                          	;
  318:                          	;**************************************
  319:                          	;
  320:                          	;TIMER 2 OVERFLOW INTERRUPT
  321:                          	;
  322:                          	;**************************************
  323:                          	;

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 7



 Line    I  Addr Code           Source

  324:      002B C0 D0          	PUSH	PSW
  325:      002D 02 40 2B       	LJMP	402BH
  326:                          	;
  327:                          	;**************************************
  328:                          	;
  329:                          	;USER ENTRY
  330:                          	;
  331:                          	;**************************************
  332:                          	;
  333:           N      0030    	ORG	30H
  334:                          	;
  335:      0030 02 19 3F       	LJMP	IBLK		;LINK TO USER BLOCK
  336:                          	;
  337:      0033 20 26 08       STQ:	JB	I_T0,STS	;SEE IF MONITOR WANTS I
  338:      0036 C2 96          	CLR	DACK
  339:      0038 30 B2 FD       	JNB	P3.2,$		;WAIT FOR DMA TO END
  340:      003B D2 96          	SETB	DACK
  341:      003D 32             	RETI
  342:                          	;
  343:      003E 02 20 40       STS:	LJMP	2040H		;GO TO THE MONITOR
  344:                          	;
  345:      0041 D2 16          STK:	SETB	INTPEN		;TELL BASIC AN INTERRU
  346:      0043 32             	RETI
  347:                          	;
  348:      0044 02 20 50       STU:	LJMP	2050H		;SERIAL PORT INTERRUPT
  349:                          	;
  350:                          	;
  351:                          	;**************************************
  352:                          	;
  353:                          	; This is the equate table for 8052 bas
  354:                          	;
  355:                          	;**************************************
  356:                          	;
  357:                          	; The register to direct equates for CJ
  358:                          	;
  359:           N      0000    R0B0	EQU	0
  360:           N      0001    R1B0	EQU	1
  361:           N      0002    R2B0	EQU	2
  362:           N      0003    R3B0	EQU	3
  363:           N      0004    R4B0	EQU	4
  364:           N      0005    R5B0	EQU	5
  365:           N      0006    R6B0	EQU	6
  366:           N      0007    R7B0	EQU	7
  367:                          	;
  368:                          	; Register bank 1 contains the text poi
  369:                          	; and the arg stack pointer.
  370:                          	;
  371:           N      0008    TXAL	EQU	8		;R0 BANK 1 = TEXT POINTER LO
  372:           N      0009    ASTKA	EQU	9		;R1 BANK 1 = ARG STACK
  373:           N      000A    TXAH	EQU	10		;R2 BANK 1 = TEXT POINTER H
  374:                          	;
  375:                          	; Now five temporary locations that are
  376:                          	;
  377:           N      000B    TEMP1	EQU	11
  378:           N      000C    TEMP2	EQU	12
  379:           N      000D    TEMP3	EQU	13

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 8



 Line    I  Addr Code           Source

  380:           N      000E    TEMP4	EQU	14
  381:           N      000F    TEMP5	EQU	15
  382:                          	;
  383:                          	; Register bank 2 contains the read tex
  384:                          	; and the control stack pointer.
  385:                          	;
  386:           N      0010    RTXAL	EQU	16		;R0 BANK 2 = READ TEXT POI
  387:           N      0011    CSTKA	EQU	17		;R1 BANK 2 = CONTROL STACK
  388:           N      0012    RTXAH	EQU	18		;R2 BANK 2 = READ TEXT POI
  389:                          	;
  390:                          	; Now some internal system equates.
  391:                          	;
  392:           N      0013    BOFAH	EQU	19		;START OF THE BASIC PROGRA
  393:           N      0014    BOFAL	EQU	20		;START OF THE BASIC PROGRA
  394:           N      0015    NULLCT	EQU	21		;NULL COUNT
  395:           N      0016    PHEAD	EQU	22		;PRINT HEAD POSITION
  396:           N      0017    FORMAT	EQU	23
  397:                          	;
  398:                          	; Register bank 3 is for the user and c
  399:                          	; by basic
  400:                          	;
  401:                          	;
  402:                          	;
  403:                          	; Now everything else is used by basic.
  404:                          	; First the bit locations, these use by
  405:                          	;
  406:           B        10    OTS		BIT	16	;34.0-ON TIME INSTRUCTION EX
  407:           B        11    INPROG		BIT	17	;34.1-INTERRUPT IN PROCES
  408:           B        12    INTBIT		BIT	18	;34.2-INTERRUPT SET BIT
  409:           B        13    ON_ERR		BIT	19	;34.3-ON ERROR EXECUTED
  410:           B        14    OTI		BIT	20	;34.4-ON TIME INTERRUPT IN P
  411:           B        15    LINEB		BIT	21	;34.5-LINE CHANGE OCCURED
  412:           B        16    INTPEN		BIT	22	;34.6-INTERRUPT PENDING B
  413:           B        17    CONB		BIT	23	;34.7-CAN CONTINUE IF SET
  414:           B        18    GTRD		BIT	24	;35.0-READ GET LOCATION
  415:           B        19    LPB		BIT	25	;35.1-PRINT TO LINE PRINTER 
  416:           B        1A    CKS_B		BIT	26	;35.2-FOR PWM INTERRUPT
  417:           B        1B    COB		BIT	27	;35.3-CONSOLE OUT BIT
  418:                          				;     0 = SERIAL PORT
  419:                          				;     1 = LINE PRINTER
  420:           B        1C    COUB		BIT	28	;35.4-USER CONSOLE OUT BIT
  421:                          				;     0 = SERIAL PORT
  422:                          				;     1 = USER DRIVER
  423:           B        1D    INBIT		BIT	29	;35.5-INITIALIZATION BIT
  424:           B        1E    CIUB		BIT	30	;35.6-USER CONSOLE IN BIT
  425:                          				;     0 = SERIAL PORT
  426:                          				;     1 = USER ROUTINE
  427:           B        1F    SPINT		BIT	31	;35.7-SERIAL PORT INTERRUP
  428:           B        20    STOPBIT 	BIT	32	;36.0-PROGRAM STOP ENCOU
  429:           B        21    U_IDL		BIT	33	;36.1-USER IDLE BREAK
  430:           B        22    INP_B		BIT	34	;36.2-SET DURING INPUT INS
  431:                          ;DCMPXZ 	BIT	35	;36.3-DCMPX ZERO FLAG
  432:           B        24    ARGF		BIT	36	;36.4-ARG STACK HAS A VALUE
  433:           B        25    RETBIT		BIT	37	;36.5-RET FROM INTERRUPT 
  434:           B        26    I_T0		BIT	38	;36.6-TRAP INTERRUPT ZERO T
  435:           B        27    UPB		BIT	39	;36.7-SET WHEN @ IS VALID

C51ASM V1.2             Copyright (c) 2009 Atmel Corp.            PAGE 9



 Line    I  Addr Code           Source

  436:                          
  437:                          ;
  438:                          ;***************************************
  439:                          ;****** Sorry - but the ego message had 
  440:                          ;
  441:                          ;JKBIT		BIT	40	;37.0-WB TRIGGER We use t
  442:                          ;
  443:           B        28    mul_underflow	BIT	40	;37.0-mul_limit_cas
  444:                          ;
  445:                          ;***************************************
  446:                          ;
  447:           B        29    ENDBIT		BIT	41	;37.1-GET END OF PROGRAM
  448:           B        2A    UBIT		BIT	42	;37.2-FOR DIM STATEMENT
  449:           B        2B    ISAV		BIT	43	;37.3-SAVE INTERRUPT STATUS
  450:           B        2C    BO		BIT	44	;37.4-BUBBLE OUTPUT
  451:           B        2D    XBIT		BIT	45	;37.5-EXTERNAL PROGRAM PRES
  452:           B        2E    C_BIT		BIT	46	;37.6-SET WHEN CLOCK RUNNI
  453:           B        2F    DIRF		BIT	47	;37.7-DIRECT INPUT MODE
  454:           B        30    NO_C		BIT	48	;38.0-NO CONTROL C
  455:           B        31    DRQ		BIT	49	;38.1-DMA ENABLED
  456:           B        32    BI		BIT	50	;38.2-BUBBLE INPUT
  457:                          ;
  458:                          ;***************************************
  459:                          ;****** Disable Intel programming for to
  460:                          ;
  461:                          ;INTELB 	BIT	51	;38.3-INTELLIGENT PROM P
  462:                          ;
  463:                          ;***************************************
  464:                          ;
  465:           B        34    C0ORX1		BIT	52	;38.4-PRINT FROM ROM OR R
  466:           B        35    CNT_S		BIT	53	;38.5-CONTROL S ENCOUNTERE
  467:           B        36    ZSURP		BIT	54	;38.6-ZERO SUPRESS
  468:           B        37    HMODE		BIT	55	;38.7-HEX MODE PRINT
  469:           B        97    LP		BIT	P1.7	;SOFTWARE LINE PRINTER
  470:           B        96    DACK		BIT	P1.6	;DMA ACK
  471:                          ;***************************************
  472:                          ;
  473:                          ;PROMV		BIT	P1.5	;TURN ON PROM VOLTAGE
  474:                          ;PROMP		BIT	P1.4	;PROM PULSE
  475:                          ;ALED		BIT	P1.3	;ALE DISABLE
  476:                          ;
  477:                          ;***************************************
  478:           B        92    T_BIT		BIT	P1.2	;I/O TOGGLE BIT
  479:           B        DF    BD		BIT	0DFH	;Baudrategenerator 805x7,x5
  480:                          	;
  481:                          	;
  482:                          	; The next location is a bit addressabl
  483:                          	;
  484:           N      0027    BABC	EQU	39
  485:                          	;
  486:                          	; Now floating point and the other temp
  487:                          	;
  488:                          	; FP Uses to locations 03CH
  489:                          	;
  490:                          	; Now the stack designators.
  491:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 10



 Line    I  Addr Code           Source

  492:           N      003E    SPSAV	EQU	3EH
  493:           N      003F    S_LEN	EQU	3FH
  494:           N      0040    T_HH	EQU	40H
  495:           N      0041    T_LL	EQU	41H
  496:           N      0042    INTXAH	EQU	42H
  497:           N      0043    INTXAL	EQU	43H
  498:           N      0045    MT1	EQU	45H
  499:           N      0046    MT2	EQU	46H
  500:           N      0047    MILLIV	EQU	47H		;Real Time Clock 5 milli
  501:           N      0048    TVH	EQU	48H		;Real Time Clock high byte
  502:           N      0049    TVL	EQU	49H		;Real Time Clock low byte
  503:           N      004A    SAVE_T	EQU	4AH
  504:           N      004B    SP_H	EQU	4BH		;SERIAL PORT TIME OUT
  505:           N      004C    SP_L	EQU	4CH
  506:           N      004D    CMNDSP	EQU	4DH		;SYSTEM STACK POINTER
  507:           N      0087    PCON0	EQU	87H		;PCON SFR
  508:           N      00AA    S0RELL	EQU	0AAH		;S0RELL 805x7A SFR
  509:           N      00BA    S0RELH	EQU	0BAH		;S0RELH 805x7A SFR
  510:           N      00CB    RCAPH2	EQU	0CBH		;RCAPH2 8052 SFR
  511:           N      00CA    RCAPL2	EQU	0CAH		;RCAPL2 8052 SFR
  512:           N      00D8    ADCON	EQU	0D8H		;ADCON 805xx SFR
  513:           N      00DA    DAPR	EQU	0DAH		;DAPR 805xx SFR
  514:           N      00FF    IRAMTOP EQU	0FFH		;TOP OF RAM
  515:           N      00FE    STACKTP EQU	0FEH		;ARG AND CONTROL STACK
  516:                          	;
  517:                          	; The character equates
  518:                          	;
  519:           N      000D    CR	EQU	0DH		;CARRIAGE RETURN
  520:           N      000A    LF	EQU	0AH		;LINE FEED
  521:           N      0007    BELL	EQU	07H		;BELL CHARACTER
  522:           N      0008    BS	EQU	08H		;BACK SPACE
  523:           N      0003    CNTRLC	EQU	03H		;CONTROL C
  524:           N      0004    CNTRLD	EQU	04H		;CONTROL D
  525:           N      0000    NULL	EQU	00H		;NULL
  526:                          	;
  527:                          	; The new baud rate constants
  528:                          	;
  529:           N      00B2    B4800	EQU	0B2H		;Timervalue for 4800 bau
  530:           N      00D9    B9600	EQU	0D9H		;Timervalue for 9600 bau
  531:                          	;
  532:                          	;
  533:                          	; The internal system equates
  534:                          	;
  535:           N      0049    LINLEN	EQU	73		;THE LENGTH OF AN INPUT L
  536:           N      0001    EOF	EQU	01		;END OF FILE CHARACTER
  537:           N      0001    ASTKAH	EQU	01		;ASTKA IS IN PAGE 1 OF RA
  538:           N      0000    CSTKAH	EQU	00		;CSTKA IS IN PAGE 0 OF RA
  539:           N      0001    FTYPE	EQU	01		;CONTROL STACK "FOR"
  540:           N      0002    GTYPE	EQU	02		;CONTROL STACK "GOSUB"
  541:           N      0003    DTYPE	EQU	03		;DO-WHILE/UNTIL TYPE
  542:           N      8000    ROMADR	EQU	8000H	;LOCATION OF ROM
  543:                          ;
  544:                          	; The floating point equates
  545:                          	;
  546:           N      0006    FPSIZ	EQU	6		;NO. OF BYTES IN A FLOATING
  547:           N      0004    DIGIT	EQU	FPSIZ-2 	;THE MANTISSA OF A FL

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 11



 Line    I  Addr Code           Source

  548:           N      0009    STESIZ	EQU	FPSIZ+3 	;SIZE OF SYMBOL ADJU
  549:                          ;FP_BASE EQU	 1993H		 ;BASE OF FLOATING 
  550:           N      0200    PSTART	EQU	512		;START OF A PROGRAM IN R
  551:           N      0011    FSIZE	EQU	FPSIZ+FPSIZ+2+2+1
  552:                          ;
  553:                          ;=== CH552 Added =====
  554:           N      03FF    ERAMEND	EQU	03FFH ; EX-RAM last addr (1K
  555:                          ;=====================
  556:                          ;
  557:                          	;**************************************
  558:                          	;
  559:                          USENT:	; User entry jump table
  560:                          	;
  561:                          	;**************************************
  562:                          	;
  563:      0047 17 87          	DW	CMND1		;(00, 00H)COMMAND MODE JUMP
  564:      0049 12 23          	DW	IFIX		;(01, 01H)CONVERT FP TO INT
  565:      004B 0F DD          	DW	PUSHAS		;(02, 02H)PUSH VALUE ONTO AR
  566:      004D 0F D3          	DW	POPAS		;(03, 03H)POP VALUE OFF ARG S
  567:      004F 04 BD          	DW	PG1		;(04, 04H)PROGRAM A PROM
  568:      0051 06 D8          	DW	INLINE		;(05, 05H)INPUT A LINE
  569:      0053 06 BF          	DW	UPRNT		;(06, 06H)PRINT A LINR
  570:      0055 06 A5          	DW	CRLF		;(07, 07H)OUTPUT A CRLF
  571:                          	;
  572:                          	;**************************************
  573:                          	;
  574:                          	; This is the operation jump table for 
  575:                          	;
  576:                          	;**************************************
  577:                          	;
  578:      0057 13 AC          OPTAB:	DW	ALPAR		;(08, 08H)LEFT PAREN
  579:      0059 13 2B          	DW	AEXP		;(09, 09H)EXPONENTAION
  580:      005B 11 B0          	DW	AMUL		;(10, 0AH)FP MUL
  581:      005D 17 41          	DW	AADD		;(11, 0BH)FLOATING POINT ADD
  582:      005F 14 0A          	DW	ADIV		;(12, 0CH)FLOATING POINT DIVID
  583:      0061 17 1C          	DW	ASUB		;(13, 0DH)FLOATING POINT SUBTR
  584:      0063 14 98          	DW	AXRL		;(14, 0EH)XOR
  585:      0065 14 84          	DW	AANL		;(15, 0FH)AND
  586:      0067 14 8D          	DW	AORL		;(16, 10H)OR
  587:      0069 13 A1          	DW	ANEG		;(17, 11H)NEGATE
  588:      006B 13 DB          	DW	AEQ		;(18, 12H)EQUAL
  589:      006D 13 E7          	DW	AGE		;(19, 13H)GREATER THAN OR EQUAL
  590:      006F 13 EB          	DW	ALE		;(20, 14H)LESS THAN OR EQUAL
  591:      0071 13 E1          	DW	ANE		;(21, 15H)NOT EQUAL
  592:      0073 13 D6          	DW	ALT		;(22, 16H)LESS THAN
  593:      0075 13 C5          	DW	AGT		;(23, 17H)GREATER THAN
  594:                          	;
  595:                          	;**************************************
  596:                          	;
  597:                          	; This is the jump table for unary oper
  598:                          	;
  599:                          	;**************************************
  600:                          	;
  601:      0077 13 8F          	DW	AABS		;(24, 18H)ABSOLUTE VALUE
  602:      0079 13 6D          	DW	AINT		;(25, 19H)INTEGER OPERATOR
  603:      007B 13 95          	DW	ASGN		;(26, 1AH)SIGN OPERATOR

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 12



 Line    I  Addr Code           Source

  604:      007D 14 96          	DW	ANOT		;(27, 1BH)ONE'S COMPLEMENT
  605:      007F 11 6D          	DW	ACOS		;(28, 1CH)COSINE
  606:      0081 11 D0          	DW	ATAN		;(29, 1DH)TANGENT
  607:      0083 11 71          	DW	ASIN		;(30, 1EH)SINE
  608:      0085 12 8D          	DW	ASQR		;(31, 1FH)SQUARE ROOT
  609:      0087 13 AD          	DW	ACBYTE		;(32, 20H)READ CODE
  610:      0089 13 27          	DW	AETOX		;(33, 21H)E TO THE X
  611:      008B 11 E0          	DW	AATAN		;(34, 22H)ARC TANGENT
  612:      008D 12 C0          	DW	ALN		;(35, 23H)NATURAL LOG
  613:      008F 13 B6          	DW	ADBYTE		;(36, 24H)READ DATA MEMORY
  614:      0091 13 BE          	DW	AXBYTE		;(37, 25H)READ EXTERNAL MEMO
  615:      0093 14 7F          	DW	PIPI		;(38, 26H)PI
  616:      0095 13 F1          	DW	ARND		;(39, 27H)RANDOM NUMBER
  617:      0097 14 A9          	DW	AGET		;(40, 28H)GET INPUT CHARACTER
  618:      0099 17 11          	DW	AFREE		;(41, 29H)COMPUTE #BYTES FREE
  619:      009B 17 21          	DW	ALEN		;(42, 2AH) COMPUTE LEN OF PORG
  620:      009D 0F D9          	DW	AXTAL		;(43, 2BH) CRYSTAL
  621:      009F 16 4F          	DW	PMTOP		;(44, 2CH)TOP OF MEMORY
  622:      00A1 17 29          	DW	ATIME		;(45, 2DH) TIME
  623:      00A3 14 B9          	DW	A_IE		;(46, 2EH) IE
  624:      00A5 14 BD          	DW	A_IP		;(47, 2FH) IP
  625:      00A7 14 C1          	DW	ATIM0		;(48, 30H) TIMER 0
  626:      00A9 14 C7          	DW	ATIM1		;(49, 31H) TIMER 1
  627:      00AB 14 CD          	DW	ATIM2		;(50, 32H) TIMER 2
  628:      00AD 14 D3          	DW	AT2CON		;(51, 33H) T2CON
  629:      00AF 14 D7          	DW	ATCON		;(52, 34H) TCON
  630:      00B1 14 DB          	DW	ATMOD		;(53, 35H) ATMOD
  631:      00B3 14 DF          	DW	ARCAP2		;(54, 36H) RCAP2
  632:      00B5 14 E5          	DW	AP1		;(55, 37H) P1
  633:      00B7 14 E9          	DW	APCON		;(56, 38H) PCON
  634:      00B9 0F 43          	DW	EXPRB		;(57, 39H) EVALUATE AN EXPRES
  635:      00BB 16 5C          	DW	AXTAL1		;(58, 3AH) CALCULATE CRYSTAL
  636:      00BD 14 F0          	DW	LINE		;(59, 3BH) EDIT A LINE
  637:      00BF 15 BA          	DW	PP		;(60, 3CH) PROCESS A LINE
  638:      00C1 10 A0          	DW	UPPL0		;(61, 3DH) UNPROCESS A LINE
  639:      00C3 0D 65          	DW	VAR		;(62, 3EH) FIND A VARIABLE
  640:      00C5 0E CD          	DW	GC		;(63, 3FH) GET A CHARACTER
  641:      00C7 0E D5          	DW	GCI		;(64, 40H) GET CHARACTER AND IN
  642:      00C9 07 91          	DW	INCHAR		;(65, 41H) INPUT A CHARACTER
  643:      00CB 08 02          	DW	CRUN		;(66, 42H) RUN A PROGRAM
  644:                          ;
  645:                          ;***************************************
  646:                          ;****** OPBYTE 43H for POP *************
  647:                          ;****** Boehling 1 *********************
  648:                          ;
  649:      00CD 0A 7D          	dw	SPOP		;(67, 43H) POP a value to a va
  650:                          ;
  651:                          ;***************************************
  652:                          ;
  653:                          
  654:      00CF 01             OPBOL:	DB	1		;
  655:                          	;
  656:      00D0 0F             	DB	15		;LEFT PAREN
  657:      00D1 0E             	DB	14		;EXPONENTIAN **
  658:      00D2 0A             	DB	10		;MUL
  659:      00D3 08             	DB	8		;ADD

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 13



 Line    I  Addr Code           Source

  660:      00D4 0A             	DB	10		;DIVIDE
  661:      00D5 08             	DB	8		;SUB
  662:      00D6 03             	DB	3		;XOR
  663:      00D7 05             	DB	5		;AND
  664:      00D8 04             	DB	4		;OR
  665:      00D9 0C             	DB	12		;NEGATE
  666:      00DA 06             	DB	6		;EQ
  667:      00DB 06             	DB	6		;GT
  668:      00DC 06             	DB	6		;LT
  669:      00DD 06             	DB	6		;NE
  670:      00DE 06             	DB	6		;LE
  671:      00DF 06             	DB	6		;GE
  672:                          	;
  673:      00E0 0F             UOPBOL: DB	15		;AABS
  674:      00E1 0F             	DB	15		;AAINT
  675:      00E2 0F             	DB	15		;ASGN
  676:      00E3 0F             	DB	15		;ANOT
  677:      00E4 0F             	DB	15		;ACOS
  678:      00E5 0F             	DB	15		;ATAN
  679:      00E6 0F             	DB	15		;ASIN
  680:      00E7 0F             	DB	15		;ASQR
  681:      00E8 0F             	DB	15		;ACBYTE
  682:      00E9 0F             	DB	15		;E TO THE X
  683:      00EA 0F             	DB	15		;AATAN
  684:      00EB 0F             	DB	15		;NATURAL LOG
  685:      00EC 0F             	DB	15		;DBYTE
  686:      00ED 0F             	DB	15		;XBYTE
  687:                          	;
  688:                          	;**************************************
  689:                          	;
  690:                          	; The ASCII printed messages.
  691:                          	;
  692:                          	;**************************************
  693:                          	;
  694:      00EE 53 54 4F 50    STP:	DB	'STOP"'
            00F2 22
  695:                          	;
  696:      00F3 54 52 59 20    IAN:	DB	'TRY AGAIN"'
            00F7 41 47 41 49
            00FB 4E 22
  697:                          	;
  698:      00FD 52 45 41 44    RDYS:	DB	'READY"'
            0101 59 22
  699:                          	;
  700:      0103 20 2D 20 49    INS:	DB	' - IN LINE "'
            0107 4E 20 4C 49
            010B 4E 45 20 22
  701:                          	;
  702:                          	;**************************************
  703:                          	;
  704:                          	; This is the command jump table
  705:                          	;
  706:                          	;**************************************
  707:                          	;
  708:      010F 08 02          CMNDD:	DW	CRUN		;RUN
  709:      0111 10 4E          	DW	CLIST		;LIST

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 14



 Line    I  Addr Code           Source

  710:      0113 0B 08          	DW	CNULL		;NULL
  711:      0115 06 5C          	DW	CNEW		;NEW
  712:      0117 18 3E          	DW	CCONT		;CONTINUE
  713:      0119 04 8A          	DW	CPROG		;PROGRAM A PROM
  714:      011B 17 73          	DW	CXFER		;TRANSFER FROM ROM TO RAM
  715:      011D 17 7F          	DW	CRAM		;RAM MODE
  716:      011F 05 3C          	DW	CROM		;ROM MODE
  717:                          ;
  718:                          ;***************************************
  719:                          ;****** Disable Intel programming for to
  720:                          ;
  721:                          ;	DW	CIPROG		;INTELLIGENT PROM PROGRAMMI
  722:                          ;
  723:                          ;***************************************
  724:                          ;
  725:      0121 05 00          	dw	CERASE		;Erase an EEPROM
  726:                          ;
  727:                          	;**************************************
  728:                          	;
  729:                          	; This is the statement jump table.
  730:                          	;
  731:                          	;**************************************
  732:                          	;
  733:                          STATD:	;
  734:      0123 09 6E          	DW	SLET		;LET		80H
  735:      0125 06 8F          	DW	SCLR		;CLEAR		81H
  736:      0127 0A 76          	DW	SPUSH		;PUSH VAR	82H
  737:      0129 0A AA          	DW	SGOTO		;GO TO		83H
  738:      012B 16 86          	DW	STONE		;TONE		84H
  739:      012D 0C 29          	DW	SPH0		;PRINT MODE 0	85H
  740:      012F 19 2E          	DW	SUI		;USER INPUT	86H
  741:      0131 19 33          	DW	SUO		;USER OUTPUT	87H
  742:      0133 0A 7D          	DW	SPOP		;POP VAR	88H
  743:      0135 0C 2D          	DW	SPRINT		;PRINT		89H
  744:      0137 0E 63          	DW	SCALL		;CALL		8AH
  745:      0139 0D 61          	DW	SDIMX		;DIMENSION	8BH
  746:      013B 06 0C          	DW	STRING		;STRING ALLO	8CH
  747:      013D 16 F9          	DW	SBAUD		;SET BAUD	8DH
  748:      013F 19 18          	DW	SCLOCK		;CLOCK		8EH
  749:      0141 0C 2B          	DW	SPH1		;PRINT MODE 1	8FH
  750:                          	;
  751:                          	; No direct mode from here on
  752:                          	;
  753:      0143 08 58          	DW	SSTOP		;STOP		90H
  754:      0145 0E 56          	DW	SOT		;ON TIME	91H
  755:      0147 14 19          	DW	SONEXT		;ON EXT INT	92H
  756:      0149 0B 0E          	DW	SRETI		;RET FROM INT	93H
  757:      014B 0F 05          	DW	S_DO		;DO		94H
  758:      014D 0B CE          	DW	SRESTR		;RESTOR 	95H
  759:      014F 0E FC          	DW	WCR		;REM		96H
  760:      0151 0B 5F          	DW	SNEXT		;NEXT		97H
  761:      0153 14 0F          	DW	SONERR		;ON ERROR	98H
  762:      0155 0C EB          	DW	S_ON		;ON		99H
  763:      0157 0D F5          	DW	SINPUT		;INPUT		9AH
  764:      0159 0B E3          	DW	SREAD		;READ		9BH
  765:      015B 0E EC          	DW	FINDCR		;DATA		9CH

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 15



 Line    I  Addr Code           Source

  766:      015D 0B 10          	DW	SRETRN		;RETURN 	9DH
  767:      015F 0A 86          	DW	SIF		;IF		9EH
  768:      0161 0B 2D          	DW	SGOSUB		;GOSUB		9FH
  769:      0163 0A 3C          	DW	SFOR		;FOR		A0H
  770:      0165 0A FC          	DW	SWHILE		;WHILE		A1H
  771:      0167 0B 01          	DW	SUNTIL		;UNTIL		A2H
  772:      0169 17 87          	DW	CMND1		;END		A3H
  773:      016B 18 5B          	DW	I_DL		;IDLE		A4H
  774:      016D 0F E5          	DW	ST_A		;STORE AT	A5H
  775:      016F 0F E9          	DW	LD_A		;LOAD AT	A6H
  776:      0171 04 F8          	DW	PGU		;PGM		A7H
  777:      0173 07 C0          	DW	RROM		;RUN A ROM	A9H
  778:                          	;
  779:                          	;**************************************
  780:                          	;
  781:                          TOKTAB: ; This is the basic token table
  782:                          	;
  783:                          	;**************************************
  784:                          	;
  785:                          	; First the tokens for statements
  786:                          	;
  787:      0175 80             	DB	80H		;LET TOKEN
  788:      0176 4C 45 54       	DB	'LET'
  789:                          	;
  790:      0179 81             	DB	81H		;CLEAR TOKEN
  791:      017A 43 4C 45 41    	DB	'CLEAR'
            017E 52
  792:                          	;
  793:      017F 82             	DB	82H		;PUSH TOKEN
  794:      0180 50 55 53 48    	DB	'PUSH'
  795:                          	;
  796:           N      0083    T_GOTO	EQU	83H
  797:                          	;
  798:      0184 83             	DB	83H		;GO TO TOKEN
  799:      0185 47 4F 54 4F    	DB	'GOTO'
  800:                          	;
  801:      0189 84             	DB	84H		;TOGGLE TOKEN
  802:      018A 50 57 4D       	DB	'PWM'
  803:                          	;
  804:      018D 85             	DB	85H		;PRINT HEX MODE 0
  805:      018E 50 48 30 2E    	DB	'PH0.'
  806:                          	;
  807:      0192 86             	DB	86H		;USER IN TOKEN
  808:      0193 55 49          	DB	'UI'
  809:                          	;
  810:      0195 87             	DB	87H		;USER OUT TOKEN
  811:      0196 55 4F          	DB	'UO'
  812:                          	;
  813:      0198 88             	DB	88H		;POP TOKEN
  814:      0199 50 4F 50       	DB	'POP'
  815:                          	;
  816:      019C 89             	DB	89H		;PRINT TOKEN
  817:      019D 50 52 49 4E    	DB	'PRINT'
            01A1 54
  818:      01A2 89             	DB	89H
  819:      01A3 50 2E          	DB	'P.'            ;P. ALSO MEANS PRINT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 16



 Line    I  Addr Code           Source

  820:      01A5 89             	DB	89H		;? ALSO
  821:      01A6 3F             	DB	'?'
  822:                          	;
  823:      01A7 8A             	DB	8AH		;CALL TOKEN
  824:      01A8 43 41 4C 4C    	DB	'CALL'
  825:                          	;
  826:      01AC 8B             	DB	8BH		;DIMENSION TOKEN
  827:      01AD 44 49 4D       	DB	'DIM'
  828:                          	;
  829:      01B0 8C             	DB	8CH		;STRING TOKEN
  830:      01B1 53 54 52 49    	DB	'STRING'
            01B5 4E 47
  831:                          	;
  832:      01B7 8D             	DB	8DH		;SET BAUD RATE
  833:      01B8 42 41 55 44    	DB	'BAUD'
  834:                          	;
  835:      01BC 8E             	DB	8EH		;CLOCK
  836:      01BD 43 4C 4F 43    	DB	'CLOCK'
            01C1 4B
  837:                          	;
  838:      01C2 8F             	DB	8FH		;PRINT HEX MODE 1
  839:      01C3 50 48 31 2E    	DB	'PH1.'
  840:                          	;
  841:           N      0090    T_STOP	EQU	90H		;STOP TOKEN
  842:      01C7 90             	DB	T_STOP
  843:      01C8 53 54 4F 50    	DB	'STOP'
  844:                          	;
  845:           N      0090    T_DIR	EQU	T_STOP		;NO DIRECT FROM HERE O
  846:                          	;
  847:      01CC 91             	DB	T_STOP+1	;ON TIMER INTERRUPT
  848:      01CD 4F 4E 54 49    	DB	'ONTIME'
            01D1 4D 45
  849:                          	;
  850:      01D3 92             	DB	T_STOP+2	;ON EXTERNAL INTERRUPT
  851:      01D4 4F 4E 45 58    	DB	'ONEX1'
            01D8 31
  852:                          	;
  853:      01D9 93             	DB	T_STOP+3	;RETURN FROM INTERRUPT
  854:      01DA 52 45 54 49    	DB	'RETI'
  855:                          	;
  856:      01DE 94             	DB	T_STOP+4	;DO TOKEN
  857:      01DF 44 4F          	DB	'DO'
  858:                          	;
  859:      01E1 95             	DB	T_STOP+5	;RESTORE TOKEN
  860:      01E2 52 45 53 54    	DB	'RESTORE'
            01E6 4F 52 45
  861:                          	;
  862:           N      0096    T_REM	EQU	T_STOP+6	;REMARK TOKEN
  863:      01E9 96             	DB	T_REM
  864:      01EA 52 45 4D       	DB	'REM'
  865:                          	;
  866:      01ED 97             	DB	T_REM+1 	;NEXT TOKEN
  867:      01EE 4E 45 58 54    	DB	'NEXT'
  868:                          	;
  869:      01F2 98             	DB	T_REM+2 	;ON ERROR TOKEN
  870:      01F3 4F 4E 45 52    	DB	'ONERR'

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 17



 Line    I  Addr Code           Source

            01F7 52
  871:                          	;
  872:      01F8 99             	DB	T_REM+3 	;ON TOKEN
  873:      01F9 4F 4E          	DB	'ON'
  874:                          	;
  875:      01FB 9A             	DB	T_REM+4 	;INPUT
  876:      01FC 49 4E 50 55    	DB	'INPUT'
            0200 54
  877:                          	;
  878:      0201 9B             	DB	T_REM+5 	;READ
  879:      0202 52 45 41 44    	DB	'READ'
  880:                          	;
  881:           N      009C    T_DATA	EQU	T_REM+6 	;DATA
  882:      0206 9C             	DB	T_DATA
  883:      0207 44 41 54 41    	DB	'DATA'
  884:                          	;
  885:      020B 9D             	DB	T_DATA+1	;RETURN
  886:      020C 52 45 54 55    	DB	'RETURN'
            0210 52 4E
  887:                          	;
  888:      0212 9E             	DB	T_DATA+2	;IF
  889:      0213 49 46          	DB	'IF'
  890:                          	;
  891:           N      009F    T_GOSB	EQU	T_DATA+3	;GOSUB
  892:      0215 9F             	DB	T_GOSB
  893:      0216 47 4F 53 55    	DB	'GOSUB'
            021A 42
  894:                          	;
  895:      021B A0             	DB	T_GOSB+1	;FOR
  896:      021C 46 4F 52       	DB	'FOR'
  897:                          	;
  898:      021F A1             	DB	T_GOSB+2	;WHILE
  899:      0220 57 48 49 4C    	DB	'WHILE'
            0224 45
  900:                          	;
  901:      0225 A2             	DB	T_GOSB+3	;UNTIL
  902:      0226 55 4E 54 49    	DB	'UNTIL'
            022A 4C
  903:                          	;
  904:      022B A3             	DB	T_GOSB+4	;END
  905:      022C 45 4E 44       	DB	'END'
  906:                          	;
  907:           N      00A4    T_LAST	EQU	T_GOSB+5	;LAST INITIAL TOKEN
  908:                          	;
  909:           N      00A4    T_TAB	EQU	T_LAST		;TAB TOKEN
  910:      022F A4             	DB	T_TAB
  911:      0230 54 41 42       	DB	'TAB'
  912:                          	;
  913:           N      00A5    T_THEN	EQU	T_LAST+1	;THEN TOKEN
  914:      0233 A5             	DB	T_THEN
  915:      0234 54 48 45 4E    	DB	'THEN'
  916:                          	;
  917:           N      00A6    T_TO	EQU	T_LAST+2	;TO TOKEN
  918:      0238 A6             	DB	T_TO
  919:      0239 54 4F          	DB	'TO'
  920:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 18



 Line    I  Addr Code           Source

  921:           N      00A7    T_STEP	EQU	T_LAST+3	;STEP TOKEN
  922:      023B A7             	DB	T_STEP
  923:      023C 53 54 45 50    	DB	'STEP'
  924:                          	;
  925:           N      00A8    T_ELSE	EQU	T_LAST+4	;ELSE TOKEN
  926:      0240 A8             	DB	T_ELSE
  927:      0241 45 4C 53 45    	DB	'ELSE'
  928:                          	;
  929:           N      00A9    T_SPC	EQU	T_LAST+5	;SPACE TOKEN
  930:      0245 A9             	DB	T_SPC
  931:      0246 53 50 43       	DB	'SPC'
  932:                          	;
  933:           N      00AA    T_CR	EQU	T_LAST+6
  934:      0249 AA             	DB	T_CR
  935:      024A 43 52          	DB	'CR'
  936:                          	;
  937:      024C AB             	DB	T_CR+1
  938:      024D 49 44 4C 45    	DB	'IDLE'
  939:                          	;
  940:      0251 AC             	DB	T_CR+2
  941:      0252 53 54 40       	DB	'ST@'
  942:                          	;
  943:      0255 AD             	DB	T_CR+3
  944:      0256 4C 44 40       	DB	'LD@'
  945:                          	;
  946:      0259 AE             	DB	T_CR+4
  947:      025A 50 47 4D       	DB	'PGM'
  948:                          	;
  949:      025D AF             	DB	T_CR+5
  950:      025E 52 52 4F 4D    	DB	'RROM'
  951:                          	;
  952:                          	; Operator tokens
  953:                          	;
  954:           N      00E0    T_LPAR	EQU	0E0H		;LEFT PAREN
  955:      0262 E0             	DB	T_LPAR
  956:      0263 28             	DB	'('
  957:                          	;
  958:      0264 E1             	DB	T_LPAR+1	;EXPONENTIAN
  959:      0265 2A 2A          	DB	'**'
  960:                          	;
  961:      0267 E2             	DB	T_LPAR+2	;FP MULTIPLY
  962:      0268 2A             	DB	'*'
  963:                          	;
  964:           N      00E3    T_ADD	EQU	T_LPAR+3
  965:      0269 E3             	DB	T_LPAR+3	;ADD TOKEN
  966:      026A 2B             	DB	'+'
  967:                          	;
  968:      026B E4             	DB	T_LPAR+4	;DIVIDE TOKEN
  969:      026C 2F             	DB	'/'
  970:                          	;
  971:           N      00E5    T_SUB	EQU	T_LPAR+5	;SUBTRACT TOKEN
  972:      026D E5             	DB	T_SUB
  973:      026E 2D             	DB	'-'
  974:                          	;
  975:      026F E6             	DB	T_LPAR+6	;LOGICAL EXCLUSIVE OR
  976:      0270 2E 58 4F 52    	DB	'.XOR.'

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 19



 Line    I  Addr Code           Source

            0274 2E
  977:                          	;
  978:      0275 E7             	DB	T_LPAR+7	;LOGICAL AND
  979:      0276 2E 41 4E 44    	DB	'.AND.'
            027A 2E
  980:                          	;
  981:      027B E8             	DB	T_LPAR+8	;LOGICAL OR
  982:      027C 2E 4F 52 2E    	DB	'.OR.'
  983:                          	;
  984:           N      00E9    T_NEG	EQU	T_LPAR+9
  985:                          	;
  986:           N      00EA    T_EQU	EQU	T_LPAR+10	;EQUAL
  987:      0280 EA             	DB	T_EQU
  988:      0281 3D             	DB	'='
  989:                          	;
  990:      0282 EB             	DB	T_LPAR+11	;GREATER THAN OR EQUAL
  991:      0283 3E 3D          	DB	'>='
  992:                          	;
  993:      0285 EC             	DB	T_LPAR+12	;LESS THAN OR EQUAL
  994:      0286 3C 3D          	DB	'<='
  995:                          	;
  996:      0288 ED             	DB	T_LPAR+13	;NOT EQUAL
  997:      0289 3C 3E          	DB	'<>'
  998:                          	;
  999:      028B EE             	DB	T_LPAR+14	;LESS THAN
 1000:      028C 3C             	DB	'<'
 1001:                          	;
 1002:      028D EF             	DB	T_LPAR+15	;GREATER THAN
 1003:      028E 3E             	DB	'>'
 1004:                          	;
 1005:                          	;
 1006:           N      00B0    T_UOP	EQU	0B0H		;UNARY OP BASE TOKEN
 1007:                          	;
 1008:      028F B0             	DB	T_UOP		;ABS TOKEN
 1009:      0290 41 42 53       	DB	'ABS'
 1010:                          	;
 1011:      0293 B1             	DB	T_UOP+1 	;INTEGER TOKEN
 1012:      0294 49 4E 54       	DB	'INT'
 1013:                          	;
 1014:      0297 B2             	DB	T_UOP+2 	;SIGN TOKEN
 1015:      0298 53 47 4E       	DB	'SGN'
 1016:                          	;
 1017:      029B B3             	DB	T_UOP+3 	;GET TOKEN
 1018:      029C 4E 4F 54       	DB	'NOT'
 1019:                          	;
 1020:      029F B4             	DB	T_UOP+4 	;COSINE TOKEN
 1021:      02A0 43 4F 53       	DB	'COS'
 1022:                          	;
 1023:      02A3 B5             	DB	T_UOP+5 	;TANGENT TOKEN
 1024:      02A4 54 41 4E       	DB	'TAN'
 1025:                          	;
 1026:      02A7 B6             	DB	T_UOP+6 	;SINE TOKEN
 1027:      02A8 53 49 4E       	DB	'SIN'
 1028:                          	;
 1029:      02AB B7             	DB	T_UOP+7 	;SQUARE ROOT TOKEN
 1030:      02AC 53 51 52       	DB	'SQR'

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 20



 Line    I  Addr Code           Source

 1031:                          	;
 1032:      02AF B8             	DB	T_UOP+8 	;CBYTE TOKEN
 1033:      02B0 43 42 59       	DB	'CBY'
 1034:                          	;
 1035:      02B3 B9             	DB	T_UOP+9 	;EXP (E TO THE X) TOKEN
 1036:      02B4 45 58 50       	DB	'EXP'
 1037:                          	;
 1038:      02B7 BA             	DB	T_UOP+10
 1039:      02B8 41 54 4E       	DB	'ATN'
 1040:                          	;
 1041:      02BB BB             	DB	T_UOP+11
 1042:      02BC 4C 4F 47       	DB	'LOG'
 1043:                          	;
 1044:      02BF BC             	DB	T_UOP+12	;DBYTE TOKEN
 1045:      02C0 44 42 59       	DB	'DBY'
 1046:                          	;
 1047:      02C3 BD             	DB	T_UOP+13	;XBYTE TOKEN
 1048:      02C4 58 42 59       	DB	'XBY'
 1049:                          	;
 1050:           N      00BE    T_ULAST EQU	T_UOP+14	;LAST OPERATOR NEED
 1051:                          	;
 1052:      02C7 BE             	DB	T_ULAST
 1053:      02C8 50 49          	DB	'PI'
 1054:                          	;
 1055:      02CA BF             	DB	T_ULAST+1	;RND TOKEN
 1056:      02CB 52 4E 44       	DB	'RND'
 1057:                          	;
 1058:      02CE C0             	DB	T_ULAST+2	;GET TOKEN
 1059:      02CF 47 45 54       	DB	'GET'
 1060:                          	;
 1061:      02D2 C1             	DB	T_ULAST+3	;FREE TOKEN
 1062:      02D3 46 52 45 45    	DB	'FREE'
 1063:                          	;
 1064:      02D7 C2             	DB	T_ULAST+4	;LEN TOKEN
 1065:      02D8 4C 45 4E       	DB	'LEN'
 1066:                          	;
 1067:           N      00C3    T_XTAL	EQU	T_ULAST+5	;CRYSTAL TOKEN
 1068:      02DB C3             	DB	T_XTAL
 1069:      02DC 58 54 41 4C    	DB	'XTAL'
 1070:                          	;
 1071:           N      00C4    T_MTOP	EQU	T_ULAST+6	;MTOP
 1072:      02E0 C4             	DB	T_MTOP
 1073:      02E1 4D 54 4F 50    	DB	'MTOP'
 1074:                          	;
 1075:           N      00C6    T_IE	EQU	T_ULAST+8	;IE REGISTER
 1076:      02E5 C6             	DB	T_IE
 1077:      02E6 49 45          	DB	'IE'
 1078:                          	;
 1079:           N      00C7    T_IP	EQU	T_ULAST+9	;IP REGISTER
 1080:      02E8 C7             	DB	T_IP
 1081:      02E9 49 50          	DB	'IP'
 1082:                          	;
 1083:           N      00C8    TMR0	EQU	T_ULAST+10	;TIMER 0
 1084:      02EB C8             	DB	TMR0
 1085:      02EC 54 49 4D 45    	DB	'TIMER0'
            02F0 52 30

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 21



 Line    I  Addr Code           Source

 1086:                          	;
 1087:           N      00C9    TMR1	EQU	T_ULAST+11	;TIMER 1
 1088:      02F2 C9             	DB	TMR1
 1089:      02F3 54 49 4D 45    	DB	'TIMER1'
            02F7 52 31
 1090:                          	;
 1091:           N      00CA    TMR2	EQU	T_ULAST+12	;TIMER 2
 1092:      02F9 CA             	DB	TMR2
 1093:      02FA 54 49 4D 45    	DB	'TIMER2'
            02FE 52 32
 1094:                          	;
 1095:           N      00C5    T_TIME	EQU	T_ULAST+7	;TIME
 1096:      0300 C5             	DB	T_TIME
 1097:      0301 54 49 4D 45    	DB	'TIME'
 1098:                          	;
 1099:           N      00CB    TT2C	EQU	T_ULAST+13	;T2CON
 1100:      0305 CB             	DB	TT2C
 1101:      0306 54 32 43 4F    	DB	'T2CON'
            030A 4E
 1102:                          	;
 1103:           N      00CC    TTC	EQU	T_ULAST+14	;TCON
 1104:      030B CC             	DB	TTC
 1105:      030C 54 43 4F 4E    	DB	'TCON'
 1106:                          	;
 1107:           N      00CD    TTM	EQU	T_ULAST+15	;TMOD
 1108:      0310 CD             	DB	TTM
 1109:      0311 54 4D 4F 44    	DB	'TMOD'
 1110:                          	;
 1111:           N      00CE    TRC2	EQU	T_ULAST+16	;RCAP2
 1112:      0315 CE             	DB	TRC2
 1113:      0316 52 43 41 50    	DB	'RCAP2'
            031A 32
 1114:                          	;
 1115:           N      00CF    T_P1	EQU	T_ULAST+17	;P1
 1116:      031B CF             	DB	T_P1
 1117:      031C 50 4F 52 54    	DB	'PORT1'
            0320 31
 1118:                          	;
 1119:           N      00D0    T_PC	EQU	T_ULAST+18	;PCON
 1120:      0321 D0             	DB	T_PC
 1121:      0322 50 43 4F 4E    	DB	'PCON'
 1122:                          	;
 1123:           N      00D1    T_ASC	EQU	T_ULAST+19	;ASC TOKEN
 1124:      0326 D1             	DB	T_ASC
 1125:      0327 41 53 43 28    	DB	'ASC('
 1126:                          	;
 1127:           N      00D2    T_USE	EQU	T_ULAST+20	;USING TOKEN
 1128:      032B D2             	DB	T_USE
 1129:      032C 55 53 49 4E    	DB	'USING('
            0330 47 28
 1130:      0332 D2             	DB	T_USE
 1131:      0333 55 2E 28       	DB	'U.('
 1132:                          	;
 1133:           N      00D3    T_CHR	EQU	T_ULAST+21	;CHR TOKEN
 1134:      0336 D3             	DB	T_CHR
 1135:      0337 43 48 52 28    	DB	'CHR('

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 22



 Line    I  Addr Code           Source

 1136:                          	;
 1137:           N      00F0    T_CMND	EQU	0F0H		;COMMAND BASE
 1138:                          	;
 1139:      033B F0             	DB	0F0H		;RUN TOKEN
 1140:      033C 52 55 4E       	DB	'RUN'
 1141:                          	;
 1142:      033F F1             	DB	0F1H		;LIST TOKEN
 1143:      0340 4C 49 53 54    	DB	'LIST'
 1144:                          	;
 1145:      0344 F2             	DB	0F2H		;NULL TOKEN
 1146:      0345 4E 55 4C 4C    	DB	'NULL'
 1147:                          	;
 1148:      0349 F3             	DB	0F3H		;NEW TOKEN
 1149:      034A 4E 45 57       	DB	'NEW'
 1150:                          	;
 1151:      034D F4             	DB	0F4H		;CONTINUE TOKEN
 1152:      034E 43 4F 4E 54    	DB	'CONT'
 1153:                          	;
 1154:      0352 F5             	DB	0F5H		;PROGRAM TOKEN
 1155:      0353 50 52 4F 47    	DB	'PROG'
 1156:                          	;
 1157:      0357 F6             	DB	0F6H		;TRANSFER TOKEN
 1158:      0358 58 46 45 52    	DB	'XFER'
 1159:                          	;
 1160:      035C F7             	DB	0F7H		;RAM MODE
 1161:      035D 52 41 4D       	DB	'RAM'
 1162:                          	;
 1163:      0360 F8             	DB	0F8H		;ROM MODE
 1164:      0361 52 4F 4D       	DB	'ROM'
 1165:                          ;
 1166:                          ;
 1167:                          ;***************************************
 1168:                          ;****** Disable Intel programming for to
 1169:                          ;
 1170:                          ;	DB	0F9H		;INTELLIGENT PROM PROGRAMMING
 1171:                          ;	DB	'FPROG'
 1172:                          ;
 1173:                          ;***************************************
 1174:                          ;****** New command "ERASE" to fill an E
 1175:                          ;****** Boehling 3 *********************
 1176:                          ;
 1177:      0364 F9             	db	0F9H		;Erase an EEPROM
 1178:      0365 45 52 41 53    	db	'ERASE'
            0369 45
 1179:                          ;
 1180:                          ;***************************************
 1181:                          ;****** Karmann 2 Bugfix ***************
 1182:                          ;
 1183:      036A FE             	db	0feh		;dummy token and
 1184:      036B 7F             	db	07fh		;unused dummy char
 1185:                          ;
 1186:                          ;****** continue with original code: ***
 1187:                          ;
 1188:      036C FF             	DB	0FFH		;END OF TABLE
 1189:                          	;
 1190:      036D 45 58 54 52    EIG:	DB	'EXTRA IGNORED"'

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 23



 Line    I  Addr Code           Source

            0371 41 20 49 47
            0375 4E 4F 52 45
            0379 44 22
 1191:                          	;
 1192:      037B 41 2D 53 54    EXA:	DB	'A-STACK"'
            037F 41 43 4B 22
 1193:                          	;
 1194:      0383 43 2D 53 54    EXC:	DB	'C-STACK"'
            0387 41 43 4B 22
 1195:                          	;
 1196:                          	;**************************************
 1197:                          	;
 1198:                          CRST:	; This performs system initialzati
 1199:                          	; new power on reset functions could be
 1200:                          	;
 1201:                          	;**************************************
 1202:                          	;
 1203:                          	; First, initialize SFR's
 1204:                          	;
 1205:      038B 75 98 5A       	MOV	SCON,#5AH	;INITIALIZE SFR'S
 1206:                          ;
 1207:                          ;***************************************
 1208:                          ;****** Use XTAL up to 47 MHz **********
 1209:                          ;****** Wulf 2 *************************
 1210:                          ;
 1211:                          ;	MOV	TMOD,#10H
 1212:                          ;
 1213:      038E 75 89 11       	mov	TMOD,#11H	;Use 16 bit mode of timer
 1214:                          ;
 1215:                          ;***************************************
 1216:                          ;
 1217:      0391 75 88 54       	MOV	TCON,#54H
 1218:      0394 75 C8 34       	MOV	T2CON,#34H
 1219:                          ;	DB	75H		;MOV DIRECT, # OP CODE
 1220:                          ;	DB	0C8H		;T2CON LOCATION
 1221:                          ;	DB	34H		;CONFIGURATION BYTE
 1222:                          ;
 1223:                          ;=== CH552 Added =====
 1224:      0397 91 37          	acall	setfsys	; Set CPU Clock 24MHz(Max
 1225:                          ;=====================
 1226:                          	;
 1227:      0399 90 20 01       	MOV	DPTR,#2001H	;READ CODE AT 2001H
 1228:      039C E4             	CLR	A
 1229:      039D 93             	MOVC	A,@A+DPTR
 1230:      039E B4 AA 03       	CJNE	A,#0AAH,CRST1	;IF IT IS AN AAH, DO
 1231:      03A1 12 20 90       	LCALL	2090H
 1232:                          	;
 1233:      03A4 78 FF          CRST1:	MOV	R0,#IRAMTOP	;PUT THE TOP OF R
 1234:      03A6 E4             	CLR	A		;ZERO THE ACC
 1235:                          	;
 1236:      03A7 F6             CRST2:	MOV	@R0,A		;CLEAR INTERNAL MEMORY
 1237:      03A8 D8 FD          	DJNZ	R0,CRST2	;LOOP TIL DONE
 1238:                          	;
 1239:                          	; Now, test the external memory
 1240:                          	;
 1241:      03AA 75 3E 4D       	MOV	SPSAV,#CMNDSP	;SET UP THE STACK

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 24



 Line    I  Addr Code           Source

 1242:      03AD 85 3E 81       	MOV	SP,SPSAV
 1243:                          ;
 1244:                          ;***************************************
 1245:                          ;****** Karmann 1 Bugfix ***************
 1246:                          ;
 1247:      03B0 12 17 E0       	lcall	TEST_USER	;chek for user command 
 1248:                          ;
 1249:                          ;****** continue with original code: ***
 1250:                          ;
 1251:      03B3 75 13 80       	MOV	BOFAH,#HIGH ROMADR
 1252:      03B6 75 14 11       	MOV	BOFAL,#LOW ROMADR+17
 1253:      03B9 90 80 00       	MOV	DPTR,#ROMADR	;GET THE BYTE AT 8000H
 1254:      03BC E0             	MOVX	A,@DPTR
 1255:      03BD C3             	CLR	C
 1256:      03BE 94 31          	SUBB	A,#31H		;FOR BIAS
 1257:      03C0 F5 45          	MOV	MT1,A		;SAVE IN DIRECT MATH LOC
 1258:      03C2 C2 E2          	CLR	ACC.2		;SAVE FOR RESET
 1259:      03C4 FF             	MOV	R7,A		;SAVE IT IN R7
 1260:      03C5 A3             	INC	DPTR
 1261:      03C6 B1 BA          	ACALL	L31DPI		;SAVE BAUD RATE
 1262:      03C8 12 08 85       	LCALL	RCL
 1263:      03CB A3             	INC	DPTR		;GET MEMTOP
 1264:      03CC B1 BA          	ACALL	L31DPI
 1265:      03CE 90 00 5F       	MOV	DPTR,#5FH	;READ THE EXTERNAL BYTE
 1266:      03D1 E0             	MOVX	A,@DPTR
 1267:      03D2 90 00 00       	MOV	DPTR,#0 	;ESTABLISH BASE FOR CLEAR
 1268:      03D5 B4 A5 08       	CJNE	A,#0A5H,CRS	;Erase the memory
 1269:      03D8 E5 45          	MOV	A,MT1
 1270:      03DA C2 E0          	CLR	ACC.0		;CLEAR BIT ONE
 1271:      03DC 64 04          	XRL	A,#4H
 1272:      03DE 60 2C          	JZ	CR2
 1273:                          	;
 1274:      03E0 BF 02 02       CRS:	CJNE	R7,#2,CRS1
 1275:      03E3 80 03          	SJMP	CRS2
 1276:      03E5 BF 03 04       CRS1:	CJNE	R7,#3,CR0
 1277:      03E8 D1 7D          CRS2:	ACALL	CL_1
 1278:      03EA 80 14          	SJMP	CR1
 1279:                          	;
 1280:      03EC AB 83          CR0:	MOV	R3,DPH		;SAVE THE DPTR
 1281:      03EE A9 82          	MOV	R1,DPL
 1282:      03F0 A3             	INC	DPTR
 1283:      03F1 74 5A          	MOV	A,#5AH
 1284:      03F3 F0             	MOVX	@DPTR,A 	;Test external memory
 1285:      03F4 E0             	MOVX	A,@DPTR
 1286:      03F5 B4 5A 08       	CJNE	A,#5AH,CR1
 1287:      03F8 E4             	CLR	A
 1288:      03F9 F0             	MOVX	@DPTR,A
 1289:                          ;
 1290:                          ;***************************************
 1291:                          ;******* Skowronek alterations to progra
 1292:                          ;
 1293:                          ;	CJNE	R3,#0E0H,CR0
 1294:                          ;
 1295:                          ;=== CH552 Replaced =====
 1296:                          ;	CJNE	R3,#HIGH ROMADR-1,CR0	;Stop the t
 1297:                          ;	CJNE	R1,#LOW ROMADR-2,CR0	;EEPROM star

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 25



 Line    I  Addr Code           Source

 1298:                          ;
 1299:      03FA BB 03 EF       	CJNE	R3,#HIGH ERAMEND,CR0	; Stop the te
 1300:      03FD B9 FE EC       	CJNE	R1,#LOW ERAMEND-1,CR0	; EXT-RAM en
 1301:                          ;========================
 1302:                          ;
 1303:                          ;***************************************
 1304:                          ;
 1305:      0400 BB 03 00       CR1:	CJNE	R3,#03H,CR11	;NEED THIS MUCH R
 1306:      0403 40 86          CR11:	JC	CRST
 1307:      0405 90 01 0A       	MOV	DPTR,#MEMTOP	;SAVE MEMTOP
 1308:      0408 D1 03          	ACALL	S31DP2		;SAVE MEMTOP AND SEED RCE
 1309:      040A D1 5C          	ACALL	CNEW		;CLEAR THE MEMORY AND SET U
 1310:                          	;
 1311:      040C D1 6F          CR2:	ACALL	RC1		;SET UP STACKS IF NOT DO
 1312:                          	;
 1313:      040E 12 16 57       	LCALL	AXTAL0		;DO THE CRYSTAL
 1314:      0411 E5 45          	MOV	A,MT1		;GET THE RESET BYTE
 1315:      0413 B4 05 03       	CJNE	A,#5,CR20
 1316:      0416 12 40 39       	LCALL	4039H
 1317:      0419 50 0D          CR20:	JNC	BG1		;CHECK FOR 0,1,2,3, OR 4
 1318:      041B 30 E0 49       	JNB	ACC.0,BG3	;NO RUN IF WRONG TYPE
 1319:      041E 90 80 10       	MOV	DPTR,#ROMADR+16
 1320:      0421 E0             	MOVX	A,@DPTR 	;READ THE BYTE
 1321:      0422 B4 55 42       	CJNE	A,#55H,BG3
 1322:      0425 02 08 02       	LJMP	CRUN
 1323:                          ;
 1324:                          ;***************************************
 1325:                          ;******* New baudrate detection ********
 1326:                          ;******* Wulf 3 alteration 1 ***********
 1327:                          ;
 1328:                          ;BG1:	 CLR	 A		 ;DO BAUD RATE
 1329:                          ;	 MOV	 R3,A
 1330:                          ;	 MOV	 R1,A
 1331:                          ;	 MOV	 R0,#4
 1332:                          ;	 JB	 RXD,$		 ;LOOP UNTIL A CHARACTER I
 1333:                          ;	;
 1334:                          ;BG2:	 DJNZ	 R0,$		 ;FOUR CLOCKS, IN LOO
 1335:                          ;	 CALL	 DEC3211	 ;NINE CLOCKS
 1336:                          ;	 MOV	 R0,#2		 ;ONE CLOCK
 1337:                          ;	 JNB	 RXD,BG2	 ;TWO CLOCKS, LOOP UNTIL
 1338:                          ;	 JB	 RXD,$		 ;WAIT FOR STOP CHARACTER 
 1339:                          ;	 JNB	 RXD,$
 1340:                          ;
 1341:                          ;***************************************
 1342:                          ;******* New processor type detection **
 1343:                          ;******* Wulf 4 ************************
 1344:                          ;
 1345:                          ;-- comment out for AT98LP52 -----------
 1346:                          ;
 1347:                          ;BG1:	clr	a
 1348:                          ;	mov	t2con,a
 1349:                          ;	mov	TH2,#0FFh
 1350:                          ;	mov	TL2,#0F8h
 1351:                          ;	jb	rxd,$
 1352:                          ;	mov	t2con,#5	;Timer2 start
 1353:                          ;	jnb	rxd,$

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 26



 Line    I  Addr Code           Source

 1354:                          ;	mov	t2con,a 	;Timer2 stop
 1355:                          ;	jb	rxd,$
 1356:                          ;	jnb	rxd,$
 1357:                          ;	call	sercalc 	;r3=timer2 MSB default
 1358:                          ;	;
 1359:                          ;	cjne	a,ADCON,BG10	;jump if A/D process
 1360:                          ;BG14:	mov	a,S0RELL
 1361:                          ;	cjne	a,#B9600,BG2	;jump if not 805x7A
 1362:                          ;	mov	a,r3
 1363:                          ;	anl	S0RELH,a
 1364:                          ;	mov	S0RELL,r1	;start Baudratetimer 805
 1365:                          ;	sjmp	BG11
 1366:                          ;	;
 1367:                          ;BG10:	cjne	r1,#B9600,BG12	;jump if wron
 1368:                          ;BG11:	orl	PCON0,#080h	;setb smod for fa
 1369:                          ;	sjmp	BG13
 1370:                          ;	;
 1371:                          ;BG12:	cjne	r1,#B4800,BG14	;jump if wron
 1372:                          ;BG13:	setb	BD		;enable baudrategenerato
 1373:                          ;	sjmp	BG15
 1374:                          ;	;
 1375:                          ;BG2:	mov	t2con,#34h	;configure Timer2 a
 1376:                          ;BG15:	CALL	RCL		;LOAD THE TIMER
 1377:                          
 1378:                          ;
 1379:                          ;-- insert for AT98LP52 ----------------
 1380:                          ;
 1381:                          ;BG1:	mov	r6,#0		; Speed Table Index
 1382:                          ;	mov	r3,#0FFH	; Set R3 = RCAP2H
 1383:                          ;
 1384:                          ;BG11:	mov	dptr,#SPEED_TBL	; Speed Table
 1385:                          ;	mov	a,r6		; Speed Table Index
 1386:                          ;	movc	a,@a+dptr	; Fetch Speed Table
 1387:                          ;	inc	r6
 1388:                          ;	jz	bg3		; Table End, Use Last Speed
 1389:                          ;
 1390:                          ;	mov	r1,a		; Set R1 = RCAP2L
 1391:                          ;	mov	t2con,#34h	;configure Timer2 as ba
 1392:                          ;	call	RCL		;LOAD THE TIMER
 1393:                          ;
 1394:                          ;	mov	dptr,#TEST_MSG	; Put Test Message
 1395:                          ;	mov	r7,#0		; Message Text Index
 1396:                          ;
 1397:                          ;BG13:	mov	a,r7		; Text Index
 1398:                          ;	movc	a,@a+dptr	; Fetch Message String
 1399:                          ;	jz	BG14		; String End ?
 1400:                          ;	jnb	TI,$		; Wait Until Transmmit End
 1401:                          ;	clr	TI		; Clear TX Flag
 1402:                          ;	mov	SBUF,a	 	; Output Character
 1403:                          ;	inc	r7		; Next Character
 1404:                          ;	sjmp	BG13
 1405:                          ;
 1406:                          ;BG14:	jnb	RI,$		; Wait Until Receive En
 1407:                          ;	mov	a,SBUF		; Get Receive Character
 1408:                          ;	clr	RI		; Reset Flag
 1409:                          ;	anl	a,#07FH		; Clear Bit-7

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 27



 Line    I  Addr Code           Source

 1410:                          ;	cjne	a,#'y',BG11	; Ok?, Test Next Spee
 1411:                          ;	sjmp	BG3
 1412:                          ;
 1413:                          ;SPEED_TBL:	db	0A0H	; RCAP2H,L = FFA0H (
 1414:                          ;		db	0B8H	; RCAP2H,L = FFB8H (19.2Kbps,
 1415:                          ;		db	0D0H	; RCAP2H,L = FFD0H (19.2Kbbs,
 1416:                          ;		db	0DCH	; RCAP2H,L = FFDCH (19.2Kbps,
 1417:                          ;		db	00h	; Table End
 1418:                          
 1419:                          ;-- CH552 Insert Start -----------------
 1420:                          ;=======================================
 1421:                          ;  CH552 Set Fixed baudrate 19.23Kbps
 1422:                          ;  RCAP2H,L = 65536 - (Fsys/16/Baud Rate
 1423:                          ;=======================================
 1424:           N      FFB2    baud19K	equ	0ffb2h		; RCAP2H,L Value of 
 1425:                          ;
 1426:                          BG1:
 1427:      0428 43 C9 C0       	orl		t2mod,#0C0H		; Set bTMR_CLK, bT2_C
 1428:      042B 7B FF          	mov		r3,#high baud19k	; Set R3 = RCAP2H
 1429:      042D 79 B2          	mov		r1,#low baud19k		; Set R1 = RCAP2L
 1430:      042F 75 C8 34       	mov		t2con,#34h		; configure Timer2 as 
 1431:      0432 12 08 85       	call	RCL				; LOAD THE TIMER
 1432:                          
 1433:      0435 80 30          	sjmp	BG3
 1434:                          
 1435:                          ;=======================================
 1436:                          ;  CH552 System Clock (Fsys) Up 6MHz -> 
 1437:                          ;=======================================
 1438:                          setfsys:
 1439:      0437 E5 B9          	mov	a,CLOCK_CFG		; Get CLOCK_CFG
 1440:      0439 54 F8          	anl	a,#0F8H			;  Clear MASK_SYS_CK_SEL
 1441:      043B 44 06          	orl	a,#006H			;  Set MASK_SYS_CK_SEL = 
 1442:                          
 1443:      043D 75 A1 55       	mov	SAFE_MOD,#055H	; Enter Safe_Mode Ke
 1444:      0440 75 A1 AA       	mov	SAFE_MOD,#0AAH	; Enter Safe_Mode Ke
 1445:                          
 1446:      0443 F5 B9          	mov	CLOCK_CFG,a		; Rewrite CLOCK_CFG
 1447:                          
 1448:      0445 75 A1 00       	mov	SAFE_MOD,#00	; Exit Safe_Mode
 1449:                          
 1450:      0448 22             	ret
 1451:                          
 1452:           N      0467    	org	0467h		; Insert Dummy Space, 0467H 
 1453:                          ;
 1454:                          ;-- insert end -------------------------
 1455:                          ;
 1456:                          ;****** Original code from here ********
 1457:                          ;
 1458:      0467 90 1F D3       BG3:	MOV	DPTR,#S_N	;GET THE MESSAGE
 1459:      046A D1 AD          	ACALL	CRP		;PRINT IT
 1460:      046C 02 17 7F       	LJMP	CRAM
 1461:                          	;
 1462:                          	;**************************************
 1463:                          	;
 1464:                          	; CIPROG AND CPROG - Program a prom
 1465:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 28



 Line    I  Addr Code           Source

 1466:                          	;**************************************
 1467:                          	;
 1468:      046F 7F 00          PG8:	MOV	R7,#00H 	;PROGRAM ONE BYTE AT A
 1469:      0471 7E 01          	MOV	R6,#01H
 1470:      0473 7A 7F          	MOV	R2,#HIGH ROMADR-1
 1471:      0475 78 FF          	MOV	R0,#LOW ROMADR-1;LOAD PROM ADDRESS
 1472:      0477 91 B5          	ACALL	PG101
 1473:      0479 0E             	INC	R6
 1474:      047A E5 CB          	MOV	A,RCAPH2
 1475:                          ;	DB	0E5H		;MOV A DIRECT OP CODE
 1476:                          ;	DB	0CBH		;ADDRESS OF R2CAP HIGH
 1477:      047C 91 B5          	ACALL	PG101
 1478:      047E E5 CA          	MOV	A,RCAPL2
 1479:                          ;	DB	0E5H		;MOV A, DIRECT OP CODE
 1480:                          ;	DB	0CAH		;R2CAP LOW
 1481:      0480 7E 03          	MOV	R6,#3
 1482:      0482 79 09          	MOV	R1,#LOW MEMTOP-1
 1483:      0484 7B 01          	MOV	R3,#HIGH MEMTOP
 1484:      0486 91 B5          	ACALL	PG101		;SAVE MEMTOP
 1485:      0488 80 29          	SJMP	PGR
 1486:                          ;
 1487:                          ;
 1488:                          ;***************************************
 1489:                          ;****** Skowronek alterations to program
 1490:                          ;****** Support the "PGM" statement was 
 1491:                          ;****** Disable Intel programming and co
 1492:                          ;
 1493:                          ;CIPROG: MOV	DPTR,#IPROGS	;LOAD IPROG LO
 1494:                          ;	SETB	INTELB
 1495:                          ;	SJMP	CPROG1		;GO DO PROG
 1496:                          ;	;
 1497:                          ;CPROG: MOV	DPTR,#PROGS	;LOAD PROG LOCAT
 1498:                          ;	CLR	INTELB
 1499:                          ;	;
 1500:                          ;CPROG1: ACALL	LD_T		;LOAD THE TIMER
 1501:                          ;	CLR	PROMV		;TURN ON THE PROM VOLTAGE
 1502:                          ;	CALL	DELTST		;SEE IF A CR
 1503:                          ;	JNZ	PG8		;SAVE TIMER IF SO
 1504:                          ;	MOV	R4,#0FEH
 1505:                          ;	SETB	INBIT
 1506:                          ;	ACALL	ROMFD		;GET THE ROM ADDRESS OF T
 1507:                          ;	CALL	TEMPD		;SAVE THE ADDRESS
 1508:                          ;	MOV	A,R4		;GET COUNT
 1509:                          ;	CPL	A
 1510:                          ;	CALL	TWO_R2		;PUT IT ON THE STACK
 1511:                          ;	CALL	FP_BASE7	;OUTPUT IT
 1512:                          ;	ACALL	CCAL		;GET THE PROGRAM
 1513:                          ;	ACALL	CRLF		;DO CRLF
 1514:                          ;	MOV	R0,TEMP4	;GET ADDRESS
 1515:                          ;	MOV	R2,TEMP5
 1516:                          ;	MOV	A,#55H		;LOAD SIGNIFIER
 1517:                          ;	INC	R6		;LOAD LEN + 1
 1518:                          ;	CJNE	R6,#00,CPROG2
 1519:                          ;	INC	R7
 1520:                          ;CPROG2: ACALL	 PG102
 1521:                          ;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 29



 Line    I  Addr Code           Source

 1522:                          ;PGR:	SETB	PROMV
 1523:                          ;	AJMP	C_K
 1524:                          ;
 1525:                          ;PG1:	MOV	P2,R3		;GET THE BYTE TO PROGRA
 1526:                          ;	MOVX	A,@R1
 1527:                          ;PG101:  LCALL	 INC3210	 ;BUMP POINTERS
 1528:                          ;PG102:  MOV	 R5,#1		 ;SET UP INTELLIGEN
 1529:                          ;
 1530:                          ;PG2:	MOV	R4,A		;SAVE THE BYTE IN R4
 1531:                          ;	ACALL	PG7		;PROGRAM THE BYTE
 1532:                          ;	ACALL	PG9
 1533:                          ;	JB	INTELB,PG4	;SEE IF INTELLIGENT PROG
 1534:                          ;
 1535:                          ;PG3:	XRL	A,R4
 1536:                          ;	JNZ	PG6		;ERROR IF NOT THE SAME
 1537:                          ;	CALL	DEC76		;BUMP THE COUNTERS
 1538:                          ;	JNZ	PG1		;LOOP IF NOT DONE
 1539:                          ;	ANL	PSW,#11100111B	;INSURE RB0
 1540:                          ;PG31:	 RET
 1541:                          ;
 1542:                          ;PG4:	XRL	A,R4		;SEE IF PROGRAMMED
 1543:                          ;	JNZ	PG5		;JUMP IF NOT
 1544:                          ;	MOV	A,R4		;GET THE DATA BACK
 1545:                          ;	ACALL	PG7		;PROGRAM THE LOCATION
 1546:                          ;PG41:	 ACALL	 ZRO		 ;AGAIN
 1547:                          ;	ACALL	ZRO		;AND AGAIN
 1548:                          ;	ACALL	ZRO		;AND AGAIN
 1549:                          ;	DJNZ	R5,PG41 	;KEEP DOING IT
 1550:                          ;	ACALL	PG9		;RESET PROG
 1551:                          ;	SJMP	PG3		;FINISH THE LOOP
 1552:                          ;
 1553:                          ;PG5:	INC	R5		;BUMP THE COUNTER
 1554:                          ;	MOV	A,R4		;GET THE BYTE
 1555:                          ;	CJNE	R5,#25,PG2	;SEE IF TRIED 25 TIMES
 1556:                          ;
 1557:                          ;PG6:	SETB	PROMV		;TURN OFF PROM VOLTAGE
 1558:                          ;	MOV	PSW,#0		;INSURE RB0
 1559:                          ;	JNB	DIRF,PG31	;EXIT IF IN RUN MODE
 1560:                          ;	MOV	DPTR,#E16X	;PROGRAMMING ERROR
 1561:                          ;
 1562:                          ;ERRLK: LJMP	ERROR		;PROCESS THE ERROR
 1563:                          ;
 1564:                          ;PG7:	MOV	P0,R0		;SET UP THE PORTS
 1565:                          ;	MOV	P2,R2		;LATCH LOW ORDER ADDRESS
 1566:                          ;	ACALL	PG11		;DELAY FOR 8748/9
 1567:                          ;	CLR	ALED
 1568:                          ;	MOV	P0,A		;PUT DATA ON THE PORT
 1569:                          ;	;
 1570:                          ;ZRO:	NOP			;SETTLEING TIME + FP ZERO
 1571:                          ;	NOP
 1572:                          ;	NOP
 1573:                          ;	NOP
 1574:                          ;	NOP
 1575:                          ;	NOP
 1576:                          ;	ACALL	PG11		;DELAY A WHILE
 1577:                          ;	CLR	PROMP		;START PROGRAMMING

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 30



 Line    I  Addr Code           Source

 1578:                          ;	ACALL	TIMER_LOAD	;START THE TIMER
 1579:                          ;	JNB	TF1,$		;WAIT FOR PART TO PROGRAM
 1580:                          ;	RET			;EXIT
 1581:                          ;
 1582:                          ;PG9:	SETB	PROMP
 1583:                          ;	ACALL	PG11		;DELAY FOR A WHILE
 1584:                          ;	JNB	P3.2,$		;LOOP FOR EEPROMS
 1585:                          ;	MOV	P0,#0FFH
 1586:                          ;	CLR	P3.7		;LOWER READ
 1587:                          ;	ACALL	PG11
 1588:                          ;	MOV	A,P0		;READ THE PORT
 1589:                          ;	SETB	P3.7
 1590:                          ;	SETB	ALED
 1591:                          ;	RET
 1592:                          ;
 1593:                          ;PG11:	MOV	TEMP5,#12	;DELAY 30uS AT 12 M
 1594:                          ;	DJNZ	TEMP5,$
 1595:                          ;	RET
 1596:                          ;
 1597:                          ;	;*************************************
 1598:                          ;	;
 1599:                          ;PGU:	;PROGRAM A PROM FOR THE USER
 1600:                          ;	;
 1601:                          ;	;*************************************
 1602:                          ;
 1603:                          ;	CLR	PROMV		;TURN ON THE VOLTAGE
 1604:                          ;	MOV	PSW,#00011000B	;SELECT RB3
 1605:                          ;	ACALL	PG1		;DO IT
 1606:                          ;	SETB	PROMV		;TURN IT OFF
 1607:                          ;	RET
 1608:                          ;
 1609:                          ;****** alteredet code starts here: ****
 1610:                          ;
 1611:      048A 90 01 28       CPROG:	MOV	DPTR,#PROGS	;LOAD PROG LOCATI
 1612:                          	;
 1613:      048D B1 82          CPROG1: ACALL	LD_T		;LOAD THE TIMER
 1614:      048F 12 0E E1       	CALL	DELTST		;SEE IF A CR
 1615:      0492 70 DB          	JNZ	PG8		;SAVE TIMER IF SO
 1616:      0494 7C FE          	MOV	R4,#0FEH
 1617:      0496 D2 1D          	SETB	INBIT
 1618:      0498 B1 5B          	ACALL	ROMFD		;GET THE ROM ADDRESS OF TH
 1619:      049A 12 18 54       	CALL	TEMPD		;SAVE THE ADDRESS
 1620:      049D EC             	MOV	A,R4		;GET COUNT
 1621:      049E F4             	CPL	A
 1622:      049F 12 14 B1       	CALL	TWO_R2		;PUT IT ON THE STACK
 1623:      04A2 12 19 7D       	CALL	FP_BASE7	;OUTPUT IT
 1624:      04A5 B1 1C          	ACALL	CCAL		;GET THE PROGRAM
 1625:      04A7 D1 A5          	ACALL	CRLF		;DO CRLF
 1626:      04A9 A8 0E          	MOV	R0,TEMP4	;GET ADDRESS
 1627:      04AB AA 0F          	MOV	R2,TEMP5
 1628:      04AD 74 55          	MOV	A,#55H		;LOAD SIGNIFIER
 1629:      04AF 0E             	INC	R6		;LOAD LEN + 1
 1630:      04B0 0F             	INC	R7
 1631:      04B1 91 C3          CPROG2: ACALL	PG2
 1632:                          	;
 1633:      04B3 A1 40          PGR:	AJMP	C_K		;Exit to command mode

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 31



 Line    I  Addr Code           Source

 1634:                          	;
 1635:      04B5 0F             PG101:	INC	R7
 1636:      04B6 BE 00 07       	CJNE	R6,#0,PG4
 1637:      04B9 1F             	DEC	R7
 1638:      04BA 80 04          	SJMP	PG4
 1639:                          	;
 1640:      04BC 0F             PG10:	INC	R7
 1641:                          	;
 1642:      04BD 8B A0          PG1:	MOV	P2,R3		;GET THE BYTE TO PROGRAM
 1643:      04BF E3             	MOVX	A,@R1
 1644:      04C0 12 15 76       PG4:	LCALL	INC3210 	;BUMP POINTERS
 1645:                          	;
 1646:      04C3 91 D9          PG2:	ACALL	PG7		;Write the byte
 1647:      04C5 70 04          	JNZ	PG5		;exit if error
 1648:      04C7 DE F4          	DJNZ	R6,PG1
 1649:      04C9 DF F2          	DJNZ	R7,PG1		;LOOP IF NOT DONE
 1650:                          	;
 1651:      04CB 53 D0 E7       PG5:	ANL	PSW,#11100111B	;INSURE RB0
 1652:      04CE 60 27          	JZ	PG31		;Jump if none error
 1653:                          	;
 1654:      04D0 30 2F 24       PG6:	JNB	DIRF,PG31	;EXIT IF IN RUN MODE
 1655:      04D3 90 1F 9A       	MOV	DPTR,#E16X	;PROGRAMMING ERROR
 1656:      04D6 02 18 8F       ERRLK:	LJMP	ERROR		;PROCESS THE ERROR
 1657:                          	;
 1658:                          	;
 1659:      04D9 FC             PG7:	MOV	R4,A		;SAVE THE BYTE IN R4 for 
 1660:      04DA 8A 83          	mov	dph,r2		;load data pointer with eep
 1661:      04DC 88 82          	mov	dpl,r0
 1662:      04DE F0             	movx	@dptr,a 	;write the byte
 1663:      04DF 7D             	DB	07DH		;mov	 r5,#0
 1664:                          	;
 1665:      04E0 00             ZRO:	NOP
 1666:      04E1 00             	NOP			;SETTLEING TIME + FP ZERO
 1667:      04E2 00             	NOP			;Atenttion. This 6 NOP's a not on
 1668:      04E3 00             	NOP			;for settleing time, it is also t
 1669:      04E4 00             	NOP			;floating point zero!
 1670:      04E5 00             	NOP
 1671:      04E6 75 0F 0C       	MOV	TEMP5,#12	;DELAY 30uS AT 12 MHZ
 1672:      04E9 D5 0F FD       	DJNZ	TEMP5,$
 1673:      04EC B1 2D          	ACALL	TIMER_LOAD	;START THE TIMER
 1674:      04EE 30 8F FD       	JNB	TF1,$		;WAIT FOR PART TO PROGRAM
 1675:      04F1 E0             	movx	A,@DPTR 	;Read back for error dete
 1676:      04F2 6C             	xrl	A,R4		;Test for error
 1677:      04F3 60 02          	jz	PG31
 1678:      04F5 DD E9          	djnz	r5,ZRO
 1679:      04F7 22             PG31:	RET
 1680:                          	;
 1681:                          	;**************************************
 1682:                          	;
 1683:                          PGU:	;PROGRAM A PROM FOR THE USER (state
 1684:                          	;
 1685:                          	;**************************************
 1686:                          	;
 1687:      04F8 75 D0 18       	MOV	PSW,#00011000B	;SELECT RB3
 1688:      04FB BE 00 BE       	CJNE	R6,#0,PG10
 1689:      04FE 80 BD          	SJMP	PG1

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 32



 Line    I  Addr Code           Source

 1690:                          ;
 1691:                          ;***************************************
 1692:                          ;****** The new command "ERASE" to fill 
 1693:                          ;****** Boehling 3 *********************
 1694:                          ;
 1695:      0500 7F 40          CERASE: mov	R7,#40H 		;Erase 16K byte
 1696:      0502 7E 00          	mov	R6,#00H
 1697:      0504 7A 7F          	mov	R2,#HIGH ROMADR-1	;Startaddress EEP
 1698:      0506 78 FF          	mov	R0,#LOW ROMADR-1
 1699:      0508 90 01 28       	mov	DPTR,#PROGS		;Point to EEPROM timei
 1700:      050B B1 82          	acall	LD_T			;Load the timer
 1701:                          	;
 1702:      050D 12 15 76       ERA1:	lcall	INC3210 		;Bump pointers
 1703:      0510 74 FF          	mov	A,#0FFH 		;Fill the EEPROM with 0FF
 1704:      0512 91 D9          	acall	PG7			;Write the byte
 1705:      0514 70 BA          	jnz	PG6			;Exit if error
 1706:      0516 DE F5          	DJNZ	R6,ERA1
 1707:      0518 DF F3          	DJNZ	R7,ERA1 		;Do the loop
 1708:      051A A1 40          	ajmp	C_K			;Exit to command mode
 1709:                          ;
 1710:                          ;***************************************
 1711:                          ;
 1712:                          ;****** continue with original code: ***
 1713:                          	;
 1714:                          	;**************************************
 1715:                          	;
 1716:                          CCAL:	; Set up for prom moves
 1717:                          	; R3:R1 gets source
 1718:                          	; R7:R6 gets # of bytes
 1719:                          	;
 1720:                          	;**************************************
 1721:                          	;
 1722:      051C B1 8A          	ACALL	GETEND		;GET THE LAST LOCATION
 1723:      051E A3             	INC	DPTR		;BUMP TO LOAD EOF
 1724:      051F AB 13          	MOV	R3,BOFAH
 1725:      0521 A9 14          	MOV	R1,BOFAL	;RESTORE START
 1726:      0523 C3             	CLR	C		;PREPARE FOR SUBB
 1727:      0524 E5 82          	MOV	A,DPL		;SUB DPTR - BOFA > R7:R6
 1728:      0526 99             	SUBB	A,R1
 1729:      0527 FE             	MOV	R6,A
 1730:      0528 E5 83          	MOV	A,DPH
 1731:      052A 9B             	SUBB	A,R3
 1732:      052B FF             	MOV	R7,A
 1733:      052C 22             CCAL1:	RET
 1734:                          	;
 1735:                          	;**************************************
 1736:                          	;
 1737:                          TIMER_LOAD:; Load the timer
 1738:                          	;
 1739:                          	;**************************************
 1740:                          	;
 1741:      052D B1 2C          	ACALL	CCAL1		;DELAY FOUR CLOCKS
 1742:                          TIMER_LOAD1:
 1743:      052F C2 8E          	CLR	TR1		;STOP IT WHILE IT'S LOADED
 1744:      0531 85 40 8D       	MOV	TH1,T_HH
 1745:      0534 85 41 8B       	MOV	TL1,T_LL

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 33



 Line    I  Addr Code           Source

 1746:      0537 C2 8F          	CLR	TF1		;CLEAR THE OVERFLOW FLAG
 1747:      0539 D2 8E          	SETB	TR1		;START IT NOW
 1748:      053B 22             	RET
 1749:                          	;
 1750:                          	;**************************************
 1751:                          	;
 1752:                          CROM:	; The command action routine - ROM
 1753:                          	;
 1754:                          	;**************************************
 1755:                          	;
 1756:      053C C2 17          	CLR	CONB		;CAN'T CONTINUE IF MODE CHANG
 1757:      053E B1 43          	ACALL	RO1		;DO IT
 1758:                          	;
 1759:      0540 02 10 92       C_K:	LJMP	CL3		;EXIT
 1760:                          	;
 1761:                          ;RO1:	 CALL	 INTGER 	;SEE IF INTGER PRES
 1762:                          ;	 MOV	 R4,R0B0	;SAVE THE NUMBER
 1763:                          ;	 JNC	 $+4
 1764:                          ;	 MOV	 R4,#01H	;ONE IF NO INTEGER PRESE
 1765:                          ;	ACALL	ROMFD		;FIND THE PROGRAM
 1766:                          ;
 1767:      0543 12 0E E1       RO1:	CALL	DELTST
 1768:      0546 7C 01          	MOV	R4,#1
 1769:      0548 50 04          	JNC	RO11
 1770:      054A 12 0E 8E       	CALL	ONE
 1771:      054D FC             	MOV	R4,A
 1772:                          ;
 1773:      054E B1 5B          RO11:	ACALL	ROMFD
 1774:      0550 BC 00 11       	CJNE	R4,#0,RFX	;EXIT IF R4 <> 0
 1775:      0553 A3             	INC	DPTR		;BUMP PAST TAG
 1776:      0554 85 83 13       	MOV	BOFAH,DPH	;SAVE THE ADDRESS
 1777:      0557 85 82 14       	MOV	BOFAL,DPL
 1778:      055A 22             	RET
 1779:                          	;
 1780:      055B 90 80 10       ROMFD:	MOV	DPTR,#ROMADR+16 ;START OF USE
 1781:                          	;
 1782:      055E E0             RF1:	MOVX	A,@DPTR 	;GET THE BYTE
 1783:      055F B4 55 09       	CJNE	A,#55H,RF3	;SEE IF PROPER TAG
 1784:      0562 DC 01          	DJNZ	R4,RF2		;BUMP COUNTER
 1785:                          	;
 1786:      0564 22             RFX:	RET			;DPTR HAS THE START ADDRESS
 1787:                          	;
 1788:      0565 A3             RF2:	INC	DPTR		;BUMP PAST TAG
 1789:      0566 B1 AC          	ACALL	G5
 1790:      0568 A3             	INC	DPTR		;BUMP TO NEXT PROGRAM
 1791:      0569 80 F3          	SJMP	RF1		;DO IT AGAIN
 1792:                          	;
 1793:      056B 10 1D F6       RF3:	JBC	INBIT,RFX	;EXIT IF SET
 1794:                          	;
 1795:      056E 90 1F C9       NOGO:	MOV	DPTR,#NOROM
 1796:      0571 81 D6          	AJMP	ERRLK
 1797:                          	;
 1798:                          	;**************************************
 1799:                          	;
 1800:                          L20DPI: ; load R2:R0 with the location t
 1801:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 34



 Line    I  Addr Code           Source

 1802:                          	;**************************************
 1803:                          	;
 1804:      0573 E0             	MOVX	A,@DPTR
 1805:      0574 FA             	MOV	R2,A
 1806:      0575 A3             	INC	DPTR
 1807:      0576 E0             	MOVX	A,@DPTR
 1808:      0577 F8             	MOV	R0,A
 1809:      0578 22             	RET			;DON'T BUMP DPTR
 1810:                          	;
 1811:                          	;**************************************
 1812:                          	;
 1813:                          X31DP:	; swap R3:R1 with DPTR
 1814:                          	;
 1815:                          	;**************************************
 1816:                          	;
 1817:      0579 CB             	XCH	A,R3
 1818:      057A C5 83          	XCH	A,DPH
 1819:      057C CB             	XCH	A,R3
 1820:      057D C9             	XCH	A,R1
 1821:      057E C5 82          	XCH	A,DPL
 1822:      0580 C9             	XCH	A,R1
 1823:      0581 22             	RET
 1824:                          	;
 1825:                          	;**************************************
 1826:                          	;
 1827:                          LD_T:	; Load the timer save location wit
 1828:                          	; pointing to.
 1829:                          	;
 1830:                          	;**************************************
 1831:                          	;
 1832:      0582 E0             	MOVX	A,@DPTR
 1833:      0583 F5 40          	MOV	T_HH,A
 1834:      0585 A3             	INC	DPTR
 1835:      0586 E0             	MOVX	A,@DPTR
 1836:      0587 F5 41          	MOV	T_LL,A
 1837:      0589 22             	RET
 1838:                          	;
 1839:                          	;
 1840:                          	;**************************************
 1841:                          	;
 1842:                          	;GETLIN - FIND THE LOCATION OF THE LINE
 1843:                          	;	  IF ACC = 0 THE LINE WAS NOT FOUND I
 1844:                          	;	  WAS TOO BIG, ELSE ACC <> 0 AND THE 
 1845:                          	;	  AT THE LINE THAT IS GREATER THAN OR
 1846:                          	;	  VALUE IN R3:R1.
 1847:                          	;
 1848:                          	;**************************************
 1849:                          	;
 1850:      058A D2 29          GETEND: SETB	ENDBIT		;GET THE END OF THE
 1851:                          	;
 1852:      058C 12 0E 9B       GETLIN: CALL	DP_B		;GET BEGINNING ADDRES
 1853:                          	;
 1854:      058F 12 0A A4       G1:	CALL	B_C
 1855:      0592 60 12          	JZ	G3		;EXIT WITH A ZERO IN A IF AT END
 1856:      0594 A3             	INC	DPTR		;POINT AT THE LINE NUMBER
 1857:      0595 20 29 0A       	JB	ENDBIT,G2	;SEE IF WE WANT TO FIND TH

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 35



 Line    I  Addr Code           Source

 1858:      0598 B1 CC          	ACALL	DCMPX		;SEE IF (DPTR) = R3:R1
 1859:      059A B1 C2          	ACALL	DECDP		;POINT AT LINE COUNT
 1860:      059C E0             	MOVX	A,@DPTR 	;PUT LINE LENGTH INTO ACC
 1861:      059D 20 2A 06       	JB	UBIT,G3 	;EXIT IF EQUAL
 1862:      05A0 40 04          	JC	G3		;SEE IF LESS THAN OR ZERO
 1863:                          	;
 1864:      05A2 B1 DE          G2:	ACALL	ADDPTR		;ADD IT TO DPTR
 1865:      05A4 80 E9          	SJMP	G1		;LOOP
 1866:                          	;
 1867:      05A6 C2 29          G3:	CLR	ENDBIT		;RESET ENDBIT
 1868:      05A8 22             	RET			;EXIT
 1869:                          	;
 1870:      05A9 90 02 00       G4:	MOV	DPTR,#PSTART	;DO RAM
 1871:                          	;
 1872:      05AC D2 29          G5:	SETB	ENDBIT
 1873:      05AE 80 DF          	SJMP	G1		;NOW DO TEST
 1874:                          	;
 1875:                          	;**************************************
 1876:                          	;
 1877:                          	; LDPTRI - Load the DATA POINTER with t
 1878:                          	;	   to - DPH = (DPTR) , DPL = (DPTR+1)
 1879:                          	;
 1880:                          	; acc gets wasted
 1881:                          	;
 1882:                          	;**************************************
 1883:                          	;
 1884:      05B0 E0             LDPTRI: MOVX	A,@DPTR 	;GET THE HIGH BYTE
 1885:      05B1 C0 E0          	PUSH	ACC		;SAVE IT
 1886:      05B3 A3             	INC	DPTR		;BUMP THE POINTER
 1887:      05B4 E0             	MOVX	A,@DPTR 	;GET THE LOW BYTE
 1888:      05B5 F5 82          	MOV	DPL,A		;PUT IT IN DPL
 1889:      05B7 D0 83          	POP	DPH		;GET THE HIGH BYTE
 1890:      05B9 22             	RET			;GO BACK
 1891:                          	;
 1892:                          	;**************************************
 1893:                          	;
 1894:                          	;L31DPI - LOAD R3 WITH (DPTR) AND R1 WI
 1895:                          	;
 1896:                          	;ACC GETS CLOBBERED
 1897:                          	;
 1898:                          	;**************************************
 1899:                          	;
 1900:      05BA E0             L31DPI: MOVX	A,@DPTR 	;GET THE HIGH BYTE
 1901:      05BB FB             	MOV	R3,A		;PUT IT IN THE REG
 1902:      05BC A3             	INC	DPTR		;BUMP THE POINTER
 1903:      05BD E0             	MOVX	A,@DPTR 	;GET THE NEXT BYTE
 1904:      05BE F9             	MOV	R1,A		;SAVE IT
 1905:      05BF 22             	RET
 1906:                          	;
 1907:                          	;**************************************
 1908:                          	;
 1909:                          	;DECDP - DECREMENT THE DATA POINTER - U
 1910:                          	;
 1911:                          	;**************************************
 1912:                          	;
 1913:      05C0 B1 C2          DECDP2: ACALL	DECDP

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 36



 Line    I  Addr Code           Source

 1914:                          	;
 1915:      05C2 C5 82          DECDP:	XCH	A,DPL		;GET DPL
 1916:      05C4 70 02          	JNZ	DECDP1		;BUMP IF ZERO
 1917:      05C6 15 83          	DEC	DPH
 1918:      05C8 14             DECDP1: DEC	A		;DECREMENT IT
 1919:      05C9 C5 82          	XCH	A,DPL		;GET A BACK
 1920:      05CB 22             	RET			;EXIT
 1921:                          	;
 1922:                          	;**************************************
 1923:                          	;
 1924:                          	;DCMPX - DOUBLE COMPARE - COMPARE (DPTR
 1925:                          	;R3:R1 - (DPTR) = SET CARRY FLAG
 1926:                          	;
 1927:                          	;IF R3:R1 > (DPTR) THEN C = 0
 1928:                          	;IF R3:R1 < (DPTR) THEN C = 1
 1929:                          	;IF R3:R1 = (DPTR) THEN C = 0
 1930:                          	;
 1931:                          	;**************************************
 1932:                          	;
 1933:      05CC C2 2A          DCMPX:	CLR	UBIT		;ASSUME NOT EQUAL
 1934:      05CE E0             	MOVX	A,@DPTR 	;GET THE BYTE
 1935:      05CF B5 03 0A       	CJNE	A,R3B0,D1	;IF A IS GREATER THAN R3
 1936:                          				;WHICH IS R3<@DPTR = NO CARRY AND
 1937:                          				;R3>@DPTR CARRY IS SET
 1938:      05D2 A3             	INC	DPTR		;BUMP THE DATA POINTER
 1939:      05D3 E0             	MOVX	A,@DPTR 	;GET THE BYTE
 1940:      05D4 B1 C2          	ACALL	DECDP		;PUT DPTR BACK
 1941:      05D6 B5 01 03       	CJNE	A,R1B0,D1	;DO THE COMPARE
 1942:      05D9 B3             	CPL	C		;FLIP CARRY
 1943:                          	;
 1944:      05DA B2 2A          	CPL	UBIT		;SET IT
 1945:      05DC B3             D1:	CPL	C		;GET THE CARRY RIGHT
 1946:      05DD 22             	RET			;EXIT
 1947:                          	;
 1948:                          	;**************************************
 1949:                          	;
 1950:                          	; ADDPTR - Add acc to the dptr
 1951:                          	;
 1952:                          	; acc gets wasted
 1953:                          	;
 1954:                          	;**************************************
 1955:                          	;
 1956:      05DE 25 82          ADDPTR: ADD	A,DPL		;ADD THE ACC TO DPL
 1957:      05E0 F5 82          	MOV	DPL,A		;PUT IT IN DPL
 1958:      05E2 50 02          	JNC	ADDPTR1 	;JUMP IF NO CARRY
 1959:      05E4 05 83          	INC	DPH		;BUMP DPH
 1960:      05E6 22             ADDPTR1:RET			;EXIT
 1961:                          	;
 1962:                          	;**************************************
 1963:                          	;
 1964:                          LCLR:	; Set up the storage allocation
 1965:                          	;
 1966:                          	;**************************************
 1967:                          	;
 1968:      05E7 D1 9A          	ACALL	ICLR		;CLEAR THE INTERRUPTS
 1969:      05E9 B1 A9          	ACALL	G4		;PUT END ADDRESS INTO DPTR

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 37



 Line    I  Addr Code           Source

 1970:      05EB 74 06          	MOV	A,#6		;ADJUST MATRIX SPACE
 1971:      05ED B1 DE          	ACALL	ADDPTR		;ADD FOR PROPER BOUNDS
 1972:      05EF B1 79          	ACALL	X31DP		;PUT MATRIX BOUNDS IN R3:R
 1973:      05F1 90 01 08       	MOV	DPTR,#MT_ALL	;SAVE R3:R1 IN MATRIX 
 1974:      05F4 D1 05          	ACALL	S31DP		;DPTR POINTS TO MEMTOP
 1975:      05F6 B1 BA          	ACALL	L31DPI		;LOAD MEMTOP INTO R3:R1
 1976:      05F8 90 01 22       	MOV	DPTR,#STR_AL	;GET MEMORY ALLOCATED 
 1977:      05FB B1 B0          	ACALL	LDPTRI
 1978:      05FD 12 0A 02       	CALL	DUBSUB		;R3:R1 = MEMTOP - STRING A
 1979:      0600 90 01 04       	MOV	DPTR,#VARTOP	;SAVE R3:R1 IN VARTOP
 1980:                          	;
 1981:                          	; FALL THRU TO S31DP2
 1982:                          	;
 1983:                          	;**************************************
 1984:                          	;
 1985:                          	;S31DP - STORE R3 INTO (DPTR) AND R1 IN
 1986:                          	;
 1987:                          	;ACC GETS CLOBBERED
 1988:                          	;
 1989:                          	;**************************************
 1990:                          	;
 1991:      0603 D1 05          S31DP2: ACALL	S31DP		;DO IT TWICE
 1992:                          	;
 1993:      0605 EB             S31DP:	MOV	A,R3		;GET R3 INTO ACC
 1994:      0606 F0             	MOVX	@DPTR,A 	;STORE IT
 1995:      0607 A3             	INC	DPTR		;BUMP DPTR
 1996:      0608 E9             	MOV	A,R1		;GET R1
 1997:      0609 F0             	MOVX	@DPTR,A 	;STORE IT
 1998:      060A A3             	INC	DPTR		;BUMP IT AGAIN TO SAVE PROGRA
 1999:      060B 22             	RET			;GO BACK
 2000:                          	;
 2001:                          	;
 2002:                          	;**************************************
 2003:                          	;
 2004:                          STRING: ; Allocate memory for strings
 2005:                          	;
 2006:                          	;**************************************
 2007:                          	;
 2008:      060C 12 0E 85       	LCALL	TWO		;R3:R1 = NUMBER, R2:R0 = LEN
 2009:      060F 90 01 22       	MOV	DPTR,#STR_AL	;SAVE STRING ALLOCATIO
 2010:      0612 D1 05          	ACALL	S31DP
 2011:      0614 0E             	INC	R6		;BUMP
 2012:      0615 8E 3F          	MOV	S_LEN,R6	;SAVE STRING LENGTH
 2013:      0617 C1 64          	AJMP	RCLEAR		;CLEAR AND SET IT UP
 2014:                          	;
 2015:                          	;**************************************
 2016:                          	;
 2017:                          	; F_VAR - Find	the variable in symbol t
 2018:                          	;	  R7:R6 contain the variable name
 2019:                          	;	  If not found create a zero entry an
 2020:                          	;	  R2:R0 has the address of variable o
 2021:                          	;
 2022:                          	;**************************************
 2023:                          	;
 2024:      0619 90 01 04       F_VAR:	MOV	DPTR,#VARTOP	;PUT VARTOP IN D
 2025:      061C B1 B0          	ACALL	LDPTRI

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 38



 Line    I  Addr Code           Source

 2026:      061E B1 C0          	ACALL	DECDP2		;ADJUST DPTR FOR LOOKUP
 2027:                          	;
 2028:      0620 E0             F_VAR0: MOVX	A,@DPTR 	;LOAD THE VARIABLE
 2029:      0621 60 20          	JZ	F_VAR2		;TEST IF AT THE END OF THE T
 2030:      0623 A3             	INC	DPTR		;BUMP FOR NEXT BYTE
 2031:      0624 B5 07 0F       	CJNE	A,R7B0,F_VAR1	;SEE IF MATCH
 2032:      0627 E0             	MOVX	A,@DPTR 	;LOAD THE NAME
 2033:      0628 B5 06 0B       	CJNE	A,R6B0,F_VAR1
 2034:                          	;
 2035:                          	; Found the variable now adjust and put
 2036:                          	;
 2037:      062B E5 82          DLD:	MOV	A,DPL		;R2:R0 = DPTR-2
 2038:      062D 94 02          	SUBB	A,#2
 2039:      062F F8             	MOV	R0,A
 2040:      0630 E5 83          	MOV	A,DPH
 2041:      0632 94 00          	SUBB	A,#0		;CARRY IS CLEARED
 2042:      0634 FA             	MOV	R2,A
 2043:      0635 22             	RET
 2044:                          	;
 2045:      0636 E5 82          F_VAR1: MOV	A,DPL		;SUBTRACT THE STACK S
 2046:      0638 C3             	CLR	C
 2047:      0639 94 09          	SUBB	A,#STESIZ
 2048:      063B F5 82          	MOV	DPL,A		;RESTORE DPL
 2049:      063D 50 E1          	JNC	F_VAR0
 2050:      063F 15 83          	DEC	DPH
 2051:      0641 80 DD          	SJMP	F_VAR0		;CONTINUE COMPARE
 2052:                          	;
 2053:                          	;
 2054:                          	; Add the entry to the symbol table
 2055:                          	;
 2056:      0643 12 0D EF       F_VAR2: LCALL	R76S		;SAVE R7 AND R6
 2057:      0646 C3             	CLR	C
 2058:      0647 D1 2B          	ACALL	DLD		;BUMP THE POINTER TO GET ENT
 2059:                          	;
 2060:                          	; Adjust pointer and save storage alloc
 2061:                          	; and make sure we aren't wiping anythi
 2062:                          	; First calculate new storage allocatio
 2063:                          	;
 2064:      0649 E8             	MOV	A,R0
 2065:      064A 94 06          	SUBB	A,#STESIZ-3	;NEED THIS MUCH RAM
 2066:      064C F9             	MOV	R1,A
 2067:      064D EA             	MOV	A,R2
 2068:      064E 94 00          	SUBB	A,#0
 2069:      0650 FB             	MOV	R3,A
 2070:                          	;
 2071:                          	; Now save the new storage allocation
 2072:                          	;
 2073:      0651 90 01 06       	MOV	DPTR,#ST_ALL
 2074:      0654 D1 05          	CALL	S31DP		;SAVE STORAGE ALLOCATION
 2075:                          	;
 2076:                          	; Now make sure we didn't blow it, by w
 2077:                          	;
 2078:      0656 B1 CC          	ACALL	DCMPX		;COMPARE STORAGE ALLOCATIO
 2079:      0658 40 32          	JC	CCLR3		;ERROR IF CARRY
 2080:      065A D3             	SETB	C		;DID NOT FIND ENTRY
 2081:      065B 22             	RET			;EXIT IF TEST IS OK

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 39



 Line    I  Addr Code           Source

 2082:                          	;
 2083:                          	;**************************************
 2084:                          	;
 2085:                          	; Command action routine - NEW
 2086:                          	;
 2087:                          	;**************************************
 2088:                          	;
 2089:      065C 90 02 00       CNEW:	MOV	DPTR,#PSTART	;SAVE THE START O
 2090:      065F 74 01          	MOV	A,#EOF		;END OF FILE
 2091:      0661 F0             	MOVX	@DPTR,A 	;PUT IT IN MEMORY
 2092:                          	;
 2093:                          	; falls thru
 2094:                          	;
 2095:                          	;**************************************
 2096:                          	;
 2097:                          	; The statement action routine - CLEAR
 2098:                          	;
 2099:                          	;**************************************
 2100:                          	;
 2101:      0662 C2 15          CNEW1:	CLR	LINEB		;SET UP FOR RUN AND GO
 2102:                          	;
 2103:      0664 B1 E7          RCLEAR: ACALL	LCLR		;CLEAR THE INTERRUPT
 2104:      0666 90 01 0A       	MOV	DPTR,#MEMTOP	;PUT MEMTOP IN R3:R1
 2105:      0669 B1 BA          	ACALL	L31DPI
 2106:      066B B1 A9          	ACALL	G4		;DPTR GETS END ADDRESS
 2107:      066D D1 7D          	ACALL	CL_1		;CLEAR THE MEMORY
 2108:                          	;
 2109:      066F 90 00 FE       RC1:	MOV	DPTR,#STACKTP	;POINT AT CONTROL
 2110:      0672 E4             	CLR	A		;CONTROL UNDERFLOW
 2111:                          	;
 2112:      0673 F0             RC2:	MOVX	@DPTR,A 	;SAVE IN MEMORY
 2113:      0674 75 11 FE       	MOV	CSTKA,#STACKTP
 2114:      0677 75 09 FE       	MOV	ASTKA,#STACKTP
 2115:      067A C2 17          	CLR	CONB		;CAN'T CONTINUE
 2116:      067C 22             	RET
 2117:                          	;
 2118:                          	;**************************************
 2119:                          	;
 2120:                          	; Loop until the memory is cleared
 2121:                          	;
 2122:                          	;**************************************
 2123:                          	;
 2124:      067D A3             CL_1:	INC	DPTR		;BUMP MEMORY POINTER
 2125:      067E E4             	CLR	A		;CLEAR THE MEMORY
 2126:      067F F0             	MOVX	@DPTR,A 	;CLEAR THE RAM
 2127:      0680 E0             	MOVX	A,@DPTR 	;READ IT
 2128:      0681 70 09          	JNZ	CCLR3		;MAKE SURE IT IS CLEARED
 2129:      0683 EB             	MOV	A,R3		;GET POINTER FOR COMPARE
 2130:      0684 B5 83 F6       	CJNE	A,DPH,CL_1	;SEE TO LOOP
 2131:      0687 E9             	MOV	A,R1		;NOW TEST LOW BYTE
 2132:      0688 B5 82 F2       	CJNE	A,DPL,CL_1
 2133:                          	;
 2134:      068B 22             CL_2:	RET
 2135:                          	;
 2136:      068C 02 15 B5       CCLR3:	JMP	TB		;ALLOCATED MEMORY DOESN'T
 2137:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 40



 Line    I  Addr Code           Source

 2138:                          	;**************************************
 2139:                          	;
 2140:                          SCLR:	;Entry point for clear return
 2141:                          	;
 2142:                          	;**************************************
 2143:                          	;
 2144:      068F 12 0E E1       	CALL	DELTST		;TEST FOR A CR
 2145:      0692 50 D0          	JNC	RCLEAR
 2146:      0694 12 0E D7       	CALL	GCI1		;BUMP THE TEST POINTER
 2147:      0697 B4 49 D5       	CJNE	A,#'I',RC1      ;SEE IF I, ELSE RE
 2148:                          	;
 2149:                          	;**************************************
 2150:                          	;
 2151:                          ICLR:	; Clear interrupts and system garb
 2152:                          	;
 2153:                          	;**************************************
 2154:                          	;
 2155:      069A 30 12 02       	JNB	INTBIT,ICLR1	;SEE IF BASIC HAS INTE
 2156:      069D C2 AA          	CLR	EX1		;IF SO, CLEAR INTERRUPTS
 2157:      069F 53 22 20       ICLR1:	ANL	34,#00100000B	;SET INTERRUPTS
 2158:      06A2 32             	RETI
 2159:                          	;
 2160:                          	;**************************************
 2161:                          	;
 2162:                          	;OUTPUT ROUTINES
 2163:                          	;
 2164:                          	;**************************************
 2165:                          	;
 2166:      06A3 D1 A5          CRLF2:	ACALL	CRLF		;DO TWO CRLF'S
 2167:                          	;
 2168:      06A5 7D 0D          CRLF:	MOV	R5,#CR		;LOAD THE CR
 2169:      06A7 F1 11          	ACALL	TEROT		;CALL TERMINAL OUT
 2170:      06A9 7D 0A          	MOV	R5,#LF		;LOAD THE LF
 2171:      06AB E1 11          	AJMP	TEROT		;OUTPUT IT AND RETURN
 2172:                          	;
 2173:                          	;PRINT THE MESSAGE ADDRESSED IN ROM OR 
 2174:                          	;ENDS WITH THE CHARACTER IN R4
 2175:                          	;DPTR HAS THE ADDRESS OF THE TERMINATOR
 2176:                          	;
 2177:      06AD D1 A5          CRP:	ACALL	CRLF		;DO A CR THEN PRINT ROM
 2178:                          	;
 2179:      06AF E4             ROM_P:	CLR	A		;CLEAR A FOR LOOKUP
 2180:      06B0 93             	MOVC	A,@A+DPTR	;GET THE CHARACTER
 2181:      06B1 C2 E7          	CLR	ACC.7		;CLEAR MS BIT
 2182:      06B3 B4 22 01       	CJNE	A,#'"',ROM_P1   ;EXIT IF TERMINATO
 2183:      06B6 22             	RET
 2184:      06B7 D2 34          ROM_P1: SETB	C0ORX1
 2185:                          	;
 2186:      06B9 FD             PN1:	MOV	R5,A		;OUTPUT THE CHARACTER
 2187:      06BA F1 11          	ACALL	TEROT
 2188:      06BC A3             	INC	DPTR		;BUMP THE POINTER
 2189:      06BD 80 04          	SJMP	PN0
 2190:                          	;
 2191:      06BF B1 79          UPRNT:	ACALL	X31DP
 2192:                          	;
 2193:      06C1 7C 0D          PRNTCR: MOV	R4,#CR		;OUTPUT UNTIL A CR

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 41



 Line    I  Addr Code           Source

 2194:                          	;
 2195:      06C3 10 34 E9       PN0:	JBC	C0ORX1,ROM_P
 2196:      06C6 E0             	MOVX	A,@DPTR 	;GET THE RAM BYTE
 2197:      06C7 60 03          	JZ	PN01
 2198:      06C9 B5 04 01       	CJNE	A,R4B0,PN02	;SEE IF THE SAME AS TE
 2199:      06CC 22             PN01:	RET			;EXIT IF THE SAME
 2200:      06CD B4 0D E9       PN02:	CJNE	A,#CR,PN1	;NEVER PRINT A CR I
 2201:      06D0 02 18 85       	LJMP	E1XX		;BAD SYNTAX
 2202:                          	;
 2203:                          	;**************************************
 2204:                          	;
 2205:                          	; INLINE - Input a line to IBUF, exit w
 2206:                          	;
 2207:                          	;**************************************
 2208:                          	;
 2209:      06D3 B4 04 16       INL2:	CJNE	A,#CNTRLD,INL2B ;SEE IF A CON
 2210:                          	;
 2211:      06D6 D1 A5          INL0:	ACALL	CRLF		;DO A CR
 2212:                          	;
 2213:      06D8 75 A0 00       INLINE: MOV	P2,#HIGH IBUF	;IBUF IS IN TH
 2214:      06DB 78 07          	MOV	R0,#LOW IBUF	;POINT AT THE INPUT BU
 2215:                          	;
 2216:      06DD F1 91          INL1:	ACALL	INCHAR		;GET A CHARACTER
 2217:      06DF FD             	MOV	R5,A		;SAVE IN R5 FOR OUTPUT
 2218:      06E0 B4 7F F0       	CJNE	A,#7FH,INL2	;SEE IF A DELETE CHARA
 2219:      06E3 B8 07 18       	CJNE	R0,#LOW IBUF,INL6
 2220:      06E6 7D 07          INL11:	MOV	R5,#BELL	;OUTPUT A BELL
 2221:                          	;
 2222:      06E8 F1 11          INLX:	ACALL	TEROT		;OUTPUT CHARACTER
 2223:      06EA 80 F1          	SJMP	INL1		;DO IT AGAIN
 2224:                          	;
 2225:      06EC F2             INL2B:	MOVX	@R0,A		;SAVE THE CHARACTER
 2226:      06ED B4 0D 02       	CJNE	A,#CR,INL2B1	;IS IT A CR
 2227:      06F0 C1 A5          	AJMP	CRLF		;OUTPUT A CRLF AND EXIT
 2228:      06F2 B4 20 00       INL2B1: CJNE	A,#20H,INL2B2
 2229:      06F5 40 F1          INL2B2: JC	INLX		;ONLY ECHO CONTROL CHAR
 2230:      06F7 08             	INC	R0		;BUMP THE POINTER
 2231:      06F8 B8 56 ED       	CJNE	R0,#IBUF+79,INLX
 2232:      06FB 18             	DEC	R0		;FORCE 79
 2233:      06FC 80 E8          	SJMP	INL11		;OUTPUT A BELL
 2234:                          	;
 2235:      06FE 18             INL6:	DEC	R0		;DEC THE RAM POINTER
 2236:      06FF 7D 08          	MOV	R5,#BS		;OUTPUT A BACK SPACE
 2237:      0701 F1 11          	ACALL	TEROT
 2238:      0703 F1 0F          	ACALL	STEROT		;OUTPUT A SPACE
 2239:      0705 7D 08          	MOV	R5,#BS		;ANOTHER BACK SPACE
 2240:      0707 80 DF          	SJMP	INLX		;OUTPUT IT
 2241:                          ;
 2242:                          ;***************************************
 2243:                          ;****** Use XTAL up to 47 MHz **********
 2244:                          ;****** Wulf 2 *************************
 2245:                          ;
 2246:                          ;PTIME: DB	128-2		;PROM PROGRAMMER TIMER
 2247:                          ;	DB	00H
 2248:                          ;	DB	00H
 2249:                          ;	DB	50H

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 42



 Line    I  Addr Code           Source

 2250:                          ;	DB	67H
 2251:                          ;	DB	41H
 2252:                          ;
 2253:      0709 7D             ptime:	db	128-3		;New programmer timer v
 2254:      070A 00             	db	00H		;divide by 5
 2255:      070B 00             	db	00H		;(50ms EPROM timeing to 10ms fo
 2256:      070C 00             	db	00H
 2257:      070D 35             	db	35H
 2258:      070E 83             	db	83H
 2259:                          ;
 2260:                          ;***************************************
 2261:                          ;
 2262:                          	;**************************************
 2263:                          	;
 2264:                          	; TEROT - Output a character to the sys
 2265:                          	;	  update PHEAD position.
 2266:                          	;
 2267:                          	;**************************************
 2268:                          	;
 2269:      070F 7D 20          STEROT: MOV	R5,#' '         ;OUTPUT A SP
 2270:                          	;
 2271:      0711 C0 E0          TEROT:	PUSH	ACC		;SAVE THE ACCUMULATOR
 2272:      0713 C0 83          	PUSH	DPH		;SAVE THE DPTR
 2273:      0715 C0 82          	PUSH	DPL
 2274:      0717 30 35 04       TEROT01:JNB	CNT_S,TEROT02	;WAIT FOR A CO
 2275:      071A F1 8D          	ACALL	BCK		;GET SERIAL STATUS
 2276:      071C 80 F9          	SJMP	TEROT01
 2277:      071E ED             TEROT02:MOV	A,R5		;PUT OUTPUT BYTE IN A
 2278:      071F 30 2C 05       	JNB	BO,TEROT03	;CHECK FOR MONITOR
 2279:      0722 12 20 40       	LCALL	2040H		;DO THE MONITOR
 2280:      0725 E1 66          	AJMP	TEROT1		;CLEAN UP
 2281:      0727 30 1C 05       TEROT03:JNB	COUB,TEROT04	;SEE IF USER WA
 2282:      072A 12 40 30       	LCALL	4030H
 2283:      072D E1 66          	AJMP	TEROT1
 2284:      072F 30 27 08       TEROT04:JNB	UPB,T_1 	;NO AT IF NO XBIT
 2285:      0732 30 19 05       	JNB	LPB,T_1 	;AT PRINT
 2286:      0735 12 40 3C       	LCALL	403CH		;CALL AT LOCATION
 2287:      0738 E1 66          	AJMP	TEROT1		;FINISH OFF OUTPUT
 2288:                          	;
 2289:      073A 30 1B 22       T_1:	JNB	COB,TXX 	;SEE IF LIST SET
 2290:      073D 90 01 24       	MOV	DPTR,#SPV	;LOAD BAUD RATE
 2291:      0740 B1 82          	ACALL	LD_T
 2292:      0742 C2 97          	CLR	LP		;OUTPUT START BIT
 2293:      0744 B1 2D          	ACALL	TIMER_LOAD	;LOAD AND START THE TI
 2294:      0746 ED             	MOV	A,R5		;GET THE OUTPUT BYTE
 2295:      0747 D3             	SETB	C		;SET CARRY FOR LAST OUTPUT
 2296:      0748 7D 09          	MOV	R5,#9		;LOAD TIMER COUNTDOWN
 2297:                          	;
 2298:      074A 13             LTOUT1: RRC	A		;ROTATE A
 2299:      074B 30 8F FD       	JNB	TF1,$		;WAIT TILL TIMER READY
 2300:      074E 92 97          	MOV	LP,C		;OUTPUT THE BIT
 2301:      0750 B1 2D          	ACALL	TIMER_LOAD	;DO THE NEXT BIT
 2302:      0752 DD F6          	DJNZ	R5,LTOUT1	;LOOP UNTIL DONE
 2303:      0754 30 8F FD       	JNB	TF1,$		;FIRST STOP BIT
 2304:      0757 B1 2D          	ACALL	TIMER_LOAD
 2305:      0759 30 8F FD       	JNB	TF1,$		;SECOND STOP BIT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 43



 Line    I  Addr Code           Source

 2306:      075C FD             	MOV	R5,A		;RESTORE R5
 2307:      075D 80 07          	SJMP	TEROT1		;BACK TO TEROT
 2308:                          	;
 2309:      075F 30 99 FD       TXX:	JNB	TI,$		;WAIT FOR TRANSMIT READY
 2310:      0762 C2 99          	CLR	TI
 2311:      0764 8D 99          	MOV	SBUF,R5 	;SEND OUT THE CHARACTER
 2312:                          	;
 2313:      0766 BD 0D 03       TEROT1: CJNE	R5,#CR,TEROT11	;SEE IF A CR
 2314:      0769 75 16 00       	MOV	PHEAD,#00H	;IF A CR, RESET PHEAD AN
 2315:                          	;
 2316:      076C BD 0A 0B       TEROT11:CJNE	R5,#LF,NLC	;SEE IF A LF
 2317:      076F E5 15          	MOV	A,NULLCT	;GET THE NULL COUNT
 2318:      0771 60 07          	JZ	NLC		;NO NULLS IF ZERO
 2319:                          	;
 2320:      0773 7D 00          TEROT2: MOV	R5,#NULL	;PUT THE NULL IN TH
 2321:      0775 F1 11          	ACALL	TEROT		;OUTPUT THE NULL
 2322:      0777 14             	DEC	A		;DECREMENT NULL COUNT
 2323:      0778 70 F9          	JNZ	TEROT2		;LOOP UNTIL DONE
 2324:                          	;
 2325:      077A BD 08 02       NLC:	CJNE	R5,#BS,NLC1	;DEC PHEAD IF A BA
 2326:      077D 15 16          	DEC	PHEAD
 2327:      077F BD 20 00       NLC1:	CJNE	R5,#20H,NLC2	;IS IT A PRINTAB
 2328:      0782 40 02          NLC2:	JC	NLC3		;DON'T INCREMENT PHEAD IF
 2329:      0784 05 16          	INC	PHEAD		;BUMP PRINT HEAD
 2330:      0786 D0 82          NLC3:	POP	DPL		;RESTORE DPTR
 2331:      0788 D0 83          	POP	DPH
 2332:      078A D0 E0          	POP	ACC		;RESTORE ACC
 2333:      078C 22             	RET			;EXIT
 2334:                          	;
 2335:      078D F1 C8          BCK:	ACALL	CSTS		;CHECK STATUS
 2336:      078F 50 2E          	JNC	CI_RET1 	;EXIT IF NO CHARACTER
 2337:                          	;
 2338:                          	;**************************************
 2339:                          	;
 2340:                          	;INPUTS A CHARACTER FROM THE SYSTEM CON
 2341:                          	;
 2342:                          	;**************************************
 2343:                          	;
 2344:      0791 30 32 05       INCHAR: JNB	BI,INCHAR1	;CHECK FOR MONITO
 2345:      0794 12 20 60       	LCALL	2060H
 2346:      0797 80 11          	SJMP	INCH1
 2347:      0799 30 1E 05       INCHAR1:JNB	CIUB,INCHAR2	;CHECK FOR USER
 2348:      079C 12 40 33       	LCALL	4033H
 2349:      079F 80 09          	SJMP	INCH1
 2350:      07A1 30 98 FD       INCHAR2:JNB	RI,$		;WAIT FOR RECEIVER REA
 2351:      07A4 E5 99          	MOV	A,SBUF
 2352:      07A6 C2 98          	CLR	RI		;RESET READY
 2353:      07A8 C2 E7          	CLR	ACC.7		;NO BIT 7
 2354:                          	;
 2355:      07AA B4 13 02       INCH1:	CJNE	A,#13H,INCH11
 2356:      07AD D2 35          	SETB	CNT_S
 2357:      07AF B4 11 02       INCH11: CJNE	A,#11H,INCH12
 2358:      07B2 C2 35          	CLR	CNT_S
 2359:      07B4 B4 03 04       INCH12: CJNE	A,#CNTRLC,INCH13
 2360:      07B7 30 30 1D       	JNB	NO_C,C_EX	;TRAP NO CONTROL C
 2361:      07BA 22             	RET

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 44



 Line    I  Addr Code           Source

 2362:                          	;
 2363:                          ;
 2364:                          ;***************************************
 2365:                          ;****** Sorry - but the ego message had 
 2366:                          ;
 2367:                          INCH13:
 2368:                          ;	CLR	JKBIT
 2369:      07BB B4 17 00       	CJNE	A,#17H,CI_RET	;CONTROL W
 2370:                          ;	SETB	JKBIT
 2371:                          ;
 2372:                          ;***************************************
 2373:                          	;
 2374:      07BE D3             CI_RET: SETB	C		;CARRY SET IF A CHARACTE
 2375:      07BF 22             CI_RET1:RET			;EXIT
 2376:                          	;
 2377:                          	;**************************************
 2378:                          	;
 2379:                          	;RROM - The Statement Action Routine RR
 2380:                          	;
 2381:                          	;**************************************
 2382:                          	;
 2383:      07C0 D2 1D          RROM:	SETB	INBIT		;SO NO ERRORS
 2384:      07C2 B1 43          	ACALL	RO1		;FIND THE LINE NUMBER
 2385:      07C4 10 1D 3B       	JBC	INBIT,CRUN
 2386:      07C7 22             	RET			;EXIT
 2387:                          	;
 2388:                          	;**************************************
 2389:                          	;
 2390:                          CSTS:	;	RETURNS CARRY = 1 IF THERE IS A 
 2391:                          	;	THE SYSTEM CONSOLE. IF NO CHARACTER T
 2392:                          	;	WILL BE CLEARED
 2393:                          	;
 2394:                          	;**************************************
 2395:                          	;
 2396:      07C8 30 32 03       	JNB	BI,CSTS1	;BUBBLE STATUS
 2397:      07CB 02 20 68       	LJMP	2068H
 2398:      07CE 30 1E 03       CSTS1:	JNB	CIUB,CSTS2	;SEE IF EXTERNAL C
 2399:      07D1 02 40 36       	LJMP	4036H
 2400:      07D4 A2 98          CSTS2:	MOV	C,RI
 2401:      07D6 22             	RET
 2402:                          	;
 2403:                          ;
 2404:                          ;***************************************
 2405:                          ;****** Sorry - but the ego message had 
 2406:                          ;
 2407:                          ;C_EX0:  MOV	 DPTR,#WB	 ;EGO MESSAGE
 2408:                          ;	 ACALL	 ROM_P
 2409:                          ;
 2410:                          ;***************************************
 2411:                          	;
 2412:      07D7 C2 35          C_EX:	CLR	CNT_S		;NO OUTPUT STOP
 2413:      07D9 12 0C 31       	LCALL	SPRINT1 	;ASSURE CONSOLE
 2414:      07DC D1 A5          	ACALL	CRLF
 2415:                          ;
 2416:                          ;***************************************
 2417:                          ;****** Sorry - but the ego message had 

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 45



 Line    I  Addr Code           Source

 2418:                          ;
 2419:                          ;	 JBC	 JKBIT,C_EX0
 2420:                          ;
 2421:                          ;***************************************
 2422:                          ;
 2423:      07DE 30 2F 7F       	JNB	DIRF,SSTOP0
 2424:      07E1 A1 40          	AJMP	C_K		;CLEAR COB AND EXIT
 2425:                          	;
 2426:      07E3 E5 48          T_CMP:	MOV	A,TVH		;COMPARE TIMER TO SP_H
 2427:      07E5 A9 49          	MOV	R1,TVL
 2428:      07E7 B5 48 F9       	CJNE	A,TVH,T_CMP
 2429:      07EA C9             	XCH	A,R1
 2430:      07EB 95 4C          	SUBB	A,SP_L
 2431:      07ED E9             	MOV	A,R1
 2432:      07EE 95 4B          	SUBB	A,SP_H
 2433:      07F0 22             	RET
 2434:                          	;
 2435:                          	;**************************************
 2436:                          	;
 2437:                          BR0:	; Trap the timer interrupt
 2438:                          	;
 2439:                          	;**************************************
 2440:                          	;
 2441:      07F1 F1 E3          	CALL	T_CMP		;COMPARE TIMER
 2442:      07F3 40 40          	JC	BCHR1		;EXIT IF TEST FAILS
 2443:      07F5 D2 14          	SETB	OTI		;DOING THE TIMER INTERRUPT
 2444:      07F7 C2 10          	CLR	OTS		;CLEAR TIMER BIT
 2445:      07F9 A2 11          	MOV	C,INPROG	;SAVE IN PROGRESS
 2446:      07FB 92 2B          	MOV	ISAV,C
 2447:      07FD 90 01 26       	MOV	DPTR,#TIV
 2448:      0800 80 3C          	SJMP	BR2
 2449:                          	;
 2450:                          	;**************************************
 2451:                          	;
 2452:                          	; The command action routine - RUN
 2453:                          	;
 2454:                          	;**************************************
 2455:                          	;
 2456:      0802 12 06 62       CRUN:	LCALL	CNEW1		;CLEAR THE STORAGE AR
 2457:      0805 71 D0          	ACALL	SRESTR1 	;GET THE STARTING ADDRES
 2458:      0807 51 A4          	ACALL	B_C
 2459:      0809 60 4A          	JZ	CMNDLK		;IF NULL GO TO COMMAND MODE
 2460:                          	;
 2461:      080B D1 B8          	ACALL	T_DP
 2462:      080D F1 23          	ACALL	B_TXA		;BUMP TO STARTING LINE
 2463:                          	;
 2464:      080F 91 3C          CILOOP: ACALL	SP0		;DO A CR AND A LF
 2465:      0811 C2 2F          CILOOP1:CLR	DIRF		;NOT IN DIRECT MODE
 2466:                          	;
 2467:                          	;INTERPERTER DRIVER
 2468:                          	;
 2469:      0813 85 3E 81       ILOOP:	MOV	SP,SPSAV	;RESTORE THE STACK E
 2470:      0816 20 2F 06       	JB	DIRF,ILOOP1	;NO INTERRUPTS IF IN DIR
 2471:      0819 85 0A 42       	MOV	INTXAH,TXAH	;SAVE THE TEXT POINTER
 2472:      081C 85 08 43       	MOV	INTXAL,TXAL
 2473:      081F 12 07 8D       ILOOP1: LCALL	BCK		;GET CONSOLE STATUS

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 46



 Line    I  Addr Code           Source

 2474:      0822 20 2F 24       	JB	DIRF,I_L	;DIRECT MODE
 2475:      0825 B0 18          	ANL	C,/GTRD 	;SEE IF CHARACTER READY
 2476:      0827 50 06          	JNC	BCHR		;NO CHARACTER = NO CARRY
 2477:                          	;
 2478:                          	; DO TRAP OPERATION
 2479:                          	;
 2480:      0829 90 01 00       	MOV	DPTR,#GTB	;SAVE TRAP CHARACTER
 2481:      082C F0             	MOVX	@DPTR,A
 2482:      082D D2 18          	SETB	GTRD		;SAYS READ A BYTE
 2483:                          	;
 2484:      082F 20 14 17       BCHR:	JB	OTI,I_L 	;EXIT IF TIMER INTERRU
 2485:      0832 20 10 BC       	JB	OTS,BR0 	;TEST TIMER VALUE IF SET
 2486:      0835 30 16 11       BCHR1:	JNB	INTPEN,I_L	;SEE IF INTERRUPT 
 2487:      0838 20 11 0E       	JB	INPROG,I_L	;DON'T DO IT AGAIN IF IN 
 2488:      083B 90 01 20       	MOV	DPTR,#INTLOC	;POINT AT INTERRUPT LO
 2489:                          	;
 2490:      083E 7C 02          BR2:	MOV	R4,#GTYPE	;SETUP FOR A FORCED G
 2491:      0840 71 35          	ACALL	SGS1		;PUT TXA ON STACK
 2492:      0842 D2 11          	SETB	INPROG		;INTERRUPT IN PROGRESS
 2493:                          	;
 2494:      0844 12 05 73       ERL4:	CALL	L20DPI
 2495:      0847 41 F8          	AJMP	D_L1		;GET THE LINE NUMBER
 2496:                          	;
 2497:      0849 11 F8          I_L:	ACALL	ISTAT		;LOOP
 2498:      084B F1 17          	ACALL	CLN_UP		;FINISH IT OFF
 2499:      084D 50 C4          	JNC	ILOOP		;LOOP ON THE DRIVER
 2500:      084F 30 2F 03       	JNB	DIRF,CMNDLK	;CMND1 IF IN RUN MODE
 2501:      0852 02 17 94       	LJMP	CMNDR		;DON'T PRINT READY
 2502:                          	;
 2503:      0855 02 17 87       CMNDLK: JMP	CMND1		;DONE
 2504:                          	;**************************************
 2505:                          	;
 2506:                          	; The Statement Action Routine - STOP
 2507:                          	;
 2508:                          	;**************************************
 2509:                          	;
 2510:      0858 F1 17          SSTOP:	ACALL	CLN_UP		;FINISH OFF THIS LI
 2511:      085A 85 0A 42       	MOV	INTXAH,TXAH	;SAVE TEXT POINTER FOR 
 2512:      085D 85 08 43       	MOV	INTXAL,TXAL
 2513:                          	;
 2514:      0860 D2 17          SSTOP0: SETB	CONB		;CONTINUE WILL WORK
 2515:      0862 90 00 EE       	MOV	DPTR,#STP	;PRINT THE STOP MESSAGE
 2516:      0865 D2 20          	SETB	STOPBIT 	;SET FOR ERROR ROUTINE
 2517:      0867 02 18 AD       	JMP	ERRS		;JUMP TO ERROR ROUTINE
 2518:                          	;
 2519:                          	;**************************************
 2520:                          	;
 2521:                          	; ITRAP - Trap special function registe
 2522:                          	;
 2523:                          	;**************************************
 2524:                          	;
 2525:      086A B4 C8 05       ITRAP:	CJNE	A,#TMR0,ITRAP1	;TIMER 0
 2526:      086D 8B 8C          	MOV	TH0,R3
 2527:      086F 89 8A          	MOV	TL0,R1
 2528:      0871 22             	RET
 2529:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 47



 Line    I  Addr Code           Source

 2530:      0872 B4 C9 05       ITRAP1: CJNE	A,#TMR1,ITRAP2	;TIMER 1
 2531:      0875 8B 8D          	MOV	TH1,R3
 2532:      0877 89 8B          	MOV	TL1,R1
 2533:      0879 22             	RET
 2534:                          	;
 2535:      087A B4 CA 05       ITRAP2: CJNE	A,#TMR2,ITRAP3	;TIMER 2
 2536:      087D 8B CD          ITRAP21:MOV	TH2,R3
 2537:      087F 89 CC          	MOV	TL2,R1
 2538:                          ;	DB	8BH		;MOV R3 DIRECT OP CODE
 2539:                          ;	DB	0CDH		;T2H LOCATION
 2540:                          ;	DB	89H		;MOV R1 DIRECT OP CODE
 2541:                          ;	DB	0CCH		;T2L LOCATION
 2542:      0881 22             	RET
 2543:                          	;
 2544:      0882 B4 CE 05       ITRAP3: CJNE	A,#TRC2,RCL1	;RCAP2 TOKEN
 2545:      0885 8B CB          RCL:	MOV	RCAPH2,R3
 2546:      0887 89 CA          	MOV	RCAPL2,R1
 2547:                          ;	DB	8BH		;MOV R3 DIRECT OP CODE
 2548:                          ;	DB	0CBH		;RCAP2H LOCATION
 2549:                          ;	DB	89H		;MOV R1 DIRECT OP CODE
 2550:                          ;	DB	0CAH		;RCAP2L LOCATION
 2551:      0889 22             	RET
 2552:                          	;
 2553:      088A 31 D5          RCL1:	ACALL	R3CK		;MAKE SURE THAT R3 IS 
 2554:      088C B4 CB 03       	CJNE	A,#TT2C,RCL2
 2555:      088F 89 C8          	MOV	T2CON,R1
 2556:                          ;	DB	89H		;MOV R1 DIRECT OP CODE
 2557:                          ;	DB	0C8H		;T2CON LOCATION
 2558:      0891 22             	RET
 2559:                          	;
 2560:      0892 B4 C6 03       RCL2:	CJNE	A,#T_IE,RCL3	;IE TOKEN
 2561:      0895 89 A8          	MOV	IE,R1
 2562:      0897 22             	RET
 2563:                          	;
 2564:      0898 B4 C7 03       RCL3:	CJNE	A,#T_IP,RCL4	;IP TOKEN
 2565:      089B 89 B8          	MOV	IP,R1
 2566:      089D 22             	RET
 2567:                          	;
 2568:      089E B4 CC 03       RCL4:	CJNE	A,#TTC,RCL5	;TCON TOKEN
 2569:      08A1 89 88          	MOV	TCON,R1
 2570:      08A3 22             	RET
 2571:                          	;
 2572:      08A4 B4 CD 03       RCL5:	CJNE	A,#TTM,RCL6	;TMOD TOKEN
 2573:      08A7 89 89          	MOV	TMOD,R1
 2574:      08A9 22             	RET
 2575:                          	;
 2576:      08AA B4 CF 32       RCL6:	CJNE	A,#T_P1,T_T2	;P1 TOKEN
 2577:      08AD 89 90          	MOV	P1,R1
 2578:      08AF 22             	RET
 2579:                          	;
 2580:                          	;**************************************
 2581:                          	;
 2582:                          	; T_TRAP - Trap special operators
 2583:                          	;
 2584:                          	;**************************************
 2585:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 48



 Line    I  Addr Code           Source

 2586:      08B0 F5 0F          T_T:	MOV	TEMP5,A 	;SAVE THE TOKEN
 2587:      08B2 D1 D7          	ACALL	GCI1		;BUMP POINTER
 2588:      08B4 31 C8          	ACALL	SLET2		;EVALUATE AFTER =
 2589:      08B6 E5 0F          	MOV	A,TEMP5 	;GET THE TOKEN BACK
 2590:      08B8 B4 C3 03       	CJNE	A,#T_XTAL,T_T01
 2591:      08BB 02 16 5C       	LJMP	AXTAL1		;SET UP CRYSTAL
 2592:                          	;
 2593:      08BE D1 90          T_T01:	ACALL	IFIXL		;R3:R1 HAS THE TOS
 2594:      08C0 E5 0F          	MOV	A,TEMP5 	;GET THE TOKEN AGAIN
 2595:      08C2 B4 C4 09       	CJNE	A,#T_MTOP,T_T1	;SEE IF MTOP TOKEN
 2596:      08C5 90 01 0A       	MOV	DPTR,#MEMTOP
 2597:      08C8 12 06 05       	CALL	S31DP
 2598:      08CB 02 06 64       	JMP	RCLEAR		;CLEAR THE MEMORY
 2599:                          	;
 2600:      08CE B4 C5 99       T_T1:	CJNE	A,#T_TIME,ITRAP ;SEE IF A TIM
 2601:      08D1 A2 AF          	MOV	C,EA		;SAVE INTERRUPTS
 2602:      08D3 C2 AF          	CLR	EA		;NO TIMER 0 INTERRUPTS DURING L
 2603:      08D5 8B 48          	MOV	TVH,R3		;SAVE THE TIME
 2604:      08D7 89 49          	MOV	TVL,R1
 2605:                          ;
 2606:                          ;***************************************
 2607:                          ;****** Reset millisecond counter on "TI
 2608:                          ;****** Boehling 2 *********************
 2609:                          ;
 2610:      08D9 75 47 00       	mov	MILLIV,#0	;Reset millisecond counte
 2611:                          ;
 2612:                          ;***************************************
 2613:                          ;
 2614:      08DC 92 AF          	MOV	EA,C		;RESTORE INTERRUPTS
 2615:      08DE 22             	RET			;EXIT
 2616:                          	;
 2617:      08DF B4 D0 56       T_T2:	CJNE	A,#T_PC,INTERX	;PCON TOKEN
 2618:      08E2 89 87          	MOV	PCON,R1
 2619:                          ;	DB	89H		;MOV DIRECT, R1 OP CODE
 2620:                          ;	DB	87H		;ADDRESS OF PCON
 2621:      08E4 22             	RET			;EXIT
 2622:                          	;
 2623:      08E5 B4 D1 C8       T_TRAP: CJNE	A,#T_ASC,T_T	;SEE IF ASC TO
 2624:      08E8 D1 CB          	ACALL	IGC		;EAT IT AND GET THE NEXT CHA
 2625:      08EA B4 24 4B       	CJNE	A,#'$',INTERX   ;ERROR IF NOT A ST
 2626:      08ED 51 1E          	ACALL	CSY		;CALCULATE ADDRESS
 2627:      08EF B1 AD          	ACALL	X3120
 2628:      08F1 12 14 B4       	CALL	TWO_EY
 2629:      08F4 31 DD          	ACALL	SPEOP1		;EVALUATE AFTER EQUALS
 2630:      08F6 21 21          	AJMP	ISTAX1		;SAVE THE CHARACTER
 2631:                          	;
 2632:                          	;**************************************
 2633:                          	;
 2634:                          	;INTERPERT THE STATEMENT POINTED TO BY 
 2635:                          	;
 2636:                          	;**************************************
 2637:                          	;
 2638:      08F8 D1 CD          ISTAT:	ACALL	GC		;GET THR FIRST CHARACTE
 2639:      08FA 30 2D 0E       	JNB	XBIT,IAT	;TRAP TO EXTERNAL RUN PACK
 2640:      08FD B4 20 00       	CJNE	A,#20H,ISTAT1
 2641:      0900 50 09          ISTAT1: JNC	IAT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 49



 Line    I  Addr Code           Source

 2642:      0902 12 20 70       	LCALL	2070H		;LET THE USER SET UP THE D
 2643:      0905 D1 D7          	ACALL	GCI1
 2644:      0907 54 0F          	ANL	A,#0FH		;STRIP OFF BIAS
 2645:      0909 80 51          	SJMP	ISTA1
 2646:                          	;
 2647:      090B B4 C3 00       IAT:	CJNE	A,#T_XTAL,IAT1
 2648:      090E 50 D5          IAT1:	JNC	T_TRAP
 2649:      0910 30 E7 5B       	JNB	ACC.7,SLET	;IMPLIED LET IF BIT 7 NO
 2650:      0913 B4 BC 06       	CJNE	A,#T_UOP+12,ISTAX	;DBYTE TOKEN
 2651:      0916 31 D9          	ACALL	SPEOP		;EVALUATE SPECIAL OPERATOR
 2652:      0918 31 D5          	ACALL	R3CK		;CHECK LOCATION
 2653:      091A F7             	MOV	@R1,A		;SAVE IT
 2654:      091B 22             	RET
 2655:                          	;
 2656:      091C B4 BD 06       ISTAX:	CJNE	A,#T_UOP+13,ISTAY	;XBYTE TOK
 2657:      091F 31 D9          	ACALL	SPEOP
 2658:                          	;
 2659:      0921 8B A0          ISTAX1: MOV	P2,R3
 2660:      0923 F3             	MOVX	@R1,A
 2661:      0924 22             	RET
 2662:                          	;
 2663:      0925 B4 AB 00       ISTAY:	CJNE	A,#T_CR+1,ISTAY1;TRAP NEW OP
 2664:      0928 40 09          ISTAY1: JC	I_S
 2665:      092A B4 B0 00       	CJNE	A,#0B0H,ISTAY2	;SEE IF TOO BIG
 2666:      092D 50 09          ISTAY2: JNC	INTERX
 2667:      092F 24 F9          	ADD	A,#0F9H 	;BIAS FOR LOOKUP TABLE
 2668:      0931 80 1D          	SJMP	ISTA0		;DO THE OPERATION
 2669:                          	;
 2670:      0933 B4 A4 00       I_S:	CJNE	A,#T_LAST,I_S1	;MAKE SURE AN I
 2671:      0936 40 03          I_S1:	JC	INTERX1 	;ERROR IF NOT
 2672:                          	;
 2673:      0938 02 18 85       INTERX: LJMP	E1XX		;SYNTAX ERROR
 2674:                          	;
 2675:      093B 30 2F 12       INTERX1:JNB	DIRF,ISTA0	;EXECUTE ALL STAT
 2676:      093E B4 90 00       	CJNE	A,#T_DIR,INTERX2;SEE IF ON TOKEN
 2677:      0941 40 0D          INTERX2:JC	ISTA0		;OK IF DIRECT
 2678:      0943 B4 A0 02       	CJNE	A,#T_GOSB+1,INTERX3;SEE IF FOR
 2679:      0946 80 08          	SJMP	ISTA0		;FOR IS OK
 2680:      0948 B4 97 02       INTERX3:CJNE	A,#T_REM+1,INTERX4	;NEXT IS
 2681:      094B 80 03          	SJMP	ISTA0
 2682:      094D B4 96 E8       INTERX4:CJNE	A,#T_STOP+6,INTERX	;SO IS R
 2683:                          	;
 2684:      0950 D1 D7          ISTA0:	ACALL	GCI1		;ADVANCE THE TEXT POI
 2685:      0952 90 01 23       	MOV	DPTR,#STATD	;POINT DPTR TO LOOKUP T
 2686:      0955 B4 80 02       	CJNE	A,#T_GOTO-3,ISTA01;SEE IF LET TOKE
 2687:      0958 80 9E          	SJMP	ISTAT		;WASTE LET TOKEN
 2688:      095A 54 3F          ISTA01: ANL	A,#3FH		;STRIP OFF THE GARBA
 2689:                          	;
 2690:      095C 23             ISTA1:	RL	A		;ROTATE FOR OFFSET
 2691:      095D 25 82          	ADD	A,DPL		;BUMP
 2692:      095F F5 82          	MOV	DPL,A		;SAVE IT
 2693:      0961 E4             	CLR	A
 2694:      0962 93             	MOVC	A,@A+DPTR	;GET HIGH BYTE
 2695:      0963 C0 E0          	PUSH	ACC		;SAVE IT
 2696:      0965 A3             	INC	DPTR
 2697:      0966 E4             	CLR	A

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 50



 Line    I  Addr Code           Source

 2698:      0967 93             	MOVC	A,@A+DPTR	;GET LOW BYTE
 2699:      0968 D0 83          	POP	DPH
 2700:      096A F5 82          	MOV	DPL,A
 2701:                          	;
 2702:      096C E4             AC1:	CLR	A
 2703:      096D 73             	JMP	@A+DPTR 	;GO DO IT
 2704:                          	;
 2705:                          	;**************************************
 2706:                          	;
 2707:                          	; The statement action routine - LET
 2708:                          	;
 2709:                          	;**************************************
 2710:                          	;
 2711:      096E D1 BF          SLET:	ACALL	S_C		;CHECK FOR POSSIBLE STR
 2712:      0970 40 50          	JC	SLET0		;NO STRING
 2713:      0972 C2 15          	CLR	LINEB		;USED STRINGS
 2714:                          	;
 2715:      0974 12 05 79       	CALL	X31DP		;PUT ADDRESS IN DPTR
 2716:      0977 7F EA          	MOV	R7,#T_EQU	;WASTE =
 2717:      0979 91 E5          	ACALL	EATC
 2718:      097B D1 CD          	ACALL	GC		;GET THE NEXT CHARACTER
 2719:      097D B4 22 11       	CJNE	A,#'"',S_3      ;CHECK FOR A "
 2720:      0980 AF 3F          	MOV	R7,S_LEN	;GET THE STRING LENGTH
 2721:                          	;
 2722:      0982 D1 D7          S_0:	ACALL	GCI1		;BUMP PAST "
 2723:      0984 D1 E1          	ACALL	DELTST		;CHECK FOR DELIMITER
 2724:      0986 60 B0          	JZ	INTERX		;EXIT IF CARRIAGE RETURN
 2725:      0988 F0             	MOVX	@DPTR,A 	;SAVE THE CHARACTER
 2726:      0989 B4 22 26       	CJNE	A,#'"',S_1      ;SEE IF DONE
 2727:                          	;
 2728:      098C 74 0D          S_E:	MOV	A,#CR		;PUT A CR IN A
 2729:      098E F0             	MOVX	@DPTR,A 	;SAVE CR
 2730:      098F C1 D7          	AJMP	GCI1
 2731:                          	;
 2732:      0991 C0 83          S_3:	PUSH	DPH
 2733:      0993 C0 82          	PUSH	DPL		;SAVE DESTINATION
 2734:      0995 D1 BF          	ACALL	S_C		;CALCULATE SOURCE
 2735:      0997 40 9F          	JC	INTERX		;ERROR IF CARRY
 2736:      0999 D0 00          	POP	R0B0		;GET DESTINATION BACK
 2737:      099B D0 02          	POP	R2B0
 2738:                          	;
 2739:      099D AF 3F          SSOOP:	MOV	R7,S_LEN	;SET UP COUNTER
 2740:                          	;
 2741:      099F 12 15 96       S_4:	CALL	TBYTE		;TRANSFER THE BYTE
 2742:      09A2 B4 0D 01       	CJNE	A,#CR,S_41	;EXIT IF A CR
 2743:      09A5 22             	RET
 2744:      09A6 DF 05          S_41:	DJNZ	R7,S_5		;BUMP COUNTER
 2745:      09A8 74 0D          	MOV	A,#CR		;SAVE A CR
 2746:      09AA F2             	MOVX	@R0,A
 2747:      09AB C1 4E          	AJMP	EIGP		;PRINT EXTRA IGNORED
 2748:                          	;
 2749:                          	;
 2750:      09AD 12 15 76       S_5:	CALL	INC3210 	;BUMP POINTERS
 2751:      09B0 80 ED          	SJMP	S_4		;LOOP
 2752:                          	;
 2753:      09B2 DF 06          S_1:	DJNZ	R7,S_11 	;SEE IF DONE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 51



 Line    I  Addr Code           Source

 2754:      09B4 31 8C          	ACALL	S_E
 2755:      09B6 D1 4E          	ACALL	EIGP		;PRINT EXTRA IGNORED
 2756:      09B8 C1 EC          	AJMP	FINDCR		;GO FIND THE END
 2757:      09BA A3             S_11:	INC	DPTR		;BUMP THE STORE POINTER
 2758:      09BB 80 C5          	SJMP	S_0		;CONTINUE TO LOOP
 2759:                          	;
 2760:      09BD 90 18 28       E3XX:	MOV	DPTR,#E3X	;BAD ARG ERROR
 2761:      09C0 81 0E          	AJMP	EK
 2762:                          	;
 2763:      09C2 31 C6          SLET0:	ACALL	SLET1
 2764:      09C4 E1 D3          	AJMP	POPAS		;COPY EXPRESSION TO VARIABL
 2765:                          	;
 2766:      09C6 F1 01          SLET1:	ACALL	VAR_ER		;CHECK FOR A"VARIAB
 2767:                          	;
 2768:      09C8 C0 02          SLET2:	PUSH	R2B0		;SAVE THE VARIABLE ADD
 2769:      09CA C0 00          	PUSH	R0B0
 2770:      09CC 7F EA          	MOV	R7,#T_EQU	;GET EQUAL TOKEN
 2771:      09CE F1 41          	ACALL	WE
 2772:      09D0 D0 01          	POP	R1B0		;POP VARIABLE TO R3:R1
 2773:      09D2 D0 03          	POP	R3B0
 2774:      09D4 22             	RET			;EXIT
 2775:                          	;
 2776:      09D5 BB 00 E5       R3CK:	CJNE	R3,#00H,E3XX	;CHECK TO SEE IF
 2777:      09D8 22             	RET
 2778:                          	;
 2779:      09D9 D1 D7          SPEOP:	ACALL	GCI1		;BUMP TXA
 2780:      09DB 91 DF          	ACALL	P_E		;EVALUATE PAREN
 2781:      09DD 31 C8          SPEOP1: ACALL	SLET2		;EVALUATE AFTER =
 2782:      09DF 12 14 A1       	CALL	TWOL		;R7:R6 GETS VALUE, R3:R1 GET
 2783:      09E2 EE             	MOV	A,R6		;SAVE THE VALUE
 2784:                          	;
 2785:      09E3 BF 00 D7       	CJNE	R7,#00H,E3XX	;R2 MUST BE = 0
 2786:      09E6 22             	RET
 2787:                          	;
 2788:                          	;**************************************
 2789:                          	;
 2790:                          	; ST_CAL - Calculate string Address
 2791:                          	;
 2792:                          	;**************************************
 2793:                          	;
 2794:                          IST_CAL:;
 2795:                          	;
 2796:      09E7 D1 95          	ACALL	I_PI		;BUMP TEXT, THEN EVALUATE
 2797:      09E9 31 D5          	ACALL	R3CK		;ERROR IF R3 <> 0
 2798:      09EB 09             	INC	R1		;BUMP FOR OFFSET
 2799:      09EC E9             	MOV	A,R1		;ERROR IF R1 = 255
 2800:      09ED 60 CE          	JZ	E3XX
 2801:      09EF 90 01 04       	MOV	DPTR,#VARTOP	;GET TOP OF VARIABLE S
 2802:      09F2 85 3F F0       	MOV	B,S_LEN 	;MULTIPLY FOR LOCATION
 2803:      09F5 51 10          	ACALL	VARD		;CALCULATE THE LOCATION
 2804:      09F7 90 01 0A       	MOV	DPTR,#MEMTOP	;SEE IF BLEW IT
 2805:      09FA 12 15 B0       	CALL	FUL1
 2806:      09FD 85 3F 82       	MOV	DPL,S_LEN	;GET STRING LENGTH, DPH =
 2807:      0A00 15 83          	DEC	DPH		;DPH = 0
 2808:                          	;
 2809:      0A02 C3             DUBSUB: CLR	C

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 52



 Line    I  Addr Code           Source

 2810:      0A03 E9             	MOV	A,R1
 2811:      0A04 95 82          	SUBB	A,DPL
 2812:      0A06 F9             	MOV	R1,A
 2813:      0A07 EB             	MOV	A,R3
 2814:      0A08 95 83          	SUBB	A,DPH
 2815:      0A0A FB             	MOV	R3,A
 2816:      0A0B 49             	ORL	A,R1
 2817:      0A0C 22             	RET
 2818:                          	;
 2819:                          	;**************************************
 2820:                          	;
 2821:                          	;VARD - Calculate the offset base
 2822:                          	;
 2823:                          	;**************************************
 2824:                          	;
 2825:      0A0D 75 F0 06       VARB:	MOV	B,#FPSIZ	;SET UP FOR OPERATION
 2826:                          	;
 2827:      0A10 12 05 B0       VARD:	CALL	LDPTRI		;LOAD DPTR
 2828:      0A13 E9             	MOV	A,R1		;MULTIPLY BASE
 2829:      0A14 A4             	MUL	AB
 2830:      0A15 25 82          	ADD	A,DPL
 2831:      0A17 F9             	MOV	R1,A
 2832:      0A18 E5 F0          	MOV	A,B
 2833:      0A1A 35 83          	ADDC	A,DPH
 2834:      0A1C FB             	MOV	R3,A
 2835:      0A1D 22             	RET
 2836:                          	;
 2837:                          	;**************************************
 2838:                          	;
 2839:                          CSY:	; Calculate a biased string address
 2840:                          	;
 2841:                          	;**************************************
 2842:                          	;
 2843:      0A1E 31 E7          	ACALL	IST_CAL 	;CALCULATE IT
 2844:      0A20 C0 03          	PUSH	R3B0		;SAVE IT
 2845:      0A22 C0 01          	PUSH	R1B0
 2846:      0A24 7F 2C          	MOV	R7,#','         ;WASTE THE COMMA
 2847:      0A26 91 E5          	ACALL	EATC
 2848:      0A28 D1 8E          	ACALL	ONE		;GET THE NEXT EXPRESSION
 2849:      0A2A E9             	MOV	A,R1		;CHECK FOR BOUNDS
 2850:      0A2B B5 3F 00       	CJNE	A,S_LEN,CSY1
 2851:      0A2E 50 8D          CSY1:	JNC	E3XX		;MUST HAVE A CARRY
 2852:      0A30 19             	DEC	R1		;BIAS THE POINTER
 2853:      0A31 D0 E0          	POP	ACC		;GET VALUE LOW
 2854:      0A33 29             	ADD	A,R1		;ADD IT TO BASE
 2855:      0A34 F9             	MOV	R1,A		;SAVE IT
 2856:      0A35 D0 03          	POP	R3B0		;GET HIGH ADDRESS
 2857:      0A37 50 01          	JNC	CSY2		;PROPAGATE THE CARRY
 2858:      0A39 0B             	INC	R3
 2859:      0A3A 81 E3          CSY2:	AJMP	ERPAR		;WASTE THE RIGHT PAREN
 2860:                          	;
 2861:                          	;**************************************
 2862:                          	;
 2863:                          	; The statement action routine FOR
 2864:                          	;
 2865:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 53



 Line    I  Addr Code           Source

 2866:                          	;
 2867:      0A3C 31 C6          SFOR:	ACALL	SLET1		;SET UP CONTROL VARIA
 2868:      0A3E C0 03          	PUSH	R3B0		;SAVE THE CONTROL VARIABLE L
 2869:      0A40 C0 01          	PUSH	R1B0
 2870:      0A42 F1 D3          	ACALL	POPAS		;POP ARG STACK AND COPY CO
 2871:      0A44 7F A6          	MOV	R7,#T_TO	;GET TO TOKEN
 2872:      0A46 F1 41          	ACALL	WE
 2873:      0A48 D1 CD          	ACALL	GC		;GET NEXT CHARACTER
 2874:      0A4A B4 A7 06       	CJNE	A,#T_STEP,SF2
 2875:      0A4D D1 D7          	ACALL	GCI1		;EAT THE TOKEN
 2876:      0A4F F1 43          	ACALL	EXPRB		;EVALUATE EXPRESSION
 2877:      0A51 80 03          	SJMP	SF21		;JUMP OVER
 2878:                          	;
 2879:      0A53 12 14 43       SF2:	LCALL	PUSH_ONE	;PUT ONE ON THE STAC
 2880:                          	;
 2881:      0A56 74 EF          SF21:	MOV	A,#-FSIZE	;ALLOCATE FSIZE BYTE
 2882:      0A58 71 B1          	ACALL	PUSHCS		;GET CS IN R0
 2883:      0A5A 71 BD          	ACALL	CSC		;CHECK CONTROL STACK
 2884:      0A5C 7B 00          	MOV	R3,#CSTKAH	;IN CONTROL STACK
 2885:      0A5E A9 00          	MOV	R1,R0B0 	;STACK ADDRESS
 2886:      0A60 F1 D3          	ACALL	POPAS		;PUT STEP ON STACK
 2887:      0A62 F1 D3          	ACALL	POPAS		;PUT LIMIT ON STACK
 2888:      0A64 D1 A2          	ACALL	DP_T		;DPTR GETS TEXT
 2889:      0A66 A8 01          	MOV	R0,R1B0 	;GET THE POINTER
 2890:      0A68 71 39          	ACALL	T_X_S		;SAVE THE TEXT
 2891:      0A6A D0 08          	POP	TXAL		;GET CONTROL VARIABLE
 2892:      0A6C D0 0A          	POP	TXAH
 2893:      0A6E 7C 01          	MOV	R4,#FTYPE	;AND THE TYPE
 2894:      0A70 71 39          	ACALL	T_X_S		;SAVE IT
 2895:                          	;
 2896:      0A72 D1 B8          SF3:	ACALL	T_DP		;GET THE TEXT POINTER
 2897:      0A74 01 13          	AJMP	ILOOP		;CONTINUE TO PROCESS
 2898:                          	;
 2899:                          	;**************************************
 2900:                          	;
 2901:                          	; The statement action routines - PUSH 
 2902:                          	;
 2903:                          	;**************************************
 2904:                          	;
 2905:      0A76 F1 43          SPUSH:	ACALL	EXPRB		;PUT EXPRESSION ON S
 2906:      0A78 D1 C6          	ACALL	C_TST		;SEE IF MORE TO DO
 2907:      0A7A 50 FA          	JNC	SPUSH		;IF A COMMA PUSH ANOTHER
 2908:      0A7C 22             	RET
 2909:                          	;
 2910:                          	;
 2911:      0A7D F1 01          SPOP:	ACALL	VAR_ER		;GET VARIABLE
 2912:      0A7F F1 D1          	ACALL	XPOP		;FLIP THE REGISTERS FOR POP
 2913:      0A81 D1 C6          	ACALL	C_TST		;SEE IF MORE TO DO
 2914:      0A83 50 F8          	JNC	SPOP
 2915:                          	;
 2916:      0A85 22             SPOP1:	RET
 2917:                          	;
 2918:                          	;**************************************
 2919:                          	;
 2920:                          	; The statement action routine - IF
 2921:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 54



 Line    I  Addr Code           Source

 2922:                          	;**************************************
 2923:                          	;
 2924:      0A86 51 C7          SIF:	ACALL	RTST		;EVALUATE THE EXPRESSIO
 2925:      0A88 F9             	MOV	R1,A		;SAVE THE RESULT
 2926:      0A89 D1 CD          	ACALL	GC		;GET THE CHARACTER AFTER EXPR
 2927:      0A8B B4 A5 02       	CJNE	A,#T_THEN,SIF1	;SEE IF THEN TOKEN
 2928:      0A8E D1 D7          	ACALL	GCI1		;WASTE THEN TOKEN
 2929:      0A90 B9 00 0B       SIF1:	CJNE	R1,#0,T_F1	;CHECK R_OP RESULT
 2930:                          	;
 2931:      0A93 7F A8          E_FIND: MOV	R7,#T_ELSE	;FIND ELSE TOKEN
 2932:      0A95 D1 EE          	ACALL	FINDC
 2933:      0A97 60 EC          	JZ	SPOP1		;EXIT IF A CR
 2934:      0A99 D1 D7          	ACALL	GCI1		;BUMP PAST TOKEN
 2935:      0A9B B4 A8 F5       	CJNE	A,#T_ELSE,E_FIND;WASTE IF NO ELSE
 2936:                          	;
 2937:      0A9E F1 35          T_F1:	ACALL	INTGER		;SEE IF NUMBER
 2938:      0AA0 50 56          	JNC	D_L1		;EXECUTE LINE NUMBER
 2939:      0AA2 01 F8          	AJMP	ISTAT		;EXECUTE STATEMENT IN NOT
 2940:                          	;
 2941:      0AA4 E0             B_C:	MOVX	A,@DPTR
 2942:      0AA5 14             	DEC	A
 2943:      0AA6 20 E7 2E       	JB	ACC.7,FL11
 2944:      0AA9 22             	RET
 2945:                          	;
 2946:                          	;**************************************
 2947:                          	;
 2948:                          	; The statement action routine - GOTO
 2949:                          	;
 2950:                          	;**************************************
 2951:                          	;
 2952:      0AAA 51 F2          SGOTO:	ACALL	RLINE		;R2:R0 AND DPTR GET 
 2953:                          	;
 2954:      0AAC D1 B8          SGT1:	ACALL	T_DP		;TEXT POINTER GETS DPT
 2955:                          	;
 2956:      0AAE 10 25 08       	JBC	RETBIT,SGT2	;SEE IF RETI EXECUTED
 2957:                          	;
 2958:      0AB1 30 15 03       	JNB	LINEB,SGT11	;SEE IF A LINE WAS EDIT
 2959:      0AB4 12 06 62       	LCALL	CNEW1		;CLEAR THE MEMORY IF SET
 2960:      0AB7 01 11          SGT11:	AJMP	CILOOP1 	;CLEAR DIRF AND LOO
 2961:                          	;
 2962:      0AB9 10 14 05       SGT2:	JBC	OTI,SGT21	;SEE IF TIMER INTERR
 2963:      0ABC 53 22 BD       	ANL	34,#10111101B	;CLEAR INTERRUPTS
 2964:      0ABF 01 13          	AJMP	ILOOP		;EXECUTE
 2965:      0AC1 A2 2B          SGT21:	MOV	C,ISAV
 2966:      0AC3 92 11          	MOV	INPROG,C
 2967:      0AC5 01 13          	AJMP	ILOOP		;RESTORE INTERRUPTS AND RET
 2968:                          	;
 2969:                          	;
 2970:                          	;**************************************
 2971:                          	;
 2972:                          RTST:	; Test for ZERO
 2973:                          	;
 2974:                          	;**************************************
 2975:                          	;
 2976:      0AC7 F1 43          	ACALL	EXPRB		;EVALUATE EXPRESSION
 2977:      0AC9 12 12 4F       	CALL	INC_ASTKA	;BUMP ARG STACK

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 55



 Line    I  Addr Code           Source

 2978:      0ACC 60 02          	JZ	RTST1		;EXIT WITH ZERO OR 0FFH
 2979:      0ACE 74 FF          	MOV	A,#0FFH
 2980:      0AD0 22             RTST1:	RET
 2981:                          	;
 2982:                          	;
 2983:                          	;**************************************
 2984:                          	;
 2985:                          	; GLN - get the line number in R2:R0, r
 2986:                          	;
 2987:                          	;**************************************
 2988:                          	;
 2989:      0AD1 D1 9B          GLN:	ACALL	DP_B		;GET THE BEGINNING ADDR
 2990:                          	;
 2991:      0AD3 E0             FL1:	MOVX	A,@DPTR 	;GET THE LENGTH
 2992:      0AD4 FF             	MOV	R7,A		;SAVE THE LENGTH
 2993:      0AD5 DF 05          	DJNZ	R7,FL3		;SEE IF END OF FILE
 2994:                          	;
 2995:      0AD7 90 1F B5       FL11:	MOV	DPTR,#E10X	;NO LINE NUMBER
 2996:      0ADA 81 0E          	AJMP	EK		;HANDLE THE ERROR
 2997:                          	;
 2998:      0ADC 20 E7 F8       FL3:	JB	ACC.7,FL11	;CHECK FOR BIT 7
 2999:      0ADF A3             	INC	DPTR		;POINT AT HIGH BYTE
 3000:      0AE0 E0             	MOVX	A,@DPTR 	;GET HIGH BYTE
 3001:      0AE1 B5 02 08       	CJNE	A,R2B0,FL2	;SEE IF MATCH
 3002:      0AE4 A3             	INC	DPTR		;BUMP TO LOW BYTE
 3003:      0AE5 1F             	DEC	R7		;ADJUST AGAIN
 3004:      0AE6 E0             	MOVX	A,@DPTR 	;GET THE LOW BYTE
 3005:      0AE7 B5 00 02       	CJNE	A,R0B0,FL2	;SEE IF LOW BYTE MATCH
 3006:      0AEA A3             	INC	DPTR		;POINT AT FIRST CHARACTER
 3007:      0AEB 22             	RET			;FOUND IT
 3008:                          	;
 3009:      0AEC EF             FL2:	MOV	A,R7		;GET THE LENGTH COUNTER
 3010:      0AED 12 05 DE       	CALL	ADDPTR		;ADD A TO DATA POINTER
 3011:      0AF0 80 E1          	SJMP	FL1		;LOOP
 3012:                          	;
 3013:                          	;
 3014:                          	;**************************************
 3015:                          	;
 3016:                          	;RLINE - Read in ASCII string, get line
 3017:                          	;
 3018:                          	;**************************************
 3019:                          	;
 3020:      0AF2 F1 30          RLINE:	ACALL	INTERR		;GET THE INTEGER
 3021:                          	;
 3022:      0AF4 51 D1          RL1:	ACALL	GLN
 3023:      0AF6 E1 17          	AJMP	CLN_UP
 3024:                          	;
 3025:                          	;
 3026:      0AF8 51 D1          D_L1:	ACALL	GLN		;GET THE LINE
 3027:      0AFA 41 AC          	AJMP	SGT1		;EXECUTE THE LINE
 3028:                          	;
 3029:                          	;**************************************
 3030:                          	;
 3031:                          	; The statement action routines WHILE a
 3032:                          	;
 3033:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 56



 Line    I  Addr Code           Source

 3034:                          	;
 3035:      0AFC 51 C7          SWHILE: ACALL	RTST		;EVALUATE RELATIONAL
 3036:      0AFE F4             	CPL	A
 3037:      0AFF 80 02          	SJMP	S_WU
 3038:                          	;
 3039:      0B01 51 C7          SUNTIL: ACALL	RTST		;EVALUATE RELATIONAL
 3040:                          	;
 3041:      0B03 7C 03          S_WU:	MOV	R4,#DTYPE	;DO EXPECTED
 3042:      0B05 FD             	MOV	R5,A		;SAVE R_OP RESULT
 3043:      0B06 80 0C          	SJMP	SR0		;GO PROCESS
 3044:                          	;
 3045:                          	;
 3046:                          	;**************************************
 3047:                          	;
 3048:                          CNULL:	; The Command Action Routine - NU
 3049:                          	;
 3050:                          	;**************************************
 3051:                          	;
 3052:      0B08 F1 30          	ACALL	INTERR		;GET AN INTEGER FOLLOWING
 3053:      0B0A 88 15          	MOV	NULLCT,R0	;SAVE THE NULLCOUNT
 3054:      0B0C 01 55          	AJMP	CMNDLK		;JUMP TO COMMAND MODE
 3055:                          	;
 3056:                          	;**************************************
 3057:                          	;
 3058:                          	; The statement action routine - RETI
 3059:                          	;
 3060:                          	;**************************************
 3061:                          	;
 3062:      0B0E D2 25          SRETI:	SETB	RETBIT		;SAYS THAT RETI HAS 
 3063:                          	;
 3064:                          	;**************************************
 3065:                          	;
 3066:                          	; The statement action routine - RETURN
 3067:                          	;
 3068:                          	;**************************************
 3069:                          	;
 3070:      0B10 7C 02          SRETRN: MOV	R4,#GTYPE	;MAKE SURE OF GOSU
 3071:      0B12 7D 55          	MOV	R5,#55H 	;TYPE RETURN TYPE
 3072:                          	;
 3073:      0B14 71 4B          SR0:	ACALL	CSETUP		;SET UP CONTROL STACK
 3074:      0B16 E2             	MOVX	A,@R0		;GET RETURN TEXT ADDRESS
 3075:      0B17 F5 83          	MOV	DPH,A
 3076:      0B19 08             	INC	R0
 3077:      0B1A E2             	MOVX	A,@R0
 3078:      0B1B F5 82          	MOV	DPL,A
 3079:      0B1D 08             	INC	R0		;POP CONTROL STACK
 3080:      0B1E E0             	MOVX	A,@DPTR 	;SEE IF GOSUB WAS THE LAS
 3081:      0B1F B4 01 02       	CJNE	A,#EOF,SR01
 3082:      0B22 01 55          	AJMP	CMNDLK
 3083:      0B24 ED             SR01:	MOV	A,R5		;GET TYPE
 3084:      0B25 60 85          	JZ	SGT1		;EXIT IF ZERO
 3085:      0B27 88 11          	MOV	CSTKA,R0	;POP THE STACK
 3086:      0B29 F4             	CPL	A		;OPTION TEST, 00H, 55H, 0FFH, NO
 3087:      0B2A 70 80          	JNZ	SGT1		;MUST BE GOSUB
 3088:      0B2C 22             	RET			;NORMAL FALL THRU EXIT FOR NO MAT
 3089:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 57



 Line    I  Addr Code           Source

 3090:                          	;**************************************
 3091:                          	;
 3092:                          	; The statement action routine - GOSUB
 3093:                          	;
 3094:                          	;**************************************
 3095:                          	;
 3096:      0B2D 51 F2          SGOSUB: ACALL	RLINE		;NEW TXA IN DPTR
 3097:                          	;
 3098:      0B2F 7C 02          SGS0:	MOV	R4,#GTYPE
 3099:      0B31 71 35          	ACALL	SGS1		;SET EVERYTHING UP
 3100:      0B33 41 72          	AJMP	SF3		;EXIT
 3101:                          	;
 3102:      0B35 74 FD          SGS1:	MOV	A,#-3		;ALLOCATE 3 BYTES ON CO
 3103:      0B37 71 B1          	ACALL	PUSHCS
 3104:                          	;
 3105:      0B39 75 A0 00       T_X_S:	MOV	P2,#CSTKAH	;SET UP PORT FOR C
 3106:      0B3C E5 08          	MOV	A,TXAL		;GET RETURN ADDRESS AND SAV
 3107:      0B3E F2             	MOVX	@R0,A
 3108:      0B3F 18             	DEC	R0
 3109:      0B40 E5 0A          	MOV	A,TXAH
 3110:      0B42 F2             	MOVX	@R0,A
 3111:      0B43 18             	DEC	R0
 3112:      0B44 EC             	MOV	A,R4		;GET TYPE
 3113:      0B45 F2             	MOVX	@R0,A		;SAVE TYPE
 3114:      0B46 22             	RET			;EXIT
 3115:                          	;
 3116:                          	;
 3117:      0B47 74 03          CS1:	MOV	A,#3		;POP 3 BYTES
 3118:      0B49 71 B1          	ACALL	PUSHCS
 3119:                          	;
 3120:      0B4B A8 11          CSETUP: MOV	R0,CSTKA	;GET CONTROL STACK
 3121:      0B4D 75 A0 00       	MOV	P2,#CSTKAH
 3122:      0B50 E2             	MOVX	A,@R0		;GET BYTE
 3123:      0B51 B5 04 02       	CJNE	A,R4B0,CSETUP1	;SEE IF TYPE MATCH
 3124:      0B54 08             	INC	R0
 3125:      0B55 22             	RET
 3126:      0B56 60 69          CSETUP1:JZ	E4XX		;EXIT IF STACK UNDERFLO
 3127:      0B58 B4 01 EC       	CJNE	A,#FTYPE,CS1	;SEE IF FOR TYPE
 3128:      0B5B 71 AF          	ACALL	XXI3		;WASTE THE FOR TYPE
 3129:      0B5D 80 EC          	SJMP	CSETUP		;LOOP
 3130:                          	;
 3131:                          	;**************************************
 3132:                          	;
 3133:                          	; The statement action routine - NEXT
 3134:                          	;
 3135:                          	;**************************************
 3136:                          	;
 3137:      0B5F 7C 01          SNEXT:	MOV	R4,#FTYPE	;FOR TYPE
 3138:      0B61 71 4B          	ACALL	CSETUP		;SETUP CONTROL STACK
 3139:      0B63 88 0F          	MOV	TEMP5,R0	;SAVE CONTROL VARIABLE ADD
 3140:      0B65 79 0B          	MOV	R1,#TEMP1	;SAVE VAR + RETURN IN TEM
 3141:                          	;
 3142:      0B67 E2             XXI:	MOVX	A,@R0		;LOOP UNTIL DONE
 3143:      0B68 F7             	MOV	@R1,A
 3144:      0B69 09             	INC	R1
 3145:      0B6A 08             	INC	R0

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 58



 Line    I  Addr Code           Source

 3146:      0B6B B9 0F F9       	CJNE	R1,#TEMP5,XXI
 3147:                          	;
 3148:      0B6E B1 65          	ACALL	VAR		;SEE IF THE USER HAS A VARIA
 3149:      0B70 50 04          	JNC	XXI1
 3150:      0B72 AA 0B          	MOV	R2,TEMP1
 3151:      0B74 A8 0C          	MOV	R0,TEMP2
 3152:      0B76 EA             XXI1:	MOV	A,R2		;SEE IF VAR'S AGREE
 3153:      0B77 B5 0B 47       	CJNE	A,TEMP1,E4XX
 3154:      0B7A E8             	MOV	A,R0
 3155:      0B7B B5 0C 43       	CJNE	A,TEMP2,E4XX
 3156:      0B7E F1 DD          	ACALL	PUSHAS		;PUT CONTROL VARIABLE ON 
 3157:      0B80 74 0E          	MOV	A,#FPSIZ+FPSIZ+2;COMPUTE ADDRESS TO
 3158:      0B82 25 0F          	ADD	A,TEMP5 	;ADD IT TO BASE OF STACK
 3159:      0B84 F8             	MOV	R0,A		;SAVE IN R0
 3160:      0B85 7A 00          	MOV	R2,#CSTKAH	;SET UP TO PUSH STEP VAL
 3161:      0B87 8A A0          	MOV	P2,R2		;SET UP PORT
 3162:      0B89 E2             	MOVX	A,@R0		;GET SIGN
 3163:      0B8A 08             	INC	R0		;BACK TO EXPONENT
 3164:      0B8B C0 E0          	PUSH	ACC		;SAVE SIGN OF STEP
 3165:      0B8D F1 DD          	ACALL	PUSHAS		;PUT STEP VALUE ON STACK
 3166:      0B8F C0 00          	PUSH	R0B0		;SAVE LIMIT VALUE LOCATION
 3167:      0B91 12 17 41       	CALL	AADD		;ADD STEP VALUE TO VARIABLE
 3168:      0B94 12 14 2C       	CALL	CSTAKA		;COPY STACK
 3169:      0B97 AB 0B          	MOV	R3,TEMP1	;GET CONTROL VARIABLE
 3170:      0B99 A9 0C          	MOV	R1,TEMP2
 3171:      0B9B F1 D3          	ACALL	POPAS		;SAVE THE RESULT
 3172:      0B9D 7A 00          	MOV	R2,#CSTKAH	;RESTORE LIMIT LOCATION
 3173:      0B9F D0 00          	POP	R0B0
 3174:      0BA1 F1 DD          	ACALL	PUSHAS		;PUT LIMIT ON STACK
 3175:      0BA3 12 19 73       	CALL	FP_BASE2	;DO THE COMPARE
 3176:      0BA6 D0 E0          	POP	ACC		;GET LIMIT SIGN BACK
 3177:      0BA8 60 01          	JZ	XXI2		;IF SIGN NEGATIVE, TEST "BACKW
 3178:      0BAA B3             	CPL	C
 3179:      0BAB 72 D5          XXI2:	ORL	C,F0		;SEE IF EQUAL
 3180:      0BAD 40 17          	JC	N4		;STILL SMALLER THAN LIMIT?
 3181:      0BAF 74 11          XXI3:	MOV	A,#FSIZE	;REMOVE CONTROL STACK
 3182:                          	;
 3183:                          	; Fall thru to PUSHCS
 3184:                          	;
 3185:                          	;**************************************
 3186:                          	;
 3187:                          	; PUSHCS - push frame onto control stac
 3188:                          	;	   acc has - number of bytes, also te
 3189:                          	;
 3190:                          	;**************************************
 3191:                          	;
 3192:      0BB1 25 11          PUSHCS: ADD	A,CSTKA 	;BUMP CONTROL STACK
 3193:      0BB3 B4 61 00       	CJNE	A,#CONVT+17,PUSHCS1 ;SEE IF OVERFL
 3194:      0BB6 40 09          PUSHCS1:JC	E4XX		;EXIT IF STACK OVERFLOW
 3195:      0BB8 C5 11          	XCH	A,CSTKA 	;STORE NEW CONTROL STACK V
 3196:      0BBA 14             	DEC	A		;BUMP OLD VALUE
 3197:      0BBB F8             	MOV	R0,A		;PUT OLD-1 IN R0
 3198:                          	;
 3199:      0BBC 22             PUSHCS2:RET			;EXIT
 3200:                          	;
 3201:      0BBD F1 17          CSC:	ACALL	CLN_UP		;FINISH OFF THE LINE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 59



 Line    I  Addr Code           Source

 3202:      0BBF 50 FB          	JNC	PUSHCS2 	;EXIT IF NO TERMINATOR
 3203:                          	;
 3204:      0BC1 90 03 83       E4XX:	MOV	DPTR,#EXC	;CONTROL STACK ERROR
 3205:      0BC4 81 0E          	AJMP	EK		;STACK ERROR
 3206:                          	;
 3207:      0BC6 85 0D 0A       N4:	MOV	TXAH,TEMP3	;GET TEXT POINTER
 3208:      0BC9 85 0E 08       	MOV	TXAL,TEMP4
 3209:      0BCC 01 13          	AJMP	ILOOP		;EXIT
 3210:                          	;
 3211:                          	;**************************************
 3212:                          	;
 3213:                          	; The statement action routine - RESTOR
 3214:                          	;
 3215:                          	;**************************************
 3216:                          	;
 3217:      0BCE 71 D6          SRESTR: ACALL	X_TR		;SWAP POINTERS
 3218:      0BD0 D1 9B          SRESTR1:ACALL	DP_B		;GET THE STARTING AD
 3219:      0BD2 D1 B8          	ACALL	T_DP		;PUT STARTING ADDRESS IN TE
 3220:      0BD4 F1 23          	ACALL	B_TXA		;BUMP TXA
 3221:                          	;
 3222:                          	; Fall thru
 3223:                          	;
 3224:                          X_TR:	;swap txa and rtxa
 3225:                          	;
 3226:      0BD6 C5 0A          	XCH	A,TXAH
 3227:      0BD8 C5 12          	XCH	A,RTXAH
 3228:      0BDA C5 0A          	XCH	A,TXAH
 3229:      0BDC C5 08          	XCH	A,TXAL
 3230:      0BDE C5 10          	XCH	A,RTXAL
 3231:      0BE0 C5 08          	XCH	A,TXAL
 3232:      0BE2 22             	RET			;EXIT
 3233:                          	;
 3234:                          	;**************************************
 3235:                          	;
 3236:                          	; The statement action routine - READ
 3237:                          	;
 3238:                          	;**************************************
 3239:                          	;
 3240:      0BE3 71 D6          SREAD:	ACALL	X_TR		;SWAP POINTERS
 3241:                          	;
 3242:      0BE5 D1 C6          SRD0:	ACALL	C_TST		;CHECK FOR COMMA
 3243:      0BE7 40 16          	JC	SRD4		;SEE WHAT IT IS
 3244:                          	;
 3245:      0BE9 F1 43          SRD:	ACALL	EXPRB		;EVALUATE THE EXPRESSI
 3246:      0BEB D1 CD          	ACALL	GC		;GET THE CHARACTER AFTER EXPR
 3247:      0BED B4 2C 02       	CJNE	A,#',',SRD1     ;SEE IF MORE DATA
 3248:      0BF0 80 02          	SJMP	SRD2		;BYBASS CLEAN UP IF A COMMA
 3249:                          	;
 3250:      0BF2 F1 17          SRD1:	ACALL	CLN_UP		;FINISH OFF THE LINE
 3251:                          	;
 3252:      0BF4 71 D6          SRD2:	ACALL	X_TR		;RESTORE POINTERS
 3253:      0BF6 F1 01          	ACALL	VAR_ER		;GET VARIABLE ADDRESS
 3254:      0BF8 F1 D1          	ACALL	XPOP		;FLIP THE REGISTERS FOR POP
 3255:      0BFA D1 C6          	ACALL	C_TST		;SEE IF A COMMA
 3256:      0BFC 50 E5          	JNC	SREAD		;READ AGAIN IF A COMMA
 3257:      0BFE 22             SRD21:	RET			;EXIT IF NOT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 60



 Line    I  Addr Code           Source

 3258:                          	;
 3259:      0BFF B4 9C 04       SRD4:	CJNE	A,#T_DATA,SRD5	;SEE IF DATA
 3260:      0C02 D1 D7          	ACALL	GCI1		;BUMP POINTER
 3261:      0C04 80 E3          	SJMP	SRD
 3262:                          	;
 3263:      0C06 B4 01 08       SRD5:	CJNE	A,#EOF,SRD6	;SEE IF YOU BLEW 
 3264:      0C09 71 D6          SRD51:	ACALL	X_TR		;GET THE TEXT POINTER
 3265:      0C0B 90 1F 81       	MOV	DPTR,#E14X	;READ ERROR
 3266:                          	;
 3267:      0C0E 02 18 8F       EK:	LJMP	ERROR
 3268:                          	;
 3269:      0C11 D1 EC          SRD6:	ACALL	FINDCR		;WASTE THIS LINE
 3270:      0C13 F1 17          	ACALL	CLN_UP		;CLEAN IT UP
 3271:      0C15 40 F2          	JC	SRD51		;ERROR IF AT END
 3272:      0C17 80 CC          	SJMP	SRD0
 3273:                          	;
 3274:      0C19 D1 CD          NUMC:	ACALL	GC		;GET A CHARACTER
 3275:      0C1B B4 23 04       	CJNE	A,#'#',NUMC1    ;SEE IF A #
 3276:      0C1E D2 1B          	SETB	COB		;VALID LINE PRINT
 3277:      0C20 C1 CB          	AJMP	IGC		;BUMP THE TEXT POINTER
 3278:                          	;
 3279:      0C22 B4 40 D9       NUMC1:	CJNE	A,#'@',SRD21    ;EXIT IF NO 
 3280:      0C25 D2 19          	SETB	LPB
 3281:      0C27 C1 CB          	AJMP	IGC
 3282:                          	;
 3283:                          	;**************************************
 3284:                          	;
 3285:                          	; The statement action routine - PRINT
 3286:                          	;
 3287:                          	;**************************************
 3288:                          	;
 3289:      0C29 D2 36          SPH0:	SETB	ZSURP		;NO ZEROS
 3290:                          	;
 3291:      0C2B D2 37          SPH1:	SETB	HMODE		;HEX MODE
 3292:                          	;
 3293:      0C2D 91 19          SPRINT: ACALL	NUMC		;TEST FOR A LINE PRI
 3294:      0C2F 91 38          	ACALL	SPRINT2 	;PROCEED
 3295:      0C31 53 23 F5       SPRINT1:ANL	35,#11110101B	;CLEAR COB AND
 3296:      0C34 53 26 3F       	ANL	38,#00111111B	;NO HEX MODE
 3297:                          	;
 3298:      0C37 22             	RET
 3299:                          	;
 3300:      0C38 D1 E1          SPRINT2:ACALL	DELTST		;CHECK FOR A DELIM
 3301:      0C3A 40 07          	JC	SP1
 3302:                          	;
 3303:      0C3C 02 06 A5       SP0:	JMP	CRLF		;EXIT WITH A CR IF SO
 3304:                          	;
 3305:      0C3F D1 C6          SP2:	ACALL	C_TST		;CHECK FOR A COMMA
 3306:      0C41 40 F9          	JC	SP0		;EXIT IF NO COMMA
 3307:                          	;
 3308:      0C43 D1 A9          SP1:	ACALL	CPS		;SEE IF A STRING TO PRIN
 3309:      0C45 50 F8          	JNC	SP2		;IF A STRING, CHECK FOR A COMM
 3310:                          	;
 3311:      0C47 B4 A4 08       SP4:	CJNE	A,#T_TAB,SP6
 3312:      0C4A D1 95          	ACALL	I_PI		;ALWAYS CLEARS CARRY
 3313:      0C4C 95 16          	SUBB	A,PHEAD 	;TAKE DELTA BETWEEN TAB A

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 61



 Line    I  Addr Code           Source

 3314:      0C4E 40 EF          	JC	SP2		;EXIT IF PHEAD > TAB
 3315:      0C50 80 05          	SJMP	SP7		;OUTPUT SPACES
 3316:                          	;
 3317:      0C52 B4 A9 0A       SP6:	CJNE	A,#T_SPC,SM
 3318:      0C55 D1 95          	ACALL	I_PI		;SET UP PAREN VALUE
 3319:                          	;
 3320:      0C57 60 E6          SP7:	JZ	SP2
 3321:      0C59 12 07 0F       	LCALL	STEROT		;OUTPUT A SPACE
 3322:      0C5C 14             	DEC	A		;DECREMENT COUNTER
 3323:      0C5D 80 F8          	SJMP	SP7		;LOOP
 3324:                          	;
 3325:      0C5F B4 D3 13       SM:	CJNE	A,#T_CHR,SP8
 3326:      0C62 D1 CB          	ACALL	IGC
 3327:      0C64 B4 24 06       	CJNE	A,#'$',SM01
 3328:      0C67 F1 F9          	ACALL	CNX		;PUT THE CHARACTER ON THE ST
 3329:      0C69 D1 90          	ACALL	IFIXL		;PUT THE CHARACTER IN R1
 3330:      0C6B 80 04          	SJMP	SM02
 3331:      0C6D D1 8E          SM01:	ACALL	ONE		;EVALUATE THE EXPRESSIO
 3332:      0C6F 91 E3          	ACALL	ERPAR
 3333:      0C71 AD 01          SM02:	MOV	R5,R1B0 	;BYTE TO OUTPUT
 3334:      0C73 80 07          	SJMP	SQ
 3335:                          	;
 3336:      0C75 B4 AA 09       SP8:	CJNE	A,#T_CR,SX
 3337:      0C78 D1 D7          	ACALL	GCI1		;EAT THE TOKEN
 3338:      0C7A 7D 0D          	MOV	R5,#CR
 3339:                          	;
 3340:      0C7C 12 07 11       SQ:	CALL	TEROT
 3341:      0C7F 80 BE          	SJMP	SP2		;OUTPUT A CR AND DO IT AGAIN
 3342:                          	;
 3343:      0C81 B4 D2 53       SX:	CJNE	A,#T_USE,SP9	;USING TOKEN
 3344:      0C84 D1 CB          	ACALL	IGC		;GE THE CHARACTER AFTER THE 
 3345:      0C86 B4 46 16       	CJNE	A,#'F',U4       ;SEE IF FLOATING
 3346:      0C89 75 17 F0       	MOV	FORMAT,#0F0H	;SET FLOATING
 3347:      0C8C D1 CB          	ACALL	IGC		;BUMP THE POINTER AND GET TH
 3348:      0C8E D1 D7          	ACALL	GCI1		;BUMP IT AGAIN
 3349:      0C90 54 0F          	ANL	A,#0FH		;STRIP OFF ASCII BIAS
 3350:      0C92 60 07          	JZ	U3		;EXIT IF ZERO
 3351:      0C94 B4 03 00       	CJNE	A,#3,SX1	;SEE IF AT LEAST A THREE
 3352:      0C97 50 02          SX1:	JNC	U3		;FORCE A THREE IF NOT A THR
 3353:      0C99 74 03          	MOV	A,#3
 3354:                          	;
 3355:      0C9B 42 17          U3:	ORL	FORMAT,A	;PUT DIGIT IN FORMAT
 3356:      0C9D 80 2A          	SJMP	U8		;CLEAN UP END
 3357:                          	;
 3358:      0C9F B4 30 07       U4:	CJNE	A,#'0',U5
 3359:      0CA2 75 17 00       	MOV	FORMAT,#0	;FREE FORMAT
 3360:      0CA5 D1 D7          	ACALL	GCI1		;BUMP THE POINTER
 3361:      0CA7 80 20          	SJMP	U8
 3362:                          	;
 3363:      0CA9 B4 23 1D       U5:	CJNE	A,#'#',U8       ;SEE IF INTGER 
 3364:      0CAC 91 CD          	ACALL	U6
 3365:      0CAE 8F 17          	MOV	FORMAT,R7	;SAVE THE FORMAT
 3366:      0CB0 B4 2E 11       	CJNE	A,#'.',U8A      ;SEE IF TERMINATOR
 3367:      0CB3 D1 CB          	ACALL	IGC		;BUMP PAST .
 3368:      0CB5 91 CD          	ACALL	U6		;LOOP AGAIN
 3369:      0CB7 EF             	MOV	A,R7		;GET COUNT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 62



 Line    I  Addr Code           Source

 3370:      0CB8 25 17          	ADD	A,FORMAT	;SEE IF TOO BIG
 3371:      0CBA 24 F7          	ADD	A,#0F7H
 3372:      0CBC 50 02          	JNC	U5A
 3373:                          	;
 3374:      0CBE 21 38          SE0:	AJMP	INTERX		;ERROR, BAD SYNTAX
 3375:                          	;
 3376:      0CC0 EF             U5A:	MOV	A,R7		;GET THE COUNT BACK
 3377:      0CC1 C4             	SWAP	A		;ADJUST
 3378:      0CC2 42 17          	ORL	FORMAT,A	;GET THE COUNT
 3379:                          	;
 3380:      0CC4 E5 17          U8A:	MOV	A,FORMAT
 3381:                          	;
 3382:      0CC6 C4             U8B:	SWAP	A		;GET THE FORMAT RIGHT
 3383:      0CC7 F5 17          	MOV	FORMAT,A
 3384:                          	;
 3385:      0CC9 91 E3          U8:	ACALL	ERPAR
 3386:      0CCB 81 3F          	AJMP	SP2		;DONE
 3387:                          	;
 3388:      0CCD 7F 00          U6:	MOV	R7,#0		;SET COUNTER
 3389:                          	;
 3390:      0CCF B4 23 0C       U7:	CJNE	A,#'#',SP9A     ;EXIT IF NOT A 
 3391:      0CD2 0F             	INC	R7		;BUMP COUNTER
 3392:      0CD3 D1 CB          	ACALL	IGC		;GET THE NEXT CHARACTER
 3393:      0CD5 80 F8          	SJMP	U7		;LOOP
 3394:                          	;
 3395:      0CD7 D1 E3          SP9:	ACALL	DELTST1 	;CHECK FOR DELIMITER
 3396:      0CD9 50 03          	JNC	SP9A		;EXIT IF A DELIMITER
 3397:                          	;
 3398:      0CDB B4 A8 34       	CJNE	A,#T_ELSE,SS
 3399:                          	;
 3400:      0CDE 22             SP9A:	RET			;EXIT IF ELSE TOKEN
 3401:                          	;
 3402:                          	;**************************************
 3403:                          	;
 3404:                          	; P_E - Evaluate an expression in paren
 3405:                          	;
 3406:                          	;**************************************
 3407:                          	;
 3408:      0CDF 7F E0          P_E:	MOV	R7,#T_LPAR
 3409:      0CE1 F1 41          	ACALL	WE
 3410:                          	;
 3411:      0CE3 7F 29          ERPAR:	MOV	R7,#')'         ;EAT A RIGHT 
 3412:                          	;
 3413:      0CE5 D1 D5          EATC:	ACALL	GCI		;GET THE CHARACTER
 3414:      0CE7 B5 07 D4       	CJNE	A,R7B0,SE0	;ERROR IF NOT THE SAME
 3415:      0CEA 22             	RET
 3416:                          	;
 3417:                          	;**************************************
 3418:                          	;
 3419:                          S_ON:	; ON Statement
 3420:                          	;
 3421:                          	;**************************************
 3422:                          	;
 3423:      0CEB D1 8E          	ACALL	ONE		;GET THE EXPRESSION
 3424:      0CED D1 D5          	ACALL	GCI		;GET THE NEXT CHARACTER
 3425:      0CEF B4 83 04       	CJNE	A,#T_GOTO,C0

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 63



 Line    I  Addr Code           Source

 3426:      0CF2 91 FD          	ACALL	C1		;EAT THE COMMAS
 3427:      0CF4 41 72          	AJMP	SF3		;DO GOTO
 3428:                          	;
 3429:      0CF6 B4 9F C5       C0:	CJNE	A,#T_GOSB,SE0
 3430:      0CF9 91 FD          	ACALL	C1
 3431:      0CFB 61 2F          	AJMP	SGS0		;DO GOSUB
 3432:                          	;
 3433:      0CFD B9 00 06       C1:	CJNE	R1,#0,C2
 3434:      0D00 F1 30          	ACALL	INTERR		;GET THE LINE NUMBER
 3435:      0D02 D1 EC          	ACALL	FINDCR
 3436:      0D04 41 F4          	AJMP	RL1		;FINISH UP THIS LINE
 3437:                          	;
 3438:      0D06 7F 2C          C2:	MOV	R7,#','
 3439:      0D08 D1 EE          	ACALL	FINDC
 3440:      0D0A B4 2C B1       	CJNE	A,#',',SE0      ;ERROR IF NOT A CO
 3441:      0D0D 19             	DEC	R1
 3442:      0D0E D1 D7          	ACALL	GCI1		;BUMP PAST COMMA
 3443:      0D10 80 EB          	SJMP	C1
 3444:                          	;
 3445:      0D12 D1 BF          SS:	ACALL	S_C		;SEE IF A STRING
 3446:      0D14 40 05          	JC	SA		;NO STRING IF CARRY IS SET
 3447:      0D16 12 06 BF       	LCALL	UPRNT		;PUT POINTER IN DPTR
 3448:      0D19 81 3F          	AJMP	SP2		;SEE IF MORE
 3449:                          	;
 3450:      0D1B F1 43          SA:	ACALL	EXPRB		;MUST BE AN EXPRESSION
 3451:      0D1D 74 48          	MOV	A,#72
 3452:      0D1F B5 16 00       	CJNE	A,PHEAD,SA1	;CHECK PHEAD POSITION
 3453:      0D22 50 02          SA1:	JNC	SA2
 3454:      0D24 91 3C          	ACALL	SP0		;FORCE A CRLF
 3455:      0D26 30 37 14       SA2:	JNB	HMODE,S13	;HEX MODE?
 3456:      0D29 12 12 02       	CALL	FCMP		;SEE IF TOS IS < 0FFFH
 3457:      0D2C 40 0F          	JC	S13		;EXIT IF GREATER
 3458:      0D2E 12 13 8F       	CALL	AABS		;GET THE SIGN
 3459:      0D31 70 07          	JNZ	OOPS		;WASTE IF NEGATIVE
 3460:      0D33 D1 90          	ACALL	IFIXL
 3461:      0D35 12 19 85       	CALL	FP_BASE11	;PRINT HEXMODE
 3462:      0D38 81 3F          	AJMP	SP2
 3463:      0D3A 12 13 A1       OOPS:	CALL	ANEG		;MAKE IT NEGATIVE
 3464:                          	;
 3465:      0D3D 12 19 7D       S13:	CALL	FP_BASE7	;DO FP OUTPUT
 3466:      0D40 74 01          	MOV	A,#1		;OUTPUT A SPACE
 3467:      0D42 81 57          	AJMP	SP7
 3468:                          	;
 3469:                          	;**************************************
 3470:                          	;
 3471:                          	; ANU -  Get variable name from text - 
 3472:                          	;	 if succeeds returns variable in R7:R
 3473:                          	;	 R6 = 0 if no digit in name
 3474:                          	;
 3475:                          	;**************************************
 3476:                          	;
 3477:      0D44 D1 CB          ANU:	ACALL	IGC		;INCREMENT AND GET CHARA
 3478:      0D46 12 1F ED       	LCALL	DIGIT_CHECK	;CHECK FOR DIGIT
 3479:      0D49 40 0C          	JC	AL2		;EXIT IF VALID DIGIT
 3480:      0D4B B4 5F 01       	CJNE	A,#'_',AL       ;SEE IF A _
 3481:      0D4E 22             	RET

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 64



 Line    I  Addr Code           Source

 3482:                          	;
 3483:      0D4F B4 41 00       AL:	CJNE	A,#'A',AL1      ;IS IT AN ASCII
 3484:      0D52 40 04          AL1:	JC	AL3		;EXIT IF CARRY IS SET
 3485:      0D54 B4 5B 00       	CJNE	A,#'Z'+1,AL2    ;IS IT LESS THAN A
 3486:      0D57 B3             AL2:	CPL	C		;FLIP CARRY
 3487:      0D58 22             AL3:	RET
 3488:                          	;
 3489:      0D59 30 D5 3E       SD01:	JNB	F0,VAR2
 3490:                          	;
 3491:      0D5C 90 17 61       SD0:	MOV	DPTR,#E6X
 3492:      0D5F 81 0E          	AJMP	EK
 3493:                          	;
 3494:      0D61 D2 D5          SDIMX:	SETB	F0		;SAYS DOING A DIMENSION
 3495:      0D63 80 02          	SJMP	VAR1
 3496:                          	;
 3497:      0D65 C2 D5          VAR:	CLR	F0		;SAYS DOING A VARIABLE
 3498:                          	;
 3499:      0D67 D1 CD          VAR1:	ACALL	GC		;GET THE CHARACTER
 3500:      0D69 B1 4F          	ACALL	AL		;CHECK FOR ALPHA
 3501:      0D6B 50 04          	JNC	VAR11		;ERROR IF IN DIM
 3502:      0D6D 20 D5 EC       	JB	F0,SD0
 3503:      0D70 22             	RET
 3504:      0D71 FF             VAR11:	MOV	R7,A		;SAVE ALPHA CHARACTER
 3505:      0D72 E4             	CLR	A		;ZERO IN CASE OF FAILURE
 3506:      0D73 FD             	MOV	R5,A		;SAVE IT
 3507:                          	;
 3508:      0D74 FE             VY:	MOV	R6,A
 3509:      0D75 B1 44          	ACALL	ANU		;CHECK FOR ALPHA OR NUMBER
 3510:      0D77 40 07          	JC	VX		;EXIT IF NO ALPHA OR NUM
 3511:                          	;
 3512:      0D79 CF             	XCH	A,R7
 3513:      0D7A 2D             	ADD	A,R5		;NUMBER OF CHARACTERS IN ALPH
 3514:      0D7B CF             	XCH	A,R7		;PUT IT BACK
 3515:      0D7C 7D 1A          	MOV	R5,#26		;FOR THE SECOND TIME AROUND
 3516:      0D7E 80 F4          	SJMP	VY
 3517:                          	;
 3518:      0D80 C2 15          VX:	CLR	LINEB		;TELL EDITOR A VARIABLE I
 3519:      0D82 B4 E0 2F       	CJNE	A,#T_LPAR,V4	;SEE IF A LEFT PAREN
 3520:                          	;
 3521:      0D85 43 06 80       	ORL	R6B0,#80H	;SET BIT 7 TO SIGINIFY MA
 3522:      0D88 12 06 19       	CALL	F_VAR		;FIND THE VARIABLE
 3523:      0D8B C0 02          	PUSH	R2B0		;SAVE THE LOCATION
 3524:      0D8D C0 00          	PUSH	R0B0
 3525:      0D8F 50 C8          	JNC	SD01		;DEFAULT IF NOT IN TABLE
 3526:      0D91 20 D5 28       	JB	F0,SDI		;NO DEFAULT FOR DIMENSION
 3527:      0D94 79 0A          	MOV	R1,#10
 3528:      0D96 7B 00          	MOV	R3,#0
 3529:      0D98 B1 CC          	ACALL	D_CHK
 3530:                          	;
 3531:      0D9A D1 97          VAR2:	ACALL	PAREN_INT	;EVALUATE INTEGER 
 3532:      0D9C BB 00 BD       	CJNE	R3,#0,SD0	;ERROR IF R3<>0
 3533:      0D9F D0 82          	POP	DPL		;GET VAR FOR LOOKUP
 3534:      0DA1 D0 83          	POP	DPH
 3535:      0DA3 E0             	MOVX	A,@DPTR 	;GET DIMENSION
 3536:      0DA4 14             	DEC	A		;BUMP OFFSET
 3537:      0DA5 99             	SUBB	A,R1		;A MUST BE > R1

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 65



 Line    I  Addr Code           Source

 3538:      0DA6 40 B4          	JC	SD0
 3539:      0DA8 12 05 C0       	LCALL	DECDP2		;BUMP POINTER TWICE
 3540:      0DAB 51 0D          	ACALL	VARB		;CALCULATE THE BASE
 3541:                          	;
 3542:      0DAD C9             X3120:	XCH	A,R1		;SWAP R2:R0, R3:R1
 3543:      0DAE C8             	XCH	A,R0
 3544:      0DAF C9             	XCH	A,R1
 3545:      0DB0 CB             	XCH	A,R3
 3546:      0DB1 CA             	XCH	A,R2
 3547:      0DB2 CB             	XCH	A,R3
 3548:      0DB3 22             	RET
 3549:                          	;
 3550:      0DB4 20 D5 A5       V4:	JB	F0,SD0		;ERROR IF NO LPAR FOR DIM
 3551:      0DB7 12 06 19       	LCALL	F_VAR		;GET SCALAR VARIABLE
 3552:      0DBA C3             	CLR	C
 3553:      0DBB 22             	RET
 3554:                          	;
 3555:      0DBC D1 97          SDI:	ACALL	PAREN_INT	;EVALUATE PAREN EXP
 3556:      0DBE BB 00 9B       	CJNE	R3,#0,SD0	;ERROR IF NOT ZERO
 3557:      0DC1 D0 00          	POP	R0B0		;SET UP R2:R0
 3558:      0DC3 D0 02          	POP	R2B0
 3559:      0DC5 B1 CC          	ACALL	D_CHK		;DO DIM
 3560:      0DC7 D1 C6          	ACALL	C_TST		;CHECK FOR COMMA
 3561:      0DC9 50 96          	JNC	SDIMX		;LOOP IF COMMA
 3562:      0DCB 22             	RET			;RETURN IF NO COMMA
 3563:                          	;
 3564:      0DCC 09             D_CHK:	INC	R1		;BUMP FOR TABLE LOOKUP
 3565:      0DCD E9             	MOV	A,R1
 3566:      0DCE 60 8C          	JZ	SD0		;ERROR IF 0FFFFH
 3567:      0DD0 FC             	MOV	R4,A		;SAVE FOR LATER
 3568:      0DD1 90 01 08       	MOV	DPTR,#MT_ALL	;GET MATRIX ALLOCATION
 3569:      0DD4 51 0D          	ACALL	VARB		;DO THE CALCULATION
 3570:      0DD6 AF 83          	MOV	R7,DPH		;SAVE MATRIX ALLOCATION
 3571:      0DD8 AE 82          	MOV	R6,DPL
 3572:      0DDA 90 01 06       	MOV	DPTR,#ST_ALL	;SEE IF TOO MUCH MEMOR
 3573:      0DDD 12 15 B0       	CALL	FUL1		;ST_ALL SHOULD BE > R3:R1
 3574:      0DE0 90 01 08       	MOV	DPTR,#MT_ALL	;SAVE THE NEW MATRIX P
 3575:      0DE3 12 06 05       	CALL	S31DP
 3576:      0DE6 88 82          	MOV	DPL,R0		;GET VARIABLE ADDRESS
 3577:      0DE8 8A 83          	MOV	DPH,R2
 3578:      0DEA EC             	MOV	A,R4		;DIMENSION SIZE
 3579:      0DEB F0             	MOVX	@DPTR,A 	;SAVE IT
 3580:      0DEC 12 05 C0       	CALL	DECDP2		;SAVE TARGET ADDRESS
 3581:                          	;
 3582:      0DEF EF             R76S:	MOV	A,R7
 3583:      0DF0 F0             	MOVX	@DPTR,A
 3584:      0DF1 A3             	INC	DPTR
 3585:      0DF2 EE             	MOV	A,R6		;ELEMENT SIZE
 3586:      0DF3 F0             	MOVX	@DPTR,A
 3587:      0DF4 22             	RET			;R2:R0 STILL HAS SYMBOL TABLE ADD
 3588:                          	;
 3589:                          	;**************************************
 3590:                          	;
 3591:                          	; The statement action routine - INPUT
 3592:                          	;
 3593:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 66



 Line    I  Addr Code           Source

 3594:                          	;
 3595:      0DF5 D1 A9          SINPUT: ACALL	CPS		;PRINT STRING IF THER
 3596:                          	;
 3597:      0DF7 D1 C6          	ACALL	C_TST		;CHECK FOR A COMMA
 3598:      0DF9 50 07          	JNC	IN2A		;NO CRLF
 3599:      0DFB 91 3C          	ACALL	SP0		;DO A CRLF
 3600:                          	;
 3601:      0DFD 7D 3F          IN2:	MOV	R5,#'?'         ;OUTPUT A ?
 3602:      0DFF 12 07 11       	CALL	TEROT
 3603:                          	;
 3604:      0E02 D2 22          IN2A:	SETB	INP_B		;DOING INPUT
 3605:      0E04 12 06 D8       	CALL	INLINE		;INPUT THE LINE
 3606:      0E07 C2 22          	CLR	INP_B
 3607:      0E09 75 0F 00       	MOV	TEMP5,#HIGH IBUF
 3608:      0E0C 75 0E 07       	MOV	TEMP4,#LOW IBUF
 3609:                          	;
 3610:      0E0F D1 BF          IN3:	ACALL	S_C		;SEE IF A STRING
 3611:      0E11 40 0D          	JC	IN3A		;IF CARRY IS SET, NO STRING
 3612:      0E13 B1 AD          	ACALL	X3120		;FLIP THE ADDRESSES
 3613:      0E15 AB 0F          	MOV	R3,TEMP5
 3614:      0E17 A9 0E          	MOV	R1,TEMP4
 3615:      0E19 31 9D          	ACALL	SSOOP
 3616:      0E1B D1 C6          	ACALL	C_TST		;SEE IF MORE TO DO
 3617:      0E1D 50 DE          	JNC	IN2
 3618:      0E1F 22             	RET
 3619:                          	;
 3620:      0E20 12 18 4D       IN3A:	CALL	DTEMP		;GET THE USER LOCATION
 3621:      0E23 12 19 57       	CALL	GET_NUM 	;GET THE USER SUPPLIED NU
 3622:      0E26 70 18          	JNZ	IN5		;ERROR IF NOT ZERO
 3623:      0E28 12 18 54       	CALL	TEMPD		;SAVE THE DATA POINTER
 3624:      0E2B F1 01          	ACALL	VAR_ER		;GET THE VARIABLE
 3625:      0E2D F1 D1          	ACALL	XPOP		;SAVE THE VARIABLE
 3626:      0E2F 12 18 4D       	CALL	DTEMP		;GET DPTR BACK FROM VAR_ER
 3627:      0E32 D1 C6          	ACALL	C_TST		;SEE IF MORE TO DO
 3628:      0E34 40 13          	JC	IN6		;EXIT IF NO COMMA
 3629:      0E36 E0             	MOVX	A,@DPTR 	;GET INPUT TERMINATOR
 3630:      0E37 B4 2C 06       	CJNE	A,#',',IN5      ;IF NOT A COMMA DO
 3631:      0E3A A3             	INC	DPTR		;BUMP PAST COMMA AND READ NEX
 3632:      0E3B 12 18 54       	CALL	TEMPD
 3633:      0E3E 80 CF          	SJMP	IN3
 3634:                          	;
 3635:      0E40 90 00 F3       IN5:	MOV	DPTR,#IAN	;PRINT INPUT A NUMBER
 3636:      0E43 12 06 AD       	CALL	CRP		;DO A CR, THEN, PRINT FROM RO
 3637:      0E46 02 18 44       	LJMP	CC1		;TRY IT AGAIN
 3638:                          	;
 3639:      0E49 E0             IN6:	MOVX	A,@DPTR
 3640:      0E4A B4 0D 01       	CJNE	A,#CR,EIGP
 3641:      0E4D 22             	RET
 3642:                          	;
 3643:      0E4E 90 03 6D       EIGP:	MOV	DPTR,#EIG
 3644:      0E51 12 06 AD       	CALL	CRP		;PRINT THE MESSAGE AND EXIT
 3645:      0E54 81 3C          	AJMP	SP0		;EXIT WITH A CRLF
 3646:                          	;
 3647:                          	;**************************************
 3648:                          	;
 3649:                          SOT:	; On timer interrupt

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 67



 Line    I  Addr Code           Source

 3650:                          	;
 3651:                          	;**************************************
 3652:                          	;
 3653:      0E56 D1 85          	ACALL	TWO		;GET THE NUMBERS
 3654:      0E58 8B 4B          	MOV	SP_H,R3
 3655:      0E5A 89 4C          	MOV	SP_L,R1
 3656:      0E5C 90 01 26       	MOV	DPTR,#TIV	;SAVE THE NUMBER
 3657:      0E5F D2 10          	SETB	OTS
 3658:      0E61 A1 EF          	AJMP	R76S		;EXIT
 3659:                          	;
 3660:                          	;
 3661:                          	;**************************************
 3662:                          	;
 3663:                          SCALL:	; Call a user rountine
 3664:                          	;
 3665:                          	;**************************************
 3666:                          	;
 3667:      0E63 F1 30          	ACALL	INTERR		;CONVERT INTEGER
 3668:      0E65 BA 00 0A       	CJNE	R2,#0,S_C_1	;SEE IF TRAP
 3669:      0E68 E8             	MOV	A,R0
 3670:      0E69 20 E7 06       	JB	ACC.7,S_C_1
 3671:      0E6C 28             	ADD	A,R0
 3672:      0E6D 90 41 00       	MOV	DPTR,#4100H
 3673:      0E70 F5 82          	MOV	DPL,A
 3674:                          	;
 3675:      0E72 31 6C          S_C_1:	ACALL	AC1		;JUMP TO USER PROGRAM
 3676:      0E74 53 D0 E7       	ANL	PSW,#11100111B	;BACK TO BANK 0
 3677:      0E77 22             	RET			;EXIT
 3678:                          	;
 3679:                          	;**************************************
 3680:                          	;
 3681:                          THREE:	; Save value for timer function
 3682:                          	;
 3683:                          	;**************************************
 3684:                          	;
 3685:      0E78 D1 8E          	ACALL	ONE		;GET THE FIRST INTEGER
 3686:      0E7A 12 16 7B       	CALL	CBIAS		;BIAS FOR TIMER LOAD
 3687:      0E7D 8B 40          	MOV	T_HH,R3
 3688:      0E7F 89 41          	MOV	T_LL,R1
 3689:      0E81 7F 2C          	MOV	R7,#','         ;WASTE A COMMA
 3690:      0E83 91 E5          	ACALL	EATC		;FALL THRU TO TWO
 3691:                          	;
 3692:                          	;**************************************
 3693:                          	;
 3694:                          TWO:	; Get two values seperated by a com
 3695:                          	;
 3696:                          	;**************************************
 3697:                          	;
 3698:      0E85 F1 43          	ACALL	EXPRB
 3699:      0E87 7F 2C          	MOV	R7,#','         ;WASTE THE COMMA
 3700:      0E89 F1 41          	ACALL	WE
 3701:      0E8B 02 14 A1       	JMP	TWOL		;EXIT
 3702:                          	;
 3703:                          	;**************************************
 3704:                          	;
 3705:                          ONE:	; Evaluate an expression and get an

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 68



 Line    I  Addr Code           Source

 3706:                          	;
 3707:                          	;**************************************
 3708:                          	;
 3709:      0E8E F1 43          	ACALL	EXPRB		;EVALUATE EXPERSSION
 3710:                          	;
 3711:      0E90 12 12 23       IFIXL:	CALL	IFIX		;INTEGERS IN R3:R1
 3712:      0E93 E9             	MOV	A,R1
 3713:      0E94 22             	RET
 3714:                          	;
 3715:                          	;
 3716:                          	;**************************************
 3717:                          	;
 3718:                          I_PI:	; Increment text pointer then get 
 3719:                          	;
 3720:                          	;**************************************
 3721:                          	;
 3722:      0E95 D1 D7          	ACALL	GCI1		;BUMP TEXT, THEN GET INTEGE
 3723:                          	;
 3724:                          PAREN_INT:; Get an integer in parens ( )
 3725:                          	;
 3726:      0E97 91 DF          	ACALL	P_E
 3727:      0E99 80 F5          	SJMP	IFIXL
 3728:                          	;
 3729:      0E9B 85 13 83       DP_B:	MOV	DPH,BOFAH
 3730:      0E9E 85 14 82       	MOV	DPL,BOFAL
 3731:      0EA1 22             	RET
 3732:                          	;
 3733:      0EA2 85 0A 83       DP_T:	MOV	DPH,TXAH
 3734:      0EA5 85 08 82       	MOV	DPL,TXAL
 3735:      0EA8 22             	RET
 3736:                          	;
 3737:      0EA9 D1 CD          CPS:	ACALL	GC		;GET THE CHARACTER
 3738:      0EAB B4 22 73       	CJNE	A,#'"',NOPASS   ;EXIT IF NO STRING
 3739:      0EAE D1 A2          	ACALL	DP_T		;GET TEXT POINTER
 3740:      0EB0 A3             	INC	DPTR		;BUMP PAST "
 3741:      0EB1 7C 22          	MOV	R4,#'"'
 3742:      0EB3 12 06 C3       	CALL	PN0		;DO THE PRINT
 3743:      0EB6 A3             	INC	DPTR		;GO PAST QUOTE
 3744:      0EB7 C3             	CLR	C		;PASSED TEST
 3745:                          	;
 3746:      0EB8 85 83 0A       T_DP:	MOV	TXAH,DPH	;TEXT POINTER GETS DP
 3747:      0EBB 85 82 08       	MOV	TXAL,DPL
 3748:      0EBE 22             	RET
 3749:                          	;
 3750:                          	;**************************************
 3751:                          	;
 3752:                          S_C:	; Check for a string
 3753:                          	;
 3754:                          	;**************************************
 3755:                          	;
 3756:      0EBF D1 CD          	ACALL	GC		;GET THE CHARACTER
 3757:      0EC1 B4 24 5D       	CJNE	A,#'$',NOPASS   ;SET CARRY IF NOT 
 3758:      0EC4 21 E7          	AJMP	IST_CAL 	;CLEAR CARRY, CALCULATE O
 3759:                          	;
 3760:                          	;
 3761:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 69



 Line    I  Addr Code           Source

 3762:                          	;**************************************
 3763:                          	;
 3764:      0EC6 D1 CD          C_TST:	ACALL	GC		;GET A CHARACTER
 3765:      0EC8 B4 2C 56       	CJNE	A,#',',NOPASS   ;SEE IF A COMMA
 3766:                          	;
 3767:                          	;**************************************
 3768:                          	;
 3769:                          	;GC AND GCI - GET A CHARACTER FROM TEXT
 3770:                          	;	      PUT CHARACTER IN THE ACC
 3771:                          	;
 3772:                          	;**************************************
 3773:                          	;
 3774:      0ECB D1 D7          IGC:	ACALL	GCI1		;BUMP POINTER, THEN GET
 3775:                          	;
 3776:      0ECD D2 D3          GC:	SETB	RS0		;USE BANK 1
 3777:      0ECF 8A A0          	MOV	P2,R2		;SET UP PORT 2
 3778:      0ED1 E2             	MOVX	A,@R0		;GET EXTERNAL BYTE
 3779:      0ED2 C2 D3          	CLR	RS0		;BACK TO BANK 0
 3780:      0ED4 22             	RET			;EXIT
 3781:                          	;
 3782:      0ED5 D1 CD          GCI:	ACALL	GC
 3783:                          	;
 3784:                          	; This routine bumps txa by one and alw
 3785:                          	;
 3786:      0ED7 D2 D3          GCI1:	SETB	RS0		;BANK 1
 3787:      0ED9 08             	INC	R0		;BUMP TXA
 3788:      0EDA B8 00 01       	CJNE	R0,#0,GCI11
 3789:      0EDD 0A             	INC	R2
 3790:      0EDE C2 D3          GCI11:	CLR	RS0
 3791:      0EE0 22             	RET			;EXIT
 3792:                          	;
 3793:                          	;**************************************
 3794:                          	;
 3795:                          	; Check delimiters
 3796:                          	;
 3797:                          	;**************************************
 3798:                          	;
 3799:      0EE1 D1 CD          DELTST: ACALL	GC		;GET A CHARACTER
 3800:      0EE3 B4 0D 02       DELTST1:CJNE	A,#CR,DT1	;SEE IF A CR
 3801:      0EE6 E4             	CLR	A
 3802:      0EE7 22             	RET
 3803:                          	;
 3804:      0EE8 B4 3A 36       DT1:	CJNE	A,#':',NOPASS   ;SET CARRY IF 
 3805:                          	;
 3806:      0EEB 22             L_RET:	RET
 3807:                          	;
 3808:                          	;
 3809:                          	;**************************************
 3810:                          	;
 3811:                          	; FINDC - Find the character in R7, upd
 3812:                          	;
 3813:                          	;**************************************
 3814:                          	;
 3815:      0EEC 7F 0D          FINDCR: MOV	R7,#CR		;KILL A STATEMENT LI
 3816:                          	;
 3817:      0EEE D1 E1          FINDC:	ACALL	DELTST

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 70



 Line    I  Addr Code           Source

 3818:      0EF0 50 F9          	JNC	L_RET
 3819:                          	;
 3820:      0EF2 B5 07 01       	CJNE	A,R7B0,FNDCL2	;MATCH?
 3821:      0EF5 22             	RET
 3822:                          	;
 3823:      0EF6 D1 D7          FNDCL2: ACALL	GCI1
 3824:      0EF8 80 F4          	SJMP	FINDC		;LOOP
 3825:                          	;
 3826:      0EFA D1 D7          FNDCL3: ACALL	GCI1
 3827:                          	;
 3828:      0EFC D1 E1          WCR:	ACALL	DELTST		;WASTE UNTIL A "REAL"
 3829:      0EFE 70 FA          	JNZ	FNDCL3
 3830:      0F00 22             	RET
 3831:                          	;
 3832:                          	;**************************************
 3833:                          	;
 3834:                          	; VAR_ER - Check for a variable, exit i
 3835:                          	;
 3836:                          	;**************************************
 3837:                          	;
 3838:      0F01 B1 65          VAR_ER: ACALL	VAR
 3839:      0F03 80 2D          	SJMP	INTERR1
 3840:                          	;
 3841:                          	;
 3842:                          	;**************************************
 3843:                          	;
 3844:                          	; S_D0 - The Statement Action Routine D
 3845:                          	;
 3846:                          	;**************************************
 3847:                          	;
 3848:      0F05 71 BD          S_DO:	ACALL	CSC		;FINISH UP THE LINE
 3849:      0F07 7C 03          	MOV	R4,#DTYPE	;TYPE FOR STACK
 3850:      0F09 71 35          	ACALL	SGS1		;SAVE ON STACK
 3851:      0F0B 01 13          	AJMP	ILOOP		;EXIT
 3852:                          	;
 3853:                          	;**************************************
 3854:                          	;
 3855:                          	; CLN_UP - Clean up the end of a statem
 3856:                          	;	   file, eat character and line count
 3857:                          	;
 3858:                          	;**************************************
 3859:                          	;
 3860:      0F0D B4 3A 02       C_2:	CJNE	A,#':',C_1      ;SEE IF A TERM
 3861:      0F10 C1 D7          	AJMP	GCI1		;BUMP POINTER AND EXIT, IF S
 3862:                          	;
 3863:      0F12 B4 A8 6D       C_1:	CJNE	A,#T_ELSE,EP5
 3864:      0F15 D1 FC          	ACALL	WCR		;WASTE UNTIL A CR
 3865:                          	;
 3866:      0F17 D1 CD          CLN_UP: ACALL	GC		;GET THE CHARACTER
 3867:      0F19 B4 0D F1       	CJNE	A,#CR,C_2	;SEE IF A CR
 3868:      0F1C D1 CB          	ACALL	IGC		;GET THE NEXT CHARACTER
 3869:      0F1E B4 01 02       	CJNE	A,#EOF,B_TXA	;SEE IF TERMINATOR
 3870:                          	;
 3871:      0F21 D3             NOPASS: SETB	C
 3872:      0F22 22             	RET
 3873:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 71



 Line    I  Addr Code           Source

 3874:      0F23 C5 08          B_TXA:	XCH	A,TXAL		;BUMP TXA BY THREE
 3875:      0F25 24 03          	ADD	A,#3
 3876:      0F27 C5 08          	XCH	A,TXAL
 3877:      0F29 10 D7 01       	JBC	CY,B_TXA1
 3878:      0F2C 22             	RET
 3879:      0F2D 05 0A          B_TXA1: INC	TXAH
 3880:      0F2F 22             	RET
 3881:                          	;
 3882:                          	;**************************************
 3883:                          	;
 3884:                          	;	  Get an INTEGER from the text
 3885:                          	;	  sets CARRY if not found
 3886:                          	;	  returns the INTGER value in DPTR an
 3887:                          	;	  returns the terminator in ACC
 3888:                          	;
 3889:                          	;**************************************
 3890:                          	;
 3891:      0F30 F1 35          INTERR: ACALL	INTGER		;GET THE INTEGER
 3892:      0F32 40 4E          INTERR1:JC	EP5		;ERROR IF NOT FOUND
 3893:      0F34 22             	RET			;EXIT IF FOUND
 3894:                          	;
 3895:      0F35 D1 A2          INTGER: ACALL	DP_T
 3896:      0F37 12 19 81       	CALL	FP_BASE9	;CONVERT THE INTEGER
 3897:      0F3A D1 B8          	ACALL	T_DP
 3898:      0F3C 8A 83          	MOV	DPH,R2		;PUT THE RETURNED VALUE IN 
 3899:      0F3E 88 82          	MOV	DPL,R0
 3900:                          	;
 3901:      0F40 22             ITRET:	RET			;EXIT
 3902:                          	;
 3903:                          	;
 3904:      0F41 91 E5          WE:	ACALL	EATC		;WASTE THE CHARACTER
 3905:                          	;
 3906:                          	; Fall thru to evaluate the expression
 3907:                          	;
 3908:                          	;**************************************
 3909:                          	;
 3910:                          	; EXPRB - Evaluate an expression
 3911:                          	;
 3912:                          	;**************************************
 3913:                          	;
 3914:      0F43 7A CF          EXPRB:	MOV	R2,#LOW OPBOL	;BASE PRECEDENC
 3915:                          	;
 3916:      0F45 C0 02          EP1:	PUSH	R2B0		;SAVE OPERATOR PRECEDENC
 3917:      0F47 C2 24          	CLR	ARGF		;RESET STACK DESIGNATOR
 3918:                          	;
 3919:      0F49 E5 81          EP2:	MOV	A,SP		;GET THE STACK POINTER
 3920:      0F4B 24 0C          	ADD	A,#12		;NEED AT LEAST 12 BYTES
 3921:      0F4D 50 03          	JNC	EP21
 3922:      0F4F 02 18 8C       	LJMP	E1XX2
 3923:      0F52 E5 09          EP21:	MOV	A,ASTKA 	;GET THE ARG STACK
 3924:      0F54 94 38          	SUBB	A,#LOW TM_TOP+12;NEED 12 BYTES ALS
 3925:      0F56 50 03          	JNC	EP22
 3926:      0F58 02 12 1A       	LJMP	E4YY
 3927:      0F5B 20 24 13       EP22:	JB	ARGF,EP4	;MUST BE AN OPERATOR, 
 3928:      0F5E B1 65          	ACALL	VAR		;IS THE VALUE A VARIABLE?
 3929:      0F60 50 0D          	JNC	EP3		;PUT VARIABLE ON STACK

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 72



 Line    I  Addr Code           Source

 3930:                          	;
 3931:      0F62 F1 EF          	ACALL	CONST		;IS THE VALUE A NUMERIC CO
 3932:      0F64 50 0B          	JNC	EP4		;IF SO, CONTINUE, IF NOT, SEE 
 3933:      0F66 D1 CD          	CALL	GC		;GET THE CHARACTER
 3934:      0F68 B4 E0 06       	CJNE	A,#T_LPAR,EP4	;SEE IF A LEFT PAREN
 3935:      0F6B 74 D0          	MOV	A,#(LOW OPBOL+1)
 3936:      0F6D 80 55          	SJMP	XLPAR		;PROCESS THE LEFT PAREN
 3937:                          	;
 3938:      0F6F F1 DD          EP3:	ACALL	PUSHAS		;SAVE VAR ON STACK
 3939:                          	;
 3940:      0F71 D1 CD          EP4:	ACALL	GC		;GET THE OPERATOR
 3941:                          	;
 3942:      0F73 B4 E0 00       	CJNE	A,#T_LPAR,EP41	;IS IT AN OPERATOR
 3943:      0F76 50 0E          EP41:	JNC	XOP		;PROCESS OPERATOR
 3944:      0F78 B4 B0 00       	CJNE	A,#T_UOP,EP42	;IS IT A UNARY OPERA
 3945:      0F7B 50 3B          EP42:	JNC	XBILT		;PROCESS UNARY (BUILT I
 3946:      0F7D D0 02          	POP	R2B0		;GET BACK PREVIOUS OPERATOR P
 3947:      0F7F 20 24 BE       	JB	ARGF,ITRET	;OK IF ARG FLAG IS SET
 3948:                          	;
 3949:      0F82 C3             EP5:	CLR	C		;NO RECOVERY
 3950:      0F83 02 18 87       	LJMP	E1XX1
 3951:                          	;
 3952:                          	; Process the operator
 3953:                          	;
 3954:      0F86 54 1F          XOP:	ANL	A,#1FH		;STRIP OFF THE TOKE BIT
 3955:      0F88 20 24 05       	JB	ARGF,XOP1	;IF ARG FLAG IS SET, PROCE
 3956:      0F8B B4 05 3C       	CJNE	A,#T_SUB-T_LPAR,XOP3
 3957:      0F8E 74 09          	MOV	A,#T_NEG-T_LPAR
 3958:                          	;
 3959:      0F90 24 D0          XOP1:	ADD	A,#LOW OPBOL+1	;BIAS THE TABLE
 3960:      0F92 FA             	MOV	R2,A
 3961:      0F93 90 00 00       	MOV	DPTR,#00H
 3962:      0F96 93             	MOVC	A,@A+DPTR	;GET THE CURRENT PRECEDE
 3963:      0F97 FC             	MOV	R4,A
 3964:      0F98 D0 E0          	POP	ACC		;GET THE PREVIOUS PRECEDENCE
 3965:      0F9A FD             	MOV	R5,A		;SAVE THE PREVIOUS PRECEDENCE
 3966:      0F9B 93             	MOVC	A,@A+DPTR	;GET IT
 3967:      0F9C B5 04 04       	CJNE	A,R4B0,XOP11	;SEE WHICH HAS HIGHER
 3968:      0F9F B4 0C 9E       	CJNE	A,#12,ITRET	;SEE IF ANEG
 3969:      0FA2 D3             	SETB	C
 3970:      0FA3 50 9B          XOP11:	JNC	ITRET		;PROCESS NON-INCREASIN
 3971:                          	;
 3972:                          	; Save increasing precedence
 3973:                          	;
 3974:      0FA5 C0 05          	PUSH	R5B0		;SAVE OLD PRECEDENCE ADDRESS
 3975:      0FA7 C0 02          	PUSH	R2B0		;SAVE NEW PRECEDENCE ADDRESS
 3976:      0FA9 D1 D7          	ACALL	GCI1		;EAT THE OPERATOR
 3977:      0FAB F1 45          	ACALL	EP1		;EVALUATE REMAINING EXPRESSI
 3978:      0FAD D0 E0          XOP12:	POP	ACC
 3979:                          	;
 3980:                          	; R2 has the action address, now setup 
 3981:                          	;
 3982:      0FAF 90 00 57       XOP2:	MOV	DPTR,#OPTAB
 3983:      0FB2 24 30          	ADD	A,#LOW (NOT OPBOL)
 3984:      0FB4 31 5C          	CALL	ISTA1		;SET UP TO RETURN TO EP2
 3985:      0FB6 E1 49          	AJMP	EP2		;JUMP TO EVALUATE EXPRESSION

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 73



 Line    I  Addr Code           Source

 3986:                          	;
 3987:                          	; Built-in operator processing
 3988:                          	;
 3989:      0FB8 D1 D7          XBILT:	ACALL	GCI1		;EAT THE TOKEN
 3990:      0FBA 24 30          	ADD	A,#LOW (50H+LOW UOPBOL)
 3991:      0FBC 20 24 C3       	JB	ARGF,EP5	;XBILT MUST COME AFTER AN O
 3992:      0FBF B4 EE 00       	CJNE	A,#STP,XBILT1
 3993:      0FC2 50 EB          XBILT1: JNC	XOP2
 3994:                          	;
 3995:      0FC4 C0 E0          XLPAR:	PUSH	ACC		;PUT ADDRESS ON THE STA
 3996:      0FC6 91 DF          	ACALL	P_E
 3997:      0FC8 80 E3          	SJMP	XOP12		;PERFORM OPERATION
 3998:                          	;
 3999:      0FCA B4 03 B5       XOP3:	CJNE	A,#T_ADD-T_LPAR,EP5
 4000:      0FCD D1 D7          	ACALL	GCI1
 4001:      0FCF E1 49          	AJMP	EP2		;WASTE + SIGN
 4002:                          	;
 4003:      0FD1 B1 AD          XPOP:	ACALL	X3120		;FLIP ARGS THEN POP
 4004:                          	;
 4005:                          	;**************************************
 4006:                          	;
 4007:                          	; POPAS - Pop arg stack and copy variab
 4008:                          	;
 4009:                          	;**************************************
 4010:                          	;
 4011:      0FD3 12 12 4F       POPAS:	LCALL	INC_ASTKA
 4012:      0FD6 02 14 72       	JMP	VARCOP		;COPY THE VARIABLE
 4013:                          	;
 4014:      0FD9 7A 01          AXTAL:	MOV	R2,#HIGH CXTAL
 4015:      0FDB 78 13          	MOV	R0,#LOW CXTAL
 4016:                          	;
 4017:                          	; fall thru
 4018:                          	;
 4019:                          	;**************************************
 4020:                          	;
 4021:                          PUSHAS: ; Push the Value addressed by R2
 4022:                          	;
 4023:                          	;**************************************
 4024:                          	;
 4025:      0FDD 12 12 0B       	CALL	DEC_ASTKA
 4026:      0FE0 D2 24          	SETB	ARGF		;SAYS THAT SOMTHING IS ON TH
 4027:      0FE2 02 14 72       	LJMP	VARCOP
 4028:                          	;
 4029:                          	;
 4030:                          	;**************************************
 4031:                          	;
 4032:                          ST_A:	; Store at expression
 4033:                          	;
 4034:                          	;**************************************
 4035:                          	;
 4036:      0FE5 D1 8E          	ACALL	ONE		;GET THE EXPRESSION
 4037:      0FE7 80 EA          	SJMP	POPAS		;SAVE IT
 4038:                          	;
 4039:                          	;
 4040:                          	;**************************************
 4041:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 74



 Line    I  Addr Code           Source

 4042:                          LD_A:	; Load at expression
 4043:                          	;
 4044:                          	;**************************************
 4045:                          	;
 4046:      0FE9 D1 8E          	ACALL	ONE		;GET THE EXPRESSION
 4047:      0FEB B1 AD          	ACALL	X3120		;FLIP ARGS
 4048:      0FED 80 EE          	SJMP	PUSHAS
 4049:                          	;
 4050:                          	;**************************************
 4051:                          	;
 4052:                          CONST:	; Get a constant fron the text
 4053:                          	;
 4054:                          	;**************************************
 4055:                          	;
 4056:      0FEF D1 CD          	CALL	GC		;FIRST SEE IF LITERAL
 4057:      0FF1 B4 D1 31       	CJNE	A,#T_ASC,C0C	;SEE IF ASCII TOKEN
 4058:      0FF4 D1 CB          	CALL	IGC		;GET THE CHARACTER AFTER TOKE
 4059:      0FF6 B4 24 05       	CJNE	A,#'$',CN0      ;SEE IF A STRING
 4060:                          	;
 4061:      0FF9 51 1E          CNX:	CALL	CSY		;CALCULATE IT
 4062:      0FFB 02 13 C0       	JMP	AXBYTE1 	;SAVE IT ON THE STACK
 4063:                          ;
 4064:                          ;***************************************
 4065:                          ;****** Correct ASC(x) bug *************
 4066:                          ;****** Wulf 5 *************************
 4067:                          ;
 4068:                          ;
 4069:      0FFE 30 E7 1B       CN0:	jnb	acc.7,cn0t	;jump if possibly as
 4070:      1001 90 01 75       	mov	dptr,#toktab
 4071:      1004 FE             	mov	r6,a		;save search token
 4072:      1005 F4             cn0t1:	cpl	a
 4073:      1006 60 13          	jz	cn0t4		;jump if EOT
 4074:      1008 E4             	clr	a
 4075:      1009 93             	movc	a,@a+dptr	;read token from token t
 4076:      100A A3             	inc	dptr
 4077:      100B B5 06 F7       	cjne	a,r6b0,cn0t1	;jump if wrong entry
 4078:                          	;
 4079:      100E FD             	mov	r5,a		;save search token
 4080:      100F E4             	clr	a
 4081:      1010 93             cn0t2:	movc	a,@a+dptr
 4082:      1011 FE             	mov	r6,a		;save first ascii of token te
 4083:                          	;
 4084:      1012 E4             cn0t3:	clr	a
 4085:      1013 93             	movc	a,@a+dptr
 4086:      1014 A3             	inc	dptr
 4087:      1015 30 E7 FA       	jnb	acc.7,cn0t3	;jump if possibly ascii
 4088:                          	;
 4089:      1018 6D             	xrl	a,r5
 4090:      1019 60 F5          	jz	cn0t2		;jump if same search token ag
 4091:                          	;
 4092:      101B EE             cn0t4:	mov	a,r6		;get saved ascii
 4093:      101C 12 14 B1       CN0t:	CALL	TWO_R2		;PUT IT ON THE STACK
 4094:                          ;
 4095:                          ;****** continue with original code: ***
 4096:                          ;
 4097:      101F 12 0E D7       	CALL	GCI1		;BUMP THE POINTER

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 75



 Line    I  Addr Code           Source

 4098:      1022 02 0C E3       	JMP	ERPAR		;WASTE THE RIGHT PAREN
 4099:                          	;
 4100:      1025 12 0E A2       C0C:	CALL	DP_T		;GET THE TEXT POINTER
 4101:      1028 12 19 57       	CALL	GET_NUM 	;GET THE NUMBER
 4102:      102B B4 FF 02       	CJNE	A,#0FFH,C1C	;SEE IF NO NUMBER
 4103:      102E D3             	SETB	C
 4104:      102F 22             C2C:	RET
 4105:                          	;
 4106:      1030 70 06          C1C:	JNZ	FPTST
 4107:      1032 C3             	CLR	C
 4108:      1033 D2 24          	SETB	ARGF
 4109:                          	;
 4110:      1035 02 0E B8       C3C:	JMP	T_DP
 4111:                          	;
 4112:      1038 54 0B          FPTST:	ANL	A,#00001011B	;CHECK FOR ERROR
 4113:      103A 60 F3          	JZ	C2C		;EXIT IF ZERO
 4114:                          	;
 4115:                          	; Handle the error condition
 4116:                          	;
 4117:      103C 90 17 51       	MOV	DPTR,#E2X	;DIVIDE BY ZERO
 4118:      103F 30 E0 03       	JNB	ACC.0,FPTST1	;UNDERFLOW
 4119:      1042 90 18 04       	MOV	DPTR,#E7X
 4120:      1045 30 E1 03       FPTST1: JNB	ACC.1,FPTS	;OVERFLOW
 4121:      1048 90 1F 89       	MOV	DPTR,#E11X
 4122:                          	;
 4123:      104B 02 18 8F       FPTS:	JMP	ERROR
 4124:                          	;
 4125:                          	;**************************************
 4126:                          	;
 4127:                          	; The Command action routine - LIST
 4128:                          	;
 4129:                          	;**************************************
 4130:                          	;
 4131:      104E 12 0C 19       CLIST:	CALL	NUMC		;SEE IF TO LINE PORT
 4132:      1051 71 CB          	ACALL	FSTK		;PUT 0FFFFH ON THE STACK
 4133:      1053 12 0F 35       	CALL	INTGER		;SEE IF USER SUPPLIES LN
 4134:      1056 E4             	CLR	A		;LN = 0 TO START
 4135:      1057 FB             	MOV	R3,A
 4136:      1058 F9             	MOV	R1,A
 4137:      1059 40 14          	JC	CL1		;START FROM ZERO
 4138:                          	;
 4139:      105B 12 18 54       	CALL	TEMPD		;SAVE THE START ADDTESS
 4140:      105E 12 0E D5       	CALL	GCI		;GET THE CHARACTER AFTER LIST
 4141:      1061 B4 E5 07       	CJNE	A,#T_SUB,CLIST1 ;CHECK FOR TERMINA
 4142:      1064 51 4F          	ACALL	INC_ASTKA	;WASTE 0FFFFH
 4143:      1066 12 0F 30       	LCALL	INTERR		;GET TERMINATION ADDRESS
 4144:      1069 91 B4          	ACALL	TWO_EY		;PUT TERMINATION ON THE A
 4145:      106B AB 0F          CLIST1: MOV	R3,TEMP5	;GET THE START ADDT
 4146:      106D A9 0E          	MOV	R1,TEMP4
 4147:                          	;
 4148:      106F 12 05 8C       CL1:	CALL	GETLIN		;GET THE LINE NO IN R3
 4149:      1072 60 1E          	JZ	CL3		;RET IF AT END
 4150:                          	;
 4151:      1074 11 35          CL2:	ACALL	C3C		;SAVE THE ADDRESS
 4152:      1076 A3             	INC	DPTR		;POINT TO LINE NUMBER
 4153:      1077 D1 52          	ACALL	PMTOP1		;PUT LINE NUMBER ON THE S

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 76



 Line    I  Addr Code           Source

 4154:      1079 51 08          	ACALL	CMPLK		;COMPARE LN TO END ADDRESS
 4155:      107B 40 15          	JC	CL3		;EXIT IF GREATER
 4156:      107D 12 07 8D       	CALL	BCK		;CHECK FOR A CONTROL C
 4157:      1080 51 0B          	ACALL	DEC_ASTKA	;SAVE THE COMPARE ADDRE
 4158:      1082 12 0E A2       	CALL	DP_T		;RESTORE ADDRESS
 4159:      1085 11 A3          	ACALL	UPPL		;UN-PROCESS THE LINE
 4160:      1087 11 35          	ACALL	C3C		;SAVE THE CR ADDRESS
 4161:      1089 11 94          	ACALL	CL6		;PRINT IT
 4162:      108B A3             	INC	DPTR		;BUMP POINTER TO NEXT LINE
 4163:      108C E0             	MOVX	A,@DPTR 	;GET LIN LENGTH
 4164:      108D D5 E0 E4       	DJNZ	ACC,CL2 	;LOOP
 4165:      1090 51 4F          	ACALL	INC_ASTKA	;WASTE THE COMPARE BYTE
 4166:                          	;
 4167:      1092 E1 87          CL3:	AJMP	CMND1		;BACK TO COMMAND PROCES
 4168:                          	;
 4169:      1094 90 00 07       CL6:	MOV	DPTR,#IBUF	;PRINT IBUF
 4170:      1097 12 06 C1       	CALL	PRNTCR		;PRINT IT
 4171:      109A 12 0E A2       	CALL	DP_T
 4172:                          	;
 4173:      109D 02 06 A5       CL7:	JMP	CRLF
 4174:                          	;
 4175:      10A0 12 05 79       UPPL0:	LCALL	X31DP
 4176:                          	;
 4177:                          	;**************************************
 4178:                          	;
 4179:                          	;UPPL - UN PREPROCESS A LINE ADDRESSED 
 4180:                          	;	RETURN SOURCE ADDRESS OF CR IN DPTR O
 4181:                          	;
 4182:                          	;**************************************
 4183:                          	;
 4184:      10A3 7B 00          UPPL:	MOV	R3,#HIGH IBUF	;POINT R3 AT HIG
 4185:      10A5 79 07          	MOV	R1,#LOW IBUF	;POINT R1 AT IBUF
 4186:      10A7 A3             	INC	DPTR		;SKIP OVER LINE LENGTH
 4187:                          ;
 4188:                          ;***************************************
 4189:                          ;****** Elektor 1 Patch ****************
 4190:                          ;
 4191:                          ;	ACALL	C3C		;SAVE THE DPTR (DP_T)
 4192:                          ;	CALL	L20DPI		;PUT LINE NUMBER IN R2:R0
 4193:                          ;	CALL	FP_BASE8	;CONVERT R2:R0 TO INTEGE
 4194:                          ;	CALL	DP_T
 4195:                          ;	INC	DPTR		;BUMP DPTR PAST THE LINE NUM
 4196:                          ;
 4197:                          ;****** Proper code starts here: *******
 4198:                          ;
 4199:      10A8 12 05 73       	lcall	L20DPI		;PUT LINE NUMBER IN R2:R0
 4200:      10AB 12 19 7F       	lcall	FP_BASE8	;CONVERT R2:R0 TO INTEGE
 4201:                          ;
 4202:                          ;****** continue with original code: ***
 4203:                          ;
 4204:      10AE B9 0D 00       UPP0:	CJNE	R1,#LOW IBUF+6,UPP01
 4205:      10B1 40 22          UPP01:	JC	UPP91		;PUT SPACES IN TEXT
 4206:      10B3 A3             	INC	DPTR		;BUMP PAST LN HIGH
 4207:      10B4 E0             	MOVX	A,@DPTR 	;GET USER TEXT
 4208:      10B5 FE             	MOV	R6,A		;SAVE A IN R6 FOR TOKE COMPAR
 4209:      10B6 20 E7 24       	JB	ACC.7,UPP1	;IF TOKEN, PROCESS

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 77



 Line    I  Addr Code           Source

 4210:      10B9 B4 20 00       	CJNE	A,#20H,UPP02	;TRAP THE USER TOKENS
 4211:      10BC 50 03          UPP02:	JNC	UPP03
 4212:      10BE B4 0D 1C       	CJNE	A,#CR,UPP1	;DO IT IF NOT A CR
 4213:      10C1 B4 22 09       UPP03:	CJNE	A,#'"',UPP9     ;SEE IF STRI
 4214:      10C4 31 21          	ACALL	UPP7		;SAVE IT
 4215:      10C6 31 23          UPP04:	ACALL	UPP8		;GET THE NEXT CHARACT
 4216:      10C8 B4 22 FB       	CJNE	A,#'"',UPP04    ;LOOP ON QUOTES
 4217:      10CB 80 E1          	SJMP	UPP0
 4218:                          	;
 4219:      10CD B4 3A 09       UPP9:	CJNE	A,#':',UPP1A    ;PUT A SPACE 
 4220:      10D0 31 1F          	ACALL	UPP7A
 4221:      10D2 EE             	MOV	A,R6
 4222:      10D3 31 21          	ACALL	UPP7
 4223:      10D5 31 1F          UPP91:	ACALL	UPP7A
 4224:      10D7 80 D5          	SJMP	UPP0
 4225:                          	;
 4226:      10D9 31 25          UPP1A:	ACALL	UPP81		;SAVE THE CHARACTER,
 4227:      10DB 80 D1          	SJMP	UPP0		;EXIT IF A CR, ELSE LOOP
 4228:                          	;
 4229:      10DD 11 35          UPP1:	ACALL	C3C		;SAVE THE TEXT POINTER
 4230:      10DF A2 2D          	MOV	C,XBIT
 4231:      10E1 92 D5          	MOV	F0,C		;SAVE XBIT IN F0
 4232:      10E3 90 01 75       UPP11:	MOV	DPTR,#TOKTAB	;POINT AT TOKEN 
 4233:      10E6 30 D5 03       	JNB	F0,UPP2
 4234:      10E9 12 20 78       	LCALL	2078H		;SET UP DPTR FOR LOOKUP
 4235:                          	;
 4236:      10EC E4             UPP2:	CLR	A		;ZERO A FOR LOOKUP
 4237:      10ED 93             	MOVC	A,@A+DPTR	;GET TOKEN
 4238:      10EE A3             	INC	DPTR		;ADVANCE THE TOKEN POINTER
 4239:      10EF B4 FF 05       	CJNE	A,#0FFH,UP_2	;SEE IF DONE
 4240:      10F2 10 D5 EE       	JBC	F0,UPP11	;NOW DO NORMAL TABLE
 4241:      10F5 E1 87          	AJMP	CMND1		;EXIT IF NOT FOUND
 4242:                          	;
 4243:      10F7 B5 06 F2       UP_2:	CJNE	A,R6B0,UPP2	;LOOP UNTIL THE S
 4244:                          	;
 4245:      10FA B4 B0 00       UP_3:	CJNE	A,#T_UOP,UP_4
 4246:      10FD 50 02          UP_4:	JNC	UPP3
 4247:      10FF 31 1F          	ACALL	UPP7A		;PRINT THE SPACE IF OK
 4248:                          	;
 4249:      1101 E4             UPP3:	CLR	A		;DO LOOKUP
 4250:      1102 93             	MOVC	A,@A+DPTR
 4251:      1103 20 E7 07       	JB	ACC.7,UPP4	;EXIT IF DONE, ELSE SAVE
 4252:      1106 60 05          	JZ	UPP4		;DONE IF ZERO
 4253:      1108 31 21          	ACALL	UPP7		;SAVE THE CHARACTER
 4254:      110A A3             	INC	DPTR
 4255:      110B 80 F4          	SJMP	UPP3		;LOOP
 4256:                          	;
 4257:      110D 12 0E A2       UPP4:	CALL	DP_T		;GET IT BACK
 4258:      1110 EE             	MOV	A,R6		;SEE IF A REM TOKEN
 4259:      1111 64 96          	XRL	A,#T_REM
 4260:      1113 70 04          	JNZ	UPP42
 4261:      1115 31 23          UPP41:	ACALL	UPP8
 4262:      1117 80 FC          	SJMP	UPP41
 4263:      1119 50 93          UPP42:	JNC	UPP0		;START OVER AGAIN IF NO
 4264:      111B 31 1F          	ACALL	UPP7A		;PRINT THE SPACE IF OK
 4265:      111D 80 8F          	SJMP	UPP0		;DONE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 78



 Line    I  Addr Code           Source

 4266:                          	;
 4267:      111F 74 20          UPP7A:	MOV	A,#' '          ;OUTPUT A SPA
 4268:                          	;
 4269:      1121 C1 44          UPP7:	AJMP	PPL91		;SAVE A
 4270:                          	;
 4271:      1123 A3             UPP8:	INC	DPTR
 4272:      1124 E0             	MOVX	A,@DPTR
 4273:      1125 B4 0D F9       UPP81:	CJNE	A,#CR,UPP7
 4274:      1128 C1 30          	AJMP	PPL71
 4275:                          	;
 4276:                          	;**************************************
 4277:                          	;
 4278:                          	; This table contains all of the floati
 4279:                          	;
 4280:                          	; The constants in ROM are stored "back
 4281:                          	; basic normally treats floating point 
 4282:                          	; loading from the exponent and decreme
 4283:                          	; ROM constants pointers load from the 
 4284:                          	; digits and increment the pointers. Th
 4285:                          	; arg stack loading faster and 2) compe
 4286:                          	; no decrement data pointer instruction
 4287:                          	;
 4288:                          	; The numbers are stored as follows:
 4289:                          	;
 4290:                          	; BYTE X+5    = MOST SIGNIFICANT DIGITS
 4291:                          	; BYTE X+4    = NEXT MOST SIGNIFICANT D
 4292:                          	; BYTE X+3    = NEXT LEAST SIGNIFICANT 
 4293:                          	; BYTE X+2    = LEAST SIGNIFICANT DIGIT
 4294:                          	; BYTE X+1    = SIGN OF THE ABOVE MANTI
 4295:                          	; BYTE X      = EXPONENT IN TWO'S COMPL
 4296:                          	;		ZERO EXPONENT = THE NUMBER ZERO
 4297:                          	;
 4298:                          	;**************************************
 4299:                          	;
 4300:      112A 7E             ATTAB:	DB	128-2		; ARCTAN LOOKUP
 4301:      112B 00             	DB	00H
 4302:      112C 57             	DB	57H
 4303:      112D 22             	DB	22H
 4304:      112E 66             	DB	66H
 4305:      112F 28             	DB	28H
 4306:                          	;
 4307:      1130 7F             	DB	128-1
 4308:      1131 01             	DB	01H
 4309:      1132 37             	DB	37H
 4310:      1133 57             	DB	57H
 4311:      1134 16             	DB	16H
 4312:      1135 16             	DB	16H
 4313:                          	;
 4314:      1136 7F             	DB	128-1
 4315:      1137 00             	DB	00H
 4316:      1138 14             	DB	14H
 4317:      1139 96             	DB	96H
 4318:      113A 90             	DB	90H
 4319:      113B 42             	DB	42H
 4320:                          	;
 4321:      113C 7F             	DB	128-1

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 79



 Line    I  Addr Code           Source

 4322:      113D 01             	DB	01H
 4323:      113E 40             	DB	40H
 4324:      113F 96             	DB	96H
 4325:      1140 28             	DB	28H
 4326:      1141 75             	DB	75H
 4327:                          	;
 4328:      1142 80             	DB	128
 4329:      1143 00             	DB	00H
 4330:      1144 64             	DB	64H
 4331:      1145 62             	DB	62H
 4332:      1146 65             	DB	65H
 4333:      1147 10             	DB	10H
 4334:                          	;
 4335:      1148 80             	DB	128
 4336:      1149 01             	DB	01H
 4337:      114A 99             	DB	99H
 4338:      114B 88             	DB	88H
 4339:      114C 20             	DB	20H
 4340:      114D 14             	DB	14H
 4341:                          	;
 4342:      114E 80             	DB	128
 4343:      114F 00             	DB	00H
 4344:      1150 51             	DB	51H
 4345:      1151 35             	DB	35H
 4346:      1152 99             	DB	99H
 4347:      1153 19             	DB	19H
 4348:                          	;
 4349:      1154 80             	DB	128
 4350:      1155 01             	DB	01H
 4351:      1156 45             	DB	45H
 4352:      1157 31             	DB	31H
 4353:      1158 33             	DB	33H
 4354:      1159 33             	DB	33H
 4355:                          	;
 4356:      115A 81             	DB	129
 4357:      115B 00             	DB	00H
 4358:      115C 00             	DB	00H
 4359:      115D 00             	DB	00H
 4360:      115E 00             	DB	00H
 4361:      115F 10             	DB	10H
 4362:                          	;
 4363:      1160 FF             	DB	0FFH		;END OF TABLE
 4364:                          	;
 4365:      1161 81             NTWO:	DB	129
 4366:      1162 00             	DB	0
 4367:      1163 00             	DB	0
 4368:      1164 00             	DB	0
 4369:      1165 00             	DB	0
 4370:      1166 20             	DB	20H
 4371:                          ;
 4372:                          ;***************************************
 4373:                          ;****** Use XTAL up to 47 MHz **********
 4374:                          ;****** Wulf 2 *************************
 4375:                          ;
 4376:                          ;TTIME: DB	128-4		; CLOCK CALCULATION
 4377:                          ;	DB	00H

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 80



 Line    I  Addr Code           Source

 4378:                          ;	DB	00H
 4379:                          ;	DB	00H
 4380:                          ;	DB	04H
 4381:                          ;	DB	13H
 4382:                          ;
 4383:      1167 7B             ttime:	db	128-5		;New clock calculation 
 4384:      1168 00             	db	00H		;16 bit mode
 4385:      1169 42             	db	42H
 4386:      116A 60             	db	60H
 4387:      116B 27             	db	27H
 4388:      116C 16             	db	16H
 4389:                          ;
 4390:                          ;***************************************
 4391:                          ;
 4392:                          	;**************************************
 4393:                          	;
 4394:                          	; COSINE - Add pi/2 to stack, then fall
 4395:                          	;
 4396:                          	;**************************************
 4397:                          	;
 4398:      116D 31 92          ACOS:	ACALL	POTWO		;PUT PI/2 ON THE STAC
 4399:      116F F1 41          	ACALL	AADD		;TOS = TOS+PI/2
 4400:                          	;
 4401:                          	;**************************************
 4402:                          	;
 4403:                          	; SINE - use taylor series to calculate
 4404:                          	;
 4405:                          	;**************************************
 4406:                          	;
 4407:      1171 91 7F          ASIN:	ACALL	PIPI		;PUT PI ON THE STACK
 4408:      1173 31 B5          	ACALL	RV		;REDUCE THE VALUE
 4409:      1175 E5 46          	MOV	A,MT2		;CALCULATE THE SIGN
 4410:      1177 54 01          	ANL	A,#01H		;SAVE LSB
 4411:      1179 62 45          	XRL	MT1,A		;SAVE SIGN IN MT1
 4412:      117B 91 2C          	ACALL	CSTAKA		;NOW CONVERT TO ONE QUADR
 4413:      117D 31 92          	ACALL	POTWO
 4414:      117F 51 08          	ACALL	CMPLK		;DO COMPARE
 4415:      1181 40 04          	JC	ASIN1
 4416:      1183 91 7F          	ACALL	PIPI
 4417:      1185 F1 1C          	ACALL	ASUB
 4418:      1187 71 8F          ASIN1:	ACALL	AABS
 4419:      1189 90 16 CE       	MOV	DPTR,#SINTAB	;SET UP LOOKUP TABLE
 4420:      118C 31 9B          	ACALL	POLYC		;CALCULATE THE POLY
 4421:      118E 31 DA          	ACALL	STRIP
 4422:      1190 21 FC          	AJMP	SIN0
 4423:                          	;
 4424:                          	; Put PI/2 on the stack
 4425:                          	;
 4426:      1192 91 7F          POTWO:	ACALL	PIPI		;PUT PI ON THE STACK,
 4427:                          	;
 4428:      1194 90 11 61       DBTWO:	MOV	DPTR,#NTWO
 4429:      1197 91 33          	ACALL	PUSHC
 4430:                          	;MOV	A,#2		;BY TWO
 4431:                          	;ACALL	TWO_R2
 4432:      1199 81 0A          	AJMP	ADIV
 4433:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 81



 Line    I  Addr Code           Source

 4434:                          	;**************************************
 4435:                          	;
 4436:                          POLYC:	; Expand a power series to calcul
 4437:                          	;
 4438:                          	;**************************************
 4439:                          	;
 4440:      119B 91 2A          	ACALL	CSTAKA2 	;COPY THE STACK
 4441:      119D 31 B0          	ACALL	AMUL		;SQUARE THE STACK
 4442:      119F 91 48          	ACALL	POP_T1		;SAVE X*X
 4443:      11A1 91 33          	ACALL	PUSHC		;PUT CONSTANT ON STACK
 4444:                          	;
 4445:      11A3 91 4F          POLY1:	ACALL	PUSH_T1 	;PUT COMPUTED VALU
 4446:      11A5 31 B0          	ACALL	AMUL		;MULTIPLY CONSTANT AND COMP
 4447:      11A7 91 33          	ACALL	PUSHC		;PUT NEXT CONSTANT ON STAC
 4448:      11A9 F1 41          	ACALL	AADD		;ADD IT TO THE OLD VALUE
 4449:      11AB E4             	CLR	A		;CHECK TO SEE IF DONE
 4450:      11AC 93             	MOVC	A,@A+DPTR
 4451:      11AD B4 FF F3       	CJNE	A,#0FFH,POLY1	;LOOP UNTIL DONE
 4452:                          	;
 4453:      11B0 12 19 75       AMUL:	LCALL	FP_BASE3
 4454:      11B3 01 38          	AJMP	FPTST
 4455:                          	;
 4456:                          	;**************************************
 4457:                          	;
 4458:                          RV:	; Reduce a value for Trig and A**X f
 4459:                          	;
 4460:                          	; value = (value/x - INT(value/x)) * x
 4461:                          	;
 4462:                          	;**************************************
 4463:                          	;
 4464:      11B5 91 6C          	ACALL	C2_T2		;COPY TOS TO T2
 4465:      11B7 91 0A          	ACALL	ADIV		;TOS = TOS/TEMP2
 4466:      11B9 71 8F          	ACALL	AABS		;MAKE THE TOS A POSITIVE NU
 4467:      11BB F5 45          	MOV	MT1,A		;SAVE THE SIGN
 4468:      11BD 91 2A          	ACALL	CSTAKA2 	;COPY THE STACK TWICE
 4469:      11BF 51 23          	ACALL	IFIX		;PUT THE NUMBER IN R3:R1
 4470:      11C1 C0 03          	PUSH	R3B0		;SAVE R3
 4471:      11C3 89 46          	MOV	MT2,R1		;SAVE THE LS BYTE IN MT2
 4472:      11C5 71 6D          	ACALL	AINT		;MAKE THE TOS AN INTEGER
 4473:      11C7 F1 1C          	ACALL	ASUB		;TOS = TOS/T2 - INT(TOS/T2)
 4474:      11C9 91 56          	ACALL	P_T2		;TOS = T2
 4475:      11CB 31 B0          	ACALL	AMUL		;TOS = T2*(TOS/T2 - INT(TOS
 4476:      11CD D0 03          	POP	R3B0		;RESTORE R3
 4477:      11CF 22             	RET			;EXIT
 4478:                          	;
 4479:                          	;**************************************
 4480:                          	;
 4481:                          	; TAN
 4482:                          	;
 4483:                          	;**************************************
 4484:                          	;
 4485:      11D0 91 2C          ATAN:	ACALL	CSTAKA		;DUPLACATE STACK
 4486:      11D2 31 71          	ACALL	ASIN		;TOS = SIN(X)
 4487:      11D4 91 5A          	ACALL	SWAP_ASTKA	;TOS = X
 4488:      11D6 31 6D          	ACALL	ACOS		;TOS = COS(X)
 4489:      11D8 81 0A          	AJMP	ADIV		;TOS = SIN(X)/COS(X)

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 82



 Line    I  Addr Code           Source

 4490:                          	;
 4491:      11DA 51 53          STRIP:	ACALL	SETREG		;SETUP R0
 4492:      11DC 7B 01          	MOV	R3,#1		;LOOP COUNT
 4493:      11DE 61 81          	AJMP	AI11		;WASTE THE LSB
 4494:                          	;
 4495:                          	;**************************************
 4496:                          	;
 4497:                          	; ARC TAN
 4498:                          	;
 4499:                          	;**************************************
 4500:                          	;
 4501:      11E0 71 8F          AATAN:	ACALL	AABS
 4502:      11E2 F5 45          	MOV	MT1,A		;SAVE THE SIGN
 4503:      11E4 51 53          	ACALL	SETREG		;GET THE EXPONENT
 4504:      11E6 24 7F          	ADD	A,#7FH		;BIAS THE EXPONENT
 4505:      11E8 92 2A          	MOV	UBIT,C		;SAVE CARRY STATUS
 4506:      11EA 50 02          	JNC	AATAN1		;SEE IF > 1
 4507:      11EC 51 7C          	ACALL	RECIP		;IF > 1, TAKE RECIP
 4508:      11EE 90 11 2A       AATAN1: MOV	DPTR,#ATTAB	;SET UP TO CALCU
 4509:      11F1 31 9B          	ACALL	POLYC		;CALCULATE THE POLY
 4510:      11F3 30 2A 06       	JNB	UBIT,SIN0	;JUMP IF NOT SET
 4511:      11F6 71 A1          	ACALL	ANEG		;MAKE X POLY NEGATIVE
 4512:      11F8 31 92          	ACALL	POTWO		;SUBTRACT PI/2
 4513:      11FA F1 41          	ACALL	AADD
 4514:                          	;
 4515:      11FC E5 45          SIN0:	MOV	A,MT1		;GET THE SIGN
 4516:      11FE 60 19          	JZ	SRT
 4517:      1200 61 A1          	AJMP	ANEG
 4518:                          	;
 4519:                          	;**************************************
 4520:                          	;
 4521:                          	; FCOMP - COMPARE 0FFFFH TO TOS
 4522:                          	;
 4523:                          	;**************************************
 4524:                          	;
 4525:      1202 91 2C          FCMP:	ACALL	CSTAKA		;COPY THE STACK
 4526:      1204 71 CB          	ACALL	FSTK		;MAKE THE TOS = 0FFFFH
 4527:      1206 91 5A          	ACALL	SWAP_ASTKA	;NOW COMPARE IS 0FFFFH
 4528:                          	;
 4529:      1208 02 19 73       CMPLK:	JMP	FP_BASE2	;DO THE COMPARE
 4530:                          	;
 4531:                          	;**************************************
 4532:                          	;
 4533:                          DEC_ASTKA:	;Push ARG STACK and check for
 4534:                          	;
 4535:                          	;**************************************
 4536:                          	;
 4537:      120B 74 FA          	MOV	A,#-FPSIZ
 4538:      120D 25 09          	ADD	A,ASTKA
 4539:      120F B4 32 00       	CJNE	A,#LOW TM_TOP+6,DEC_ASTKA1
 4540:                          DEC_ASTKA1:
 4541:      1212 40 06          	JC	E4YY
 4542:      1214 F5 09          	MOV	ASTKA,A
 4543:      1216 F9             	MOV	R1,A
 4544:      1217 7B 01          	MOV	R3,#ASTKAH
 4545:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 83



 Line    I  Addr Code           Source

 4546:      1219 22             SRT:	RET
 4547:                          	;
 4548:      121A 90 03 7B       E4YY:	MOV	DPTR,#EXA
 4549:      121D 01 4B          	AJMP	FPTS		;ARG STACK ERROR
 4550:                          	;
 4551:                          	;
 4552:      121F 91 33          AXTAL3: ACALL	PUSHC		;PUSH CONSTANT, THE
 4553:      1221 31 B0          	ACALL	AMUL
 4554:                          	;
 4555:                          	; Fall thru to IFIX
 4556:                          	;
 4557:                          	;**************************************
 4558:                          	;
 4559:                          IFIX:	; Convert a floating point number 
 4560:                          	;
 4561:                          	;**************************************
 4562:                          	;
 4563:      1223 E4             	CLR	A		;RESET THE START
 4564:      1224 FB             	MOV	R3,A
 4565:      1225 F9             	MOV	R1,A
 4566:      1226 A8 09          	MOV	R0,ASTKA	;GET THE ARG STACK
 4567:      1228 75 A0 01       	MOV	P2,#ASTKAH
 4568:      122B E2             	MOVX	A,@R0		;READ EXPONENT
 4569:      122C C3             	CLR	C
 4570:      122D 94 81          	SUBB	A,#81H		;BASE EXPONENT
 4571:      122F FC             	MOV	R4,A		;SAVE IT
 4572:      1230 18             	DEC	R0		;POINT AT SIGN
 4573:      1231 E2             	MOVX	A,@R0		;GET THE SIGN
 4574:      1232 70 56          	JNZ	SQ_ERR		;ERROR IF NEGATIVE
 4575:      1234 40 19          	JC	INC_ASTKA	;EXIT IF EXPONENT IS < 81H
 4576:      1236 0C             	INC	R4		;ADJUST LOOP COUNTER
 4577:      1237 E8             	MOV	A,R0		;BUMP THE POINTER REGISTER
 4578:      1238 94 05          	SUBB	A,#FPSIZ-1
 4579:      123A F8             	MOV	R0,A
 4580:                          	;
 4581:      123B 08             I2:	INC	R0		;POINT AT DIGIT
 4582:      123C E2             	MOVX	A,@R0		;GET DIGIT
 4583:      123D C4             	SWAP	A		;FLIP
 4584:      123E 12 19 83       	CALL	FP_BASE10	;ACCUMULATE
 4585:      1241 40 47          	JC	SQ_ERR
 4586:      1243 DC 02          	DJNZ	R4,I21
 4587:      1245 80 08          	SJMP	INC_ASTKA
 4588:      1247 E2             I21:	MOVX	A,@R0		;GET DIGIT
 4589:      1248 12 19 83       	CALL	FP_BASE10
 4590:      124B 40 3D          	JC	SQ_ERR
 4591:      124D DC EC          	DJNZ	R4,I2
 4592:                          	;
 4593:                          	;**************************************
 4594:                          	;
 4595:                          INC_ASTKA:	; Pop the ARG STACK and check
 4596:                          	;
 4597:                          	;**************************************
 4598:                          	;
 4599:      124F 74 06          	MOV	A,#FPSIZ	;NUMBER TO POP
 4600:      1251 80 01          	SJMP	SETREG1
 4601:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 84



 Line    I  Addr Code           Source

 4602:      1253 E4             SETREG: CLR	A		;DON'T POP ANYTHING
 4603:      1254 A8 09          SETREG1:MOV	R0,ASTKA
 4604:      1256 7A 01          	MOV	R2,#ASTKAH
 4605:      1258 8A A0          	MOV	P2,R2
 4606:      125A 28             	ADD	A,R0
 4607:      125B 40 BD          	JC	E4YY
 4608:      125D F5 09          	MOV	ASTKA,A
 4609:      125F E2             	MOVX	A,@R0
 4610:      1260 22             A_D:	RET
 4611:                          	;
 4612:                          	;**************************************
 4613:                          	;
 4614:                          	; EBIAS - Bias a number for E to the X 
 4615:                          	;
 4616:                          	;**************************************
 4617:                          	;
 4618:      1261 91 43          EBIAS:	ACALL	PUSH_ONE
 4619:      1263 31 B5          	ACALL	RV
 4620:      1265 BB 00 22       	CJNE	R3,#00H,SQ_ERR	;ERROR IF R3 <> 0
 4621:      1268 91 6C          	ACALL	C2_T2		;TEMP 2 GETS FRACTIONS
 4622:      126A 51 4F          	ACALL	INC_ASTKA
 4623:      126C 91 48          	ACALL	POP_T1
 4624:      126E 91 43          	ACALL	PUSH_ONE
 4625:                          	;
 4626:      1270 E5 46          AELP:	MOV	A,MT2
 4627:      1272 70 0E          	JNZ	AEL1
 4628:                          	;
 4629:      1274 E5 45          	MOV	A,MT1
 4630:      1276 60 E8          	JZ	A_D
 4631:      1278 90 01 1E       	MOV	DPTR,#FPT2-1
 4632:      127B F0             	MOVX	@DPTR,A 	;MAKE THE FRACTIONS NEGAT
 4633:                          	;
 4634:      127C 91 43          RECIP:	ACALL	PUSH_ONE
 4635:      127E 91 5A          	ACALL	SWAP_ASTKA
 4636:      1280 81 0A          	AJMP	ADIV
 4637:                          	;
 4638:      1282 15 46          AEL1:	DEC	MT2
 4639:      1284 91 4F          	ACALL	PUSH_T1
 4640:      1286 31 B0          	ACALL	AMUL
 4641:      1288 80 E6          	SJMP	AELP
 4642:                          	;
 4643:      128A 02 09 BD       SQ_ERR: LJMP	E3XX		;LINK TO BAD ARG
 4644:                          	;
 4645:                          	;**************************************
 4646:                          	;
 4647:                          	; SQUARE ROOT
 4648:                          	;
 4649:                          	;**************************************
 4650:                          	;
 4651:      128D 71 8F          ASQR:	ACALL	AABS		;GET THE SIGN
 4652:      128F 70 F9          	JNZ	SQ_ERR		;ERROR IF NEGATIVE
 4653:      1291 91 6C          	ACALL	C2_T2		;COPY VARIABLE TO T2
 4654:      1293 91 48          	ACALL	POP_T1		;SAVE IT IN T1
 4655:      1295 78 19          	MOV	R0,#LOW FPT1
 4656:      1297 E2             	MOVX	A,@R0		;GET EXPONENT
 4657:      1298 60 24          	JZ	SQR41		;EXIT IF ZERO

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 85



 Line    I  Addr Code           Source

 4658:      129A 24 80          	ADD	A,#128		;BIAS THE EXPONENT
 4659:      129C 50 05          	JNC	SQR1		;SEE IF < 80H
 4660:      129E 03             	RR	A
 4661:      129F 54 7F          	ANL	A,#127
 4662:      12A1 80 07          	SJMP	SQR2
 4663:                          	;
 4664:      12A3 F4             SQR1:	CPL	A		;FLIP BITS
 4665:      12A4 04             	INC	A
 4666:      12A5 03             	RR	A
 4667:      12A6 54 7F          	ANL	A,#127		;STRIP MSB
 4668:      12A8 F4             	CPL	A
 4669:      12A9 04             	INC	A
 4670:                          	;
 4671:      12AA 24 80          SQR2:	ADD	A,#128		;BIAS EXPONENT
 4672:      12AC F2             	MOVX	@R0,A		;SAVE IT
 4673:                          	;
 4674:                          	; NEWGUESS = ( X/OLDGUESS + OLDGUESS) /
 4675:                          	;
 4676:      12AD 91 56          SQR4:	ACALL	P_T2		;TOS = X
 4677:      12AF 91 4F          	ACALL	PUSH_T1 	;PUT NUMBER ON STACK
 4678:      12B1 91 0A          	ACALL	ADIV		;TOS = X/GUESS
 4679:      12B3 91 4F          	ACALL	PUSH_T1 	;PUT ON AGAIN
 4680:      12B5 F1 41          	ACALL	AADD		;TOS = X/GUESS + GUESS
 4681:      12B7 31 94          	ACALL	DBTWO		;TOS = ( X/GUESS + GUESS )
 4682:      12B9 71 1C          	ACALL	TEMP_COMP	;SEE IF DONE
 4683:      12BB 30 D5 EF       	JNB	F0,SQR4
 4684:                          	;
 4685:      12BE 81 4F          SQR41:	AJMP	PUSH_T1 	;PUT THE ANSWER ON 
 4686:                          	;
 4687:                          	;**************************************
 4688:                          	;
 4689:                          	; NATURAL LOG
 4690:                          	;
 4691:                          	;**************************************
 4692:                          	;
 4693:      12C0 71 8F          ALN:	ACALL	AABS		;MAKE SURE THAT NUM IS 
 4694:      12C2 70 C6          	JNZ	SQ_ERR		;ERROR IF NOT
 4695:      12C4 F5 46          	MOV	MT2,A		;CLEAR FOR LOOP
 4696:      12C6 08             	INC	R0		;POINT AT EXPONENT
 4697:      12C7 E2             	MOVX	A,@R0		;READ THE EXPONENT
 4698:      12C8 60 C0          	JZ	SQ_ERR		;ERROR IF EXPONENT IS ZERO
 4699:      12CA B4 81 00       	CJNE	A,#81H,ALN1	;SEE IF NUM >= 1
 4700:      12CD 92 2A          ALN1:	MOV	UBIT,C		;SAVE CARRY STATUS
 4701:      12CF 40 02          	JC	ALNL		;TAKE RECIP IF >= 1
 4702:      12D1 51 7C          	ACALL	RECIP
 4703:                          	;
 4704:                          	; Loop to reduce
 4705:                          	;
 4706:      12D3 91 2C          ALNL:	ACALL	CSTAKA		;COPY THE STACK FOR 
 4707:      12D5 91 43          	ACALL	PUSH_ONE	;COMPARE NUM TO ONE
 4708:      12D7 51 08          	ACALL	CMPLK
 4709:      12D9 50 1D          	JNC	ALNO		;EXIT IF DONE
 4710:      12DB 51 53          	ACALL	SETREG		;GET THE EXPONENT
 4711:      12DD 24 85          	ADD	A,#85H		;SEE HOW BIG IT IS
 4712:      12DF 50 0E          	JNC	ALN11		;BUMP BY EXP(11) IF TOO SMAL
 4713:      12E1 91 30          	ACALL	PLNEXP		;PUT EXP(1) ON STACK

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 86



 Line    I  Addr Code           Source

 4714:      12E3 74 01          	MOV	A,#1		;BUMP COUNT
 4715:                          	;
 4716:      12E5 25 46          ALNE:	ADD	A,MT2
 4717:      12E7 40 A1          	JC	SQ_ERR
 4718:      12E9 F5 46          	MOV	MT2,A
 4719:      12EB 31 B0          	ACALL	AMUL		;BIAS THE NUMBER
 4720:      12ED 80 E4          	SJMP	ALNL
 4721:                          	;
 4722:      12EF 90 17 F2       ALN11:	MOV	DPTR,#EXP11	;PUT EXP(11) ON S
 4723:      12F2 91 33          	ACALL	PUSHC
 4724:      12F4 74 0B          	MOV	A,#11
 4725:      12F6 80 ED          	SJMP	ALNE
 4726:                          	;
 4727:      12F8 91 6C          ALNO:	ACALL	C2_T2		;PUT NUM IN TEMP 2
 4728:      12FA 91 43          	ACALL	PUSH_ONE	;TOS = 1
 4729:      12FC F1 1C          	ACALL	ASUB		;TOS = X - 1
 4730:      12FE 91 56          	ACALL	P_T2		;TOS = X
 4731:      1300 91 43          	ACALL	PUSH_ONE	;TOS = 1
 4732:      1302 F1 41          	ACALL	AADD		;TOS = X + 1
 4733:      1304 91 0A          	ACALL	ADIV		;TOS = (X-1)/(X+1)
 4734:      1306 90 16 A9       	MOV	DPTR,#LNTAB	;LOG TABLE
 4735:      1309 31 9B          	ACALL	POLYC
 4736:      130B A3             	INC	DPTR		;POINT AT LN(10)
 4737:      130C 91 33          	ACALL	PUSHC
 4738:      130E 31 B0          	ACALL	AMUL
 4739:      1310 E5 46          	MOV	A,MT2		;GET THE COUNT
 4740:      1312 91 B1          	ACALL	TWO_R2		;PUT IT ON THE STACK
 4741:      1314 F1 1C          	ACALL	ASUB		;INT - POLY
 4742:      1316 31 DA          	ACALL	STRIP
 4743:      1318 30 2A 74       	JNB	UBIT,AABS
 4744:                          	;
 4745:      131B 22             LN_D:	RET
 4746:                          	;
 4747:                          	;**************************************
 4748:                          	;
 4749:                          TEMP_COMP:	; Compare FPTEMP1 to TOS, FPT
 4750:                          	;
 4751:                          	;**************************************
 4752:                          	;
 4753:      131C 91 4F          	ACALL	PUSH_T1 	;SAVE THE TEMP
 4754:      131E 91 5A          	ACALL	SWAP_ASTKA	;TRADE WITH THE NEXT N
 4755:      1320 91 2C          	ACALL	CSTAKA		;COPY THE STACK
 4756:      1322 91 48          	ACALL	POP_T1		;SAVE THE NEW NUMBER
 4757:      1324 02 19 73       	JMP	FP_BASE2	;DO THE COMPARE
 4758:                          	;
 4759:      1327 91 30          AETOX:	ACALL	PLNEXP		;EXP(1) ON TOS
 4760:      1329 91 5A          	ACALL	SWAP_ASTKA	;X ON TOS
 4761:                          	;
 4762:                          AEXP:	;EXPONENTIATION
 4763:                          	;
 4764:      132B 51 61          	ACALL	EBIAS		;T1=BASE,T2=FRACTIONS,TOS=
 4765:      132D 90 01 1F       	MOV	DPTR,#FPT2	;POINT AT FRACTIONS
 4766:      1330 E0             	MOVX	A,@DPTR 	;READ THE EXP OF THE FRAC
 4767:      1331 60 E8          	JZ	LN_D		;EXIT IF ZERO
 4768:      1333 91 56          	ACALL	P_T2		;TOS = FRACTIONS
 4769:      1335 91 4F          	ACALL	PUSH_T1 	;TOS = BASE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 87



 Line    I  Addr Code           Source

 4770:      1337 51 53          	ACALL	SETREG		;SEE IF BASE IS ZERO
 4771:      1339 60 02          	JZ	AEXP1
 4772:      133B 51 C0          	ACALL	ALN		;TOS = LN(BASE)
 4773:      133D 31 B0          AEXP1:	ACALL	AMUL		;TOS = FRACTIONS * LN
 4774:      133F 91 30          	ACALL	PLNEXP		;TOS = EXP(1)
 4775:      1341 91 5A          	ACALL	SWAP_ASTKA	;TOS = FRACTIONS * LN(
 4776:      1343 51 61          	ACALL	EBIAS		;T2 = FRACTIONS, TOS = INT
 4777:      1345 75 46 00       	MOV	MT2,#00H	;NOW CALCULATE E**X
 4778:      1348 91 43          	ACALL	PUSH_ONE
 4779:      134A 91 2C          	ACALL	CSTAKA
 4780:      134C 91 48          	ACALL	POP_T1		;T1 = 1
 4781:                          	;
 4782:      134E 91 56          AEXL:	ACALL	P_T2		;TOS = FRACTIONS
 4783:      1350 31 B0          	ACALL	AMUL		;TOS = FRACTIONS * ACCUMLAT
 4784:      1352 05 46          	INC	MT2		;DO THE DEMONIATOR
 4785:      1354 E5 46          	MOV	A,MT2
 4786:      1356 91 B1          	ACALL	TWO_R2
 4787:      1358 91 0A          	ACALL	ADIV
 4788:      135A 91 2C          	ACALL	CSTAKA		;SAVE THE ITERATION
 4789:      135C 91 4F          	ACALL	PUSH_T1 	;NOW ACCUMLATE
 4790:      135E F1 41          	ACALL	AADD		;ADD ACCUMLATION
 4791:      1360 71 1C          	ACALL	TEMP_COMP
 4792:      1362 30 D5 E9       	JNB	F0,AEXL 	;LOOP UNTIL DONE
 4793:                          	;
 4794:      1365 51 4F          	ACALL	INC_ASTKA
 4795:      1367 91 4F          	ACALL	PUSH_T1
 4796:      1369 31 B0          	ACALL	AMUL		;LAST INT MULTIPLIED
 4797:                          	;
 4798:      136B 21 B0          MU1:	AJMP	AMUL		;FIRST INT MULTIPLIED
 4799:                          	;
 4800:                          	;**************************************
 4801:                          	;
 4802:                          	; integer operator - INT
 4803:                          	;
 4804:                          	;**************************************
 4805:                          	;
 4806:      136D 51 53          AINT:	ACALL	SETREG		;SET UP THE REGISTER
 4807:      136F 94 81          	SUBB	A,#129		;SUBTRACT EXPONENT BIAS
 4808:      1371 50 07          	JNC	AI1		;JUMP IF ACC > 81H
 4809:                          	;
 4810:                          	; Force the number to be a zero
 4811:                          	;
 4812:      1373 51 4F          	ACALL	INC_ASTKA	;BUMP THE STACK
 4813:                          	;
 4814:      1375 90 04 E0       P_Z:	MOV	DPTR,#ZRO	;PUT ZERO ON THE STAC
 4815:      1378 81 33          	AJMP	PUSHC
 4816:                          	;
 4817:      137A 94 07          AI1:	SUBB	A,#7
 4818:      137C 50 10          	JNC	AI3
 4819:      137E F4             	CPL	A
 4820:      137F 04             	INC	A
 4821:      1380 FB             	MOV	R3,A
 4822:      1381 18             AI11:	DEC	R0		;POINT AT SIGN
 4823:                          	;
 4824:      1382 18             AI2:	DEC	R0		;NOW AT LSB'S
 4825:      1383 E2             	MOVX	A,@R0		;READ BYTE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 88



 Line    I  Addr Code           Source

 4826:      1384 54 F0          	ANL	A,#0F0H 	;STRIP NIBBLE
 4827:      1386 F2             	MOVX	@R0,A		;WRITE BYTE
 4828:      1387 DB 01          	DJNZ	R3,AI21
 4829:      1389 22             	RET
 4830:      138A E4             AI21:	CLR	A
 4831:      138B F2             	MOVX	@R0,A		;CLEAR THE LOCATION
 4832:      138C DB F4          	DJNZ	R3,AI2
 4833:                          	;
 4834:      138E 22             AI3:	RET			;EXIT
 4835:                          	;
 4836:                          	;**************************************
 4837:                          	;
 4838:                          AABS:	; Absolute value - Make sign of nu
 4839:                          	;		   return sign in ACC
 4840:                          	;
 4841:                          	;**************************************
 4842:                          	;
 4843:      138F 71 A1          	ACALL	ANEG		;CHECK TO SEE IF + OR -
 4844:      1391 70 19          	JNZ	ALPAR		;EXIT IF NON ZERO, BECAUSE T
 4845:      1393 F2             	MOVX	@R0,A		;MAKE A POSITIVE SIGN
 4846:      1394 22             	RET
 4847:                          	;
 4848:                          	;**************************************
 4849:                          	;
 4850:                          ASGN:	; Returns the sign of the number 1
 4851:                          	;
 4852:                          	;**************************************
 4853:                          	;
 4854:      1395 51 4F          	ACALL	INC_ASTKA	;POP STACK, GET EXPONEN
 4855:      1397 60 DC          	JZ	P_Z		;EXIT IF ZERO
 4856:      1399 18             	DEC	R0		;BUMP TO SIGN
 4857:      139A E2             	MOVX	A,@R0		;GET THE SIGN
 4858:      139B FF             	MOV	R7,A		;SAVE THE SIGN
 4859:      139C 91 43          	ACALL	PUSH_ONE	;PUT A ONE ON THE STACK
 4860:      139E EF             	MOV	A,R7		;GET THE SIGN
 4861:      139F 60 0B          	JZ	ALPAR		;EXIT IF ZERO
 4862:                          	;
 4863:                          	; Fall thru to ANEG
 4864:                          	;
 4865:                          	;**************************************
 4866:                          	;
 4867:                          ANEG:	; Flip the sign of the number on t
 4868:                          	;
 4869:                          	;**************************************
 4870:                          	;
 4871:      13A1 51 53          	ACALL	SETREG
 4872:      13A3 18             	DEC	R0		;POINT AT THE SIGN OF THE NUMBE
 4873:      13A4 60 06          	JZ	ALPAR		;EXIT IF ZERO
 4874:      13A6 E2             	MOVX	A,@R0
 4875:      13A7 64 01          	XRL	A,#01H		;FLIP THE SIGN
 4876:      13A9 F2             	MOVX	@R0,A
 4877:      13AA 64 01          	XRL	A,#01H		;RESTORE THE SIGN
 4878:                          	;
 4879:      13AC 22             ALPAR:	RET
 4880:                          	;
 4881:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 89



 Line    I  Addr Code           Source

 4882:                          	;
 4883:                          ACBYTE: ; Read the ROM
 4884:                          	;
 4885:                          	;**************************************
 4886:                          	;
 4887:      13AD 51 23          	ACALL	IFIX		;GET EXPRESSION
 4888:      13AF 12 05 79       	CALL	X31DP		;PUT R3:R1 INTO THE DP
 4889:      13B2 E4             	CLR	A
 4890:      13B3 93             	MOVC	A,@A+DPTR
 4891:      13B4 81 B1          	AJMP	TWO_R2
 4892:                          	;
 4893:                          	;**************************************
 4894:                          	;
 4895:                          ADBYTE: ; Read internal memory
 4896:                          	;
 4897:                          	;**************************************
 4898:                          	;
 4899:      13B6 51 23          	ACALL	IFIX		;GET THE EXPRESSION
 4900:      13B8 12 09 D5       	CALL	R3CK		;MAKE SURE R3 = 0
 4901:      13BB E7             	MOV	A,@R1
 4902:      13BC 81 B1          	AJMP	TWO_R2
 4903:                          	;
 4904:                          	;**************************************
 4905:                          	;
 4906:                          AXBYTE: ; Read external memory
 4907:                          	;
 4908:                          	;**************************************
 4909:                          	;
 4910:      13BE 51 23          	ACALL	IFIX		;GET THE EXPRESSION
 4911:      13C0 8B A0          AXBYTE1:MOV	P2,R3
 4912:      13C2 E3             	MOVX	A,@R1
 4913:      13C3 81 B1          	AJMP	TWO_R2
 4914:                          	;
 4915:                          	;**************************************
 4916:                          	;
 4917:                          	; The relational operators - EQUAL			  
 4918:                          	;			     GREATER THAN		  (>)
 4919:                          	;			     LESS THAN			  (<)
 4920:                          	;			     GREATER THAN OR EQUAL	  (>=)
 4921:                          	;			     LESS THAN OR EQUAL 	  (<=)
 4922:                          	;			     NOT EQUAL			  (<>)
 4923:                          	;
 4924:                          	;**************************************
 4925:                          	;
 4926:      13C5 51 08          AGT:	ACALL	CMPLK
 4927:      13C7 72 D5          	ORL	C,F0		;SEE IF EITHER IS A ONE
 4928:      13C9 40 AA          AGT1:	JC	P_Z
 4929:                          	;
 4930:      13CB 90 13 D0       FSTK:	MOV	DPTR,#FS
 4931:      13CE 81 33          	AJMP	PUSHC
 4932:                          	;
 4933:      13D0 85             FS:	DB	85H
 4934:      13D1 00             	DB	00H
 4935:      13D2 00             	DB	00H
 4936:      13D3 50             	DB	50H
 4937:      13D4 53             	DB	53H

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 90



 Line    I  Addr Code           Source

 4938:      13D5 65             	DB	65H
 4939:                          	;
 4940:      13D6 51 08          ALT:	ACALL	CMPLK
 4941:      13D8 B3             ALT1:	CPL	C
 4942:      13D9 80 EE          	SJMP	AGT1
 4943:                          	;
 4944:      13DB 51 08          AEQ:	ACALL	CMPLK
 4945:      13DD A2 D5          AEQ1:	MOV	C,F0
 4946:      13DF 80 F7          	SJMP	ALT1
 4947:                          	;
 4948:      13E1 51 08          ANE:	ACALL	CMPLK
 4949:      13E3 B2 D5          	CPL	F0
 4950:      13E5 80 F6          	SJMP	AEQ1
 4951:                          	;
 4952:      13E7 51 08          AGE:	ACALL	CMPLK
 4953:      13E9 80 DE          	SJMP	AGT1
 4954:                          	;
 4955:      13EB 51 08          ALE:	ACALL	CMPLK
 4956:      13ED 72 D5          	ORL	C,F0
 4957:      13EF 80 E7          	SJMP	ALT1
 4958:                          	;
 4959:                          	;**************************************
 4960:                          	;
 4961:                          ARND:	; Generate a random number
 4962:                          	;
 4963:                          	;**************************************
 4964:                          	;
 4965:      13F1 90 01 0C       	MOV	DPTR,#RCELL	;GET THE BINARY SEED
 4966:      13F4 12 05 BA       	CALL	L31DPI
 4967:      13F7 E9             	MOV	A,R1
 4968:      13F8 C3             	CLR	C
 4969:      13F9 13             	RRC	A
 4970:      13FA F8             	MOV	R0,A
 4971:      13FB 74 06          	MOV	A,#6
 4972:      13FD 13             	RRC	A
 4973:      13FE 29             	ADD	A,R1
 4974:      13FF C8             	XCH	A,R0
 4975:      1400 3B             	ADDC	A,R3
 4976:      1401 FA             	MOV	R2,A
 4977:      1402 15 82          	DEC	DPL		;SAVE THE NEW SEED
 4978:      1404 91 24          	ACALL	S20DP
 4979:      1406 91 B4          	ACALL	TWO_EY
 4980:      1408 71 CB          	ACALL	FSTK
 4981:                          	;
 4982:      140A 12 19 77       ADIV:	LCALL	FP_BASE4
 4983:      140D 01 38          	AJMP	FPTST
 4984:                          	;
 4985:                          	;**************************************
 4986:                          	;
 4987:                          SONERR: ; ON ERROR Statement
 4988:                          	;
 4989:                          	;**************************************
 4990:                          	;
 4991:      140F 12 0F 30       	LCALL	INTERR		;GET THE LINE NUMBER
 4992:      1412 D2 13          	SETB	ON_ERR
 4993:      1414 90 01 02       	MOV	DPTR,#ERRNUM	;POINT AT THR ERROR LO

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 91



 Line    I  Addr Code           Source

 4994:      1417 80 0B          	SJMP	S20DP
 4995:                          	;
 4996:                          	;
 4997:                          	;**************************************
 4998:                          	;
 4999:                          SONEXT: ; ON EXT1 Statement
 5000:                          	;
 5001:                          	;**************************************
 5002:                          	;
 5003:      1419 12 0F 30       	LCALL	INTERR
 5004:      141C D2 12          	SETB	INTBIT
 5005:      141E 43 A8 84       	ORL	IE,#10000100B	;ENABLE INTERRUPTS
 5006:      1421 90 01 20       	MOV	DPTR,#INTLOC
 5007:                          	;
 5008:      1424 EA             S20DP:	MOV	A,R2		;SAVE R2:R0 @DPTR
 5009:      1425 F0             	MOVX	@DPTR,A
 5010:      1426 A3             	INC	DPTR
 5011:      1427 E8             	MOV	A,R0
 5012:      1428 F0             	MOVX	@DPTR,A
 5013:      1429 22             	RET
 5014:                          	;
 5015:                          	;**************************************
 5016:                          	;
 5017:                          	; CASTAK - Copy and push another top of
 5018:                          	;
 5019:                          	;**************************************
 5020:                          	;
 5021:      142A 91 2C          CSTAKA2:ACALL	CSTAKA		;COPY STACK TWICE
 5022:                          	;
 5023:      142C 51 53          CSTAKA: ACALL	SETREG		;SET UP R2:R0
 5024:      142E 80 23          	SJMP	PUSH_T12
 5025:                          	;
 5026:      1430 90 17 F8       PLNEXP: MOV	DPTR,#EXP1
 5027:                          	;
 5028:                          	;**************************************
 5029:                          	;
 5030:                          	; PUSHC - Push constant on to the arg s
 5031:                          	;
 5032:                          	;**************************************
 5033:                          	;
 5034:      1433 51 0B          PUSHC:	ACALL	DEC_ASTKA
 5035:      1435 8B A0          	MOV	P2,R3
 5036:      1437 7B 06          	MOV	R3,#FPSIZ	;LOOP COUNTER
 5037:                          	;
 5038:      1439 E4             PCL:	CLR	A		;SET UP A
 5039:      143A 93             	MOVC	A,@A+DPTR	;LOAD IT
 5040:      143B F3             	MOVX	@R1,A		;SAVE IT
 5041:      143C A3             	INC	DPTR		;BUMP POINTERS
 5042:      143D 19             	DEC	R1
 5043:      143E DB F9          	DJNZ	R3,PCL		;LOOP
 5044:                          	;
 5045:      1440 D2 24          	SETB	ARGF
 5046:      1442 22             	RET			;EXIT
 5047:                          	;
 5048:                          PUSH_ONE:;
 5049:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 92



 Line    I  Addr Code           Source

 5050:      1443 90 16 F2       	MOV	DPTR,#FPONE
 5051:      1446 81 33          	AJMP	PUSHC
 5052:                          	;
 5053:                          POP_T1:
 5054:                          	;
 5055:      1448 7B 01          	MOV	R3,#HIGH FPT1
 5056:      144A 79 19          	MOV	R1,#LOW FPT1
 5057:      144C 02 0F D3       	JMP	POPAS
 5058:                          	;
 5059:                          PUSH_T1:
 5060:                          	;
 5061:      144F 78 19          	MOV	R0,#LOW FPT1
 5062:                          PUSH_T11:
 5063:      1451 7A 01          	MOV	R2,#HIGH FPT1
 5064:                          PUSH_T12:
 5065:      1453 02 0F DD       	LJMP	PUSHAS
 5066:                          	;
 5067:      1456 78 1F          P_T2:	MOV	R0,#LOW FPT2
 5068:      1458 80 F7          	SJMP	PUSH_T11		;JUMP TO PUSHAS
 5069:                          	;
 5070:                          	;**************************************
 5071:                          	;
 5072:                          SWAP_ASTKA:	; SWAP TOS<>TOS-1
 5073:                          	;
 5074:                          	;**************************************
 5075:                          	;
 5076:      145A 51 53          	ACALL	SETREG		;SET UP R2:R0 AND P2
 5077:      145C 74 06          	MOV	A,#FPSIZ	;PUT TOS+1 IN R1
 5078:      145E FA             	MOV	R2,A
 5079:      145F 28             	ADD	A,R0
 5080:      1460 F9             	MOV	R1,A
 5081:                          	;
 5082:      1461 E2             S_L:	MOVX	A,@R0
 5083:      1462 FB             	MOV	R3,A
 5084:      1463 E3             	MOVX	A,@R1
 5085:      1464 F2             	MOVX	@R0,A
 5086:      1465 EB             	MOV	A,R3
 5087:      1466 F3             	MOVX	@R1,A
 5088:      1467 19             	DEC	R1
 5089:      1468 18             	DEC	R0
 5090:      1469 DA F6          	DJNZ	R2,S_L
 5091:      146B 22             	RET
 5092:                          	;
 5093:      146C 51 53          C2_T2:	ACALL	SETREG		;SET UP R2:R0
 5094:      146E 7B 01          	MOV	R3,#HIGH FPT2
 5095:      1470 79 1F          	MOV	R1,#LOW FPT2	;TEMP VALUE
 5096:                          	;
 5097:                          	; Fall thru
 5098:                          	;
 5099:                          	;**************************************
 5100:                          	;
 5101:                          	; VARCOP - Copy a variable from R2:R0 t
 5102:                          	;
 5103:                          	;**************************************
 5104:                          	;
 5105:      1472 7C 06          VARCOP: MOV	R4,#FPSIZ	;LOAD THE LOOP COU

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 93



 Line    I  Addr Code           Source

 5106:                          	;
 5107:      1474 8A A0          V_C:	MOV	P2,R2		;SET UP THE PORTS
 5108:      1476 E2             	MOVX	A,@R0		;READ THE VALUE
 5109:      1477 8B A0          	MOV	P2,R3		;PORT TIME AGAIN
 5110:      1479 F3             	MOVX	@R1,A		;SAVE IT
 5111:      147A B1 8B          	ACALL	DEC3210 	;BUMP POINTERS
 5112:      147C DC F6          	DJNZ	R4,V_C		;LOOP
 5113:      147E 22             	RET			;EXIT
 5114:                          	;
 5115:      147F 90 17 FE       PIPI:	MOV	DPTR,#PIE
 5116:      1482 81 33          	AJMP	PUSHC
 5117:                          	;
 5118:                          	;**************************************
 5119:                          	;
 5120:                          	; The logical operators ANL, ORL, XRL, 
 5121:                          	;
 5122:                          	;**************************************
 5123:                          	;
 5124:      1484 91 A1          AANL:	ACALL	TWOL		;GET THE EXPRESSIONS
 5125:      1486 EB             	MOV	A,R3		;DO THE AND
 5126:      1487 5F             	ANL	A,R7
 5127:      1488 FA             	MOV	R2,A
 5128:      1489 E9             	MOV	A,R1
 5129:      148A 5E             	ANL	A,R6
 5130:      148B 80 26          	SJMP	TWO_EX
 5131:                          	;
 5132:      148D 91 A1          AORL:	ACALL	TWOL		;SAME THING FOR OR
 5133:      148F EB             	MOV	A,R3
 5134:      1490 4F             	ORL	A,R7
 5135:      1491 FA             	MOV	R2,A
 5136:      1492 E9             	MOV	A,R1
 5137:      1493 4E             	ORL	A,R6
 5138:      1494 80 1D          	SJMP	TWO_EX
 5139:                          	;
 5140:      1496 71 CB          ANOT:	ACALL	FSTK		;PUT 0FFFFH ON THE STA
 5141:                          	;
 5142:      1498 91 A1          AXRL:	ACALL	TWOL
 5143:      149A EB             	MOV	A,R3
 5144:      149B 6F             	XRL	A,R7
 5145:      149C FA             	MOV	R2,A
 5146:      149D E9             	MOV	A,R1
 5147:      149E 6E             	XRL	A,R6
 5148:      149F 80 12          	SJMP	TWO_EX
 5149:                          	;
 5150:      14A1 51 23          TWOL:	ACALL	IFIX
 5151:      14A3 AF 03          	MOV	R7,R3B0
 5152:      14A5 AE 01          	MOV	R6,R1B0
 5153:      14A7 41 23          	AJMP	IFIX
 5154:                          	;
 5155:                          	;**************************************
 5156:                          	;
 5157:                          AGET:	; READ THE BREAK BYTE AND PUT IT O
 5158:                          	;
 5159:                          	;**************************************
 5160:                          	;
 5161:      14A9 90 01 00       	MOV	DPTR,#GTB	;GET THE BREAK BYTE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 94



 Line    I  Addr Code           Source

 5162:      14AC E0             	MOVX	A,@DPTR
 5163:      14AD 10 18 01       	JBC	GTRD,TWO_R2
 5164:      14B0 E4             	CLR	A
 5165:                          	;
 5166:      14B1 7A 00          TWO_R2: MOV	R2,#00H 	;ACC GOES TO STACK
 5167:                          	;
 5168:                          	;
 5169:      14B3 F8             TWO_EX: MOV	R0,A		;R2:ACC GOES TO STACK
 5170:                          	;
 5171:                          	;
 5172:      14B4 D2 24          TWO_EY: SETB	ARGF		;R2:R0 GETS PUT ON TH
 5173:      14B6 02 19 87       	JMP	FP_BASE12	;DO IT
 5174:                          	;
 5175:                          	;**************************************
 5176:                          	;
 5177:                          	; Put directs onto the stack
 5178:                          	;
 5179:                          	;**************************************
 5180:                          	;
 5181:      14B9 E5 A8          A_IE:	MOV	A,IE		;IE
 5182:      14BB 80 F4          	SJMP	TWO_R2
 5183:                          	;
 5184:      14BD E5 B8          A_IP:	MOV	A,IP		;IP
 5185:      14BF 80 F0          	SJMP	TWO_R2
 5186:                          	;
 5187:      14C1 AA 8C          ATIM0:	MOV	R2,TH0		;TIMER 0
 5188:      14C3 A8 8A          	MOV	R0,TL0
 5189:      14C5 80 ED          	SJMP	TWO_EY
 5190:                          	;
 5191:      14C7 AA 8D          ATIM1:	MOV	R2,TH1		;TIMER 1
 5192:      14C9 A8 8B          	MOV	R0,TL1
 5193:      14CB 80 E7          	SJMP	TWO_EY
 5194:                          	;
 5195:      14CD AA CD          ATIM2:	MOV	R2,TH2
 5196:      14CF A8 CC          	MOV	R0,TL2
 5197:                          ;	DB	0AAH		;MOV R2 DIRECT OP CODE
 5198:                          ;	DB	0CDH		;T2 HIGH
 5199:                          ;	DB	0A8H		;MOV R0 DIRECT OP CODE
 5200:                          ;	DB	0CCH		;T2 LOW
 5201:      14D1 80 E1          	SJMP	TWO_EY		;TIMER 2
 5202:                          	;
 5203:      14D3 E5 C8          AT2CON: MOV	A,T2CON
 5204:                          ;	DB	0E5H		;MOV A,DIRECT OPCODE
 5205:                          ;	DB	0C8H		;T2CON LOCATION
 5206:      14D5 80 DA          	SJMP	TWO_R2
 5207:                          	;
 5208:      14D7 E5 88          ATCON:	MOV	A,TCON		;TCON
 5209:      14D9 80 D6          	SJMP	TWO_R2
 5210:                          	;
 5211:      14DB E5 89          ATMOD:	MOV	A,TMOD		;TMOD
 5212:      14DD 80 D2          	SJMP	TWO_R2
 5213:                          	;
 5214:      14DF AA CB          ARCAP2: MOV	R2,RCAPH2
 5215:      14E1 A8 CA          	MOV	R0,RCAPL2
 5216:                          ;	DB	0AAH		;MOV R2, DIRECT OP CODE
 5217:                          ;	DB	0CBH		;RCAP2H LOCATION

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 95



 Line    I  Addr Code           Source

 5218:                          ;	DB	0A8H		;MOV R0, DIRECT OP CODE
 5219:                          ;	DB	0CAH		;R2CAPL LOCATION
 5220:      14E3 80 CF          	SJMP	TWO_EY
 5221:                          	;
 5222:      14E5 E5 90          AP1:	MOV	A,P1		;GET P1
 5223:      14E7 80 C8          	SJMP	TWO_R2		;PUT IT ON THE STACK
 5224:                          	;
 5225:      14E9 E5 87          APCON:	MOV	A,PCON
 5226:                          ;	DB	0E5H		;MOV A, DIRECT OP CODE
 5227:                          ;	DB	87H		;ADDRESS OF PCON
 5228:      14EB 80 C4          	SJMP	TWO_R2		;PUT PCON ON THE STACK
 5229:                          	;
 5230:                          	;**************************************
 5231:                          	;
 5232:                          	;THIS IS THE LINE EDITOR
 5233:                          	;
 5234:                          	;TAKE THE PROCESSED LINE IN IBUF AND IN
 5235:                          	;BASIC TEXT FILE.
 5236:                          	;
 5237:                          	;**************************************
 5238:                          	;
 5239:      14ED 02 05 6E       LINE0:	LJMP	NOGO		;CAN'T EDIT A ROM
 5240:                          	;
 5241:      14F0 E5 13          LINE:	MOV	A,BOFAH
 5242:      14F2 B4 02 F8       	CJNE	A,#HIGH PSTART,LINE0
 5243:      14F5 12 05 A9       	CALL	G4		;GET END ADDRESS FOR EDITING
 5244:      14F8 AC 82          	MOV	R4,DPL
 5245:      14FA AD 83          	MOV	R5,DPH
 5246:      14FC AB 0F          	MOV	R3,TEMP5	;GET HIGH ORDER IBLN
 5247:      14FE A9 0E          	MOV	R1,TEMP4	;LOW ORDER IBLN
 5248:                          	;
 5249:      1500 12 05 8C       	CALL	GETLIN		;FIND THE LINE
 5250:      1503 70 12          	JNZ	INSR		;INSERT IF NOT ZERO, ELSE APP
 5251:                          	;
 5252:                          	;APPEND THE LINE AT THE END
 5253:                          	;
 5254:      1505 E5 0D          	MOV	A,TEMP3 	;PUT IBCNT IN THE ACC
 5255:      1507 B4 04 01       	CJNE	A,#4H,LINE1	;SEE IF NO ENTRY
 5256:      150A 22             	RET			;RET IF NO ENTRY
 5257:                          	;
 5258:      150B B1 A8          LINE1:	ACALL	FULL		;SEE IF ENOUGH SPACE 
 5259:      150D AA 05          	MOV	R2,R5B0 	;PUT END ADDRESS A INTO TR
 5260:      150F A8 04          	MOV	R0,R4B0 	;REGISTERS
 5261:      1511 B1 66          	ACALL	IMOV		;DO THE BLOCK MOVE
 5262:                          	;
 5263:      1513 74 01          UE:	MOV	A,#EOF		;SAVE EOF CHARACTER
 5264:      1515 A1 99          	AJMP	TBR
 5265:                          	;
 5266:                          	;INSERT A LINE INTO THE FILE
 5267:                          	;
 5268:      1517 FF             INSR:	MOV	R7,A		;SAVE IT IN R7
 5269:      1518 12 18 54       	CALL	TEMPD		;SAVE INSERATION ADDRESS
 5270:      151B E5 0D          	MOV	A,TEMP3 	;PUT THE COUNT LENGTH IN T
 5271:      151D 40 09          	JC	LTX		;JUMP IF NEW LINE # NOT = OLD L
 5272:      151F B4 04 01       	CJNE	A,#04H,INSR1	;SEE IF NULL
 5273:      1522 E4             	CLR	A

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 96



 Line    I  Addr Code           Source

 5274:                          	;
 5275:      1523 9F             INSR1:	SUBB	A,R7		;SUBTRACT LINE COUNT F
 5276:      1524 60 36          	JZ	LIN1		;LINE LENGTHS EQUAL
 5277:      1526 40 1F          	JC	GTX		;SMALLER LINE
 5278:                          	;
 5279:                          	;EXPAND FOR A NEW LINE OR A LARGER LINE
 5280:                          	;
 5281:      1528 FF             LTX:	MOV	R7,A		;SAVE A IN R7
 5282:      1529 E5 0D          	MOV	A,TEMP3 	;GET THE COUNT IN THE ACC
 5283:      152B B4 04 01       	CJNE	A,#04H,LTX1	;DO NO INSERTATION IF 
 5284:      152E 22             	RET			;EXIT IF IT IS
 5285:                          	;
 5286:      152F EF             LTX1:	MOV	A,R7		;GET THE COUNT BACK - DE
 5287:      1530 B1 A8          	ACALL	FULL		;SEE IF ENOUGH MEMORY NEW E
 5288:      1532 12 18 4D       	CALL	DTEMP		;GET INSERATION ADDRESS
 5289:      1535 B1 9D          	ACALL	NMOV		;R7:R6 GETS (EOFA)-DPTR
 5290:      1537 12 0D AD       	CALL	X3120
 5291:      153A A9 04          	MOV	R1,R4B0 	;EOFA LOW
 5292:      153C AB 05          	MOV	R3,R5B0 	;EOFA HIGH
 5293:      153E 0E             	INC	R6		;INCREMENT BYTE COUNT
 5294:      153F BE 00 01       	CJNE	R6,#00,LTX2	;NEED TO BUMP HIGH BYT
 5295:      1542 0F             	INC	R7
 5296:                          	;
 5297:      1543 B1 81          LTX2:	ACALL	RMOV		;GO DO THE INSERTION
 5298:      1545 80 15          	SJMP	LIN1		;INSERT THE CURRENT LINE
 5299:                          	;
 5300:      1547 F4             GTX:	CPL	A		;FLIP ACC
 5301:      1548 04             	INC	A		;TWOS COMPLEMENT
 5302:      1549 12 05 DE       	CALL	ADDPTR		;DO THE ADDITION
 5303:      154C B1 9D          	ACALL	NMOV		;R7:R6 GETS (EOFA)-DPTR
 5304:      154E A9 82          	MOV	R1,DPL		;SET UP THE REGISTERS
 5305:      1550 AB 83          	MOV	R3,DPH
 5306:      1552 AA 0F          	MOV	R2,TEMP5	;PUT INSERTATION ADDRESS I
 5307:      1554 A8 0E          	MOV	R0,TEMP4
 5308:      1556 60 02          	JZ	GTX1		;IF ACC WAS ZERO FROM NMOV, JU
 5309:      1558 B1 6D          	ACALL	LMOV		;IF NO ZERO DO A LMOV
 5310:                          	;
 5311:      155A B1 13          GTX1:	ACALL	UE		;SAVE NEW END ADDRESS
 5312:                          	;
 5313:      155C AA 0F          LIN1:	MOV	R2,TEMP5	;GET THE INSERTATION 
 5314:      155E A8 0E          	MOV	R0,TEMP4
 5315:      1560 E5 0D          	MOV	A,TEMP3 	;PUT THE COUNT LENGTH IN A
 5316:      1562 B4 04 01       	CJNE	A,#04H,IMOV	;SEE IF NULL
 5317:      1565 22             	RET			;EXIT IF NULL
 5318:                          	;
 5319:                          	;**************************************
 5320:                          	;
 5321:                          	;INSERT A LINE AT ADDRESS R2:R0
 5322:                          	;
 5323:                          	;**************************************
 5324:                          	;
 5325:      1566 E4             IMOV:	CLR	A		;TO SET UP
 5326:      1567 79 04          	MOV	R1,#LOW IBCNT	;INITIALIZE THE REGIS
 5327:      1569 FB             	MOV	R3,A
 5328:      156A AE 0D          	MOV	R6,TEMP3	;PUT THE BYTE COUNT IN R6 
 5329:      156C FF             	MOV	R7,A		;PUT A 0 IN R7 FOR LMOV

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 97



 Line    I  Addr Code           Source

 5330:                          	;
 5331:                          	;**************************************
 5332:                          	;
 5333:                          	;COPY A BLOCK FROM THE BEGINNING
 5334:                          	;
 5335:                          	;R2:R0 IS THE DESTINATION ADDRESS
 5336:                          	;R3:R1 IS THE SOURCE ADDRESS
 5337:                          	;R7:R6 IS THE COUNT REGISTER
 5338:                          	;
 5339:                          	;**************************************
 5340:                          	;
 5341:      156D B1 96          LMOV:	ACALL	TBYTE		;TRANSFER THE BYTE
 5342:      156F B1 76          	ACALL	INC3210 	;BUMP THE POINTER
 5343:      1571 D1 47          	ACALL	DEC76		;BUMP R7:R6
 5344:      1573 70 F8          	JNZ	LMOV		;LOOP
 5345:      1575 22             	RET			;GO BACK TO CALLING ROUTINE
 5346:                          	;
 5347:      1576 08             INC3210:INC	R0
 5348:      1577 B8 00 01       	CJNE	R0,#00H,INC3211
 5349:      157A 0A             	INC	R2
 5350:                          	;
 5351:      157B 09             INC3211:INC	R1
 5352:      157C B9 00 01       	CJNE	R1,#00H,INC3212
 5353:      157F 0B             	INC	R3
 5354:      1580 22             INC3212:RET
 5355:                          	;
 5356:                          	;**************************************
 5357:                          	;
 5358:                          	;COPY A BLOCK STARTING AT THE END
 5359:                          	;
 5360:                          	;R2:R0 IS THE DESTINATION ADDRESS
 5361:                          	;R3:R1 IS THE SOURCE ADDRESS
 5362:                          	;R6:R7 IS THE COUNT REGISTER
 5363:                          	;
 5364:                          	;**************************************
 5365:                          	;
 5366:      1581 B1 96          RMOV:	ACALL	TBYTE		;TRANSFER THE BYTE
 5367:      1583 B1 8B          	ACALL	DEC3210 	;DEC THE LOCATIONS
 5368:      1585 D1 47          	ACALL	DEC76		;BUMP THE COUNTER
 5369:      1587 70 F8          	JNZ	RMOV		;LOOP
 5370:                          	;
 5371:      1589 00             DEC_R:	NOP			;CREATE EQUAL TIMING
 5372:      158A 22             	RET			;EXIT
 5373:                          	;
 5374:      158B 18             DEC3210:DEC	R0		;BUMP THE POINTER
 5375:      158C B8 FF 01       	CJNE	R0,#0FFH,DEC3212;SEE IF OVERFLOWED
 5376:      158F 1A             DEC3211:DEC	R2		;BUMP THE HIGH BYTE
 5377:      1590 19             DEC3212:DEC	R1		;BUMP THE POINTER
 5378:      1591 B9 FF F5       	CJNE	R1,#0FFH,DEC_R	;SEE IF OVERFLOWED
 5379:      1594 1B             	DEC	R3		;CHANGE THE HIGH BYTE
 5380:      1595 22             	RET			;EXIT
 5381:                          	;
 5382:                          	;**************************************
 5383:                          	;
 5384:                          	;TBYTE - TRANSFER A BYTE
 5385:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 98



 Line    I  Addr Code           Source

 5386:                          	;**************************************
 5387:                          	;
 5388:      1596 8B A0          TBYTE:	MOV	P2,R3		;OUTPUT SOURCE REGISTE
 5389:      1598 E3             	MOVX	A,@R1		;PUT BYTE IN ACC
 5390:                          	;
 5391:      1599 8A A0          TBR:	MOV	P2,R2		;OUTPUT DESTINATION TO P
 5392:      159B F2             	MOVX	@R0,A		;SAVE THE BYTE
 5393:      159C 22             	RET			;EXIT
 5394:                          	;
 5395:                          	;**************************************
 5396:                          	;
 5397:                          	;NMOV - R7:R6 = END ADDRESS - DPTR
 5398:                          	;
 5399:                          	;ACC GETS CLOBBERED
 5400:                          	;
 5401:                          	;**************************************
 5402:                          	;
 5403:      159D EC             NMOV:	MOV	A,R4		;THE LOW BYTE OF EOFA
 5404:      159E C3             	CLR	C		;CLEAR THE CARRY FOR SUBB
 5405:      159F 95 82          	SUBB	A,DPL		;SUBTRACT DATA POINTER LOW
 5406:      15A1 FE             	MOV	R6,A		;PUT RESULT IN R6
 5407:      15A2 ED             	MOV	A,R5		;HIGH BYTE OF EOFA
 5408:      15A3 95 83          	SUBB	A,DPH		;SUBTRACT DATA POINTER HIGH
 5409:      15A5 FF             	MOV	R7,A		;PUT RESULT IN R7
 5410:      15A6 4E             	ORL	A,R6		;SEE IF ZERO
 5411:      15A7 22             NMOV1:	RET			;EXIT
 5412:                          	;
 5413:                          	;**************************************
 5414:                          	;
 5415:                          	;CHECK FOR A FILE OVERFLOW
 5416:                          	;LEAVES THE NEW END ADDRESS IN R3:R1
 5417:                          	;A HAS THE INCREASE IN SIZE
 5418:                          	;
 5419:                          	;**************************************
 5420:                          	;
 5421:      15A8 2C             FULL:	ADD	A,R4		;ADD A TO END ADDRESS
 5422:      15A9 F9             	MOV	R1,A		;SAVE IT
 5423:      15AA E4             	CLR	A
 5424:      15AB 3D             	ADDC	A,R5		;ADD THE CARRY
 5425:      15AC FB             	MOV	R3,A
 5426:      15AD 90 01 04       	MOV	DPTR,#VARTOP	;POINT AT VARTOP
 5427:                          	;
 5428:      15B0 12 05 CC       FUL1:	CALL	DCMPX		;COMPARE THE TWO
 5429:      15B3 40 F2          	JC	NMOV1		;OUT OF ROOM
 5430:                          	;
 5431:      15B5 90 18 16       TB:	MOV	DPTR,#E5X	;OUT OF MEMORY
 5432:      15B8 01 4B          	AJMP	FPTS
 5433:                          	;
 5434:                          	;**************************************
 5435:                          	;
 5436:                          	; PP - Preprocesses the line in IBUF ba
 5437:                          	;      sets F0 if no line number
 5438:                          	;      leaves the correct length of pro
 5439:                          	;      puts the line number in IBLN
 5440:                          	;      wastes the text address TXAL and
 5441:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.            PAGE 99



 Line    I  Addr Code           Source

 5442:                          	;**************************************
 5443:                          	;
 5444:      15BA F1 6C          PP:	ACALL	T_BUF		;TXA GETS IBUF
 5445:      15BC 12 0F 35       	CALL	INTGER		;SEE IF A NUMBER PRESENT
 5446:      15BF 12 18 54       	CALL	TEMPD		;SAVE THE INTEGER IN TEMP5:
 5447:      15C2 92 D5          	MOV	F0,C		;SAVE INTEGER IF PRESENT
 5448:      15C4 90 00 05       	MOV	DPTR,#IBLN	;SAVE THE LINE NUMBER, E
 5449:      15C7 91 24          	ACALL	S20DP
 5450:      15C9 A8 08          	MOV	R0,TXAL 	;TEXT POINTER
 5451:      15CB 79 07          	MOV	R1,#LOW IBUF	;STORE POINTER
 5452:                          	;
 5453:                          	; Now process the line back into IBUF
 5454:                          	;
 5455:      15CD C2 24          PPL:	CLR	ARGF		;FIRST PASS DESIGNATOR
 5456:      15CF 90 01 75       	MOV	DPTR,#TOKTAB	;POINT DPTR AT LOOK UP
 5457:                          	;
 5458:      15D2 88 05          PPL1:	MOV	R5B0,R0 	;SAVE THE READ POINTE
 5459:      15D4 E4             	CLR	A		;ZERO A FOR LOOKUP
 5460:      15D5 93             	MOVC	A,@A+DPTR	;GET THE TOKEN
 5461:      15D6 FF             	MOV	R7,A		;SAVE TOKEN IN CASE OF MATCH
 5462:                          	;
 5463:      15D7 E2             PPL2:	MOVX	A,@R0		;GET THE USER CHARACTE
 5464:      15D8 FB             	MOV	R3,A		;SAVE FOR REM
 5465:      15D9 B4 61 00       	CJNE	A,#'a',PPL21
 5466:      15DC 40 07          PPL21:	JC	PPX		;CONVERT LOWER TO UPPER C
 5467:      15DE B4 7B 00       	CJNE	A,#('z'+1),PPL22
 5468:      15E1 50 02          PPL22:	JNC	PPX
 5469:      15E3 C2 E5          	CLR	ACC.5
 5470:                          	;
 5471:      15E5 FA             PPX:	MOV	R2,A
 5472:      15E6 F2             	MOVX	@R0,A		;SAVE UPPER CASE
 5473:      15E7 A3             	INC	DPTR		;BUMP THE LOOKUP POINTER
 5474:      15E8 E4             	CLR	A
 5475:      15E9 93             	MOVC	A,@A+DPTR
 5476:      15EA B5 02 03       	CJNE	A,R2B0,PPL3	;LEAVE IF NOT THE SAME
 5477:      15ED 08             	INC	R0		;BUMP THE USER POINTER
 5478:      15EE 80 E7          	SJMP	PPL2		;CONTINUE TO LOOP
 5479:                          	;
 5480:      15F0 20 E7 2F       PPL3:	JB	ACC.7,PPL6	;JUMP IF FOUND MATCH
 5481:      15F3 60 2D          	JZ	PPL6		;USER MATCH
 5482:                          	;
 5483:                          	;
 5484:                          	; Scan to the next TOKTAB entry
 5485:                          	;
 5486:      15F5 A3             PPL4:	INC	DPTR		;ADVANCE THE POINTER
 5487:      15F6 E4             	CLR	A		;ZERO A FOR LOOKUP
 5488:      15F7 93             	MOVC	A,@A+DPTR	;LOAD A WITH TABLE
 5489:      15F8 20 E7 03       	JB	ACC.7,PPL41	;KEEP SCANNING IF NOT A 
 5490:      15FB 70 F8          	JNZ	PPL4
 5491:      15FD A3             	INC	DPTR
 5492:                          	;
 5493:                          	; See if at the end of TOKTAB
 5494:                          	;
 5495:      15FE A8 05          PPL41:	MOV	R0,R5B0 	;RESTORE THE POINTER
 5496:      1600 B4 FF CF       	CJNE	A,#0FFH,PPL1	;SEE IF END OF TABLE
 5497:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 100



 Line    I  Addr Code           Source

 5498:                          	; Character not in TOKTAB, so see what 
 5499:                          	;
 5500:      1603 BA 20 03       	CJNE	R2,#' ',PPLX    ;SEE IF A SPACE
 5501:      1606 08             	INC	R0		;BUMP USER POINTER
 5502:      1607 80 C4          	SJMP	PPL		;TRY AGAIN
 5503:                          	;
 5504:      1609 30 2D 0A       PPLX:	JNB	XBIT,PPLY	;EXTERNAL TRAP
 5505:      160C 20 24 07       	JB	ARGF,PPLY
 5506:      160F D2 24          	SETB	ARGF		;SAYS THAT THE USER HAS TABL
 5507:      1611 12 20 78       	LCALL	2078H		;SET UP POINTER
 5508:      1614 A1 D2          	AJMP	PPL1
 5509:                          	;
 5510:      1616 D1 2F          PPLY:	ACALL	PPL7		;SAVE CHARACTER, EXIT 
 5511:      1618 B4 22 B2       	CJNE	A,#'"',PPL      ;SEE IF QUOTED STR
 5512:                          	;
 5513:                          	; Just copy a quoted string
 5514:                          	;
 5515:      161B D1 2F          PPLY1:	ACALL	PPL7		;SAVE THE CHARACTER, 
 5516:      161D B4 22 FB       	CJNE	A,#'"',PPLY1    ;IS THERE AN ENDQU
 5517:      1620 80 AB          	SJMP	PPL		;DO IT AGAIN IF ENDQUOTE
 5518:                          	;
 5519:      1622 EF             PPL6:	MOV	A,R7		;GET THE TOKEN
 5520:      1623 D1 44          	ACALL	PPL91		;SAVE THE TOKEN
 5521:      1625 B4 96 A5       	CJNE	A,#T_REM,PPL	;SEE IF A REM TOKEN
 5522:      1628 EB             	MOV	A,R3
 5523:      1629 D1 30          	ACALL	PPL71		;WASTE THE REM STATEMENT
 5524:      162B D1 2F          PPL61:	ACALL	PPL7		;LOOP UNTIL A CR
 5525:      162D 80 FC          	SJMP	PPL61
 5526:                          	;
 5527:      162F E2             PPL7:	MOVX	A,@R0		;GET THE CHARACTER
 5528:      1630 B4 0D 10       PPL71:	CJNE	A,#CR,PPL9	;FINISH IF A CR
 5529:      1633 D0 00          	POP	R0B0		;WASTE THE CALLING STACK
 5530:      1635 D0 00          	POP	R0B0
 5531:      1637 F3             	MOVX	@R1,A		;SAVE CR IN MEMORY
 5532:      1638 09             	INC	R1		;SAVE A TERMINATOR
 5533:      1639 74 01          	MOV	A,#EOF
 5534:      163B F3             	MOVX	@R1,A
 5535:      163C E9             	MOV	A,R1		;SUBTRACT FOR LENGTH
 5536:      163D 94 04          	SUBB	A,#4
 5537:      163F F5 0D          	MOV	TEMP3,A 	;SAVE LENGTH
 5538:      1641 79 04          	MOV	R1,#LOW IBCNT	;POINT AT BUFFER COUN
 5539:                          	;
 5540:      1643 08             PPL9:	INC	R0
 5541:      1644 F3             PPL91:	MOVX	@R1,A		;SAVE THE CHARACTER
 5542:      1645 09             	INC	R1		;BUMP THE POINTERS
 5543:      1646 22             	RET			;EXIT TO CALLING ROUTINE
 5544:                          	;
 5545:                          	;
 5546:                          	;**************************************
 5547:                          	;
 5548:                          	;DEC76 - DECREMENT THE REGISTER PAIR R7
 5549:                          	;
 5550:                          	;ACC = ZERO IF R7:R6 = ZERO ; ELSE ACC 
 5551:                          	;
 5552:                          	;**************************************
 5553:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 101



 Line    I  Addr Code           Source

 5554:      1647 1E             DEC76:	DEC	R6		;BUMP R6
 5555:      1648 BE FF 01       	CJNE	R6,#0FFH,DEC77	;SEE IF RAPPED AROU
 5556:      164B 1F             	DEC	R7
 5557:      164C EF             DEC77:	MOV	A,R7		;SEE IF ZERO
 5558:      164D 4E             	ORL	A,R6
 5559:      164E 22             	RET			;EXIT
 5560:                          	;
 5561:                          	;**************************************
 5562:                          	;
 5563:                          	; MTOP - Get or Put the top of assigned
 5564:                          	;
 5565:                          	;**************************************
 5566:                          	;
 5567:      164F 90 01 0A       PMTOP:	MOV	DPTR,#MEMTOP
 5568:      1652 12 05 73       PMTOP1: CALL	L20DPI
 5569:      1655 81 B4          	AJMP	TWO_EY		;PUT R2:R0 ON THE STACK
 5570:                          	;
 5571:                          	;**************************************
 5572:                          	;
 5573:                          	; AXTAL - Crystal value calculations
 5574:                          	;
 5575:                          	;**************************************
 5576:                          	;
 5577:      1657 90 17 EC       AXTAL0: MOV	DPTR,#XTALV	;CRYSTAL VALUE
 5578:      165A 91 33          	ACALL	PUSHC
 5579:                          	;
 5580:      165C 91 2A          AXTAL1: ACALL	CSTAKA2 	;COPY CRYSTAL VAL
 5581:                          ;
 5582:                          ;***************************************
 5583:                          ;****** Disable Intel programming for to
 5584:                          ;
 5585:                          ;	ACALL	CSTAKA		;Copy crystal value the 
 5586:                          ;
 5587:                          ;***************************************
 5588:                          ;
 5589:      165E 90 07 09       	MOV	DPTR,#PTIME	;PROM TIMER
 5590:      1661 D1 79          	ACALL	AXTAL2
 5591:      1663 90 01 28       	MOV	DPTR,#PROGS
 5592:      1666 F1 0E          	ACALL	S31L
 5593:                          ;
 5594:                          ;***************************************
 5595:                          ;****** Disable Intel programming for to
 5596:                          ;
 5597:                          ;	MOV	DPTR,#IPTIME	;IPROM TIMER
 5598:                          ;	ACALL	AXTAL2
 5599:                          ;	MOV	DPTR,#IPROGS
 5600:                          ;	ACALL	S31L
 5601:                          ;
 5602:                          ;***************************************
 5603:                          ;
 5604:      1668 90 11 67       	MOV	DPTR,#TTIME	;CLOCK CALCULATION
 5605:      166B 51 1F          	ACALL	AXTAL3
 5606:      166D E9             	MOV	A,R1
 5607:      166E F4             	CPL	A
 5608:      166F 04             	INC	A
 5609:      1670 F5 4A          	MOV	SAVE_T,A

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 102



 Line    I  Addr Code           Source

 5610:      1672 7B 01          	MOV	R3,#HIGH CXTAL
 5611:      1674 79 13          	MOV	R1,#LOW CXTAL
 5612:      1676 02 0F D3       	JMP	POPAS
 5613:                          	;
 5614:      1679 51 1F          AXTAL2: ACALL	AXTAL3
 5615:                          	;
 5616:                          CBIAS:	;Bias the crystal calculations
 5617:                          	;
 5618:      167B E9             	MOV	A,R1		;GET THE LOW COUNT
 5619:      167C F4             	CPL	A		;FLIP IT FOR TIMER LOAD
 5620:      167D 24 0F          	ADD	A,#15		;BIAS FOR CALL AND LOAD TIME
 5621:      167F F9             	MOV	R1,A		;RESTORE IT
 5622:      1680 EB             	MOV	A,R3		;GET THE HIGH COUNT
 5623:      1681 F4             	CPL	A		;FLIP IT
 5624:      1682 34 00          	ADDC	A,#00H		;ADD THE CARRY
 5625:      1684 FB             	MOV	R3,A		;RESTORE IT
 5626:      1685 22             	RET
 5627:                          	;
 5628:                          	;**************************************
 5629:                          	;
 5630:                          STONE:	; Toggle the I/O port
 5631:                          	;
 5632:                          	;**************************************
 5633:                          	;
 5634:      1686 12 0E 78       	CALL	THREE		;GET THE NUMBERS
 5635:      1689 D1 7B          	ACALL	CBIAS		;BIAS R3:R1 FOR COUNT LOOP
 5636:                          	;
 5637:      168B C2 92          STONE1: CLR	T_BIT		;TOGGLE THE BIT
 5638:      168D C2 8E          	CLR	TR1		;STOP THE TIMER
 5639:      168F 8B 8D          	MOV	TH1,R3		;LOAD THE TIMER
 5640:      1691 89 8B          	MOV	TL1,R1
 5641:      1693 C2 8F          	CLR	TF1		;CLEAR THE OVERFLOW FLAG
 5642:      1695 D2 8E          	SETB	TR1		;TURN IT ON
 5643:      1697 D1 47          	ACALL	DEC76
 5644:      1699 30 8F FD       	JNB	TF1,$		;WAIT
 5645:      169C 71 AC          	ACALL	ALPAR
 5646:      169E D2 92          	SETB	T_BIT		;BACK TO A ONE
 5647:      16A0 12 05 2F       	CALL	TIMER_LOAD1	;LOAD THE HIGH VALUE
 5648:      16A3 30 8F FD       	JNB	TF1,$		;WAIT
 5649:      16A6 70 E3          	JNZ	STONE1		;LOOP
 5650:      16A8 22             	RET
 5651:                          	;
 5652:                          	;LNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLN
 5653:                          	;
 5654:                          LNTAB:	; Natural log lookup table
 5655:                          	;
 5656:                          	;LNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLNLN
 5657:                          	;
 5658:      16A9 80             	DB	80H
 5659:      16AA 00             	DB	00H
 5660:      16AB 71             	DB	71H
 5661:      16AC 37             	DB	37H
 5662:      16AD 13             	DB	13H
 5663:      16AE 19             	DB	19H
 5664:                          	;
 5665:      16AF 7F             	DB	7FH

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 103



 Line    I  Addr Code           Source

 5666:      16B0 00             	DB	00H
 5667:      16B1 76             	DB	76H
 5668:      16B2 64             	DB	64H
 5669:      16B3 37             	DB	37H
 5670:      16B4 94             	DB	94H
 5671:                          	;
 5672:      16B5 80             	DB	80H
 5673:      16B6 00             	DB	00H
 5674:      16B7 07             	DB	07H
 5675:      16B8 22             	DB	22H
 5676:      16B9 75             	DB	75H
 5677:      16BA 17             	DB	17H
 5678:                          	;
 5679:      16BB 80             	DB	80H
 5680:      16BC 00             	DB	00H
 5681:      16BD 52             	DB	52H
 5682:      16BE 35             	DB	35H
 5683:      16BF 93             	DB	93H
 5684:      16C0 28             	DB	28H
 5685:                          	;
 5686:      16C1 80             	DB	80H
 5687:      16C2 00             	DB	00H
 5688:      16C3 71             	DB	71H
 5689:      16C4 91             	DB	91H
 5690:      16C5 85             	DB	85H
 5691:      16C6 86             	DB	86H
 5692:                          	;
 5693:      16C7 FF             	DB	0FFH
 5694:                          	;
 5695:      16C8 81             	DB	81H
 5696:      16C9 00             	DB	00H
 5697:      16CA 51             	DB	51H
 5698:      16CB 58             	DB	58H
 5699:      16CC 02             	DB	02H
 5700:      16CD 23             	DB	23H
 5701:                          	;
 5702:                          	;SINSINSINSINSINSINSINSINSINSINSINSINSI
 5703:                          	;
 5704:                          SINTAB: ; Sin lookup table
 5705:                          	;
 5706:                          	;SINSINSINSINSINSINSINSINSINSINSINSINSI
 5707:                          	;
 5708:      16CE 77             	DB	128-9
 5709:      16CF 00             	DB	00H
 5710:      16D0 44             	DB	44H
 5711:      16D1 90             	DB	90H
 5712:      16D2 05             	DB	05H
 5713:      16D3 16             	DB	16H
 5714:                          	;
 5715:      16D4 79             	DB	128-7
 5716:      16D5 01             	DB	01H
 5717:      16D6 08             	DB	08H
 5718:      16D7 21             	DB	21H
 5719:      16D8 05             	DB	05H
 5720:      16D9 25             	DB	25H
 5721:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 104



 Line    I  Addr Code           Source

 5722:      16DA 7B             	DB	128-5
 5723:      16DB 00             	DB	00H
 5724:      16DC 19             	DB	19H
 5725:      16DD 73             	DB	73H
 5726:      16DE 55             	DB	55H
 5727:      16DF 27             	DB	27H
 5728:      16E0 7D             	DB	128-3
 5729:      16E1 01             	DB	01H
 5730:      16E2 70             	DB	70H
 5731:      16E3 12             	DB	12H
 5732:      16E4 84             	DB	84H
 5733:      16E5 19             	DB	19H
 5734:                          	;
 5735:      16E6 7E             	DB	128-2
 5736:      16E7 00             	DB	00H
 5737:      16E8 33             	DB	33H
 5738:      16E9 33             	DB	33H
 5739:      16EA 33             	DB	33H
 5740:      16EB 83             	DB	83H
 5741:                          	;
 5742:      16EC 80             	DB	128
 5743:      16ED 01             	DB	01H
 5744:      16EE 67             	DB	67H
 5745:      16EF 66             	DB	66H
 5746:      16F0 66             	DB	66H
 5747:      16F1 16             	DB	16H
 5748:                          	;
 5749:      16F2 81             FPONE:	DB	128+1
 5750:      16F3 00             	DB	00H
 5751:      16F4 00             	DB	00H
 5752:      16F5 00             	DB	00H
 5753:      16F6 00             	DB	00H
 5754:      16F7 10             	DB	10H
 5755:                          	;
 5756:      16F8 FF             	DB	0FFH		;END OF TABLE
 5757:                          	;
 5758:      16F9 12 0F D9       SBAUD:	CALL	AXTAL		;PUT CRYSTAL ON THE S
 5759:      16FC 12 0F 43       	CALL	EXPRB		;PUT THE NUMBER AFTER BAUD 
 5760:      16FF 74 0C          	MOV	A,#12
 5761:      1701 91 B1          	ACALL	TWO_R2		;TOS = 12
 5762:      1703 31 B0          	ACALL	AMUL		;TOS = 12*BAUD
 5763:      1705 91 0A          	ACALL	ADIV		;TOS = XTAL/(12*BAUD)
 5764:      1707 51 23          	ACALL	IFIX
 5765:      1709 D1 7B          	ACALL	CBIAS
 5766:      170B 90 01 24       	MOV	DPTR,#SPV
 5767:                          	;
 5768:      170E 02 06 05       S31L:	JMP	S31DP
 5769:                          	;
 5770:      1711 D1 4F          AFREE:	CALL	PMTOP		;PUT MTOP ON STACK
 5771:      1713 12 05 A9       	CALL	G4		;GET END ADDRESS
 5772:      1716 A8 82          	MOV	R0,DPL
 5773:      1718 AA 83          	MOV	R2,DPH
 5774:      171A 91 B4          	ACALL	TWO_EY
 5775:                          	;
 5776:      171C 12 19 71       ASUB:	LCALL	FP_BASE1	;DO FP SUB
 5777:      171F 01 38          	AJMP	FPTST

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 105



 Line    I  Addr Code           Source

 5778:                          	;
 5779:      1721 12 05 1C       ALEN:	CALL	CCAL		;CALCULATE THE LEN OF T
 5780:      1724 AA 07          	MOV	R2,R7B0 	;SAVE THE HIGH BYTE
 5781:      1726 EE             	MOV	A,R6		;SAVE THE LOW BYTE
 5782:      1727 81 B3          	AJMP	TWO_EX		;PUT IT ON THE STACK
 5783:                          	;
 5784:      1729 A2 AF          ATIME:	MOV	C,EA		;SAVE INTERRUTS
 5785:      172B C2 AF          	CLR	EA
 5786:      172D C0 47          	PUSH	MILLIV		;SAVE MILLI VALUE
 5787:      172F AA 48          	MOV	R2,TVH		;GET THE TIMER
 5788:      1731 E5 49          	MOV	A,TVL
 5789:      1733 92 AF          	MOV	EA,C		;SAVE INTERRUPTS
 5790:      1735 91 B3          	ACALL	TWO_EX		;PUT TIMER ON THE STACK
 5791:      1737 D0 E0          	POP	ACC		;GET MILLI
 5792:      1739 91 B1          	ACALL	TWO_R2		;PUT MILLI ON STACK
 5793:      173B 74 C8          	MOV	A,#200
 5794:      173D 91 B1          	ACALL	TWO_R2		;DIVIDE MILLI BY 200
 5795:      173F 91 0A          	ACALL	ADIV
 5796:                          	;
 5797:      1741 12 19 6F       AADD:	LCALL	FP_BASE 	;DO FP ADDITION
 5798:      1744 01 38          	AJMP	FPTST		;CHECK FOR ERRORS
 5799:                          	;
 5800:                          	;**************************************
 5801:                          	;
 5802:                          	; Here are some error messages that wer
 5803:                          	;
 5804:                          	;**************************************
 5805:                          	;
 5806:                          	;
 5807:      1746 42 41 44 20    E1X:	DB	'BAD SYNTAX"'
            174A 53 59 4E 54
            174E 41 58 22
 5808:      1751 8A             E2X:	DB	128+10
 5809:      1752 44 49 56 49    	DB	'DIVIDE BY ZERO"'
            1756 44 45 20 42
            175A 59 20 5A 45
            175E 52 4F 22
 5810:                          	;
 5811:      1761 41 52 52 41    E6X:	DB	'ARRAY SIZE"'
            1765 59 20 53 49
            1769 5A 45 22
 5812:                          	;
 5813:                          	;**************************************
 5814:                          	;
 5815:                          T_BUF:	; TXA gets IBUF
 5816:                          	;
 5817:                          	;**************************************
 5818:                          	;
 5819:      176C 75 0A 00       	MOV	TXAH,#HIGH IBUF
 5820:      176F 75 08 07       	MOV	TXAL,#LOW IBUF
 5821:      1772 22             	RET
 5822:                          	;
 5823:                          	;
 5824:                          	;**************************************
 5825:                          	;
 5826:                          CXFER:	; Transfer a program from rom to 

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 106



 Line    I  Addr Code           Source

 5827:                          	;
 5828:                          	;**************************************
 5829:                          	;
 5830:      1773 12 05 1C       	CALL	CCAL		;GET EVERYTHING SET UP
 5831:      1776 7A 02          	MOV	R2,#HIGH PSTART
 5832:      1778 78 00          	MOV	R0,#LOW PSTART
 5833:      177A B1 6D          	ACALL	LMOV		;DO THE TRANSFER
 5834:      177C 12 06 64       	CALL	RCLEAR		;CLEAR THE MEMORY
 5835:                          	;
 5836:                          	; Fall thru to CRAM
 5837:                          	;
 5838:                          	;**************************************
 5839:                          	;
 5840:                          CRAM:	; The command action routine - RAM
 5841:                          	;
 5842:                          	;**************************************
 5843:                          	;
 5844:      177F C2 17          	CLR	CONB		;CAN'T CONTINUE IF MODE CHANG
 5845:      1781 75 13 02       	MOV	BOFAH,#HIGH PSTART
 5846:      1784 75 14 00       	MOV	BOFAL,#LOW PSTART
 5847:                          	;
 5848:                          	; Fall thru to Command Processor
 5849:                          	;
 5850:                          	;**************************************
 5851:                          	;
 5852:                          CMND1:	; The entry point for the command
 5853:                          	;
 5854:                          	;**************************************
 5855:                          	;
 5856:      1787 12 0C 31       	LCALL	SPRINT1 	;WASTE AT AND HEX
 5857:      178A C2 2D          	CLR	XBIT		;TO RESET IF NEEDED
 5858:                          ;
 5859:                          ;***************************************
 5860:                          ;****** Karmann 1 Bugfix ***************
 5861:                          ;
 5862:      178C F1 E0          	acall	TEST_USER	;check for user command
 5863:                          ;
 5864:                          ;****** continue with original code: ***
 5865:                          ;
 5866:      178E 90 00 FD       	MOV	DPTR,#RDYS	;PRINT THE READY MESSAGE
 5867:      1791 12 06 AD       	CALL	CRP		;DO A CR, THEN, PRINT FROM TH
 5868:                          	;
 5869:      1794 D2 2F          CMNDR:	SETB	DIRF		;SET THE DIRECT INPUT 
 5870:      1796 85 3E 81       	MOV	SP,SPSAV	;LOAD THE STACK
 5871:      1799 11 9D          	ACALL	CL7		;DO A CRLF
 5872:                          	;
 5873:      179B C2 18          CMNX:	CLR	GTRD		;CLEAR BREAK
 5874:      179D 90 00 5E       	MOV	DPTR,#5EH	;DO RUN TRAP
 5875:      17A0 E0             	MOVX	A,@DPTR
 5876:      17A1 64 34          	XRL	A,#52
 5877:      17A3 70 03          	JNZ	CMNX1
 5878:      17A5 02 08 02       	LJMP	CRUN
 5879:      17A8 7D 3E          CMNX1:	MOV	R5,#'>'         ;OUTPUT A PRO
 5880:      17AA 12 07 11       	LCALL	TEROT
 5881:      17AD 12 06 D8       	CALL	INLINE		;INPUT A LINE INTO IBUF
 5882:      17B0 B1 BA          	CALL	PP		;PRE-PROCESS THE LINE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 107



 Line    I  Addr Code           Source

 5883:      17B2 20 D5 0F       	JB	F0,CMND3	;NO LINE NUMBER
 5884:      17B5 91 F0          	CALL	LINE		;PROCESS THE LINE
 5885:      17B7 12 05 E7       	LCALL	LCLR
 5886:      17BA 20 15 DE       	JB	LINEB,CMNX	;DON'T CLEAR MEMORY IF NO
 5887:      17BD D2 15          	SETB	LINEB
 5888:      17BF 12 06 64       	LCALL	RCLEAR		;CLEAR THE MEMORY
 5889:      17C2 80 D7          	SJMP	CMNX		;LOOP BACK
 5890:                          	;
 5891:      17C4 F1 6C          CMND3:	CALL	T_BUF		;SET UP THE TEXT POIN
 5892:      17C6 12 0E E1       	CALL	DELTST		;GET THE CHARACTER
 5893:      17C9 60 C9          	JZ	CMNDR		;IF CR, EXIT
 5894:      17CB 90 01 0F       	MOV	DPTR,#CMNDD	;POINT AT THE COMMAND L
 5895:      17CE B4 F0 00       	CJNE	A,#T_CMND,CMND31;PROCESS STATEMENT
 5896:      17D1 40 0A          CMND31: JC	CMND5
 5897:      17D3 12 0E D7       	CALL	GCI1		;BUMP TXA
 5898:      17D6 54 0F          	ANL	A,#0FH		;STRIP MSB'S FOR LOOKUP
 5899:      17D8 12 09 5C       	LCALL	ISTA1		;PROCESS COMMAND
 5900:      17DB 80 B7          	SJMP	CMNDR
 5901:                          	;
 5902:      17DD 02 08 13       CMND5:	LJMP	ILOOP		;CHECK FOR A POSSIBLE
 5903:                          ;
 5904:                          ;***************************************
 5905:                          ;****** Karmann 1 Bugfix ***************
 5906:                          ;
 5907:                          TEST_USER:			;check for user command ext
 5908:      17E0 E4             	CLR	A
 5909:      17E1 90 20 02       	MOV	DPTR,#2002H	;CHECK FOR EXTERNAL TRA
 5910:      17E4 93             	MOVC	A,@A+DPTR
 5911:      17E5 B4 5A 03       	CJNE	A,#5AH,CMND11	;test for user comma
 5912:      17E8 12 20 48       	LCALL	2048H		;IF PRESENT JUMP TO LOCATI
 5913:      17EB 22             CMND11: ret
 5914:                          ;
 5915:                          ;****** continue with original code: ***
 5916:                          ;
 5917:                          	;CONSTANTS
 5918:                          	;
 5919:      17EC 88             XTALV:	DB	128+8		; DEFAULT CRYSTAL VALUE
 5920:      17ED 00             	DB	00H
 5921:      17EE 00             	DB	00H
 5922:      17EF 92             	DB	92H
 5923:      17F0 05             	DB	05H
 5924:      17F1 11             	DB	11H
 5925:                          	;
 5926:      17F2 85             EXP11:	DB	85H
 5927:      17F3 00             	DB	00H
 5928:      17F4 42             	DB	42H
 5929:      17F5 41             	DB	41H
 5930:      17F6 87             	DB	87H
 5931:      17F7 59             	DB	59H
 5932:                          	;
 5933:      17F8 81             EXP1:	DB	128+1		; EXP(1)
 5934:      17F9 00             	DB	00H
 5935:      17FA 18             	DB	18H
 5936:      17FB 28             	DB	28H
 5937:      17FC 18             	DB	18H
 5938:      17FD 27             	DB	27H

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 108



 Line    I  Addr Code           Source

 5939:                          ;
 5940:                          ;***************************************
 5941:                          ;****** Disable Intel programming for to
 5942:                          ;
 5943:                          ;IPTIME: DB	128-4		;FPROG TIMING
 5944:                          ;	DB	00H
 5945:                          ;	DB	00H
 5946:                          ;	DB	00H
 5947:                          ;	DB	75H
 5948:                          ;	DB	83H
 5949:                          ;
 5950:                          ;***************************************
 5951:                          ;
 5952:      17FE 81             PIE:	DB	128+1		;PI
 5953:      17FF 00             	DB	00H
 5954:      1800 26             	DB	26H
 5955:      1801 59             	DB	59H
 5956:      1802 41             	DB	41H
 5957:      1803 31             	DB	31H		; 3.1415926
 5958:                          	;
 5959:                          	;**************************************
 5960:                          	;
 5961:                          	; The error messages, some have been mo
 5962:                          	;
 5963:                          	;**************************************
 5964:                          	;
 5965:      1804 9E             E7X:	DB	128+30
 5966:      1805 41 52 49 54    	DB	'ARITH. UNDERFLOW"'
            1809 48 2E 20 55
            180D 4E 44 45 52
            1811 46 4C 4F 57
            1815 22
 5967:                          	;
 5968:      1816 4D 45 4D 4F    E5X:	DB	'MEMORY ALLOCATION"'
            181A 52 59 20 41
            181E 4C 4C 4F 43
            1822 41 54 49 4F
            1826 4E 22
 5969:                          	;
 5970:      1828 A8             E3X:	DB	128+40
 5971:      1829 42 41 44 20    	DB	'BAD ARGUMENT"'
            182D 41 52 47 55
            1831 4D 45 4E 54
            1835 22
 5972:                          	;
 5973:      1836 49 2D 53 54    EXI:	DB	'I-STACK"'
            183A 41 43 4B 22
 5974:                          	;
 5975:                          	;**************************************
 5976:                          	;
 5977:                          	; The command action routine - CONTINUE
 5978:                          	;
 5979:                          	;**************************************
 5980:                          	;
 5981:      183E 90 1F A6       CCONT:	MOV	DPTR,#E15X
 5982:      1841 30 17 4B       	JNB	CONB,ERROR	;ERROR IF CONTINUE IS NO

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 109



 Line    I  Addr Code           Source

 5983:                          	;
 5984:                          CC1:	;used for input statement entry
 5985:                          	;
 5986:      1844 85 42 0A       	MOV	TXAH,INTXAH	;RESTORE TXA
 5987:      1847 85 43 08       	MOV	TXAL,INTXAL
 5988:      184A 02 08 0F       	JMP	CILOOP		;EXECUTE
 5989:                          	;
 5990:      184D 85 0F 83       DTEMP:	MOV	DPH,TEMP5	;RESTORE DPTR
 5991:      1850 85 0E 82       	MOV	DPL,TEMP4
 5992:      1853 22             	RET
 5993:                          	;
 5994:      1854 85 83 0F       TEMPD:	MOV	TEMP5,DPH
 5995:      1857 85 82 0E       	MOV	TEMP4,DPL
 5996:      185A 22             	RET
 5997:                          	;
 5998:                          	;**************************************
 5999:                          	;
 6000:                          I_DL:	; IDLE
 6001:                          	;
 6002:                          	;**************************************
 6003:                          	;
 6004:      185B 20 2F 27       	JB	DIRF,E1XX	;SYNTAX ERROR IN DIRECT IN
 6005:      185E C2 96          	CLR	DACK		;ACK IDLE
 6006:                          	;
 6007:      1860 43 87 01       U_ID1:	ORL	PCON,#01H
 6008:                          ;	DB	01000011B	;ORL DIRECT OP CODE
 6009:                          ;	DB	87H		;PCON ADDRESS
 6010:                          ;	DB	01H		;SET IDLE BIT
 6011:      1863 20 16 0B       	JB	INTPEN,I_RET	;EXIT IF EXTERNAL INTER
 6012:      1866 10 21 08       	JBC	U_IDL,I_RET	;EXIT IF USER WANTS TO
 6013:      1869 30 10 F4       	JNB	OTS,U_ID1	;LOOP IF TIMER NOT ENABLE
 6014:      186C 12 07 E3       	LCALL	T_CMP		;CHECK THE TIMER
 6015:      186F 40 EF          	JC	U_ID1		;LOOP IF TIME NOT BIG ENOUGH
 6016:                          	;
 6017:      1871 D2 96          I_RET:	SETB	DACK		;RESTORE EXECUTION
 6018:      1873 22             	RET			;EXIT IF IT IS
 6019:                          	;
 6020:                          	;
 6021:                          	;
 6022:      1874 A3             ER0:	INC	DPTR		;BUMP TO TEXT
 6023:      1875 20 2F 23       	JB	DIRF,ERROR0	;CAN'T GET OUT OF DIRECT
 6024:      1878 30 13 20       	JNB	ON_ERR,ERROR0	;IF ON ERROR ISN'T SE
 6025:      187B 90 01 01       	MOV	DPTR,#ERRLOC	;SAVE THE ERROR CODE
 6026:      187E 12 06 73       	CALL	RC2		;SAVE ERROR AND SET UP THE ST
 6027:      1881 A3             	INC	DPTR		;POINT AT ERRNUM
 6028:      1882 02 08 44       	JMP	ERL4		;LOAD ERR NUM AND EXIT
 6029:                          	;
 6030:                          	; Syntax error
 6031:                          	;
 6032:      1885 A2 2F          E1XX:	MOV	C,DIRF		;SEE IF IN DIRECT MODE
 6033:      1887 90 17 46       E1XX1:	MOV	DPTR,#E1X	;ERROR MESSAGE
 6034:      188A 80 04          	SJMP	ERROR1		;TRAP ON SET DIRF
 6035:                          	;
 6036:      188C 90 18 36       E1XX2:	MOV	DPTR,#EXI	;STACK ERROR
 6037:                          	;
 6038:                          	; Falls through

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 110



 Line    I  Addr Code           Source

 6039:                          	;
 6040:                          	;**************************************
 6041:                          	;
 6042:                          	;ERROR PROCESSOR - PRINT OUT THE ERROR 
 6043:                          	;		   RUN OR COMMAND MODE, FIND AND PRI
 6044:                          	;		   LINE NUMBER IF IN RUN MODE
 6045:                          	;
 6046:                          	;**************************************
 6047:                          	;
 6048:      188F C3             ERROR:	CLR	C		;RESET STACK
 6049:      1890 85 3E 81       ERROR1: MOV	SP,SPSAV	;RESET THE STACK
 6050:      1893 12 0C 31       	LCALL	SPRINT1 	;CLEAR LINE AND AT MODE
 6051:      1896 E4             	CLR	A		;SET UP TO GET ERROR CODE
 6052:      1897 93             	MOVC	A,@A+DPTR
 6053:      1898 10 E7 D9       	JBC	ACC.7,ER0	;PROCESS ERROR
 6054:                          	;
 6055:      189B 11 54          ERROR0: ACALL	TEMPD		;SAVE THE DATA POIN
 6056:      189D 40 03          	JC	ERROR01 	;NO RESET IF CARRY IS SET
 6057:      189F 12 06 6F       	LCALL	RC1		;RESET THE STACKS
 6058:      18A2 12 06 A3       ERROR01:CALL	CRLF2		;DO TWO CARRIAGE RET
 6059:      18A5 90 1F F8       	MOV	DPTR,#ERS	;OUTPUT ERROR MESSAGE
 6060:      18A8 12 06 AF       	CALL	ROM_P
 6061:      18AB 11 4D          	CALL	DTEMP		;GET THE ERROR MESSAGE BACK
 6062:                          	;
 6063:      18AD 12 06 AF       ERRS:	CALL	ROM_P		;PRINT ERROR TYPE
 6064:      18B0 30 2F 05       	JNB	DIRF,ER1	;DO NOT PRINT IN LINE IF D
 6065:                          	;
 6066:      18B3 C2 20          SERR1:	CLR	STOPBIT 	;PRINT STOP THEN EXI
 6067:      18B5 02 17 87       	JMP	CMND1
 6068:                          	;
 6069:      18B8 90 01 03       ER1:	MOV	DPTR,#INS	;OUTPUT IN LINE
 6070:      18BB 12 06 AF       	CALL	ROM_P
 6071:                          	;
 6072:                          	;NOW, FIND THE LINE NUMBER
 6073:                          	;
 6074:                          	;
 6075:      18BE 12 0E 9B       	CALL	DP_B		;GET THE FIRST ADDRESS OF TH
 6076:      18C1 E4             	CLR	A		;FOR INITIALIZATION
 6077:                          	;
 6078:      18C2 11 54          ER2:	ACALL	TEMPD		;SAVE THE DPTR
 6079:      18C4 12 05 DE       	CALL	ADDPTR		;ADD ACC TO DPTR
 6080:      18C7 11 FB          	ACALL	ER4		;R3:R1 = TXA-DPTR
 6081:      18C9 40 06          	JC	ER3		;EXIT IF DPTR>TXA
 6082:      18CB 60 04          	JZ	ER3		;EXIT IF DPTR=TXA
 6083:      18CD E0             	MOVX	A,@DPTR 	;GET LENGTH
 6084:      18CE B4 01 F1       	CJNE	A,#EOF,ER2	;SEE IF AT THE END
 6085:                          	;
 6086:      18D1 11 4D          ER3:	ACALL	DTEMP		;PUT THE LINE IN THE D
 6087:      18D3 11 FB          	ACALL	ER4		;R3:R1 = TXA - BEGINNING OF 
 6088:      18D5 E9             	MOV	A,R1		;GET LENGTH
 6089:      18D6 24 0A          	ADD	A,#10		;ADD 10 TO LENGTH, DPTR STIL
 6090:      18D8 F5 45          	MOV	MT1,A		;SAVE THE COUNT
 6091:      18DA A3             	INC	DPTR		;POINT AT LINE NUMBER HIGH BY
 6092:      18DB 12 16 52       	CALL	PMTOP1		;LOAD R2:R0, PUT IT ON THE
 6093:      18DE 31 7D          	ACALL	FP_BASE7	;OUTPUT IT
 6094:      18E0 20 20 D0       	JB	STOPBIT,SERR1	;EXIT IF STOP BIT SET

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 111



 Line    I  Addr Code           Source

 6095:      18E3 12 06 A3       	CALL	CRLF2		;DO SOME CRLF'S
 6096:      18E6 11 4D          	CALL	DTEMP
 6097:      18E8 12 10 A3       	CALL	UPPL		;UNPROCESS THE LINE
 6098:      18EB 12 10 94       	CALL	CL6		;PRINT IT
 6099:      18EE 7D 2D          ER31:	MOV	R5,#'-'         ;OUTPUT DASHES
 6100:      18F0 31 6C          	ACALL	T_L		;PRINT AN X IF ERROR CHARACT
 6101:      18F2 D5 45 F9       	DJNZ	MT1,ER31	;LOOP UNTIL DONE
 6102:      18F5 7D 58          	MOV	R5,#'X'
 6103:      18F7 31 6C          	ACALL	T_L
 6104:      18F9 01 B3          	AJMP	SERR1
 6105:                          	;
 6106:      18FB AB 0A          ER4:	MOV	R3,TXAH 	;GET TEXT POINTER AND 
 6107:      18FD A9 08          	MOV	R1,TXAL
 6108:      18FF 02 0A 02       	JMP	DUBSUB
 6109:                          	;
 6110:                          	;**************************************
 6111:                          	;
 6112:                          	; Interrupt driven timer
 6113:                          	;
 6114:                          	;**************************************
 6115:                          	;
 6116:      1902 85 4A 8C       I_DR:	MOV	TH0,SAVE_T	;LOAD THE TIMER
 6117:      1905 C5 47          	XCH	A,MILLIV	;SAVE A, GET MILLI COUNTER
 6118:      1907 04             	INC	A		;BUMP COUNTER
 6119:      1908 B4 C8 08       	CJNE	A,#200,TR	;CHECK OUT TIMER VALUE
 6120:      190B E4             	CLR	A		;FORCE ACC TO BE ZERO
 6121:      190C 05 49          	INC	TVL		;INCREMENT LOW TIMER
 6122:      190E B5 49 02       	CJNE	A,TVL,TR	;CHECK LOW VALUE
 6123:      1911 05 48          	INC	TVH		;BUMP TIMER HIGH
 6124:                          	;
 6125:      1913 C5 47          TR:	XCH	A,MILLIV
 6126:      1915 D0 D0          	POP	PSW
 6127:      1917 32             	RETI
 6128:                          	;
 6129:                          	;**************************************
 6130:                          	;
 6131:                          	; The statement action routine - CLOCK
 6132:                          	;
 6133:                          	;**************************************
 6134:                          	;
 6135:      1918 31 38          SCLOCK: ACALL	OTST		;GET CHARACTER AFTER
 6136:      191A C2 A9          	CLR	ET0
 6137:      191C C2 2E          	CLR	C_BIT
 6138:      191E 50 0D          	JNC	SC_R		;EXIT IF A ZERO
 6139:                          ;
 6140:                          ;***************************************
 6141:                          ;****** Use XTAL up to 47 MHz **********
 6142:                          ;****** Wulf 2 *************************
 6143:                          ;
 6144:                          ;	ANL	TMOD,#0F0H	;SET UP THE MODE
 6145:                          ;
 6146:      1920 53 89 F1       	anl	TMOD,#0F1H	;Set up 16 bit mode for 
 6147:      1923 43 89 01       	orl	TMOD,#01H
 6148:                          ;
 6149:                          ;***************************************
 6150:                          ;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 112



 Line    I  Addr Code           Source

 6151:      1926 D2 2E          	SETB	C_BIT		;USER INTERRUPTS
 6152:      1928 43 A8 82       	ORL	IE,#82H 	;ENABLE ET0 AND EA
 6153:      192B D2 8C          	SETB	TR0		;TURN ON THE TIMER
 6154:                          	;
 6155:      192D 22             SC_R:	RET
 6156:                          	;
 6157:                          	;**************************************
 6158:                          	;
 6159:                          SUI:	; Statement USER IN action routine
 6160:                          	;
 6161:                          	;**************************************
 6162:                          	;
 6163:      192E 31 38          	ACALL	OTST
 6164:      1930 92 1E          	MOV	CIUB,C		;SET OR CLEAR CIUB
 6165:      1932 22             	RET
 6166:                          	;
 6167:                          	;**************************************
 6168:                          	;
 6169:                          SUO:	; Statement USER OUT action routine
 6170:                          	;
 6171:                          	;**************************************
 6172:                          	;
 6173:      1933 31 38          	ACALL	OTST
 6174:      1935 92 1C          	MOV	COUB,C
 6175:      1937 22             	RET
 6176:                          	;
 6177:                          OTST:	; Check for a one
 6178:                          	;
 6179:      1938 12 0E D5       	LCALL	GCI		;GET THE CHARACTER, CLEARS C
 6180:      193B 94 31          	SUBB	A,#'1'          ;SEE IF A ONE
 6181:      193D B3             	CPL	C		;SETS CARRY IF ONE, CLEARS IT IF
 6182:      193E 22             OTST1:	RET
 6183:                          	;
 6184:                          	;**************************************
 6185:                          	;
 6186:                          	; IBLK - EXECUTE USER SUPPLIED TOKEN
 6187:                          	;
 6188:                          	;**************************************
 6189:                          	;
 6190:      193F 20 D4 FC       IBLK:	JB	PSW.4,OTST1	;EXIT IF REGISTER B
 6191:      1942 20 D3 F9       	JB	PSW.3,OTST1
 6192:      1945 10 E7 06       	JBC	ACC.7,IBLK1	;SEE IF BIT SEVEN IS SE
 6193:      1948 90 00 47       	MOV	DPTR,#USENT	;USER ENTRY LOCATION
 6194:      194B 02 09 5C       	LJMP	ISTA1
 6195:                          	;
 6196:      194E 20 E0 2A       IBLK1:	JB	ACC.0,FP_BASE6	;FLOATING POINT
 6197:      1951 60 19          	JZ	T_L		;DO OUTPUT ON 80H
 6198:      1953 90 19 6D       	MOV	DPTR,#FP_BASE-2
 6199:      1956 73             	JMP	@A+DPTR
 6200:                          	;
 6201:                          	;
 6202:                          	;**************************************
 6203:                          	;
 6204:                          	; GET_NUM - GET A NUMBER, EITHER HEX OR
 6205:                          	;
 6206:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 113



 Line    I  Addr Code           Source

 6207:                          	;
 6208:      1957 31 79          GET_NUM:ACALL	FP_BASE5	;SCAN FOR HEX
 6209:      1959 50 20          	JNC	FP_BASE6	;DO FP INPUT
 6210:                          	;
 6211:      195B 31 81          	ACALL	FP_BASE9	;ASCII STRING TO R2:R0
 6212:      195D 70 0C          	JNZ	H_RET
 6213:      195F C0 83          	PUSH	DPH		;SAVE THE DATA_POINTER
 6214:      1961 C0 82          	PUSH	DPL
 6215:      1963 31 87          	ACALL	FP_BASE12	;PUT R2:R0 ON THE STACK
 6216:      1965 D0 82          	POP	DPL		;RESTORE THE DATA_POINTER
 6217:      1967 D0 83          	POP	DPH
 6218:      1969 E4             	CLR	A		;NO ERRORS
 6219:      196A 22             	RET			;EXIT
 6220:                          	;
 6221:                          	;**************************************
 6222:                          	;
 6223:                          	; WB - THE EGO MESSAGE
 6224:                          	;
 6225:                          	;**************************************
 6226:                          ;
 6227:                          ;***************************************
 6228:                          ;****** Sorry - but the ego message had 
 6229:                          ;
 6230:                          ;WB:
 6231:                          ;
 6232:                          ;	DB	'W'+80H,'R'+80H
 6233:                          ;	DB	'I'+80H,'T'+80H,'T','E'+80H,'N'+80H
 6234:                          ;	DB	' ','B'+80H,'Y'+80H,' '
 6235:                          ;	DB	'J'+80H,'O'+80H,'H'+80H,'N'+80H,' '
 6236:                          ;	DB	'K','A'+80H,'T'+80H,'A'+80H,'U'+80H
 6237:                          ;	DB	'S','K'+80H,'Y'+80H
 6238:                          ;	DB	', I','N'+80H,'T'+80H,'E'+80H,'L'+8
 6239:                          ;	DB	' '+80H,'C'+80H,'O'+80H,'R'+80H,'P'
 6240:                          ;	DB	'. 1','9'+80H,'85'
 6241:                          ;
 6242:                          ;***************************************
 6243:                          	;
 6244:      196B 22             H_RET:	RET
 6245:                          	;
 6246:                          ;***************************************
 6247:                          ;
 6248:                          ; This is a complete BCD floating point 
 6249:                          ; controller. It provides 8 digits of ac
 6250:                          ; range from +127 to -127. The mantissa 
 6251:                          ; exponent is expressed in pseudo-twos c
 6252:                          ; is used to express the number ZERO. An
 6253:                          ; greater than means the exponent is pos
 6254:                          ; 81H = E+1, 82H = E+2 and so on. If the
 6255:                          ; the exponent is negative, 7FH = E-1, 7
 6256:                          ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZ
 6257:                          ; normalized after calculation. A normal
 6258:                          ; <=.99999999.
 6259:                          ;
 6260:                          ; The numbers in memory assumed to be st
 6261:                          ;
 6262:                          ; EXPONENT OF ARGUMENT 2   =   VALUE OF 

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 114



 Line    I  Addr Code           Source

 6263:                          ; SIGN OF ARGUMENT 2	   =   VALUE OF ARG
 6264:                          ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF 
 6265:                          ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF 
 6266:                          ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF 
 6267:                          ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF 
 6268:                          ;
 6269:                          ; EXPONENT OF ARGUMENT 1   =   VALUE OF 
 6270:                          ; SIGN OF ARGUMENT 1	   =   VALUE OF ARG
 6271:                          ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF 
 6272:                          ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF 
 6273:                          ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF 
 6274:                          ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF 
 6275:                          ;
 6276:                          ; The operations are performed thusly:
 6277:                          ;
 6278:                          ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+F
 6279:                          ;
 6280:                          ; Which is ARGUMENT 2 = ARGUMENT 2 # ARG
 6281:                          ;
 6282:                          ; Where # can be ADD, SUBTRACT, MULTIPLY
 6283:                          ;
 6284:                          ; Note that the stack gets popped after 
 6285:                          ;
 6286:                          ; The FP_COMP instruction POPS the ARG_S
 6287:                          ;
 6288:                          ;***************************************
 6289:                          ;
 6290:                          ;***************************************
 6291:                          ;
 6292:                          ; STATUS ON RETURN - After performing an
 6293:                          ;		     the accumulator contains the fol
 6294:                          ;
 6295:                          ; ACCUMULATOR - BIT 0 - FLOATING POINT U
 6296:                          ;
 6297:                          ;	      - BIT 1 - FLOATING POINT OVERFLO
 6298:                          ;
 6299:                          ;	      - BIT 2 - RESULT WAS ZER0
 6300:                          ;
 6301:                          ;	      - BIT 3 - DIVIDE BY ZERO ATTEMPT
 6302:                          ;
 6303:                          ;	      - BIT 4 - NOT USED, 0 RETURNED
 6304:                          ;
 6305:                          ;	      - BIT 5 - NOT USED, 0 RETURNED
 6306:                          ;
 6307:                          ;	      - BIT 6 - NOT USED, 0 RETURNED
 6308:                          ;
 6309:                          ;	      - BIT 7 - NOT USED, 0 RETURNED
 6310:                          ;
 6311:                          ; NOTE: When underflow occures, a ZERO r
 6312:                          ;	When overflow or divide by zero occure
 6313:                          ;	.99999999 E+127 is returned and it is 
 6314:                          ;	to handle these conditions as needed i
 6315:                          ;
 6316:                          ; NOTE: The Compare instruction returns 
 6317:                          ;	and returns a CARRY FLAG = 1 if ARG 1 
 6318:                          ;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 115



 Line    I  Addr Code           Source

 6319:                          ;***************************************
 6320:                          ;
 6321:                          ;***************************************
 6322:                          ;
 6323:                          ; The following values MUST be provided 
 6324:                          ;
 6325:                          ;***************************************
 6326:                          ;
 6327:           N      0009    ARG_STACK	EQU	9	;ARGUMENT STACK POINTER
 6328:           N      0001    ARG_STACK_PAGE	EQU	1
 6329:                          ;OUTPUT 	 EQU	 1990H	 ;CALL LOCATION TO 
 6330:           N      0058    CONVERT 	EQU	58H	;LOCATION TO CONVERT NU
 6331:           B        19    INTGRC		BIT	25	;BIT SET IF INTGER ERROR
 6332:                          ;
 6333:                          ;***************************************
 6334:                          ;
 6335:                          ; The following equates are used interna
 6336:                          ;
 6337:                          ;***************************************
 6338:                          ;
 6339:           N      0006    FP_NUMBER_SIZE	EQU	6
 6340:           N      0000    UNDERFLOW	EQU	0
 6341:           N      0001    OVERFLOW	EQU	1
 6342:           N      0002    ZERO		EQU	2
 6343:           N      0003    ZERO_DIVIDE	EQU	3
 6344:                          ;
 6345:                          ;***************************************
 6346:                          ;
 6347:                          	;**************************************
 6348:                          	;
 6349:                          	; The following internal locations are 
 6350:                          	; ordering is important and the FP_DIGI
 6351:                          	; addressable
 6352:                          	;
 6353:                          	;**************************************
 6354:                          	;
 6355:           N      0028    FP_STATUS	EQU	28H		;NOT USED
 6356:           N      0029    FP_TEMP 	EQU	FP_STATUS+1	;NOT USED
 6357:           N      002A    FP_CARRY	EQU	FP_STATUS+2	;USED FOR BITS
 6358:           B        23    ADD_IN		BIT	35		;DCMPXZ IN BASIC BACKAGE
 6359:           B        50    XSIGN		BIT	FP_CARRY.0
 6360:           B        51    FOUND_RADIX	BIT	FP_CARRY.1
 6361:           B        52    FIRST_RADIX	BIT	FP_CARRY.2
 6362:           B        53    DONE_LOAD	BIT	FP_CARRY.3
 6363:           N      002B    FP_DIG12	EQU	FP_CARRY+1
 6364:           N      002C    FP_DIG34	EQU	FP_CARRY+2
 6365:           N      002D    FP_DIG56	EQU	FP_CARRY+3
 6366:           N      002E    FP_DIG78	EQU	FP_CARRY+4
 6367:           N      002F    FP_SIGN 	EQU	FP_CARRY+5
 6368:           B        78    MSIGN		BIT	FP_SIGN.0
 6369:           N      0030    FP_EXP		EQU	FP_CARRY+6
 6370:           N      002B    FP_NIB1 	EQU	FP_DIG12
 6371:           N      002C    FP_NIB2 	EQU	FP_NIB1+1
 6372:           N      002D    FP_NIB3 	EQU	FP_NIB1+2
 6373:           N      002E    FP_NIB4 	EQU	FP_NIB1+3
 6374:           N      002F    FP_NIB5 	EQU	FP_NIB1+4

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 116



 Line    I  Addr Code           Source

 6375:           N      0030    FP_NIB6 	EQU	FP_NIB1+5
 6376:           N      0031    FP_NIB7 	EQU	FP_NIB1+6
 6377:           N      0032    FP_NIB8 	EQU	FP_NIB1+7
 6378:           N      0033    FP_ACCX 	EQU	FP_NIB1+8
 6379:           N      0034    FP_ACCC 	EQU	FP_NIB1+9
 6380:           N      0035    FP_ACC1 	EQU	FP_NIB1+10
 6381:           N      0036    FP_ACC2 	EQU	FP_NIB1+11
 6382:           N      0037    FP_ACC3 	EQU	FP_NIB1+12
 6383:           N      0038    FP_ACC4 	EQU	FP_NIB1+13
 6384:           N      0039    FP_ACC5 	EQU	FP_NIB1+14
 6385:           N      003A    FP_ACC6 	EQU	FP_NIB1+15
 6386:           N      003B    FP_ACC7 	EQU	FP_NIB1+16
 6387:           N      003C    FP_ACC8 	EQU	FP_NIB1+17
 6388:           N      003D    FP_ACCS 	EQU	FP_NIB1+18
 6389:                          	;
 6390:                          ;	 ORG	 1990H
 6391:                          	;
 6392:                          OUTPUT:
 6393:      196C 02 07 11       T_L:	LJMP	TEROT
 6394:                          	;
 6395:                          	;
 6396:                          	;**************************************
 6397:                          	;
 6398:                          	; The floating point entry points and j
 6399:                          	;
 6400:                          	;**************************************
 6401:                          	;
 6402:      196F 21 93          FP_BASE:	AJMP	FLOATING_ADD
 6403:      1971 21 89          FP_BASE1:	AJMP	FLOATING_SUB
 6404:      1973 41 43          FP_BASE2:	AJMP	FLOATING_COMP
 6405:      1975 41 73          FP_BASE3:	AJMP	FLOATING_MUL
 6406:      1977 41 B0          FP_BASE4:	AJMP	FLOATING_DIV
 6407:      1979 81 89          FP_BASE5:	AJMP	HEXSCAN
 6408:      197B 81 C2          FP_BASE6:	AJMP	FLOATING_POINT_INPUT
 6409:      197D A1 7A          FP_BASE7:	AJMP	FLOATING_POINT_OUTPUT
 6410:      197F C1 F7          FP_BASE8:	AJMP	CONVERT_BINARY_TO_ASCII_S
 6411:      1981 C1 9E          FP_BASE9:	AJMP	CONVERT_ASCII_STRING_TO_B
 6412:      1983 C1 D3          FP_BASE10:	AJMP	MULNUM10
 6413:      1985 E1 30          FP_BASE11:	AJMP	HEXOUT
 6414:      1987 81 B6          FP_BASE12:	AJMP	PUSHR2R0
 6415:                          	;
 6416:                          	;
 6417:                          FLOATING_SUB:
 6418:                          	;
 6419:      1989 75 A0 01       	MOV	P2,#ARG_STACK_PAGE
 6420:      198C A8 09          	MOV	R0,ARG_STACK
 6421:      198E 18             	DEC	R0		;POINT TO SIGN
 6422:      198F E2             	MOVX	A,@R0		;READ SIGN
 6423:      1990 B2 E0          	CPL	ACC.0
 6424:      1992 F2             	MOVX	@R0,A
 6425:                          	;
 6426:                          	;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
 6427:                          	;
 6428:                          FLOATING_ADD:
 6429:                          	;
 6430:                          	;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 117



 Line    I  Addr Code           Source

 6431:                          	;
 6432:                          	;
 6433:      1993 91 6A          	ACALL	MDES1		;R7=TOS EXP, R6=TOS-1 EXP,
 6434:                          				;R3=TOS-1 SIGN, OPERATION IS R1 # R0
 6435:                          	;
 6436:      1995 EF             	MOV	A,R7		;GET TOS EXPONENT
 6437:      1996 60 0D          	JZ	POP_AND_EXIT	;IF TOS=0 THEN POP AND 
 6438:      1998 BE 00 12       	CJNE	R6,#0,LOAD1	;CLEAR CARRY EXIT IF Z
 6439:                          	;
 6440:                          	;**************************************
 6441:                          	;
 6442:                          SWAP_AND_EXIT:	; Swap external args and 
 6443:                          	;
 6444:                          	;**************************************
 6445:                          	;
 6446:      199B 91 5E          	ACALL	LOAD_POINTERS
 6447:      199D 7F 06          	MOV	R7,#FP_NUMBER_SIZE
 6448:                          	;
 6449:      199F E2             SE1:	MOVX	A,@R0		;SWAP THE ARGUMENTS
 6450:      19A0 F3             	MOVX	@R1,A
 6451:      19A1 18             	DEC	R0
 6452:      19A2 19             	DEC	R1
 6453:      19A3 DF FA          	DJNZ	R7,SE1
 6454:                          	;
 6455:                          POP_AND_EXIT:
 6456:                          	;
 6457:      19A5 E5 09          	MOV	A,ARG_STACK	;POP THE STACK
 6458:      19A7 24 06          	ADD	A,#FP_NUMBER_SIZE
 6459:      19A9 F5 09          	MOV	ARG_STACK,A
 6460:      19AB E4             	CLR	A
 6461:      19AC 22             	RET
 6462:                          	;
 6463:                          	;
 6464:      19AD 9E             LOAD1:	SUBB	A,R6		;A = ARG 1 EXP - ARG 2
 6465:      19AE 8F 30          	MOV	FP_EXP,R7	;SAVE EXPONENT AND SIGN
 6466:      19B0 8C 2F          	MOV	FP_SIGN,R4
 6467:      19B2 50 09          	JNC	LOAD2		;ARG1 EXPONENT IS LARGER OR 
 6468:      19B4 8E 30          	MOV	FP_EXP,R6
 6469:      19B6 8B 2F          	MOV	FP_SIGN,R3
 6470:      19B8 F4             	CPL	A
 6471:      19B9 04             	INC	A		;COMPENSATE FOR EXP DELTA
 6472:      19BA C8             	XCH	A,R0		;FORCE R0 TO POINT AT THE LAR
 6473:      19BB C9             	XCH	A,R1		;EXPONENT
 6474:      19BC C8             	XCH	A,R0
 6475:                          	;
 6476:      19BD FF             LOAD2:	MOV	R7,A		;SAVE THE EXPONENT DELT
 6477:      19BE C2 23          	CLR	ADD_IN
 6478:      19C0 BD 00 02       	CJNE	R5,#0,LOAD21
 6479:      19C3 D2 23          	SETB	ADD_IN
 6480:                          	;
 6481:                          	; Load the R1 mantissa
 6482:                          	;
 6483:      19C5 91 7B          LOAD21: ACALL	LOADR1_MANTISSA ;LOAD THE 
 6484:                          	;
 6485:                          	; Now align the number to the delta exp
 6486:                          	; R4 points to the string of the last d

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 118



 Line    I  Addr Code           Source

 6487:                          	;
 6488:      19C7 BF 0B 00       	CJNE	R7,#DIGIT+DIGIT+3,LOAD22
 6489:      19CA 40 02          LOAD22: JC	LOAD23
 6490:      19CC 7F 0A          	MOV	R7,#DIGIT+DIGIT+2
 6491:                          	;
 6492:      19CE 75 2A 00       LOAD23: MOV	FP_CARRY,#00	;CLEAR THE CARR
 6493:      19D1 71 BB          	ACALL	RIGHT		;SHIFT THE NUMBER
 6494:                          	;
 6495:                          	; Set up for addition and subtraction
 6496:                          	;
 6497:      19D3 7F 04          	MOV	R7,#DIGIT	;LOOP COUNT
 6498:      19D5 79 2E          	MOV	R1,#FP_DIG78
 6499:                          ;
 6500:                          ;***************************************
 6501:                          ;****** Elektor 2 Patch ****************
 6502:                          ;****** Floting Point Error, found by D.
 6503:                          ;
 6504:                          ;	MOV	A,#9EH
 6505:                          ;****** Error Number 1
 6506:                          ;
 6507:                          ;****** Value in R4 must be complemented
 6508:                          ;****** first complement
 6509:                          ;
 6510:                          ;	CLR	C
 6511:                          ;	SUBB	A,R4
 6512:                          ;	DA	A
 6513:                          ;	XCH	A,R4
 6514:                          ;	JNZ	LOAD24
 6515:                          ;	MOV	R4,A
 6516:                          ;****** Error Number 2
 6517:                          ;
 6518:                          ;****** With substraction, after reducin
 6519:                          ;****** subtrahend to the same exponents
 6520:                          ;****** that one always has to make a bo
 6521:                          ;****** position of the minuend, not as 
 6522:                          ;****** were it is made only when R4 = 5
 6523:                          ;
 6524:                          ;LOAD24: CJNE	 A,#50H,LOAD25	 ;TEST FOR 
 6525:                          ;LOAD25: JNB	 ADD_IN,SUBLP	 ;DO SUBTRACT
 6526:                          ;
 6527:                          ;***************************************
 6528:                          ;****** Proper code starts here: *******
 6529:                          ;
 6530:      19D7 74 9A          	mov	A,#9AH
 6531:      19D9 C3             	clr	C
 6532:      19DA 9C             	subb	A,R4
 6533:      19DB D4             	da	A
 6534:      19DC CC             	xch	A,R4
 6535:      19DD 30 23 1B       	jnb	ADD_IN,SUBLP
 6536:      19E0 B4 50 00       	cjne	A,#50H,LOAD25
 6537:                          ;
 6538:                          ;****** continue with original code: ***
 6539:                          ;
 6540:      19E3 B3             LOAD25: CPL	C		;FLIP CARRY FOR ADDITION
 6541:      19E4 31 F2          	ACALL	ADDLP		;DO ADDITION
 6542:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 119



 Line    I  Addr Code           Source

 6543:      19E6 50 08          	JNC	ADD_R
 6544:      19E8 05 2A          	INC	FP_CARRY
 6545:      19EA 7F 01          	MOV	R7,#1
 6546:      19EC 71 BB          	ACALL	RIGHT
 6547:      19EE 71 72          	ACALL	INC_FP_EXP	;SHIFT AND BUMP EXPONE
 6548:                          	;
 6549:      19F0 61 63          ADD_R:	AJMP	STORE_ALIGN_TEST_AND_EXIT
 6550:                          	;
 6551:      19F2 E2             ADDLP:	MOVX	A,@R0
 6552:      19F3 37             	ADDC	A,@R1
 6553:      19F4 D4             	DA	A
 6554:      19F5 F7             	MOV	@R1,A
 6555:      19F6 18             	DEC	R0
 6556:      19F7 19             	DEC	R1
 6557:      19F8 DF F8          	DJNZ	R7,ADDLP	;LOOP UNTIL DONE
 6558:      19FA 22             	RET
 6559:                          	;
 6560:      19FB E2             SUBLP:	MOVX	A,@R0		;NOW DO SUBTRACTION
 6561:      19FC FE             	MOV	R6,A
 6562:      19FD E4             	CLR	A
 6563:      19FE 34 99          	ADDC	A,#99H
 6564:      1A00 97             	SUBB	A,@R1
 6565:      1A01 2E             	ADD	A,R6
 6566:      1A02 D4             	DA	A
 6567:      1A03 F7             	MOV	@R1,A
 6568:      1A04 18             	DEC	R0
 6569:      1A05 19             	DEC	R1
 6570:      1A06 DF F3          	DJNZ	R7,SUBLP
 6571:      1A08 40 11          	JC	FSUB6
 6572:                          	;
 6573:                          	; Need to complement the result and sig
 6574:                          	; point accumulator mantissa was larger
 6575:                          	; memory and their signs were equal.
 6576:                          	;
 6577:      1A0A B2 78          	CPL	FP_SIGN.0
 6578:      1A0C 79 2E          	MOV	R1,#FP_DIG78
 6579:      1A0E 7F 04          	MOV	R7,#DIGIT	;LOOP COUNT
 6580:                          	;
 6581:      1A10 74 9A          FSUB5:	MOV	A,#9AH
 6582:      1A12 97             	SUBB	A,@R1
 6583:      1A13 24 00          	ADD	A,#0
 6584:      1A15 D4             	DA	A
 6585:      1A16 F7             	MOV	@R1,A
 6586:      1A17 19             	DEC	R1
 6587:      1A18 B3             	CPL	C
 6588:      1A19 DF F5          	DJNZ	R7,FSUB5	;LOOP
 6589:                          	;
 6590:                          	; Now see how many zeros their are
 6591:                          	;
 6592:      1A1B 78 2B          FSUB6:	MOV	R0,#FP_DIG12
 6593:      1A1D 7F 00          	MOV	R7,#0
 6594:                          	;
 6595:      1A1F E6             FSUB7:	MOV	A,@R0
 6596:      1A20 70 08          	JNZ	FSUB8
 6597:      1A22 0F             	INC	R7
 6598:      1A23 0F             	INC	R7

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 120



 Line    I  Addr Code           Source

 6599:      1A24 08             	INC	R0
 6600:      1A25 B8 2F F7       	CJNE	R0,#FP_SIGN,FSUB7
 6601:      1A28 61 AB          	AJMP	ZERO_AND_EXIT
 6602:                          	;
 6603:      1A2A B4 10 00       FSUB8:	CJNE	A,#10H,FSUB81
 6604:      1A2D 50 01          FSUB81: JNC	FSUB9
 6605:      1A2F 0F             	INC	R7
 6606:                          	;
 6607:                          	; Now R7 has the number of leading zero
 6608:                          	;
 6609:      1A30 E5 30          FSUB9:	MOV	A,FP_EXP	;GET THE OLD EXPONEN
 6610:      1A32 C3             	CLR	C
 6611:      1A33 9F             	SUBB	A,R7		;SUBTRACT FROM THE NUMBER OF
 6612:      1A34 60 0B          	JZ	FSUB10
 6613:      1A36 40 09          	JC	FSUB10
 6614:                          	;
 6615:      1A38 F5 30          	MOV	FP_EXP,A	;SAVE THE NEW EXPONENT
 6616:                          	;
 6617:      1A3A 71 F5          	ACALL	LEFT1		;SHIFT THE FP ACC
 6618:      1A3C 75 2A 00       	MOV	FP_CARRY,#0
 6619:      1A3F 61 63          	AJMP	STORE_ALIGN_TEST_AND_EXIT
 6620:                          	;
 6621:      1A41 61 A5          FSUB10: AJMP	UNDERFLOW_AND_EXIT
 6622:                          	;
 6623:                          	;**************************************
 6624:                          	;
 6625:                          FLOATING_COMP:	; Compare two floating po
 6626:                          		; used for relational operations and i
 6627:                          		; than subtraction. ON RETURN, The car
 6628:                          		; if ARG1 is > ARG2, else carry is not
 6629:                          		; if ARG1 = ARG2, F0 gets set
 6630:                          	;
 6631:                          	;**************************************
 6632:                          	;
 6633:      1A43 91 6A          	ACALL	MDES1		;SET UP THE REGISTERS
 6634:      1A45 E5 09          	MOV	A,ARG_STACK
 6635:      1A47 24 0C          	ADD	A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 6636:      1A49 F5 09          	MOV	ARG_STACK,A	;POP THE STACK TWICE, C
 6637:      1A4B EE             	MOV	A,R6		;CHECK OUT EXPONENTS
 6638:      1A4C C2 D5          	CLR	F0
 6639:      1A4E 9F             	SUBB	A,R7
 6640:      1A4F 60 0A          	JZ	EXPONENTS_EQUAL
 6641:      1A51 40 03          	JC	ARG1_EXP_IS_LARGER
 6642:                          	;
 6643:                          	; Now the ARG2 EXPONENT is > ARG1 EXPON
 6644:                          	;
 6645:                          SIGNS_DIFFERENT:
 6646:                          	;
 6647:      1A53 EB             	MOV	A,R3		;SEE IF SIGN OF ARG2 IS POSIT
 6648:      1A54 80 01          	SJMP	ARG1_EXP_IS_LARGER1
 6649:                          	;
 6650:                          ARG1_EXP_IS_LARGER:
 6651:                          	;
 6652:      1A56 EC             	MOV	A,R4		;GET THE SIGN OF ARG1 EXPONEN
 6653:                          ARG1_EXP_IS_LARGER1:
 6654:      1A57 60 01          	JZ	ARG1_EXP_IS_LARGER2

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 121



 Line    I  Addr Code           Source

 6655:      1A59 B3             	CPL	C
 6656:                          ARG1_EXP_IS_LARGER2:
 6657:      1A5A 22             	RET
 6658:                          	;
 6659:                          EXPONENTS_EQUAL:
 6660:                          	;
 6661:                          	; First, test the sign, then the mantis
 6662:                          	;
 6663:      1A5B BD 00 F5       	CJNE	R5,#0,SIGNS_DIFFERENT
 6664:                          	;
 6665:                          BOTH_PLUS:
 6666:                          	;
 6667:      1A5E 7F 04          	MOV	R7,#DIGIT	;POINT AT MS DIGIT
 6668:      1A60 18             	DEC	R0
 6669:      1A61 18             	DEC	R0
 6670:      1A62 18             	DEC	R0
 6671:      1A63 19             	DEC	R1
 6672:      1A64 19             	DEC	R1
 6673:      1A65 19             	DEC	R1
 6674:                          	;
 6675:                          	; Now do the compare
 6676:                          	;
 6677:      1A66 E2             CLOOP:	MOVX	A,@R0
 6678:      1A67 FE             	MOV	R6,A
 6679:      1A68 E3             	MOVX	A,@R1
 6680:      1A69 9E             	SUBB	A,R6
 6681:      1A6A 70 EA          	JNZ	ARG1_EXP_IS_LARGER
 6682:      1A6C 08             	INC	R0
 6683:      1A6D 09             	INC	R1
 6684:      1A6E DF F6          	DJNZ	R7,CLOOP
 6685:                          	;
 6686:                          	; If here, the numbers are the same, th
 6687:                          	;
 6688:      1A70 D2 D5          	SETB	F0
 6689:      1A72 22             	RET			;EXIT WITH EQUAL
 6690:                          	;
 6691:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
 6692:                          ;
 6693:                          FLOATING_MUL:	; Floating point multiply
 6694:                          ;
 6695:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
 6696:                          ;
 6697:      1A73 91 68          	ACALL	MUL_DIV_EXP_AND_SIGN
 6698:                          	;
 6699:                          	; check for zero exponents
 6700:                          	;
 6701:      1A75 BE 00 02       	CJNE	R6,#00,FMUL1	;ARG 2 EXP ZERO?
 6702:      1A78 61 AB          FMUL0:	AJMP	ZERO_AND_EXIT
 6703:                          	;
 6704:                          	; calculate the exponent
 6705:                          	;
 6706:      1A7A 8D 2F          FMUL1:	MOV	FP_SIGN,R5	;SAVE THE SIGN, IN
 6707:                          	;
 6708:      1A7C EF             	MOV	A,R7
 6709:      1A7D 60 F9          	JZ	FMUL0
 6710:      1A7F 2E             	ADD	A,R6		;ADD THE EXPONENTS

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 122



 Line    I  Addr Code           Source

 6711:      1A80 20 E7 05       	JB	ACC.7,FMUL_OVER
 6712:      1A83 10 D7 08       	JBC	CY,FMUL21	;SEE IF CARRY IS SET
 6713:                          	;
 6714:      1A86 61 A5          	AJMP	UNDERFLOW_AND_EXIT
 6715:                          	;
 6716:                          FMUL_OVER:
 6717:                          	;
 6718:      1A88 50 02          	JNC	FMUL2		;OK IF SET
 6719:                          	;
 6720:      1A8A 61 94          FOV:	AJMP	OVERFLOW_AND_EXIT
 6721:                          ;***************************************
 6722:                          ;****** Wulf 1 Bugfix 1 ****************
 6723:                          ;****** Multiplication Error, found by D
 6724:                          ;
 6725:                          ; FMUL2: SUBB	 A,#129 	 ;SUBTRACT THE EX
 6726:                          ;
 6727:                          ;***************************************
 6728:                          ;****** Proper code starts here: *******
 6729:                          ;
 6730:      1A8C D2 28          FMUL2:	setb	mul_underflow	;Flag of multi
 6731:      1A8E 94 83          FMUL21: subb	A,#83H		;exp. multipl. resu
 6732:      1A90 04             	inc	A		;Correct SUBB 83H
 6733:      1A91 04             	inc	A		;to original SUBB 81H
 6734:      1A92 40 02          	jc     NMARK_L		;Limit case
 6735:      1A94 C2 28          	clr	mul_underflow	;No limit case
 6736:                          NMARK_L:
 6737:                          ;
 6738:                          ;****** continue with original code: ***
 6739:                          ;
 6740:      1A96 FE             	MOV	R6,A		;SAVE IT FOR LATER
 6741:                          	;
 6742:                          	; Unpack and load R0
 6743:                          	;
 6744:      1A97 71 7E          	ACALL	UNPACK_R0
 6745:                          	;
 6746:                          	; Now set up for loop multiply
 6747:                          	;
 6748:      1A99 7B 04          	MOV	R3,#DIGIT
 6749:      1A9B AC 01          	MOV	R4,R1B0
 6750:                          	;
 6751:                          	; Now, do the multiply and accumulate t
 6752:                          	;
 6753:      1A9D 8C 01          FMUL3:	MOV	R1B0,R4
 6754:      1A9F E3             	MOVX	A,@R1
 6755:      1AA0 FA             	MOV	R2,A
 6756:      1AA1 91 2B          	ACALL	MUL_NIBBLE
 6757:                          	;
 6758:      1AA3 EA             	MOV	A,R2
 6759:      1AA4 C4             	SWAP	A
 6760:      1AA5 91 2B          	ACALL	MUL_NIBBLE
 6761:      1AA7 1C             	DEC	R4
 6762:      1AA8 DB F3          	DJNZ	R3,FMUL3
 6763:                          	;
 6764:                          	; Now, pack and restore the sign
 6765:                          	;
 6766:      1AAA 8E 30          	MOV	FP_EXP,R6

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 123



 Line    I  Addr Code           Source

 6767:      1AAC 8D 2F          	MOV	FP_SIGN,R5
 6768:      1AAE 61 11          	AJMP	PACK		;FINISH IT OFF
 6769:                          	;
 6770:                          	;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
 6771:                          	;
 6772:                          FLOATING_DIV:
 6773:                          	;
 6774:                          	;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
 6775:                          	;
 6776:      1AB0 91 6A          	ACALL	MDES1
 6777:                          	;
 6778:                          	; Check the exponents
 6779:                          	;
 6780:      1AB2 8D 2F          	MOV	FP_SIGN,R5	;SAVE THE SIGN
 6781:      1AB4 BF 00 06       	CJNE	R7,#0,DIV0	;CLEARS THE CARRY
 6782:      1AB7 71 94          	ACALL	OVERFLOW_AND_EXIT
 6783:      1AB9 E4             	CLR	A
 6784:      1ABA D2 E3          	SETB	ACC.ZERO_DIVIDE
 6785:      1ABC 22             	RET
 6786:                          	;
 6787:      1ABD EE             DIV0:	MOV	A,R6		;GET EXPONENT
 6788:      1ABE 60 B8          	JZ	FMUL0		;EXIT IF ZERO
 6789:      1AC0 9F             	SUBB	A,R7		;DELTA EXPONENT
 6790:      1AC1 20 E7 04       	JB	ACC.7,D_UNDER
 6791:      1AC4 50 04          	JNC	DIV3
 6792:      1AC6 61 A5          	AJMP	UNDERFLOW_AND_EXIT
 6793:                          	;
 6794:      1AC8 50 C0          D_UNDER:JNC	FOV
 6795:                          	;
 6796:      1ACA 24 81          DIV3:	ADD	A,#129		;CORRECTLY BIAS THE EX
 6797:      1ACC F5 30          	MOV	FP_EXP,A	;SAVE THE EXPONENT
 6798:      1ACE 91 7B          	ACALL	LOADR1_MANTISSA ;LOAD THE DIVIDED
 6799:                          	;
 6800:      1AD0 7A 34          	MOV	R2,#FP_ACCC	;SAVE LOCATION
 6801:      1AD2 AB 00          	MOV	R3,R0B0 	;SAVE POINTER IN R3
 6802:      1AD4 75 2A 00       	MOV	FP_CARRY,#0	;ZERO CARRY BYTE
 6803:                          	;
 6804:      1AD7 7D FF          DIV4:	MOV	R5,#0FFH	;LOOP COUNT
 6805:      1AD9 D3             	SETB	C
 6806:                          	;
 6807:      1ADA 8B 00          DIV5:	MOV	R0B0,R3 	;RESTORE THE EXTERNAL
 6808:      1ADC 79 2E          	MOV	R1,#FP_DIG78	;SET UP INTERNAL POINT
 6809:      1ADE 7F 04          	MOV	R7,#DIGIT	;LOOP COUNT
 6810:      1AE0 50 17          	JNC	DIV7		;EXIT IF NO CARRY
 6811:                          	;
 6812:      1AE2 E2             DIV6:	MOVX	A,@R0		;DO ACCUMLATION
 6813:      1AE3 FE             	MOV	R6,A
 6814:      1AE4 E4             	CLR	A
 6815:      1AE5 34 99          	ADDC	A,#99H
 6816:      1AE7 9E             	SUBB	A,R6
 6817:      1AE8 27             	ADD	A,@R1
 6818:      1AE9 D4             	DA	A
 6819:      1AEA F7             	MOV	@R1,A
 6820:      1AEB 18             	DEC	R0
 6821:      1AEC 19             	DEC	R1
 6822:      1AED DF F3          	DJNZ	R7,DIV6 	;LOOP

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 124



 Line    I  Addr Code           Source

 6823:                          	;
 6824:      1AEF 0D             	INC	R5		;SUBTRACT COUNTER
 6825:      1AF0 40 E8          	JC	DIV5		;KEEP LOOPING IF CARRY
 6826:      1AF2 E7             	MOV	A,@R1		;GET CARRY
 6827:      1AF3 94 01          	SUBB	A,#1		;CARRY IS CLEARED
 6828:      1AF5 F7             	MOV	@R1,A		;SAVE CARRY DIGIT
 6829:      1AF6 B3             	CPL	C
 6830:      1AF7 80 E1          	SJMP	DIV5		;LOOP
 6831:                          	;
 6832:                          	; Restore the result if carry was found
 6833:                          	;
 6834:      1AF9 31 F2          DIV7:	ACALL	ADDLP		;ADD NUMBER BACK
 6835:      1AFB 77 00          	MOV	@R1,#0		;CLEAR CARRY
 6836:      1AFD 8A 00          	MOV	R0B0,R2 	;GET SAVE COUNTER
 6837:      1AFF A6 05          	MOV	@R0,5		;SAVE COUNT BYTE
 6838:                          	;
 6839:      1B01 0A             	INC	R2		;ADJUST SAVE COUNTER
 6840:      1B02 7F 01          	MOV	R7,#1		;BUMP DIVIDEND
 6841:      1B04 71 F3          	ACALL	LEFT
 6842:      1B06 BA 3E CE       	CJNE	R2,#FP_ACC8+2,DIV4
 6843:                          	;
 6844:      1B09 D5 30 02       	DJNZ	FP_EXP,DIV8
 6845:      1B0C 61 A5          	AJMP	UNDERFLOW_AND_EXIT
 6846:                          	;
 6847:      1B0E 75 2A 00       DIV8:	MOV	FP_CARRY,#0
 6848:                          	;
 6849:                          	;**************************************
 6850:                          	;
 6851:                          PACK:	; Pack the mantissa
 6852:                          	;
 6853:                          	;**************************************
 6854:                          	;
 6855:                          	; First, set up the pointers
 6856:                          	;
 6857:      1B11 78 34          	MOV	R0,#FP_ACCC
 6858:      1B13 E6             	MOV	A,@R0		;GET FP_ACCC
 6859:      1B14 FE             	MOV	R6,A		;SAVE FOR ZERO COUNT
 6860:      1B15 60 03          	JZ	PACK0		;JUMP OVER IF ZERO
 6861:      1B17 71 72          	ACALL	INC_FP_EXP	;BUMP THE EXPONENT
 6862:      1B19 18             	DEC	R0
 6863:                          	;
 6864:      1B1A 08             PACK0:	INC	R0		;POINT AT FP_ACC1
 6865:                          	;
 6866:      1B1B 74 08          PACK1:	MOV	A,#8		;ADJUST NIBBLE POINTER
 6867:      1B1D F9             	MOV	R1,A
 6868:      1B1E 28             	ADD	A,R0
 6869:      1B1F F8             	MOV	R0,A
 6870:      1B20 B6 05 00       	CJNE	@R0,#5,PACK11	;SEE IF ADJUSTING NE
 6871:      1B23 40 13          PACK11: JC	PACK31
 6872:                          	;
 6873:      1B25 D3             PACK2:	SETB	C
 6874:      1B26 E4             	CLR	A
 6875:      1B27 18             	DEC	R0
 6876:      1B28 36             	ADDC	A,@R0
 6877:      1B29 D4             	DA	A
 6878:      1B2A D6             	XCHD	A,@R0		;SAVE THE VALUE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 125



 Line    I  Addr Code           Source

 6879:      1B2B 30 E4 09       	JNB	ACC.4,PACK3
 6880:      1B2E D9 F5          	DJNZ	R1,PACK2
 6881:                          	;
 6882:      1B30 18             	DEC	R0
 6883:      1B31 76 01          	MOV	@R0,#1
 6884:      1B33 71 72          	ACALL	INC_FP_EXP
 6885:      1B35 80 18          	SJMP	PACK4
 6886:                          	;
 6887:      1B37 19             PACK3:	DEC	R1
 6888:      1B38 E9             PACK31: MOV	A,R1
 6889:      1B39 C3             	CLR	C
 6890:      1B3A C8             	XCH	A,R0
 6891:      1B3B 98             	SUBB	A,R0
 6892:      1B3C F8             	MOV	R0,A
 6893:                          ;
 6894:                          ;***************************************
 6895:                          ;****** Wulf 1 Bugfix 2 ****************
 6896:                          ;****** Multiplication Error, found by D
 6897:                          ;
 6898:      1B3D 30 28 0F       	jnb	mul_underflow,PACK4
 6899:      1B40 C2 28          	clr	mul_underflow
 6900:      1B42 E5 30          	mov	A,FP_EXP	;test of exceeding in limi
 6901:      1B44 60 07          	jz	UNDER_MD	;message about underflow
 6902:      1B46 F4             	cpl	a		;test of exceeding in limit case
 6903:      1B47 60 04          	jz	UNDER_MD	;message about underflow
 6904:      1B49 F4             	cpl	a		;restore original exp
 6905:      1B4A B4 01 02       	cjne	a,#1,pack4	;jump if not outer limi
 6906:                          UNDER_MD:
 6907:      1B4D 61 A5          	ajmp	UNDERFLOW_AND_EXIT
 6908:                          ;
 6909:                          ;****** continue with original code: ***
 6910:                          ;
 6911:      1B4F 79 2B          PACK4:	MOV	R1,#FP_DIG12
 6912:                          	;
 6913:                          	; Now, pack
 6914:                          	;
 6915:      1B51 E6             PLOOP:	MOV	A,@R0
 6916:      1B52 C4             	SWAP	A		;FLIP THE DIGITS
 6917:      1B53 08             	INC	R0
 6918:      1B54 D6             	XCHD	A,@R0
 6919:      1B55 42 06          	ORL	6,A		;ACCUMULATE THE OR'ED DIGITS
 6920:      1B57 F7             	MOV	@R1,A
 6921:      1B58 08             	INC	R0
 6922:      1B59 09             	INC	R1
 6923:      1B5A B9 2F F4       	CJNE	R1,#FP_SIGN,PLOOP
 6924:      1B5D EE             	MOV	A,R6
 6925:      1B5E 70 03          	JNZ	STORE_ALIGN_TEST_AND_EXIT
 6926:      1B60 75 30 00       	MOV	FP_EXP,#0	;ZERO EXPONENT
 6927:                          	;
 6928:                          	;**************************************
 6929:                          	;
 6930:                          STORE_ALIGN_TEST_AND_EXIT:	;Save the num
 6931:                          	;
 6932:                          	;**************************************
 6933:                          	;
 6934:      1B63 91 5E          	ACALL	LOAD_POINTERS

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 126



 Line    I  Addr Code           Source

 6935:      1B65 89 09          	MOV	ARG_STACK,R1	;SET UP THE NEW STACK
 6936:      1B67 78 30          	MOV	R0,#FP_EXP
 6937:                          	;
 6938:                          	; Now load the numbers
 6939:                          	;
 6940:      1B69 E6             STORE2: MOV	A,@R0
 6941:      1B6A F3             	MOVX	@R1,A		;SAVE THE NUMBER
 6942:      1B6B 18             	DEC	R0
 6943:      1B6C 19             	DEC	R1
 6944:      1B6D B8 2A F9       	CJNE	R0,#FP_CARRY,STORE2
 6945:                          	;
 6946:      1B70 E4             	CLR	A		;NO ERRORS
 6947:                          	;
 6948:      1B71 22             PRET:	RET			;EXIT
 6949:                          	;
 6950:                          INC_FP_EXP:
 6951:                          	;
 6952:      1B72 05 30          	INC	FP_EXP
 6953:      1B74 E5 30          	MOV	A,FP_EXP
 6954:      1B76 70 F9          	JNZ	PRET		;EXIT IF NOT ZERO
 6955:      1B78 D0 E0          	POP	ACC		;WASTE THE CALLING STACK
 6956:      1B7A D0 E0          	POP	ACC
 6957:      1B7C 61 94          	AJMP	OVERFLOW_AND_EXIT
 6958:                          ;
 6959:                          ;***************************************
 6960:                          ;
 6961:                          UNPACK_R0:	; Unpack BCD digits and load 
 6962:                          ;
 6963:                          ;***************************************
 6964:                          	;
 6965:      1B7E C0 01          	PUSH	R1B0
 6966:      1B80 79 32          	MOV	R1,#FP_NIB8
 6967:                          	;
 6968:      1B82 E2             ULOOP:	MOVX	A,@R0
 6969:      1B83 54 0F          	ANL	A,#0FH
 6970:      1B85 F7             	MOV	@R1,A		;SAVE THE NIBBLE
 6971:      1B86 E2             	MOVX	A,@R0
 6972:      1B87 C4             	SWAP	A
 6973:      1B88 54 0F          	ANL	A,#0FH
 6974:      1B8A 19             	DEC	R1
 6975:      1B8B F7             	MOV	@R1,A		;SAVE THE NIBBLE AGAIN
 6976:      1B8C 18             	DEC	R0
 6977:      1B8D 19             	DEC	R1
 6978:      1B8E B9 2A F1       	CJNE	R1,#FP_NIB1-1,ULOOP
 6979:                          	;
 6980:      1B91 D0 01          	POP	R1B0
 6981:                          	;
 6982:      1B93 22             LOAD7:	RET
 6983:                          	;
 6984:                          	;**************************************
 6985:                          	;
 6986:                          OVERFLOW_AND_EXIT:	;LOAD 99999999 E+127,
 6987:                          	;
 6988:                          	;**************************************
 6989:                          	;
 6990:      1B94 78 2E          	MOV	R0,#FP_DIG78

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 127



 Line    I  Addr Code           Source

 6991:      1B96 74 99          	MOV	A,#99H
 6992:                          	;
 6993:      1B98 F6             OVE1:	MOV	@R0,A
 6994:      1B99 18             	DEC	R0
 6995:      1B9A B8 2A FB       	CJNE	R0,#FP_CARRY,OVE1
 6996:                          	;
 6997:      1B9D 75 30 FF       	MOV	FP_EXP,#0FFH
 6998:      1BA0 71 63          	ACALL	STORE_ALIGN_TEST_AND_EXIT
 6999:                          	;
 7000:      1BA2 D2 E1          	SETB	ACC.OVERFLOW
 7001:      1BA4 22             	RET
 7002:                          	;
 7003:                          	;**************************************
 7004:                          	;
 7005:                          UNDERFLOW_AND_EXIT:	;LOAD 0, SET UF BIT,
 7006:                          	;
 7007:                          	;**************************************
 7008:                          	;
 7009:      1BA5 71 AB          	ACALL	ZERO_AND_EXIT
 7010:      1BA7 E4             	CLR	A
 7011:      1BA8 D2 E0          	SETB	ACC.UNDERFLOW
 7012:      1BAA 22             	RET
 7013:                          	;
 7014:                          	;**************************************
 7015:                          	;
 7016:                          ZERO_AND_EXIT:		;LOAD 0, SET ZERO BIT, A
 7017:                          	;
 7018:                          	;**************************************
 7019:                          	;
 7020:      1BAB 71 B2          	ACALL	FP_CLEAR
 7021:      1BAD 71 63          	ACALL	STORE_ALIGN_TEST_AND_EXIT
 7022:      1BAF D2 E2          	SETB	ACC.ZERO
 7023:      1BB1 22             	RET			;EXIT
 7024:                          	;
 7025:                          	;**************************************
 7026:                          	;
 7027:                          FP_CLEAR:
 7028:                          	;
 7029:                          	; Clear internal storage
 7030:                          	;
 7031:                          	;**************************************
 7032:                          	;
 7033:      1BB2 E4             	CLR	A
 7034:      1BB3 78 3D          	MOV	R0,#FP_ACC8+1
 7035:                          	;
 7036:      1BB5 F6             FPC1:	MOV	@R0,A
 7037:      1BB6 18             	DEC	R0
 7038:      1BB7 B8 29 FB       	CJNE	R0,#FP_TEMP,FPC1
 7039:      1BBA 22             	RET
 7040:                          	;
 7041:                          	;**************************************
 7042:                          	;
 7043:                          RIGHT:	; Shift ACCUMULATOR RIGHT the num
 7044:                          	; Save the shifted values in R4 if SAVE
 7045:                          	;
 7046:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 128



 Line    I  Addr Code           Source

 7047:                          	;
 7048:      1BBB 7C 00          	MOV	R4,#0		;IN CASE OF NO SHIFT
 7049:                          	;
 7050:      1BBD C3             RIGHT1: CLR	C
 7051:      1BBE EF             RIGHT2: MOV	A,R7		;GET THE DIGITS TO SHI
 7052:      1BBF 60 22          	JZ	RIGHTL1 	;EXIT IF ZERO
 7053:      1BC1 94 02          	SUBB	A,#2		;TWO TO DO?
 7054:      1BC3 50 1F          	JNC	RIGHT5		;SHIFT TWO NIBBLES
 7055:                          	;
 7056:                          	; Swap one nibble then exit
 7057:                          	;
 7058:      1BC5 C0 00          RIGHT3: PUSH	R0B0		;SAVE POINTER REGISTE
 7059:      1BC7 C0 01          	PUSH	R1B0
 7060:                          	;
 7061:      1BC9 79 2E          	MOV	R1,#FP_DIG78	;LOAD THE POINTERS
 7062:      1BCB 78 2D          	MOV	R0,#FP_DIG56
 7063:      1BCD EC             	MOV	A,R4		;GET THE OVERFLOW REGISTER
 7064:      1BCE D7             	XCHD	A,@R1		;GET DIGIT 8
 7065:      1BCF C4             	SWAP	A		;FLIP FOR LOAD
 7066:      1BD0 FC             	MOV	R4,A
 7067:                          	;
 7068:      1BD1 E7             RIGHTL: MOV	A,@R1		;GET THE LOW ORDER BY
 7069:      1BD2 D6             	XCHD	A,@R0		;SWAP NIBBLES
 7070:      1BD3 C4             	SWAP	A		;FLIP FOR STORE
 7071:      1BD4 F7             	MOV	@R1,A		;SAVE THE DIGITS
 7072:      1BD5 18             	DEC	R0		;BUMP THE POINTERS
 7073:      1BD6 19             	DEC	R1
 7074:      1BD7 B9 2A F7       	CJNE	R1,#FP_DIG12-1,RIGHTL	;LOOP
 7075:                          	;
 7076:      1BDA E7             	MOV	A,@R1		;ACC = CH8
 7077:      1BDB C4             	SWAP	A		;ACC = 8CH
 7078:      1BDC 54 0F          	ANL	A,#0FH		;ACC = 0CH
 7079:      1BDE F7             	MOV	@R1,A		;CARRY DONE
 7080:      1BDF D0 01          	POP	R1B0		;EXIT
 7081:      1BE1 D0 00          	POP	R0B0		;RESTORE REGISTER
 7082:      1BE3 22             RIGHTL1:RET
 7083:                          	;
 7084:      1BE4 FF             RIGHT5: MOV	R7,A		;SAVE THE NEW SHIFT NU
 7085:      1BE5 E4             	CLR	A
 7086:      1BE6 C5 2A          	XCH	A,FP_CARRY	;SWAP THE NIBBLES
 7087:      1BE8 C5 2B          	XCH	A,FP_DIG12
 7088:      1BEA C5 2C          	XCH	A,FP_DIG34
 7089:      1BEC C5 2D          	XCH	A,FP_DIG56
 7090:      1BEE C5 2E          	XCH	A,FP_DIG78
 7091:      1BF0 FC             	MOV	R4,A		;SAVE THE LAST DIGIT SHIFTED
 7092:      1BF1 80 CB          	SJMP	RIGHT2
 7093:                          	;
 7094:                          	;**************************************
 7095:                          	;
 7096:                          LEFT:	; Shift ACCUMULATOR LEFT the numbe
 7097:                          	;
 7098:                          	;**************************************
 7099:                          	;
 7100:      1BF3 7C 00          	MOV	R4,#00H 	;CLEAR FOR SOME ENTRYS
 7101:                          	;
 7102:      1BF5 C3             LEFT1:	CLR	C

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 129



 Line    I  Addr Code           Source

 7103:      1BF6 EF             LEFT2:	MOV	A,R7		;GET SHIFT VALUE
 7104:      1BF7 60 22          	JZ	LEFTL1		;EXIT IF ZERO
 7105:      1BF9 94 02          	SUBB	A,#2		;SEE HOW MANY BYTES TO SHIFT
 7106:      1BFB 50 1F          	JNC	LEFT5
 7107:                          	;
 7108:      1BFD C0 00          LEFT3:	PUSH	R0B0		;SAVE POINTER
 7109:      1BFF C0 01          	PUSH	R1B0
 7110:      1C01 78 2A          	MOV	R0,#FP_CARRY
 7111:      1C03 79 2B          	MOV	R1,#FP_DIG12
 7112:                          	;
 7113:      1C05 E6             	MOV	A,@R0		;ACC=CHCL
 7114:      1C06 C4             	SWAP	A		;ACC = CLCH
 7115:      1C07 F6             	MOV	@R0,A		;ACC = CLCH, @R0 = CLCH
 7116:                          	;
 7117:      1C08 E7             LEFTL:	MOV	A,@R1		;DIG 12
 7118:      1C09 C4             	SWAP	A		;DIG 21
 7119:      1C0A D6             	XCHD	A,@R0
 7120:      1C0B F7             	MOV	@R1,A		;SAVE IT
 7121:      1C0C 08             	INC	R0		;BUMP POINTERS
 7122:      1C0D 09             	INC	R1
 7123:      1C0E B8 2E F7       	CJNE	R0,#FP_DIG78,LEFTL
 7124:                          	;
 7125:      1C11 EC             	MOV	A,R4
 7126:      1C12 C4             	SWAP	A
 7127:      1C13 D6             	XCHD	A,@R0
 7128:      1C14 54 F0          	ANL	A,#0F0H
 7129:      1C16 FC             	MOV	R4,A
 7130:                          	;
 7131:      1C17 D0 01          	POP	R1B0
 7132:      1C19 D0 00          	POP	R0B0		;RESTORE
 7133:      1C1B 22             LEFTL1: RET			;DONE
 7134:                          	;
 7135:      1C1C FF             LEFT5:	MOV	R7,A		;RESTORE COUNT
 7136:      1C1D E4             	CLR	A
 7137:      1C1E CC             	XCH	A,R4		;GET THE RESTORATION BYTE
 7138:      1C1F C5 2E          	XCH	A,FP_DIG78	;DO THE SWAP
 7139:      1C21 C5 2D          	XCH	A,FP_DIG56
 7140:      1C23 C5 2C          	XCH	A,FP_DIG34
 7141:      1C25 C5 2B          	XCH	A,FP_DIG12
 7142:      1C27 C5 2A          	XCH	A,FP_CARRY
 7143:      1C29 80 CB          	SJMP	LEFT2
 7144:                          	;
 7145:                          MUL_NIBBLE:
 7146:                          	;
 7147:                          	; Multiply the nibble in R7 by the FP_N
 7148:                          	; accumulate the product in FP_ACC
 7149:                          	;
 7150:                          	; Set up the pointers for multiplicatio
 7151:                          	;
 7152:      1C2B 54 0F          	ANL	A,#0FH		;STRIP OFF MS NIBBLE
 7153:      1C2D FF             	MOV	R7,A
 7154:      1C2E 78 3C          	MOV	R0,#FP_ACC8
 7155:      1C30 79 32          	MOV	R1,#FP_NIB8
 7156:      1C32 E4             	CLR	A
 7157:      1C33 F5 33          	MOV	FP_ACCX,A
 7158:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 130



 Line    I  Addr Code           Source

 7159:      1C35 18             MNLOOP: DEC	R0		;BUMP POINTER TO PROPAGA
 7160:      1C36 26             	ADD	A,@R0		;ATTEMPT TO FORCE CARRY
 7161:      1C37 D4             	DA	A		;BCD ADJUST
 7162:      1C38 30 E4 03       	JNB	ACC.4,MNL0	;DON'T ADJUST IF NO NEED
 7163:      1C3B 18             	DEC	R0		;PROPAGATE CARRY TO THE NEXT DI
 7164:      1C3C 06             	INC	@R0		;DO THE ADJUSTING
 7165:      1C3D 08             	INC	R0		;RESTORE R0
 7166:                          	;
 7167:      1C3E D6             MNL0:	XCHD	A,@R0		;RESTORE INITIAL NUMBE
 7168:      1C3F 8F F0          	MOV	B,R7		;GET THE NUBBLE TO MULTIPLY
 7169:      1C41 E7             	MOV	A,@R1		;GET THE OTHER NIBBLE
 7170:      1C42 A4             	MUL	AB		;DO THE MULTIPLY
 7171:      1C43 75 F0 0A       	MOV	B,#10		;NOW BCD ADJUST
 7172:      1C46 84             	DIV	AB
 7173:      1C47 C5 F0          	XCH	A,B		;GET THE REMAINDER
 7174:      1C49 26             	ADD	A,@R0		;PROPAGATE THE PARTIAL PRODU
 7175:      1C4A D4             	DA	A		;BCD ADJUST
 7176:      1C4B 30 E4 02       	JNB	ACC.4,MNL1	;PROPAGATE PARTIAL PRODU
 7177:      1C4E 05 F0          	INC	B
 7178:                          	;
 7179:      1C50 08             MNL1:	INC	R0
 7180:      1C51 D6             	XCHD	A,@R0		;SAVE THE NEW PRODUCT
 7181:      1C52 18             	DEC	R0
 7182:      1C53 E5 F0          	MOV	A,B		;GET BACK THE QUOTIENT
 7183:      1C55 19             	DEC	R1
 7184:      1C56 B9 2A DC       	CJNE	R1,#FP_NIB1-1,MNLOOP
 7185:                          	;
 7186:      1C59 25 33          	ADD	A,FP_ACCX	;GET THE OVERFLOW
 7187:      1C5B D4             	DA	A		;ADJUST
 7188:      1C5C F6             	MOV	@R0,A		;SAVE IT
 7189:      1C5D 22             	RET			;EXIT
 7190:                          	;
 7191:                          	;**************************************
 7192:                          	;
 7193:                          LOAD_POINTERS:	; Load the ARG_STACK into
 7194:                          	;
 7195:                          	;**************************************
 7196:                          	;
 7197:      1C5E 75 A0 01       	MOV	P2,#ARG_STACK_PAGE
 7198:      1C61 A8 09          	MOV	R0,ARG_STACK
 7199:      1C63 74 06          	MOV	A,#FP_NUMBER_SIZE
 7200:      1C65 28             	ADD	A,R0
 7201:      1C66 F9             	MOV	R1,A
 7202:      1C67 22             	RET
 7203:                          	;
 7204:                          	;**************************************
 7205:                          	;
 7206:                          MUL_DIV_EXP_AND_SIGN:
 7207:                          	;
 7208:                          	; Load the sign into R7, R6. R5 gets th
 7209:                          	; multiply and divide.
 7210:                          	;
 7211:                          	;**************************************
 7212:                          	;
 7213:      1C68 71 B2          	ACALL	FP_CLEAR	;CLEAR INTERNAL MEMORY
 7214:                          	;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 131



 Line    I  Addr Code           Source

 7215:      1C6A 91 5E          MDES1:	ACALL	LOAD_POINTERS	;LOAD REGISTE
 7216:      1C6C E2             	MOVX	A,@R0		;ARG 1 EXP
 7217:      1C6D FF             	MOV	R7,A		;SAVED IN R7
 7218:      1C6E E3             	MOVX	A,@R1		;ARG 2 EXP
 7219:      1C6F FE             	MOV	R6,A		;SAVED IN R6
 7220:      1C70 18             	DEC	R0		;BUMP POINTERS TO SIGN
 7221:      1C71 19             	DEC	R1
 7222:      1C72 E2             	MOVX	A,@R0		;GET THE SIGN
 7223:      1C73 FC             	MOV	R4,A		;SIGN OF ARG1
 7224:      1C74 E3             	MOVX	A,@R1		;GET SIGN OF NEXT ARG
 7225:      1C75 FB             	MOV	R3,A		;SIGN OF ARG2
 7226:      1C76 6C             	XRL	A,R4		;ACC GETS THE NEW SIGN
 7227:      1C77 FD             	MOV	R5,A		;R5 GETS THE NEW SIGN
 7228:                          	;
 7229:                          	; Bump the pointers to point at the LS 
 7230:                          	;
 7231:      1C78 18             	DEC	R0
 7232:      1C79 19             	DEC	R1
 7233:                          	;
 7234:      1C7A 22             	RET
 7235:                          	;
 7236:                          	;**************************************
 7237:                          	;
 7238:                          LOADR1_MANTISSA:
 7239:                          	;
 7240:                          	; Load the mantissa of R0 into FP_Digit
 7241:                          	;
 7242:                          	;**************************************
 7243:                          	;
 7244:      1C7B C0 00          	PUSH	R0B0		;SAVE REGISTER 1
 7245:      1C7D 78 2E          	MOV	R0,#FP_DIG78	;SET UP THE POINTER
 7246:                          	;
 7247:      1C7F E3             LOADR1: MOVX	A,@R1
 7248:      1C80 F6             	MOV	@R0,A
 7249:      1C81 19             	DEC	R1
 7250:      1C82 18             	DEC	R0
 7251:      1C83 B8 2A F9       	CJNE	R0,#FP_CARRY,LOADR1
 7252:                          	;
 7253:      1C86 D0 00          	POP	R0B0
 7254:      1C88 22             	RET
 7255:                          	;
 7256:                          	;**************************************
 7257:                          	;
 7258:                          HEXSCAN:	; Scan a string to determine if
 7259:                          		; set carry if hex, else carry = 0
 7260:                          	;
 7261:                          	;**************************************
 7262:                          	;
 7263:      1C89 B1 5F          	ACALL	GET_DPTR_CHARACTER
 7264:      1C8B C0 83          	PUSH	DPH
 7265:      1C8D C0 82          	PUSH	DPL		;SAVE THE POINTER
 7266:                          	;
 7267:      1C8F E0             HEXSC1: MOVX	A,@DPTR 	;GET THE CHARACTER
 7268:      1C90 F1 ED          	ACALL	DIGIT_CHECK	;SEE IF A DIGIT
 7269:      1C92 40 12          	JC	HS1		;CONTINUE IF A DIGIT
 7270:      1C94 91 A9          	ACALL	HEX_CHECK	;SEE IF HEX

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 132



 Line    I  Addr Code           Source

 7271:      1C96 40 0E          	JC	HS1
 7272:                          	;
 7273:      1C98 C2 E5          	CLR	ACC.5		;NO LOWER CASE
 7274:      1C9A B4 48 03       	CJNE	A,#'H',HEXDON
 7275:      1C9D D3             	SETB	C
 7276:      1C9E 80 01          	SJMP	HEXDO1		;NUMBER IS VALID HEX, MAYB
 7277:                          	;
 7278:      1CA0 C3             HEXDON: CLR	C
 7279:                          	;
 7280:      1CA1 D0 82          HEXDO1: POP	DPL		;RESTORE POINTER
 7281:      1CA3 D0 83          	POP	DPH
 7282:      1CA5 22             	RET
 7283:                          	;
 7284:      1CA6 A3             HS1:	INC	DPTR		;BUMP TO NEXT CHARACTER
 7285:      1CA7 80 E6          	SJMP	HEXSC1		;LOOP
 7286:                          	;
 7287:                          HEX_CHECK:	;CHECK FOR A VALID ASCII HEX,
 7288:                          	;
 7289:      1CA9 C2 E5          	CLR	ACC.5		;WASTE LOWER CASE
 7290:      1CAB B4 47 00       	CJNE	A,#'F'+1,HEX_CHECK1     ;SEE IF F 
 7291:                          HEX_CHECK1:
 7292:      1CAE 40 01          	JC	HC1
 7293:      1CB0 22             	RET
 7294:                          	;
 7295:      1CB1 B4 41 00       HC1:	CJNE	A,#'A',HC11     ;SEE IF A OR G
 7296:      1CB4 B3             HC11:	CPL	C
 7297:      1CB5 22             	RET
 7298:                          	;
 7299:                          PUSHR2R0:
 7300:                          	;
 7301:      1CB6 7B 00          	MOV	R3,#HIGH CONVERT;CONVERSION LOCATIO
 7302:      1CB8 79 58          	MOV	R1,#LOW CONVERT
 7303:      1CBA D1 F7          	ACALL	CONVERT_BINARY_TO_ASCII_STRING
 7304:      1CBC 74 0D          	MOV	A,#0DH		;A CR TO TERMINATE
 7305:      1CBE F3             	MOVX	@R1,A		;SAVE THE CR
 7306:      1CBF 90 00 58       	MOV	DPTR,#CONVERT
 7307:                          	;
 7308:                          	; Falls thru to FLOATING INPUT
 7309:                          	;
 7310:                          	;**************************************
 7311:                          	;
 7312:                          FLOATING_POINT_INPUT:	; Input a floating
 7313:                          			; the DPTR
 7314:                          	;
 7315:                          	;**************************************
 7316:                          	;
 7317:      1CC2 71 B2          	ACALL	FP_CLEAR	;CLEAR EVERYTHING
 7318:      1CC4 B1 5F          	ACALL	GET_DPTR_CHARACTER
 7319:      1CC6 B1 65          	ACALL	PLUS_MINUS_TEST
 7320:      1CC8 92 78          	MOV	MSIGN,C 	;SAVE THE MANTISSA SIGN
 7321:                          	;
 7322:                          	; Now, set up for input loop
 7323:                          	;
 7324:      1CCA 78 34          	MOV	R0,#FP_ACCC
 7325:      1CCC 7E 7F          	MOV	R6,#7FH 	;BASE EXPONENT
 7326:      1CCE D2 D5          	SETB	F0		;SET INITIAL FLAG

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 133



 Line    I  Addr Code           Source

 7327:                          	;
 7328:      1CD0 F1 EB          INLOOP: ACALL	GET_DIGIT_CHECK
 7329:      1CD2 50 07          	JNC	GTEST		;IF NOT A CHARACTER, WHAT IS
 7330:      1CD4 54 0F          	ANL	A,#0FH		;STRIP ASCII
 7331:      1CD6 B1 38          	ACALL	STDIG		;STORE THE DIGITS
 7332:                          	;
 7333:      1CD8 A3             INLPIK: INC	DPTR		;BUMP POINTER FOR LOOP
 7334:      1CD9 80 F5          	SJMP	INLOOP		;LOOP FOR INPUT
 7335:                          	;
 7336:      1CDB B4 2E 0C       GTEST:	CJNE	A,#'.',GT1      ;SEE IF A RA
 7337:      1CDE 20 51 63       	JB	FOUND_RADIX,INERR
 7338:      1CE1 D2 51          	SETB	FOUND_RADIX
 7339:      1CE3 B8 34 F2       	CJNE	R0,#FP_ACCC,INLPIK
 7340:      1CE6 D2 52          	SETB	FIRST_RADIX	;SET IF FIRST RADIX
 7341:      1CE8 80 EE          	SJMP	INLPIK		;GET ADDITIONAL DIGITS
 7342:                          	;
 7343:      1CEA 20 D5 57       GT1:	JB	F0,INERR	;ERROR IF NOT CLEARED
 7344:      1CED B4 65 02       	CJNE	A,#'e',GT11     ;CHECK FOR LOWER C
 7345:      1CF0 80 03          	SJMP	GT12
 7346:      1CF2 B4 45 33       GT11:	CJNE	A,#'E',FINISH_UP
 7347:      1CF5 B1 5E          GT12:	ACALL	INC_AND_GET_DPTR_CHARACTER
 7348:      1CF7 B1 65          	ACALL	PLUS_MINUS_TEST
 7349:      1CF9 92 50          	MOV	XSIGN,C 	;SAVE SIGN STATUS
 7350:      1CFB F1 EB          	ACALL	GET_DIGIT_CHECK
 7351:      1CFD 50 45          	JNC	INERR
 7352:                          	;
 7353:      1CFF 54 0F          	ANL	A,#0FH		;STRIP ASCII BIAS OFF THE C
 7354:      1D01 FD             	MOV	R5,A		;SAVE THE CHARACTER IN R5
 7355:                          	;
 7356:      1D02 A3             GT2:	INC	DPTR
 7357:      1D03 F1 EB          	ACALL	GET_DIGIT_CHECK
 7358:      1D05 50 0D          	JNC	FINISH1
 7359:      1D07 54 0F          	ANL	A,#0FH		;STRIP OFF BIAS
 7360:      1D09 CD             	XCH	A,R5		;GET THE LAST DIGIT
 7361:      1D0A 75 F0 0A       	MOV	B,#10		;MULTIPLY BY TEN
 7362:      1D0D A4             	MUL	AB
 7363:      1D0E 2D             	ADD	A,R5		;ADD TO ORIGINAL VALUE
 7364:      1D0F FD             	MOV	R5,A		;SAVE IN R5
 7365:      1D10 50 F0          	JNC	GT2		;LOOP IF NO CARRY
 7366:      1D12 7D FF          	MOV	R5,#0FFH	;FORCE AN ERROR
 7367:                          	;
 7368:      1D14 ED             FINISH1:MOV	A,R5		;GET THE SIGN
 7369:      1D15 30 50 09       	JNB	XSIGN,POSNUM	;SEE IF EXPONENT IS PO
 7370:      1D18 C3             	CLR	C
 7371:      1D19 9E             	SUBB	A,R6
 7372:      1D1A F4             	CPL	A
 7373:      1D1B 04             	INC	A
 7374:      1D1C 40 09          	JC	FINISH2
 7375:      1D1E 74 01          	MOV	A,#01H
 7376:      1D20 22             	RET
 7377:                          	;
 7378:      1D21 2E             POSNUM: ADD	A,R6		;ADD TO EXPONENT
 7379:      1D22 50 03          	JNC	FINISH2
 7380:                          	;
 7381:      1D24 74 02          POSNM1: MOV	A,#02H
 7382:      1D26 22             	RET

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 134



 Line    I  Addr Code           Source

 7383:                          	;
 7384:      1D27 CE             FINISH2:XCH	A,R6		;SAVE THE EXPONENT
 7385:                          	;
 7386:                          FINISH_UP:
 7387:                          	;
 7388:      1D28 8E 30          	MOV	FP_EXP,R6	;SAVE EXPONENT
 7389:      1D2A B8 34 02       	CJNE	R0,#FP_ACCC,FINISH_UP1
 7390:      1D2D 71 B2          	ACALL	FP_CLEAR	;CLEAR THE MEMORY IF 0
 7391:                          FINISH_UP1:
 7392:      1D2F E5 09          	MOV	A,ARG_STACK	;GET THE ARG STACK
 7393:      1D31 C3             	CLR	C
 7394:      1D32 94 0C          	SUBB	A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 7395:      1D34 F5 09          	MOV	ARG_STACK,A	;ADJUST FOR STORE
 7396:      1D36 61 11          	AJMP	PACK
 7397:                          	;
 7398:      1D38 C2 D5          STDIG:	CLR	F0		;CLEAR INITIAL DESIGNATOR
 7399:      1D3A 70 0B          	JNZ	STDIG1		;CONTINUE IF NOT ZERO
 7400:      1D3C B8 34 08       	CJNE	R0,#FP_ACCC,STDIG1
 7401:      1D3F 30 52 04       	JNB	FIRST_RADIX,RET_X
 7402:                          	;
 7403:      1D42 DE 02          DECX:	DJNZ	R6,RET_X
 7404:                          	;
 7405:      1D44 74 FF          INERR:	MOV	A,#0FFH
 7406:                          	;
 7407:      1D46 22             RET_X:	RET
 7408:                          	;
 7409:      1D47 20 53 02       STDIG1: JB	DONE_LOAD,FRTEST
 7410:      1D4A C2 52          	CLR	FIRST_RADIX
 7411:                          	;
 7412:      1D4C 20 52 F3       FRTEST: JB	FIRST_RADIX,DECX
 7413:                          	;
 7414:      1D4F 20 51 01       FDTEST: JB	FOUND_RADIX,FDT1
 7415:      1D52 0E             	INC	R6
 7416:                          	;
 7417:      1D53 20 53 F0       FDT1:	JB	DONE_LOAD,RET_X
 7418:      1D56 B8 3D 02       	CJNE	R0,#FP_ACC8+1,FDT2
 7419:      1D59 D2 53          	SETB	DONE_LOAD
 7420:                          	;
 7421:      1D5B F6             FDT2:	MOV	@R0,A		;SAVE THE STRIPPED ACCU
 7422:      1D5C 08             	INC	R0		;BUMP THE POINTER
 7423:      1D5D 22             	RET			;EXIT
 7424:                          	;
 7425:                          	;**************************************
 7426:                          	;
 7427:                          	; I/O utilities
 7428:                          	;
 7429:                          	;**************************************
 7430:                          	;
 7431:                          INC_AND_GET_DPTR_CHARACTER:
 7432:                          	;
 7433:      1D5E A3             	INC	DPTR
 7434:                          	;
 7435:                          GET_DPTR_CHARACTER:
 7436:                          	;
 7437:      1D5F E0             	MOVX	A,@DPTR 	;GET THE CHARACTER
 7438:      1D60 B4 20 16       	CJNE	A,#' ',PMT1     ;SEE IF A SPACE

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 135



 Line    I  Addr Code           Source

 7439:                          	;
 7440:                          	; Kill spaces
 7441:                          	;
 7442:      1D63 80 F9          	SJMP	INC_AND_GET_DPTR_CHARACTER
 7443:                          	;
 7444:                          PLUS_MINUS_TEST:
 7445:                          	;
 7446:      1D65 B4 E3 02       	CJNE	A,#0E3H,PMT11	;SEE IF A PLUS, PLUS
 7447:      1D68 80 0E          	SJMP	PMT3
 7448:      1D6A B4 2B 02       PMT11:	CJNE	A,#'+',PMT12
 7449:      1D6D 80 09          	SJMP	PMT3
 7450:      1D6F B4 E5 02       PMT12:	CJNE	A,#0E5H,PMT13	;SEE IF MINUS,
 7451:      1D72 80 03          	SJMP	PMT2
 7452:      1D74 B4 2D 02       PMT13:	CJNE	A,#'-',PMT1
 7453:                          	;
 7454:      1D77 D3             PMT2:	SETB	C
 7455:                          	;
 7456:      1D78 A3             PMT3:	INC	DPTR
 7457:                          	;
 7458:      1D79 22             PMT1:	RET
 7459:                          	;
 7460:                          	;**************************************
 7461:                          	;
 7462:                          FLOATING_POINT_OUTPUT:	; Output the numb
 7463:                          	;
 7464:                          	; IF FORMAT = 00 - FREE FLOATING
 7465:                          	;	    = FX - EXPONENTIAL (X IS THE NUMB
 7466:                          	;	    = NX - N = NUM BEFORE RADIX, X = 
 7467:                          	;		   N + X = 8 MAX
 7468:                          	;
 7469:                          	;**************************************
 7470:                          	;
 7471:      1D7A 91 6A          	ACALL	MDES1		;GET THE NUMBER TO OUTPUT,
 7472:      1D7C 31 A5          	ACALL	POP_AND_EXIT	;OUTPUT POPS THE STA
 7473:      1D7E EF             	MOV	A,R7
 7474:      1D7F FE             	MOV	R6,A		;PUT THE EXPONENT IN R6
 7475:      1D80 71 7E          	ACALL	UNPACK_R0	;UNPACK THE NUMBER
 7476:      1D82 78 2B          	MOV	R0,#FP_NIB1	;POINT AT THE NUMBER
 7477:      1D84 E5 17          	MOV	A,FORMAT	;GET THE FORMAT
 7478:      1D86 FB             	MOV	R3,A		;SAVE IN CASE OF EXP FORMAT
 7479:      1D87 60 49          	JZ	FREE		;FREE FLOATING?
 7480:      1D89 B4 F0 00       	CJNE	A,#0F0H,FPO1	;SEE IF EXPONENTIAL
 7481:      1D8C 50 73          FPO1:	JNC	EXPOUT
 7482:                          	;
 7483:                          	; If here, must be integer USING format
 7484:                          	;
 7485:      1D8E EE             	MOV	A,R6		;GET THE EXPONENT
 7486:      1D8F 70 02          	JNZ	FPO2
 7487:      1D91 7E 80          	MOV	R6,#80H
 7488:      1D93 EB             FPO2:	MOV	A,R3		;GET THE FORMAT
 7489:      1D94 C4             	SWAP	A		;SPLIT INTEGER AND FRACTION
 7490:      1D95 54 0F          	ANL	A,#0FH
 7491:      1D97 FA             	MOV	R2,A		;SAVE INTEGER
 7492:      1D98 D1 67          	ACALL	NUM_LT		;GET THE NUMBER OF INTEGE
 7493:      1D9A CA             	XCH	A,R2		;FLIP FOR SUBB
 7494:      1D9B C3             	CLR	C

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 136



 Line    I  Addr Code           Source

 7495:      1D9C 9A             	SUBB	A,R2
 7496:      1D9D FF             	MOV	R7,A
 7497:      1D9E 50 06          	JNC	FPO3
 7498:      1DA0 7D 3F          	MOV	R5,#'?'         ;OUTPUT A QUESTION 
 7499:      1DA2 D1 9C          	ACALL	SOUT1		;NUMBER IS TOO LARGE FOR F
 7500:      1DA4 A1 D2          	AJMP	FREE
 7501:      1DA6 BA 00 07       FPO3:	CJNE	R2,#00,USING0	;SEE IF ZERO
 7502:      1DA9 1F             	DEC	R7
 7503:      1DAA D1 89          	ACALL	SS7
 7504:      1DAC D1 96          	ACALL	ZOUT		;OUTPUT A ZERO
 7505:      1DAE 80 06          	SJMP	USING1
 7506:                          	;
 7507:      1DB0 D1 89          USING0: ACALL	SS7		;OUTPUT SPACES, IF NE
 7508:      1DB2 EA             	MOV	A,R2		;OUTPUT DIGITS
 7509:      1DB3 FF             	MOV	R7,A
 7510:      1DB4 D1 4B          	ACALL	OUTR0
 7511:                          	;
 7512:      1DB6 EB             USING1: MOV	A,R3
 7513:      1DB7 54 0F          	ANL	A,#0FH		;GET THE NUMBER RIGHT OF DP
 7514:      1DB9 FA             	MOV	R2,A		;SAVE IT
 7515:      1DBA 60 BD          	JZ	PMT1		;EXIT IF ZERO
 7516:      1DBC D1 92          	ACALL	ROUT		;OUTPUT DP
 7517:      1DBE D1 70          	ACALL	NUM_RT
 7518:      1DC0 B5 02 03       	CJNE	A,2,USINGX	;COMPARE A TO R2
 7519:                          	;
 7520:      1DC3 EA             USINGY: MOV	A,R2
 7521:      1DC4 C1 80          	AJMP	Z7R7
 7522:                          	;
 7523:      1DC6 50 FB          USINGX: JNC	USINGY
 7524:                          	;
 7525:      1DC8 CA             USING2: XCH	A,R2
 7526:      1DC9 C3             	CLR	C
 7527:      1DCA 9A             	SUBB	A,R2
 7528:      1DCB CA             	XCH	A,R2
 7529:      1DCC D1 80          	ACALL	Z7R7		;OUTPUT ZEROS IF NEED TO
 7530:      1DCE EA             	MOV	A,R2
 7531:      1DCF FF             	MOV	R7,A
 7532:      1DD0 C1 4B          	AJMP	OUTR0
 7533:                          	;
 7534:                          	; First, force exponential output, if n
 7535:                          	;
 7536:      1DD2 EE             FREE:	MOV	A,R6		;GET THE EXPONENT
 7537:      1DD3 70 04          	JNZ	FREE1		;IF ZERO, PRINT IT
 7538:      1DD5 D1 9A          	ACALL	SOUT
 7539:      1DD7 C1 96          	AJMP	ZOUT
 7540:                          	;
 7541:      1DD9 7B F0          FREE1:	MOV	R3,#0F0H	;IN CASE EXP NEEDED
 7542:      1DDB 74 77          	MOV	A,#80H-DIGIT-DIGIT-1
 7543:      1DDD 2E             	ADD	A,R6
 7544:      1DDE 40 21          	JC	EXPOUT
 7545:      1DE0 94 F7          	SUBB	A,#0F7H
 7546:      1DE2 40 1D          	JC	EXPOUT
 7547:                          	;
 7548:                          	; Now, just print the number
 7549:                          	;
 7550:      1DE4 D1 8B          	ACALL	SINOUT		;PRINT THE SIGN OF THE NU

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 137



 Line    I  Addr Code           Source

 7551:      1DE6 D1 67          	ACALL	NUM_LT		;GET THE NUMBER LEFT OF D
 7552:      1DE8 B4 08 02       	CJNE	A,#8,FREE4
 7553:      1DEB C1 4B          	AJMP	OUTR0
 7554:                          	;
 7555:      1DED D1 4B          FREE4:	ACALL	OUTR0
 7556:      1DEF D1 5D          	ACALL	ZTEST		;TEST FOR TRAILING ZEROS
 7557:      1DF1 60 57          	JZ	U_RET		;DONE IF ALL TRAILING ZEROS
 7558:      1DF3 D1 92          	ACALL	ROUT		;OUTPUT RADIX
 7559:                          	;
 7560:      1DF5 7F 01          FREE2:	MOV	R7,#1		;OUTPUT ONE DIGIT
 7561:      1DF7 D1 4B          	ACALL	OUTR0
 7562:      1DF9 70 4F          	JNZ	U_RET
 7563:      1DFB D1 5D          	ACALL	ZTEST
 7564:      1DFD 60 4B          	JZ	U_RET
 7565:      1DFF 80 F4          	SJMP	FREE2		;LOOP
 7566:                          	;
 7567:      1E01 D1 8B          EXPOUT: ACALL	SINOUT		;PRINT THE SIGN
 7568:      1E03 7F 01          	MOV	R7,#1		;OUTPUT ONE CHARACTER
 7569:      1E05 D1 4B          	ACALL	OUTR0
 7570:      1E07 D1 92          	ACALL	ROUT		;OUTPUT RADIX
 7571:      1E09 EB             	MOV	A,R3		;GET FORMAT
 7572:      1E0A 54 0F          	ANL	A,#0FH		;STRIP INDICATOR
 7573:      1E0C 60 06          	JZ	EXPOTX
 7574:                          	;
 7575:      1E0E FF             	MOV	R7,A		;OUTPUT THE NUMBER OF DIGITS
 7576:      1E0F 1F             	DEC	R7		;ADJUST BECAUSE ONE CHAR ALREAD
 7577:      1E10 D1 4B          	ACALL	OUTR0
 7578:      1E12 80 02          	SJMP	EXPOT4
 7579:                          	;
 7580:      1E14 B1 F5          EXPOTX: ACALL	FREE2		;OUTPUT UNTIL TRAIL
 7581:                          	;
 7582:      1E16 D1 9A          EXPOT4: ACALL	SOUT		;OUTPUT A SPACE
 7583:      1E18 7D 45          	MOV	R5,#'E'
 7584:      1E1A D1 9C          	ACALL	SOUT1		;OUTPUT AN E
 7585:      1E1C EE             	MOV	A,R6		;GET THE EXPONENT
 7586:      1E1D 60 04          	JZ	XOUT0		;EXIT IF ZERO
 7587:      1E1F 14             	DEC	A		;ADJUST FOR THE DIGIT ALREADY OU
 7588:      1E20 B4 80 05       	CJNE	A,#80H,XOUT2	;SEE WHAT IT IS
 7589:                          	;
 7590:      1E23 D1 9A          XOUT0:	ACALL	SOUT
 7591:      1E25 E4             	CLR	A
 7592:      1E26 80 0C          	SJMP	XOUT4
 7593:                          	;
 7594:      1E28 40 06          XOUT2:	JC	XOUT3		;NEGATIVE EXPONENT
 7595:      1E2A 7D 2B          	MOV	R5,#'+'         ;OUTPUT A PLUS SIGN
 7596:      1E2C D1 9C          	ACALL	SOUT1
 7597:      1E2E 80 04          	SJMP	XOUT4
 7598:                          	;
 7599:      1E30 D1 8E          XOUT3:	ACALL	MOUT
 7600:      1E32 F4             	CPL	A		;FLIP BITS
 7601:      1E33 04             	INC	A		;BUMP
 7602:                          	;
 7603:      1E34 C2 E7          XOUT4:	CLR	ACC.7
 7604:      1E36 F8             	MOV	R0,A
 7605:      1E37 7A 00          	MOV	R2,#0
 7606:      1E39 79 58          	MOV	R1,#LOW CONVERT ;CONVERSION LOCATIO

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 138



 Line    I  Addr Code           Source

 7607:      1E3B 7B 00          	MOV	R3,#HIGH CONVERT
 7608:      1E3D D1 F7          	ACALL	CONVERT_BINARY_TO_ASCII_STRING
 7609:      1E3F 78 58          	MOV	R0,#LOW CONVERT ;NOW, OUTPUT EXPONE
 7610:                          	;
 7611:      1E41 E2             EXPOT5: MOVX	A,@R0		;GET THE CHARACTER
 7612:      1E42 FD             	MOV	R5,A		;OUTPUT IT
 7613:      1E43 D1 9C          	ACALL	SOUT1
 7614:      1E45 08             	INC	R0		;BUMP THE POINTER
 7615:      1E46 E8             	MOV	A,R0		;GET THE POINTER
 7616:      1E47 B5 01 F7       	CJNE	A,R1B0,EXPOT5	;LOOP
 7617:                          	;
 7618:      1E4A 22             U_RET:	RET			;EXIT
 7619:                          	;
 7620:                          OUTR0:	; Output the characters pointed t
 7621:                          	;
 7622:      1E4B EF             	MOV	A,R7		;GET THE COUNTER
 7623:      1E4C 60 0E          	JZ	OUTR		;EXIT IF DONE
 7624:      1E4E E6             	MOV	A,@R0		;GET THE NUMBER
 7625:      1E4F 44 30          	ORL	A,#30H		;ASCII BIAS
 7626:      1E51 08             	INC	R0		;BUMP POINTER AND COUNTER
 7627:      1E52 1F             	DEC	R7
 7628:      1E53 FD             	MOV	R5,A		;PUT CHARACTER IN OUTPUT REGI
 7629:      1E54 D1 9C          	ACALL	SOUT1		;OUTPUT THE CHARACTER
 7630:      1E56 E4             	CLR	A		;JUST FOR TEST
 7631:      1E57 B8 33 F1       	CJNE	R0,#FP_NIB8+1,OUTR0
 7632:      1E5A 74 55          	MOV	A,#55H		;KNOW WHERE EXIT OCCURED
 7633:                          	;
 7634:      1E5C 22             OUTR:	RET
 7635:                          	;
 7636:      1E5D A9 00          ZTEST:	MOV	R1,R0B0 	;GET POINTER REGISTE
 7637:                          	;
 7638:      1E5F E7             ZT0:	MOV	A,@R1		;GET THE VALUE
 7639:      1E60 70 04          	JNZ	ZT1
 7640:      1E62 09             	INC	R1		;BUMP POINTER
 7641:      1E63 B9 33 F9       	CJNE	R1,#FP_NIB8+1,ZT0
 7642:                          	;
 7643:      1E66 22             ZT1:	RET
 7644:                          	;
 7645:      1E67 EE             NUM_LT: MOV	A,R6		;GET EXPONENT
 7646:      1E68 C3             	CLR	C		;GET READY FOR SUBB
 7647:      1E69 94 80          	SUBB	A,#80H		;SUB EXPONENT BIAS
 7648:      1E6B 50 01          	JNC	NL1		;OK IF NO CARRY
 7649:      1E6D E4             	CLR	A		;NO DIGITS LEFT
 7650:                          	;
 7651:      1E6E FF             NL1:	MOV	R7,A		;SAVE THE COUNT
 7652:      1E6F 22             	RET
 7653:                          	;
 7654:      1E70 C3             NUM_RT: CLR	C		;SUBB AGAIN
 7655:      1E71 74 80          	MOV	A,#80H		;EXPONENT BIAS
 7656:      1E73 9E             	SUBB	A,R6		;GET THE BIASED EXPONENT
 7657:      1E74 50 01          	JNC	NR1
 7658:      1E76 E4             	CLR	A
 7659:                          	;
 7660:      1E77 22             NR1:	RET			;EXIT
 7661:                          	;
 7662:      1E78 EF             SPACE7: MOV	A,R7		;GET THE NUMBER OF SPA

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 139



 Line    I  Addr Code           Source

 7663:      1E79 60 FC          	JZ	NR1		;EXIT IF ZERO
 7664:      1E7B D1 9A          	ACALL	SOUT		;OUTPUT A SPACE
 7665:      1E7D 1F             	DEC	R7		;BUMP COUNTER
 7666:      1E7E 80 F8          	SJMP	SPACE7		;LOOP
 7667:                          	;
 7668:      1E80 FF             Z7R7:	MOV	R7,A
 7669:                          	;
 7670:      1E81 EF             ZERO7:	MOV	A,R7		;GET COUNTER
 7671:      1E82 60 F3          	JZ	NR1		;EXIT IF ZERO
 7672:      1E84 D1 96          	ACALL	ZOUT		;OUTPUT A ZERO
 7673:      1E86 1F             	DEC	R7		;BUMP COUNTER
 7674:      1E87 80 F8          	SJMP	ZERO7		;LOOP
 7675:                          	;
 7676:      1E89 D1 78          SS7:	ACALL	SPACE7
 7677:                          	;
 7678:      1E8B EC             SINOUT: MOV	A,R4		;GET THE SIGN
 7679:      1E8C 60 0C          	JZ	SOUT		;OUTPUT A SPACE IF ZERO
 7680:                          	;
 7681:      1E8E 7D 2D          MOUT:	MOV	R5,#'-'
 7682:      1E90 80 0A          	SJMP	SOUT1		;OUTPUT A MINUS IF NOT
 7683:                          	;
 7684:      1E92 7D 2E          ROUT:	MOV	R5,#'.'         ;OUTPUT A RADI
 7685:      1E94 80 06          	SJMP	SOUT1
 7686:                          	;
 7687:      1E96 7D 30          ZOUT:	MOV	R5,#'0'         ;OUTPUT A ZERO
 7688:      1E98 80 02          	SJMP	SOUT1
 7689:                          	;
 7690:      1E9A 7D 20          SOUT:	MOV	R5,#' '         ;OUTPUT A SPAC
 7691:                          	;
 7692:      1E9C 21 6C          SOUT1:	AJMP	OUTPUT
 7693:                          	;
 7694:                          	;**************************************
 7695:                          	;
 7696:                          CONVERT_ASCII_STRING_TO_BINARY:
 7697:                          	;
 7698:                          	;DPTR POINTS TO ASCII STRING
 7699:                          	;PUT THE BINARY NUMBER IN R2:R0, ERROR 
 7700:                          	;
 7701:                          	;**************************************
 7702:                          	;
 7703:      1E9E 91 89          CASB:	ACALL	HEXSCAN 	;SEE IF HEX NUMBER
 7704:      1EA0 92 23          	MOV	ADD_IN,C	;IF ADD_IN IS SET, THE NUM
 7705:      1EA2 F1 EB          	ACALL	GET_DIGIT_CHECK
 7706:      1EA4 B3             	CPL	C		;FLIP FOR EXIT
 7707:      1EA5 40 28          	JC	RCASB
 7708:      1EA7 7B 00          	MOV	R3,#00H 	;ZERO R3:R1 FOR LOOP
 7709:      1EA9 79 00          	MOV	R1,#00H
 7710:      1EAB 80 15          	SJMP	CASB5
 7711:                          	;
 7712:      1EAD A3             CASB2:	INC	DPTR
 7713:      1EAE 89 00          	MOV	R0B0,R1 	;SAVE THE PRESENT CONVERTE
 7714:      1EB0 8B 02          	MOV	R2B0,R3 	;IN R2:R0
 7715:      1EB2 F1 EB          	ACALL	GET_DIGIT_CHECK
 7716:      1EB4 40 0C          	JC	CASB5
 7717:      1EB6 30 23 16       	JNB	ADD_IN,RCASB	;CONVERSION COMPLETE
 7718:      1EB9 91 A9          	ACALL	HEX_CHECK	;SEE IF HEX NUMBER

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 140



 Line    I  Addr Code           Source

 7719:      1EBB 40 03          	JC	CASB4		;PROCEED IF GOOD
 7720:      1EBD A3             	INC	DPTR		;BUMP PAST H
 7721:      1EBE 80 0F          	SJMP	RCASB
 7722:                          	;
 7723:      1EC0 24 09          CASB4:	ADD	A,#9		;ADJUST HEX ASCII BIAS
 7724:                          	;
 7725:      1EC2 75 F0 0A       CASB5:	MOV	B,#10
 7726:      1EC5 30 23 03       	JNB	ADD_IN,CASB6
 7727:      1EC8 75 F0 10       	MOV	B,#16		;HEX MODE
 7728:                          	;
 7729:      1ECB D1 D6          CASB6:	ACALL	MULNUM		;ACCUMULATE THE DIG
 7730:      1ECD 50 DE          	JNC	CASB2		;LOOP IF NO CARRY
 7731:                          	;
 7732:      1ECF E4             RCASB:	CLR	A		;RESET ACC
 7733:      1ED0 92 E1          	MOV	ACC.OVERFLOW,C	;IF OVERFLOW, SAY SO
 7734:      1ED2 22             	RET			;EXIT
 7735:                          	;
 7736:      1ED3 75 F0 0A       MULNUM10:MOV	B,#10
 7737:                          	;
 7738:                          	;**************************************
 7739:                          	;
 7740:                          MULNUM: ; Take the next digit in the acc
 7741:                          	; accumulate in R3:R1
 7742:                          	;
 7743:                          	;**************************************
 7744:                          	;
 7745:      1ED6 C0 E0          	PUSH	ACC		;SAVE ACC
 7746:      1ED8 C0 F0          	PUSH	B		;SAVE MULTIPLIER
 7747:      1EDA E9             	MOV	A,R1		;PUT LOW ORDER BITS IN ACC
 7748:      1EDB A4             	MUL	AB		;DO THE MULTIPLY
 7749:      1EDC F9             	MOV	R1,A		;PUT THE RESULT BACK
 7750:      1EDD EB             	MOV	A,R3		;GET THE HIGH ORDER BYTE
 7751:      1EDE AB F0          	MOV	R3,B		;SAVE THE OVERFLOW
 7752:      1EE0 D0 F0          	POP	B		;GET THE MULTIPLIER
 7753:      1EE2 A4             	MUL	AB		;DO IT
 7754:      1EE3 A2 D2          	MOV	C,OV		;SAVE OVERFLOW IN F0
 7755:      1EE5 92 D5          	MOV	F0,C
 7756:      1EE7 2B             	ADD	A,R3		;ADD OVERFLOW TO HIGH RESULT
 7757:      1EE8 FB             	MOV	R3,A		;PUT IT BACK
 7758:      1EE9 D0 E0          	POP	ACC		;GET THE ORIGINAL ACC BACK
 7759:      1EEB 72 D5          	ORL	C,F0		;OR CARRY AND OVERFLOW
 7760:      1EED 40 07          	JC	MULX		;NO GOOD IF THE CARRY IS SET
 7761:                          	;
 7762:      1EEF 54 0F          MUL11:	ANL	A,#0FH		;MASK OFF HIGH ORDER 
 7763:      1EF1 29             	ADD	A,R1		;NOW ADD THE ACC
 7764:      1EF2 F9             	MOV	R1,A		;PUT IT BACK
 7765:      1EF3 E4             	CLR	A		;PROPAGATE THE CARRY
 7766:      1EF4 3B             	ADDC	A,R3
 7767:      1EF5 FB             	MOV	R3,A		;PUT IT BACK
 7768:                          	;
 7769:      1EF6 22             MULX:	RET			;EXIT WITH OR WITHOUT CARRY
 7770:                          	;
 7771:                          CONVERT_BINARY_TO_ASCII_STRING:
 7772:                          ;
 7773:                          ;***************************************
 7774:                          ;****** Elektor 3 Patch ****************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 141



 Line    I  Addr Code           Source

 7775:                          ;****** Performance improvements *******
 7776:                          ;
 7777:                          ;
 7778:                          ;R3:R1 contains the address of the strin
 7779:                          ;R2:R0 contains the value to convert
 7780:                          ;DPTR, R7, R6, and ACC gets clobbered
 7781:                          ;
 7782:                          ;***************************************
 7783:                          ;
 7784:                          ;	CLR	A		;NO LEADING ZEROS
 7785:                          ;	MOV	DPTR,#10000	;SUBTRACT 10000
 7786:                          ;	ACALL	RSUB		;DO THE SUBTRACTION
 7787:                          ;	MOV	DPTR,#1000	;NOW 1000
 7788:                          ;	ACALL	RSUB
 7789:                          ;	MOV	DPTR,#100	;NOW 100
 7790:                          ;	ACALL	RSUB
 7791:                          ;	MOV	DPTR,#10	;NOW 10
 7792:                          ;	ACALL	RSUB
 7793:                          ;	MOV	DPTR,#1 	;NOW 1
 7794:                          ;	ACALL	RSUB
 7795:                          ;	JZ	RSUB2		;JUMP OVER RET
 7796:                          ;
 7797:                          ;RSUB_R:	RET
 7798:                          ;
 7799:                          ;RSUB:	MOV	R6,#-1		;SET UP THE COUNTER
 7800:                          ;
 7801:                          ;RSUB1: INC	R6		;BUMP THE COUNTER
 7802:                          ;	XCH	A,R2		;DO A FAST COMPARE
 7803:                          ;	CJNE	A,DPH,RSUB11
 7804:                          ;RSUB11: XCH	 A,R2
 7805:                          ;	JC	FAST_DONE
 7806:                          ;	XCH	A,R0		;GET LOW BYTE
 7807:                          ;	SUBB	A,DPL		;SUBTRACT, CARRY IS CLEARE
 7808:                          ;	XCH	A,R0		;PUT IT BACK
 7809:                          ;	XCH	A,R2		;GET THE HIGH BYTE
 7810:                          ;	SUBB	A,DPH		;ADD THE HIGH BYTE
 7811:                          ;	XCH	A,R2		;PUT IT BACK
 7812:                          ;	JNC	RSUB1		;LOOP UNTIL CARRY
 7813:                          ;
 7814:                          ;	XCH	A,R0
 7815:                          ;	ADD	A,DPL		;RESTORE R2:R0
 7816:                          ;	XCH	A,R0
 7817:                          ;	XCH	A,R2
 7818:                          ;	ADDC	A,DPH
 7819:                          ;	XCH	A,R2
 7820:                          ;
 7821:                          ;FAST_DONE:
 7822:                          ;
 7823:                          ;	ORL	A,R6		;OR THE COUNT VALUE
 7824:                          ;	JZ	RSUB_R		;RETURN IF ZERO
 7825:                          ;
 7826:                          ;RSUB2: MOV	A,#'0'          ;GET THE ASC
 7827:                          ;	ADD	A,R6		;ADD THE COUNT
 7828:                          ;
 7829:                          ;RSUB4: MOV	P2,R3		;SET UP P2
 7830:                          ;	MOVX	@R1,A		;PLACE THE VALUE IN MEMORY

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 142



 Line    I  Addr Code           Source

 7831:                          ;	INC	R1
 7832:                          ;	CJNE	R1,#00H,RSUB3	;SEE IF RAPPED AROU
 7833:                          ;	INC	R3		;BUMP HIGH BYTE
 7834:                          ;
 7835:                          ;RSUB3: RET			;EXIT
 7836:                          ;
 7837:                          ;****** Faster code starts here: *******
 7838:                          ;
 7839:      1EF7 7D 00          	mov	R5,#0
 7840:                          ;
 7841:      1EF9 EA             RSUB1:	mov	A, R2
 7842:      1EFA 75 F0 0A       	mov	B,#0AH
 7843:      1EFD 84             	div	AB
 7844:      1EFE FA             	mov	R2,A
 7845:      1EFF E8             	mov	A,R0
 7846:      1F00 54 F0          	anl	A,#0F0H
 7847:      1F02 45 F0          	orl	A,B
 7848:      1F04 C4             	swap	A
 7849:      1F05 75 F0 0A       	mov	B,#0AH
 7850:      1F08 84             	div	AB
 7851:      1F09 C4             	swap	A
 7852:      1F0A FE             	mov	R6,A
 7853:      1F0B E8             	mov	A,R0
 7854:      1F0C 54 0F          	anl	A,#0FH
 7855:      1F0E C4             	swap	A
 7856:      1F0F 45 F0          	orl	A,B
 7857:      1F11 C4             	swap	A
 7858:      1F12 75 F0 0A       	mov	B,#0AH
 7859:      1F15 84             	div	AB
 7860:      1F16 4E             	orl	A,R6
 7861:      1F17 F8             	mov	R0,A
 7862:      1F18 E5 F0          	mov	A,B
 7863:      1F1A 24 30          	add	A,#30H
 7864:      1F1C 0D             	inc	R5
 7865:      1F1D C0 E0          	push	ACC
 7866:      1F1F EA             	mov	A,R2
 7867:      1F20 48             	orl	A,R0
 7868:      1F21 70 D6          	jnz	RSUB1
 7869:                          ;
 7870:      1F23 D0 E0          RSUB2:	pop	ACC
 7871:      1F25 8B A0          	mov	P2,R3
 7872:      1F27 F3             	movx	@R1,A
 7873:      1F28 09             	inc	R1
 7874:      1F29 B9 00 01       	cjne	R1,#0,RSUB3
 7875:      1F2C 0B             	inc	R3
 7876:                          ;
 7877:      1F2D DD F4          RSUB3:	djnz	R5,RSUB2
 7878:      1F2F 22             	ret
 7879:                          ;
 7880:                          ;****** continue with original code: ***
 7881:                          ;
 7882:                          	;**************************************
 7883:                          	;
 7884:                          HEXOUT: ; Output the hex number in R3:R1
 7885:                          	;
 7886:                          	;**************************************

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 143



 Line    I  Addr Code           Source

 7887:                          	;
 7888:      1F30 D1 9A          	ACALL	SOUT		;OUTPUT A SPACE
 7889:      1F32 A2 36          	MOV	C,ZSURP 	;GET ZERO SUPPRESSION BIT
 7890:      1F34 92 23          	MOV	ADD_IN,C
 7891:      1F36 EB             	MOV	A,R3		;GET HIGH NIBBLE AND PRINT IT
 7892:      1F37 F1 53          	ACALL	HOUTHI
 7893:      1F39 EB             	MOV	A,R3
 7894:      1F3A F1 54          	ACALL	HOUTLO
 7895:                          	;
 7896:      1F3C C2 23          HEX2X:	CLR	ADD_IN		;DON'T SUPPRESS ZEROS
 7897:      1F3E E9             	MOV	A,R1		;GET LOW NIBBLE AND PRINT IT
 7898:      1F3F F1 53          	ACALL	HOUTHI
 7899:      1F41 E9             	MOV	A,R1
 7900:      1F42 F1 54          	ACALL	HOUTLO
 7901:      1F44 7D 48          	MOV	R5,#'H'         ;OUTPUT H TO INDICA
 7902:                          	;
 7903:      1F46 C1 9C          SOUT_1: AJMP	SOUT1
 7904:                          	;
 7905:      1F48 C2 23          HOUT1:	CLR	ADD_IN		;PRINTED SOMETHING, S
 7906:      1F4A 24 90          	ADD	A,#90H		;CONVERT TO ASCII
 7907:      1F4C D4             	DA	A
 7908:      1F4D 34 40          	ADDC	A,#40H
 7909:      1F4F D4             	DA	A		;GOT IT HERE
 7910:      1F50 FD             	MOV	R5,A		;OUTPUT THE BYTE
 7911:      1F51 80 F3          	SJMP	SOUT_1
 7912:                          	;
 7913:      1F53 C4             HOUTHI: SWAP	A		;SWAP TO OUTPUT HIGH NIB
 7914:                          	;
 7915:      1F54 54 0F          HOUTLO: ANL	A,#0FH		;STRIP
 7916:      1F56 70 F0          	JNZ	HOUT1		;PRINT IF NOT ZERO
 7917:      1F58 30 23 ED       	JNB	ADD_IN,HOUT1	;OUTPUT A ZERO IF NOT 
 7918:      1F5B 22             	RET
 7919:                          ;
 7920:                          ;***************************************
 7921:                          ;******* New baudrate detection ********
 7922:                          ;******* calculate r3:r1=-(Timer2 DIV 16
 7923:                          ;******* Wulf 3 alteration 2 ***********
 7924:                          ;
 7925:                          ;-- comment out for AT98LP52 -----------
 7926:                          ;
 7927:                          ;SERCALC:mov	a,#0F0h
 7928:                          ;	mov	r3,a
 7929:                          ;	mov	r1,TH2
 7930:                          ;	anl	a,r1
 7931:                          ;	swap	a
 7932:                          ;	cpl	a
 7933:                          ;	xch	a,r3
 7934:                          ;	anl	a,TL2
 7935:                          ;	xch	a,r1
 7936:                          ;	anl	a,#00Fh
 7937:                          ;	orl	a,r1
 7938:                          ;	swap	a
 7939:                          ;	cpl	a
 7940:                          ;	mov	r1,ADCON	;save BSY bit
 7941:                          ;	mov	DAPR,#0 	;start A/D for 805xx test
 7942:                          ;	xch	a,r1

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 144



 Line    I  Addr Code           Source

 7943:                          ;	ret
 7944:                          ;
 7945:                          ;-- insert for AT98LP52 ----------------
 7946:                          ;TEST_MSG: db	'Speed OK?'
 7947:                          ;	db	00h		; Stop Code
 7948:                          ;-- insert end -------------------------
 7949:                          ;***************************************
 7950:                          ;
 7951:           N      1F78    	ORG	1F78H
 7952:                          	;
 7953:      1F78 20 1A 03       CKS_I:	JB	CKS_B,CS_I
 7954:      1F7B 02 40 1B       	LJMP	401BH
 7955:                          	;
 7956:      1F7E 02 20 88       CS_I:	LJMP	2088H
 7957:                          	;
 7958:      1F81 4E 4F 20 44    E14X:	DB	'NO DATA"'
            1F85 41 54 41 22
 7959:                          	;
 7960:      1F89 94             E11X:	DB	128+20
 7961:      1F8A 41 52 49 54    	DB	'ARITH. OVERFLOW"'
            1F8E 48 2E 20 4F
            1F92 56 45 52 46
            1F96 4C 4F 57 22
 7962:                          	;
 7963:      1F9A 50 52 4F 47    E16X:	DB	'PROGRAMMING"'
            1F9E 52 41 4D 4D
            1FA2 49 4E 47 22
 7964:                          	;
 7965:      1FA6 43 41 4E       E15X:	DB	'CAN'
 7966:      1FA9 27             	DB	27H
 7967:      1FAA 54 20 43 4F    	DB	'T CONTINUE"'
            1FAE 4E 54 49 4E
            1FB2 55 45 22
 7968:                          	;
 7969:      1FB5 49 4E 56 41    E10X:	DB	'INVALID LINE NUMBER"'
            1FB9 4C 49 44 20
            1FBD 4C 49 4E 45
            1FC1 20 4E 55 4D
            1FC5 42 45 52 22
 7970:                          	;
 7971:      1FC9 50 52 4F 4D    NOROM:	DB	'PROM MODE"'
            1FCD 20 4D 4F 44
            1FD1 45 22
 7972:                          	;
 7973:                          ;***************************************
 7974:                          ;****** Set a new version message ******
 7975:                          ;
 7976:                          ;S_N:	DB	'*MCS-51(tm) BASIC V1.1*'
 7977:                          ;
 7978:      1FD3 2A 4D 43 53    S_N:	DB	'*MCS-BASIC-52 V1.31*"'
            1FD7 2D 42 41 53
            1FDB 49 43 2D 35
            1FDF 32 20 56 31
            1FE3 2E 33 31 2A
            1FE7 22
 7979:                          ;

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 145



 Line    I  Addr Code           Source

 7980:                          ;***************************************
 7981:                          ;
 7982:           N      1FEB    	ORG	1FEBH		;FOR LINK COMPATABILITY
 7983:                          	;
 7984:                          GET_DIGIT_CHECK:	; Get a character, then
 7985:                          	;
 7986:      1FEB B1 5F          	ACALL	GET_DPTR_CHARACTER
 7987:                          	;
 7988:                          DIGIT_CHECK:	;CHECK FOR A VALID ASCII DI
 7989:                          	;
 7990:      1FED B4 3A 00       	CJNE	A,#'9'+1,DC10   ;SEE IF ASCII 9 OR
 7991:      1FF0 40 01          DC10:	JC	DC1
 7992:      1FF2 22             	RET
 7993:                          	;
 7994:      1FF3 B4 30 00       DC1:	CJNE	A,#'0',DC11     ;SEE IF ASCII 
 7995:      1FF6 B3             DC11:	CPL	C
 7996:      1FF7 22             	RET
 7997:                          	;
 7998:           N      1FF8    	ORG	1FF8H
 7999:                          	;
 8000:      1FF8 45 52 52 4F    ERS:	DB	'ERROR: "'
            1FFC 52 3A 20 22
 8001:                          	;
 8002:                          	;**************************************
 8003:                          	;
 8004:                          	XSEG	;External Ram
 8005:                          	;
 8006:                          	;**************************************
 8007:                          	;
 8008:      0000 N      0004    	DS	4
 8009:      0004 N      0001    IBCNT:	DS	1		;LENGTH OF A LINE
 8010:      0005 N      0002    IBLN:	DS	2		;THE LINE NUMBER
 8011:      0007 N      0049    IBUF:	DS	LINLEN		;THE INPUT BUFFER
 8012:      0050 N      000F    CONVT:	DS	15		;CONVERSION LOCATION FOR F
 8013:                          	;
 8014:           N      0100    	ORG	100H
 8015:                          	;
 8016:      0100 N      0001    GTB:	DS	1		;GET LOCATION
 8017:      0101 N      0001    ERRLOC: DS	1		;ERROR TYPE
 8018:      0102 N      0002    ERRNUM: DS	2		;WHERE TO GO ON AN ERROR
 8019:      0104 N      0002    VARTOP: DS	2		;TOP OF VARIABLE STORAGE
 8020:      0106 N      0002    ST_ALL: DS	2		;STORAGE ALLOCATION
 8021:      0108 N      0002    MT_ALL: DS	2		;MATRIX ALLOCATION
 8022:      010A N      0002    MEMTOP: DS	2		;TOP OF MEMORY
 8023:      010C N      0002    RCELL:	DS	2		;RANDOM NUMBER CELL
 8024:      010E N      0005    	DS	FPSIZ-1
 8025:      0113 N      0001    CXTAL:	DS	1		;CRYSTAL
 8026:      0114 N      0005    	DS	FPSIZ-1
 8027:      0119 N      0001    FPT1:	DS	1		;FLOATINP POINT TEMP 1
 8028:      011A N      0005    	DS	FPSIZ-1
 8029:      011F N      0001    FPT2:	DS	1		;FLOATING POINT TEMP 2
 8030:      0120 N      0002    INTLOC: DS	2		;LOCATION TO GO TO ON INTE
 8031:      0122 N      0002    STR_AL: DS	2		;STRING ALLOCATION
 8032:      0124 N      0002    SPV:	DS	2		;SERIAL PORT BAUD RATE
 8033:      0126 N      0002    TIV:	DS	2		;TIMER INTERRUPT NUM AND LOC
 8034:      0128 N      0002    PROGS:	DS	2		;PROGRAM A PROM TIME OUT

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 146



 Line    I  Addr Code           Source

 8035:                          ;
 8036:                          ;***************************************
 8037:                          ;****** Disable Intel programming for to
 8038:                          ;****** We don't need this, but don't re
 8039:                          ;
 8040:      012A N      0002    IPROGS: DS	2		;INTELLIGENT PROM PROGRAMM
 8041:                          ;
 8042:                          ;***************************************
 8043:                          ;
 8044:      012C N      0001    TM_TOP: DS	1
 8045:                          ;
 8046:                          	END
 8047:                          
 8048:                          
 8049:                          

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 147




Segment usage:
   Code      :   8131 bytes
   Data      :      0 bytes
   Idata     :      0 bytes
   Edata     :      0 bytes
   Fdata     :      0 bytes
   Xdata     :    140 bytes
   Bit       :      0 bits

   Register banks used: ---

   Warnings: 0
   Errors:   0


C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 148



              L I S T   O F   S Y M B O L S
              =============================


SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
??C51ASM                         NUMBER   8051
??CODE_SIZE                      NUMBER   0000
??DEVICE                         NUMBER   0000
??ERAM_SIZE                      NUMBER   0000
??FDATA_SIZE                     NUMBER   0000
??RAM_SIZE                       NUMBER   0100
??VERSION                        NUMBER   0120
??_AT89C2051_                    NUMBER   001B
??_AT89C4051_                    NUMBER   001C
??_AT89C51ED2_                   NUMBER   0026
??_AT89C51IC2_                   NUMBER   0024
??_AT89C51ID2_                   NUMBER   0025
??_AT89C51RB2_                   NUMBER   0021
??_AT89C51RC2_                   NUMBER   0022
??_AT89C51RC_                    NUMBER   0020
??_AT89C51RD2_                   NUMBER   0023
??_AT89C51_                      NUMBER   001D
??_AT89C52_                      NUMBER   001E
??_AT89C55WD_                    NUMBER   001F
??_AT89LP2052_                   NUMBER   0001
??_AT89LP213_                    NUMBER   0003
??_AT89LP214_                    NUMBER   0004
??_AT89LP216_                    NUMBER   0005
??_AT89LP3240_                   NUMBER   000A
??_AT89LP4052_                   NUMBER   0002
??_AT89LP428_                    NUMBER   0006
??_AT89LP51ED2_                  NUMBER   0011
??_AT89LP51IC2_                  NUMBER   000E
??_AT89LP51ID2_                  NUMBER   0010
??_AT89LP51RB2_                  NUMBER   000C
??_AT89LP51RC2_                  NUMBER   000D
??_AT89LP51RD2_                  NUMBER   000F
??_AT89LP51_                     NUMBER   0007
??_AT89LP52_                     NUMBER   0008
??_AT89LP6440_                   NUMBER   000B
??_AT89LP828_                    NUMBER   0009
??_AT89LS51_                     NUMBER   0019
??_AT89LS52_                     NUMBER   001A
??_AT89S2051_                    NUMBER   0012
??_AT89S4051_                    NUMBER   0013
??_AT89S51_                      NUMBER   0014
??_AT89S52_                      NUMBER   0015
??_AT89S53_                      NUMBER   0016
??_AT89S8252_                    NUMBER   0017
??_AT89S8253_                    NUMBER   0018
??_DEFAULT_                      NUMBER   0000
AABS                             CODE     138F      4838
AADD                             CODE     1741      5797
AANL                             CODE     1484      5124
AATAN                            CODE     11E0      4501
AATAN1                           CODE     11EE      4508
AC                               BIT        D6
AC1                              CODE     096C      2702
ACBYTE                           CODE     13AD      4883
ACC                              DATA       E0

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 149



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
ACOS                             CODE     116D      4398
ADBYTE                           CODE     13B6      4895
ADCON                            NUMBER   00D8       512
ADDLP                            CODE     19F2      6551
ADDPTR                           CODE     05DE      1956
ADDPTR1                          CODE     05E6      1960
ADD_IN                           BIT        23      6358
ADD_R                            CODE     19F0      6549
ADIV                             CODE     140A      4982
AEL1                             CODE     1282      4638
AELP                             CODE     1270      4626
AEQ                              CODE     13DB      4944
AEQ1                             CODE     13DD      4945
AETOX                            CODE     1327      4759
AEXL                             CODE     134E      4782
AEXP                             CODE     132B      4762
AEXP1                            CODE     133D      4773
AFREE                            CODE     1711      5770
AGE                              CODE     13E7      4952
AGET                             CODE     14A9      5157
AGT                              CODE     13C5      4926
AGT1                             CODE     13C9      4928
AI1                              CODE     137A      4817
AI11                             CODE     1381      4822
AI2                              CODE     1382      4824
AI21                             CODE     138A      4830
AI3                              CODE     138E      4834
AINT                             CODE     136D      4806
AL                               CODE     0D4F      3483
AL1                              CODE     0D52      3484
AL2                              CODE     0D57      3486
AL3                              CODE     0D58      3487
ALE                              CODE     13EB      4955
ALEN                             CODE     1721      5779
ALN                              CODE     12C0      4693
ALN1                             CODE     12CD      4700
ALN11                            CODE     12EF      4722
ALNE                             CODE     12E5      4716
ALNL                             CODE     12D3      4706
ALNO                             CODE     12F8      4727
ALPAR                            CODE     13AC      4879
ALT                              CODE     13D6      4940
ALT1                             CODE     13D8      4941
AMUL                             CODE     11B0      4453
ANE                              CODE     13E1      4948
ANEG                             CODE     13A1      4867
ANOT                             CODE     1496      5140
ANU                              CODE     0D44      3477
AORL                             CODE     148D      5132
AP1                              CODE     14E5      5222
APCON                            CODE     14E9      5225
ARCAP2                           CODE     14DF      5214
ARG1_EXP_IS_LARGER               CODE     1A56      6650
ARG1_EXP_IS_LARGER1              CODE     1A57      6653
ARG1_EXP_IS_LARGER2              CODE     1A5A      6656
ARGF                             BIT        24       432
ARG_STACK                        NUMBER   0009      6327
ARG_STACK_PAGE                   NUMBER   0001      6328
ARND                             CODE     13F1      4961

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 150



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
ASGN                             CODE     1395      4850
ASIN                             CODE     1171      4407
ASIN1                            CODE     1187      4418
ASQR                             CODE     128D      4651
ASTKA                            NUMBER   0009       372
ASTKAH                           NUMBER   0001       537
ASUB                             CODE     171C      5776
AT2CON                           CODE     14D3      5203
ATAN                             CODE     11D0      4485
ATCON                            CODE     14D7      5208
ATIM0                            CODE     14C1      5187
ATIM1                            CODE     14C7      5191
ATIM2                            CODE     14CD      5195
ATIME                            CODE     1729      5784
ATMOD                            CODE     14DB      5211
ATTAB                            CODE     112A      4300
AXBYTE                           CODE     13BE      4906
AXBYTE1                          CODE     13C0      4911
AXRL                             CODE     1498      5142
AXTAL                            CODE     0FD9      4014
AXTAL0                           CODE     1657      5577
AXTAL1                           CODE     165C      5580
AXTAL2                           CODE     1679      5614
AXTAL3                           CODE     121F      4552
A_D                              CODE     1260      4610
A_IE                             CODE     14B9      5181
A_IP                             CODE     14BD      5184
B                                DATA       F0
B4800                            NUMBER   00B2       529
B9600                            NUMBER   00D9       530
BABC                             NUMBER   0027       484
BAUD19K                          NUMBER   FFB2      1424
BCHR                             CODE     082F      2484
BCHR1                            CODE     0835      2486
BCK                              CODE     078D      2335
BD                               BIT        DF       479
BELL                             NUMBER   0007       521
BG1                              CODE     0428      1426
BG3                              CODE     0467      1458
BI                               BIT        32       456
BO                               BIT        2C       450
BOFAH                            NUMBER   0013       392
BOFAL                            NUMBER   0014       393
BOTH_PLUS                        CODE     1A5E      6665
BR0                              CODE     07F1      2437
BR2                              CODE     083E      2490
BS                               NUMBER   0008       522
B_C                              CODE     0AA4      2941
B_TXA                            CODE     0F23      3874
B_TXA1                           CODE     0F2D      3879
C0                               CODE     0CF6      3429
C0C                              CODE     1025      4100
C0ORX1                           BIT        34       465
C1                               CODE     0CFD      3433
C1C                              CODE     1030      4106
C2                               CODE     0D06      3438
C2C                              CODE     102F      4104
C2_T2                            CODE     146C      5093
C3C                              CODE     1035      4110

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 151



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
CASB                             CODE     1E9E      7703
CASB2                            CODE     1EAD      7712
CASB4                            CODE     1EC0      7723
CASB5                            CODE     1EC2      7725
CASB6                            CODE     1ECB      7729
CBIAS                            CODE     167B      5616
CC1                              CODE     1844      5984
CCAL                             CODE     051C      1716
CCAL1                            CODE     052C      1733
CCLR3                            CODE     068C      2136
CCONT                            CODE     183E      5981
CERASE                           CODE     0500      1695
CILOOP                           CODE     080F      2464
CILOOP1                          CODE     0811      2465
CIUB                             BIT        1E       424
CI_RET                           CODE     07BE      2374
CI_RET1                          CODE     07BF      2375
CKS_B                            BIT        1A       416
CKS_I                            CODE     1F78      7953
CL1                              CODE     106F      4148
CL2                              CODE     1074      4151
CL3                              CODE     1092      4167
CL6                              CODE     1094      4169
CL7                              CODE     109D      4173
CLIST                            CODE     104E      4131
CLIST1                           CODE     106B      4145
CLN_UP                           CODE     0F17      3866
CLOCK_CFG                        NUMBER   00B9       199
CLOOP                            CODE     1A66      6677
CL_1                             CODE     067D      2124
CL_2                             CODE     068B      2134
CMND1                            CODE     1787      5852
CMND11                           CODE     17EB      5913
CMND3                            CODE     17C4      5891
CMND31                           CODE     17D1      5896
CMND5                            CODE     17DD      5902
CMNDD                            CODE     010F       708
CMNDLK                           CODE     0855      2503
CMNDR                            CODE     1794      5869
CMNDSP                           NUMBER   004D       506
CMNX                             CODE     179B      5873
CMNX1                            CODE     17A8      5879
CMPLK                            CODE     1208      4529
CN0                              CODE     0FFE      4069
CN0T                             CODE     101C      4093
CN0T1                            CODE     1005      4072
CN0T2                            CODE     1010      4081
CN0T3                            CODE     1012      4084
CN0T4                            CODE     101B      4092
CNEW                             CODE     065C      2089
CNEW1                            CODE     0662      2101
CNTRLC                           NUMBER   0003       523
CNTRLD                           NUMBER   0004       524
CNT_S                            BIT        35       466
CNULL                            CODE     0B08      3048
CNX                              CODE     0FF9      4061
COB                              BIT        1B       417
CONB                             BIT        17       413
CONST                            CODE     0FEF      4052

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 152



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
CONVERT                          NUMBER   0058      6330
CONVERT_ASCII_STRING_TO_BINARY   CODE     1E9E      7696
CONVERT_BINARY_TO_ASCII_STRING   CODE     1EF7      7771
CONVT                            XDATA    0050      8012
COUB                             BIT        1C       420
CPROG                            CODE     048A      1611
CPROG1                           CODE     048D      1613
CPROG2                           CODE     04B1      1631
CPS                              CODE     0EA9      3737
CR                               NUMBER   000D       519
CR0                              CODE     03EC      1280
CR1                              CODE     0400      1305
CR11                             CODE     0403      1306
CR2                              CODE     040C      1311
CR20                             CODE     0419      1317
CRAM                             CODE     177F      5840
CRLF                             CODE     06A5      2168
CRLF2                            CODE     06A3      2166
CROM                             CODE     053C      1752
CRP                              CODE     06AD      2177
CRS                              CODE     03E0      1274
CRS1                             CODE     03E5      1276
CRS2                             CODE     03E8      1277
CRST                             CODE     038B      1198
CRST1                            CODE     03A4      1233
CRST2                            CODE     03A7      1236
CRUN                             CODE     0802      2456
CS1                              CODE     0B47      3117
CSC                              CODE     0BBD      3201
CSETUP                           CODE     0B4B      3120
CSETUP1                          CODE     0B56      3126
CSTAKA                           CODE     142C      5023
CSTAKA2                          CODE     142A      5021
CSTKA                            NUMBER   0011       387
CSTKAH                           NUMBER   0000       538
CSTS                             CODE     07C8      2390
CSTS1                            CODE     07CE      2398
CSTS2                            CODE     07D4      2400
CSY                              CODE     0A1E      2839
CSY1                             CODE     0A2E      2851
CSY2                             CODE     0A3A      2859
CS_I                             CODE     1F7E      7956
CXFER                            CODE     1773      5826
CXTAL                            XDATA    0113      8025
CY                               BIT        D7
C_1                              CODE     0F12      3863
C_2                              CODE     0F0D      3860
C_BIT                            BIT        2E       452
C_EX                             CODE     07D7      2412
C_K                              CODE     0540      1759
C_TST                            CODE     0EC6      3764
D1                               CODE     05DC      1945
DACK                             BIT        96       470
DAPR                             NUMBER   00DA       513
DBTWO                            CODE     1194      4428
DC1                              CODE     1FF3      7994
DC10                             CODE     1FF0      7991
DC11                             CODE     1FF6      7995
DCMPX                            CODE     05CC      1933

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 153



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
DEC3210                          CODE     158B      5374
DEC3211                          CODE     158F      5376
DEC3212                          CODE     1590      5377
DEC76                            CODE     1647      5554
DEC77                            CODE     164C      5557
DECDP                            CODE     05C2      1915
DECDP1                           CODE     05C8      1918
DECDP2                           CODE     05C0      1913
DECX                             CODE     1D42      7403
DEC_ASTKA                        CODE     120B      4533
DEC_ASTKA1                       CODE     1212      4540
DEC_R                            CODE     1589      5371
DELTST                           CODE     0EE1      3799
DELTST1                          CODE     0EE3      3800
DIGIT                            NUMBER   0004       547
DIGIT_CHECK                      CODE     1FED      7988
DIRF                             BIT        2F       453
DIV0                             CODE     1ABD      6787
DIV3                             CODE     1ACA      6796
DIV4                             CODE     1AD7      6804
DIV5                             CODE     1ADA      6807
DIV6                             CODE     1AE2      6812
DIV7                             CODE     1AF9      6834
DIV8                             CODE     1B0E      6847
DLD                              CODE     062B      2037
DONE_LOAD                        BIT        53      6362
DPH                              DATA       83
DPL                              DATA       82
DP_B                             CODE     0E9B      3729
DP_T                             CODE     0EA2      3733
DRQ                              BIT        31       455
DT1                              CODE     0EE8      3804
DTEMP                            CODE     184D      5990
DTYPE                            NUMBER   0003       541
DUBSUB                           CODE     0A02      2809
D_CHK                            CODE     0DCC      3564
D_L1                             CODE     0AF8      3026
D_UNDER                          CODE     1AC8      6794
E10X                             CODE     1FB5      7969
E11X                             CODE     1F89      7960
E14X                             CODE     1F81      7958
E15X                             CODE     1FA6      7965
E16X                             CODE     1F9A      7963
E1X                              CODE     1746      5807
E1XX                             CODE     1885      6032
E1XX1                            CODE     1887      6033
E1XX2                            CODE     188C      6036
E2X                              CODE     1751      5808
E3X                              CODE     1828      5970
E3XX                             CODE     09BD      2760
E4XX                             CODE     0BC1      3204
E4YY                             CODE     121A      4548
E5X                              CODE     1816      5968
E6X                              CODE     1761      5811
E7X                              CODE     1804      5965
EA                               BIT        AF
EATC                             CODE     0CE5      3413
EBIAS                            CODE     1261      4618
EIG                              CODE     036D      1190

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 154



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
EIGP                             CODE     0E4E      3643
EK                               CODE     0C0E      3267
ENDBIT                           BIT        29       447
EOF                              NUMBER   0001       536
EP1                              CODE     0F45      3916
EP2                              CODE     0F49      3919
EP21                             CODE     0F52      3923
EP22                             CODE     0F5B      3927
EP3                              CODE     0F6F      3938
EP4                              CODE     0F71      3940
EP41                             CODE     0F76      3943
EP42                             CODE     0F7B      3945
EP5                              CODE     0F82      3949
ER0                              CODE     1874      6022
ER1                              CODE     18B8      6069
ER2                              CODE     18C2      6078
ER3                              CODE     18D1      6086
ER31                             CODE     18EE      6099
ER4                              CODE     18FB      6106
ERA1                             CODE     050D      1702
ERAMEND                          NUMBER   03FF       554
ERL4                             CODE     0844      2494
ERPAR                            CODE     0CE3      3411
ERRLK                            CODE     04D6      1656
ERRLOC                           XDATA    0101      8017
ERRNUM                           XDATA    0102      8018
ERROR                            CODE     188F      6048
ERROR0                           CODE     189B      6055
ERROR01                          CODE     18A2      6058
ERROR1                           CODE     1890      6049
ERRS                             CODE     18AD      6063
ERS                              CODE     1FF8      8000
ES                               BIT        AC
ET0                              BIT        A9
ET1                              BIT        AB
EX0                              BIT        A8
EX1                              BIT        AA
EXA                              CODE     037B      1192
EXC                              CODE     0383      1194
EXI                              CODE     1836      5973
EXP1                             CODE     17F8      5933
EXP11                            CODE     17F2      5926
EXPONENTS_EQUAL                  CODE     1A5B      6659
EXPOT4                           CODE     1E16      7582
EXPOT5                           CODE     1E41      7611
EXPOTX                           CODE     1E14      7580
EXPOUT                           CODE     1E01      7567
EXPRB                            CODE     0F43      3914
E_FIND                           CODE     0A93      2931
F0                               BIT        D5
FCMP                             CODE     1202      4525
FDT1                             CODE     1D53      7417
FDT2                             CODE     1D5B      7421
FDTEST                           CODE     1D4F      7414
FINDC                            CODE     0EEE      3817
FINDCR                           CODE     0EEC      3815
FINISH1                          CODE     1D14      7368
FINISH2                          CODE     1D27      7384
FINISH_UP                        CODE     1D28      7386

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 155



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
FINISH_UP1                       CODE     1D2F      7391
FIRST_RADIX                      BIT        52      6361
FL1                              CODE     0AD3      2991
FL11                             CODE     0AD7      2995
FL2                              CODE     0AEC      3009
FL3                              CODE     0ADC      2998
FLOATING_ADD                     CODE     1993      6428
FLOATING_COMP                    CODE     1A43      6625
FLOATING_DIV                     CODE     1AB0      6772
FLOATING_MUL                     CODE     1A73      6693
FLOATING_POINT_INPUT             CODE     1CC2      7312
FLOATING_POINT_OUTPUT            CODE     1D7A      7462
FLOATING_SUB                     CODE     1989      6417
FMUL0                            CODE     1A78      6702
FMUL1                            CODE     1A7A      6706
FMUL2                            CODE     1A8C      6730
FMUL21                           CODE     1A8E      6731
FMUL3                            CODE     1A9D      6753
FMUL_OVER                        CODE     1A88      6716
FNDCL2                           CODE     0EF6      3823
FNDCL3                           CODE     0EFA      3826
FORMAT                           NUMBER   0017       396
FOUND_RADIX                      BIT        51      6360
FOV                              CODE     1A8A      6720
FPC1                             CODE     1BB5      7036
FPO1                             CODE     1D8C      7481
FPO2                             CODE     1D93      7488
FPO3                             CODE     1DA6      7501
FPONE                            CODE     16F2      5749
FPSIZ                            NUMBER   0006       546
FPT1                             XDATA    0119      8027
FPT2                             XDATA    011F      8029
FPTS                             CODE     104B      4123
FPTST                            CODE     1038      4112
FPTST1                           CODE     1045      4120
FP_ACC1                          NUMBER   0035      6380
FP_ACC2                          NUMBER   0036      6381
FP_ACC3                          NUMBER   0037      6382
FP_ACC4                          NUMBER   0038      6383
FP_ACC5                          NUMBER   0039      6384
FP_ACC6                          NUMBER   003A      6385
FP_ACC7                          NUMBER   003B      6386
FP_ACC8                          NUMBER   003C      6387
FP_ACCC                          NUMBER   0034      6379
FP_ACCS                          NUMBER   003D      6388
FP_ACCX                          NUMBER   0033      6378
FP_BASE                          CODE     196F      6402
FP_BASE1                         CODE     1971      6403
FP_BASE10                        CODE     1983      6412
FP_BASE11                        CODE     1985      6413
FP_BASE12                        CODE     1987      6414
FP_BASE2                         CODE     1973      6404
FP_BASE3                         CODE     1975      6405
FP_BASE4                         CODE     1977      6406
FP_BASE5                         CODE     1979      6407
FP_BASE6                         CODE     197B      6408
FP_BASE7                         CODE     197D      6409
FP_BASE8                         CODE     197F      6410
FP_BASE9                         CODE     1981      6411

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 156



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
FP_CARRY                         NUMBER   002A      6357
FP_CLEAR                         CODE     1BB2      7027
FP_DIG12                         NUMBER   002B      6363
FP_DIG34                         NUMBER   002C      6364
FP_DIG56                         NUMBER   002D      6365
FP_DIG78                         NUMBER   002E      6366
FP_EXP                           NUMBER   0030      6369
FP_NIB1                          NUMBER   002B      6370
FP_NIB2                          NUMBER   002C      6371
FP_NIB3                          NUMBER   002D      6372
FP_NIB4                          NUMBER   002E      6373
FP_NIB5                          NUMBER   002F      6374
FP_NIB6                          NUMBER   0030      6375
FP_NIB7                          NUMBER   0031      6376
FP_NIB8                          NUMBER   0032      6377
FP_NUMBER_SIZE                   NUMBER   0006      6339
FP_SIGN                          NUMBER   002F      6367
FP_STATUS                        NUMBER   0028      6355
FP_TEMP                          NUMBER   0029      6356
FREE                             CODE     1DD2      7536
FREE1                            CODE     1DD9      7541
FREE2                            CODE     1DF5      7560
FREE4                            CODE     1DED      7555
FRTEST                           CODE     1D4C      7412
FS                               CODE     13D0      4933
FSIZE                            NUMBER   0011       551
FSTK                             CODE     13CB      4930
FSUB10                           CODE     1A41      6621
FSUB5                            CODE     1A10      6581
FSUB6                            CODE     1A1B      6592
FSUB7                            CODE     1A1F      6595
FSUB8                            CODE     1A2A      6603
FSUB81                           CODE     1A2D      6604
FSUB9                            CODE     1A30      6609
FTYPE                            NUMBER   0001       539
FUL1                             CODE     15B0      5428
FULL                             CODE     15A8      5421
F_VAR                            CODE     0619      2024
F_VAR0                           CODE     0620      2028
F_VAR1                           CODE     0636      2045
F_VAR2                           CODE     0643      2056
G1                               CODE     058F      1854
G2                               CODE     05A2      1864
G3                               CODE     05A6      1867
G4                               CODE     05A9      1870
G5                               CODE     05AC      1872
GC                               CODE     0ECD      3776
GCI                              CODE     0ED5      3782
GCI1                             CODE     0ED7      3786
GCI11                            CODE     0EDE      3790
GETEND                           CODE     058A      1850
GETLIN                           CODE     058C      1852
GET_DIGIT_CHECK                  CODE     1FEB      7984
GET_DPTR_CHARACTER               CODE     1D5F      7435
GET_NUM                          CODE     1957      6208
GLN                              CODE     0AD1      2989
GT1                              CODE     1CEA      7343
GT11                             CODE     1CF2      7346
GT12                             CODE     1CF5      7347

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 157



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
GT2                              CODE     1D02      7356
GTB                              XDATA    0100      8016
GTEST                            CODE     1CDB      7336
GTRD                             BIT        18       414
GTX                              CODE     1547      5300
GTX1                             CODE     155A      5311
GTYPE                            NUMBER   0002       540
HC1                              CODE     1CB1      7295
HC11                             CODE     1CB4      7296
HEX2X                            CODE     1F3C      7896
HEXDO1                           CODE     1CA1      7280
HEXDON                           CODE     1CA0      7278
HEXOUT                           CODE     1F30      7884
HEXSC1                           CODE     1C8F      7267
HEXSCAN                          CODE     1C89      7258
HEX_CHECK                        CODE     1CA9      7287
HEX_CHECK1                       CODE     1CAE      7291
HMODE                            BIT        37       468
HOUT1                            CODE     1F48      7905
HOUTHI                           CODE     1F53      7913
HOUTLO                           CODE     1F54      7915
HS1                              CODE     1CA6      7284
H_RET                            CODE     196B      6244
I2                               CODE     123B      4581
I21                              CODE     1247      4588
IAN                              CODE     00F3       696
IAT                              CODE     090B      2647
IAT1                             CODE     090E      2648
IBCNT                            XDATA    0004      8009
IBLK                             CODE     193F      6190
IBLK1                            CODE     194E      6196
IBLN                             XDATA    0005      8010
IBUF                             XDATA    0007      8011
ICLR                             CODE     069A      2151
ICLR1                            CODE     069F      2157
IE                               DATA       A8
IE0                              BIT        89
IE1                              BIT        8B
IFIX                             CODE     1223      4559
IFIXL                            CODE     0E90      3711
IGC                              CODE     0ECB      3774
ILOOP                            CODE     0813      2469
ILOOP1                           CODE     081F      2473
IMOV                             CODE     1566      5325
IN2                              CODE     0DFD      3601
IN2A                             CODE     0E02      3604
IN3                              CODE     0E0F      3610
IN3A                             CODE     0E20      3620
IN5                              CODE     0E40      3635
IN6                              CODE     0E49      3639
INBIT                            BIT        1D       423
INC3210                          CODE     1576      5347
INC3211                          CODE     157B      5351
INC3212                          CODE     1580      5354
INCH1                            CODE     07AA      2355
INCH11                           CODE     07AF      2357
INCH12                           CODE     07B4      2359
INCH13                           CODE     07BB      2367
INCHAR                           CODE     0791      2344

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 158



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
INCHAR1                          CODE     0799      2347
INCHAR2                          CODE     07A1      2350
INC_AND_GET_DPTR_CHARACTER       CODE     1D5E      7431
INC_ASTKA                        CODE     124F      4595
INC_FP_EXP                       CODE     1B72      6950
INERR                            CODE     1D44      7405
INL0                             CODE     06D6      2211
INL1                             CODE     06DD      2216
INL11                            CODE     06E6      2220
INL2                             CODE     06D3      2209
INL2B                            CODE     06EC      2225
INL2B1                           CODE     06F2      2228
INL2B2                           CODE     06F5      2229
INL6                             CODE     06FE      2235
INLINE                           CODE     06D8      2213
INLOOP                           CODE     1CD0      7328
INLPIK                           CODE     1CD8      7333
INLX                             CODE     06E8      2222
INPROG                           BIT        11       407
INP_B                            BIT        22       430
INS                              CODE     0103       700
INSR                             CODE     1517      5268
INSR1                            CODE     1523      5275
INT0                             BIT        B2
INT1                             BIT        B3
INTBIT                           BIT        12       408
INTERR                           CODE     0F30      3891
INTERR1                          CODE     0F32      3892
INTERX                           CODE     0938      2673
INTERX1                          CODE     093B      2675
INTERX2                          CODE     0941      2677
INTERX3                          CODE     0948      2680
INTERX4                          CODE     094D      2682
INTGER                           CODE     0F35      3895
INTGRC                           BIT        19      6331
INTLOC                           XDATA    0120      8030
INTPEN                           BIT        16       412
INTXAH                           NUMBER   0042       496
INTXAL                           NUMBER   0043       497
IP                               DATA       B8
IPROGS                           XDATA    012A      8040
IRAMTOP                          NUMBER   00FF       514
ISAV                             BIT        2B       449
ISTA0                            CODE     0950      2684
ISTA01                           CODE     095A      2688
ISTA1                            CODE     095C      2690
ISTAT                            CODE     08F8      2638
ISTAT1                           CODE     0900      2641
ISTAX                            CODE     091C      2656
ISTAX1                           CODE     0921      2659
ISTAY                            CODE     0925      2663
ISTAY1                           CODE     0928      2664
ISTAY2                           CODE     092D      2666
IST_CAL                          CODE     09E7      2794
IT0                              BIT        88
IT1                              BIT        8A
ITRAP                            CODE     086A      2525
ITRAP1                           CODE     0872      2530
ITRAP2                           CODE     087A      2535

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 159



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
ITRAP21                          CODE     087D      2536
ITRAP3                           CODE     0882      2544
ITRET                            CODE     0F40      3901
I_DL                             CODE     185B      6000
I_DR                             CODE     1902      6116
I_L                              CODE     0849      2497
I_PI                             CODE     0E95      3718
I_RET                            CODE     1871      6017
I_S                              CODE     0933      2670
I_S1                             CODE     0936      2671
I_T0                             BIT        26       434
L20DPI                           CODE     0573      1800
L31DPI                           CODE     05BA      1900
LCLR                             CODE     05E7      1964
LDPTRI                           CODE     05B0      1884
LD_A                             CODE     0FE9      4042
LD_T                             CODE     0582      1827
LEFT                             CODE     1BF3      7096
LEFT1                            CODE     1BF5      7102
LEFT2                            CODE     1BF6      7103
LEFT3                            CODE     1BFD      7108
LEFT5                            CODE     1C1C      7135
LEFTL                            CODE     1C08      7117
LEFTL1                           CODE     1C1B      7133
LF                               NUMBER   000A       520
LIN1                             CODE     155C      5313
LINE                             CODE     14F0      5241
LINE0                            CODE     14ED      5239
LINE1                            CODE     150B      5258
LINEB                            BIT        15       411
LINLEN                           NUMBER   0049       535
LMOV                             CODE     156D      5341
LNTAB                            CODE     16A9      5654
LN_D                             CODE     131B      4745
LOAD1                            CODE     19AD      6464
LOAD2                            CODE     19BD      6476
LOAD21                           CODE     19C5      6483
LOAD22                           CODE     19CA      6489
LOAD23                           CODE     19CE      6492
LOAD25                           CODE     19E3      6540
LOAD7                            CODE     1B93      6982
LOADR1                           CODE     1C7F      7247
LOADR1_MANTISSA                  CODE     1C7B      7238
LOAD_POINTERS                    CODE     1C5E      7193
LP                               BIT        97       469
LPB                              BIT        19       415
LTOUT1                           CODE     074A      2298
LTX                              CODE     1528      5281
LTX1                             CODE     152F      5286
LTX2                             CODE     1543      5297
L_RET                            CODE     0EEB      3806
MDES1                            CODE     1C6A      7215
MEMTOP                           XDATA    010A      8022
MILLIV                           NUMBER   0047       500
MNL0                             CODE     1C3E      7167
MNL1                             CODE     1C50      7179
MNLOOP                           CODE     1C35      7159
MOUT                             CODE     1E8E      7681
MSIGN                            BIT        78      6368

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 160



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
MT1                              NUMBER   0045       498
MT2                              NUMBER   0046       499
MT_ALL                           XDATA    0108      8021
MU1                              CODE     136B      4798
MUL11                            CODE     1EEF      7762
MULNUM                           CODE     1ED6      7740
MULNUM10                         CODE     1ED3      7736
MULX                             CODE     1EF6      7769
MUL_DIV_EXP_AND_SIGN             CODE     1C68      7206
MUL_NIBBLE                       CODE     1C2B      7145
MUL_UNDERFLOW                    BIT        28       443
N4                               CODE     0BC6      3207
NL1                              CODE     1E6E      7651
NLC                              CODE     077A      2325
NLC1                             CODE     077F      2327
NLC2                             CODE     0782      2328
NLC3                             CODE     0786      2330
NMARK_L                          CODE     1A96      6736
NMOV                             CODE     159D      5403
NMOV1                            CODE     15A7      5411
NOGO                             CODE     056E      1795
NOPASS                           CODE     0F21      3871
NOROM                            CODE     1FC9      7971
NO_C                             BIT        30       454
NR1                              CODE     1E77      7660
NTWO                             CODE     1161      4365
NULL                             NUMBER   0000       525
NULLCT                           NUMBER   0015       394
NUMC                             CODE     0C19      3274
NUMC1                            CODE     0C22      3279
NUM_LT                           CODE     1E67      7645
NUM_RT                           CODE     1E70      7654
ONE                              CODE     0E8E      3705
ON_ERR                           BIT        13       409
OOPS                             CODE     0D3A      3463
OPBOL                            CODE     00CF       654
OPTAB                            CODE     0057       578
OTI                              BIT        14       410
OTS                              BIT        10       406
OTST                             CODE     1938      6177
OTST1                            CODE     193E      6182
OUTPUT                           CODE     196C      6392
OUTR                             CODE     1E5C      7634
OUTR0                            CODE     1E4B      7620
OV                               BIT        D2
OVE1                             CODE     1B98      6993
OVERFLOW                         NUMBER   0001      6341
OVERFLOW_AND_EXIT                CODE     1B94      6986
P                                BIT        D0
P0                               DATA       80
P1                               DATA       90
P2                               DATA       A0
P3                               DATA       B0
PACK                             CODE     1B11      6851
PACK0                            CODE     1B1A      6864
PACK1                            CODE     1B1B      6866
PACK11                           CODE     1B23      6871
PACK2                            CODE     1B25      6873
PACK3                            CODE     1B37      6887

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 161



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
PACK31                           CODE     1B38      6888
PACK4                            CODE     1B4F      6911
PAREN_INT                        CODE     0E97      3724
PCL                              CODE     1439      5038
PCON                             DATA       87
PCON0                            NUMBER   0087       507
PG1                              CODE     04BD      1642
PG10                             CODE     04BC      1640
PG101                            CODE     04B5      1635
PG2                              CODE     04C3      1646
PG31                             CODE     04F7      1679
PG4                              CODE     04C0      1644
PG5                              CODE     04CB      1651
PG6                              CODE     04D0      1654
PG7                              CODE     04D9      1659
PG8                              CODE     046F      1468
PGR                              CODE     04B3      1633
PGU                              CODE     04F8      1683
PHEAD                            NUMBER   0016       395
PIE                              CODE     17FE      5952
PIPI                             CODE     147F      5115
PLNEXP                           CODE     1430      5026
PLOOP                            CODE     1B51      6915
PLUS_MINUS_TEST                  CODE     1D65      7444
PMT1                             CODE     1D79      7458
PMT11                            CODE     1D6A      7448
PMT12                            CODE     1D6F      7450
PMT13                            CODE     1D74      7452
PMT2                             CODE     1D77      7454
PMT3                             CODE     1D78      7456
PMTOP                            CODE     164F      5567
PMTOP1                           CODE     1652      5568
PN0                              CODE     06C3      2195
PN01                             CODE     06CC      2199
PN02                             CODE     06CD      2200
PN1                              CODE     06B9      2186
POLY1                            CODE     11A3      4445
POLYC                            CODE     119B      4436
POPAS                            CODE     0FD3      4011
POP_AND_EXIT                     CODE     19A5      6455
POP_T1                           CODE     1448      5053
POSNM1                           CODE     1D24      7381
POSNUM                           CODE     1D21      7378
POTWO                            CODE     1192      4426
PP                               CODE     15BA      5444
PPL                              CODE     15CD      5455
PPL1                             CODE     15D2      5458
PPL2                             CODE     15D7      5463
PPL21                            CODE     15DC      5466
PPL22                            CODE     15E1      5468
PPL3                             CODE     15F0      5480
PPL4                             CODE     15F5      5486
PPL41                            CODE     15FE      5495
PPL6                             CODE     1622      5519
PPL61                            CODE     162B      5524
PPL7                             CODE     162F      5527
PPL71                            CODE     1630      5528
PPL9                             CODE     1643      5540
PPL91                            CODE     1644      5541

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 162



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
PPLX                             CODE     1609      5504
PPLY                             CODE     1616      5510
PPLY1                            CODE     161B      5515
PPX                              CODE     15E5      5471
PRET                             CODE     1B71      6948
PRNTCR                           CODE     06C1      2193
PROGS                            XDATA    0128      8034
PS                               BIT        BC
PSTART                           NUMBER   0200       550
PSW                              DATA       D0
PT0                              BIT        B9
PT1                              BIT        BB
PTIME                            CODE     0709      2253
PUSHAS                           CODE     0FDD      4021
PUSHC                            CODE     1433      5034
PUSHCS                           CODE     0BB1      3192
PUSHCS1                          CODE     0BB6      3194
PUSHCS2                          CODE     0BBC      3199
PUSHR2R0                         CODE     1CB6      7299
PUSH_ONE                         CODE     1443      5048
PUSH_T1                          CODE     144F      5059
PUSH_T11                         CODE     1451      5062
PUSH_T12                         CODE     1453      5064
PX0                              BIT        B8
PX1                              BIT        BA
P_E                              CODE     0CDF      3408
P_T2                             CODE     1456      5067
P_Z                              CODE     1375      4814
R0B0                             NUMBER   0000       359
R1B0                             NUMBER   0001       360
R2B0                             NUMBER   0002       361
R3B0                             NUMBER   0003       362
R3CK                             CODE     09D5      2776
R4B0                             NUMBER   0004       363
R5B0                             NUMBER   0005       364
R6B0                             NUMBER   0006       365
R76S                             CODE     0DEF      3582
R7B0                             NUMBER   0007       366
RB8                              BIT        9A
RC1                              CODE     066F      2109
RC2                              CODE     0673      2112
RCAPH2                           NUMBER   00CB       510
RCAPL2                           NUMBER   00CA       511
RCASB                            CODE     1ECF      7732
RCELL                            XDATA    010C      8023
RCL                              CODE     0885      2545
RCL1                             CODE     088A      2553
RCL2                             CODE     0892      2560
RCL3                             CODE     0898      2564
RCL4                             CODE     089E      2568
RCL5                             CODE     08A4      2572
RCL6                             CODE     08AA      2576
RCLEAR                           CODE     0664      2103
RD                               BIT        B7
RDYS                             CODE     00FD       698
RECIP                            CODE     127C      4634
REN                              BIT        9C
RETBIT                           BIT        25       433
RET_X                            CODE     1D46      7407

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 163



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
RF1                              CODE     055E      1782
RF2                              CODE     0565      1788
RF3                              CODE     056B      1793
RFX                              CODE     0564      1786
RI                               BIT        98
RIGHT                            CODE     1BBB      7043
RIGHT1                           CODE     1BBD      7050
RIGHT2                           CODE     1BBE      7051
RIGHT3                           CODE     1BC5      7058
RIGHT5                           CODE     1BE4      7084
RIGHTL                           CODE     1BD1      7068
RIGHTL1                          CODE     1BE3      7082
RL1                              CODE     0AF4      3022
RLINE                            CODE     0AF2      3020
RMOV                             CODE     1581      5366
RO1                              CODE     0543      1767
RO11                             CODE     054E      1773
ROMADR                           NUMBER   8000       542
ROMFD                            CODE     055B      1780
ROM_P                            CODE     06AF      2179
ROM_P1                           CODE     06B7      2184
ROUT                             CODE     1E92      7684
RROM                             CODE     07C0      2383
RS0                              BIT        D3
RS1                              BIT        D4
RSUB1                            CODE     1EF9      7841
RSUB2                            CODE     1F23      7870
RSUB3                            CODE     1F2D      7877
RTST                             CODE     0AC7      2972
RTST1                            CODE     0AD0      2980
RTXAH                            NUMBER   0012       388
RTXAL                            NUMBER   0010       386
RV                               CODE     11B5      4458
RXD                              BIT        B0
S0RELH                           NUMBER   00BA       509
S0RELL                           NUMBER   00AA       508
S13                              CODE     0D3D      3465
S20DP                            CODE     1424      5008
S31DP                            CODE     0605      1993
S31DP2                           CODE     0603      1991
S31L                             CODE     170E      5768
SA                               CODE     0D1B      3450
SA1                              CODE     0D22      3453
SA2                              CODE     0D26      3455
SAFE_MOD                         NUMBER   00A1       200
SAVE_T                           NUMBER   004A       503
SBAUD                            CODE     16F9      5758
SBUF                             DATA       99
SCALL                            CODE     0E63      3663
SCLOCK                           CODE     1918      6135
SCLR                             CODE     068F      2140
SCON                             DATA       98
SC_R                             CODE     192D      6155
SD0                              CODE     0D5C      3491
SD01                             CODE     0D59      3489
SDI                              CODE     0DBC      3555
SDIMX                            CODE     0D61      3494
SE0                              CODE     0CBE      3374
SE1                              CODE     199F      6449

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 164



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
SERR1                            CODE     18B3      6066
SETFSYS                          CODE     0437      1438
SETREG                           CODE     1253      4602
SETREG1                          CODE     1254      4603
SF2                              CODE     0A53      2879
SF21                             CODE     0A56      2881
SF3                              CODE     0A72      2896
SFOR                             CODE     0A3C      2867
SGOSUB                           CODE     0B2D      3096
SGOTO                            CODE     0AAA      2952
SGS0                             CODE     0B2F      3098
SGS1                             CODE     0B35      3102
SGT1                             CODE     0AAC      2954
SGT11                            CODE     0AB7      2960
SGT2                             CODE     0AB9      2962
SGT21                            CODE     0AC1      2965
SIF                              CODE     0A86      2924
SIF1                             CODE     0A90      2929
SIGNS_DIFFERENT                  CODE     1A53      6645
SIN0                             CODE     11FC      4515
SINOUT                           CODE     1E8B      7678
SINPUT                           CODE     0DF5      3595
SINTAB                           CODE     16CE      5704
SLET                             CODE     096E      2711
SLET0                            CODE     09C2      2763
SLET1                            CODE     09C6      2766
SLET2                            CODE     09C8      2768
SM                               CODE     0C5F      3325
SM0                              BIT        9F
SM01                             CODE     0C6D      3331
SM02                             CODE     0C71      3333
SM1                              BIT        9E
SM2                              BIT        9D
SNEXT                            CODE     0B5F      3137
SONERR                           CODE     140F      4987
SONEXT                           CODE     1419      4999
SOT                              CODE     0E56      3649
SOUT                             CODE     1E9A      7690
SOUT1                            CODE     1E9C      7692
SOUT_1                           CODE     1F46      7903
SP                               DATA       81
SP0                              CODE     0C3C      3303
SP1                              CODE     0C43      3308
SP2                              CODE     0C3F      3305
SP4                              CODE     0C47      3311
SP6                              CODE     0C52      3317
SP7                              CODE     0C57      3320
SP8                              CODE     0C75      3336
SP9                              CODE     0CD7      3395
SP9A                             CODE     0CDE      3400
SPACE7                           CODE     1E78      7662
SPEOP                            CODE     09D9      2779
SPEOP1                           CODE     09DD      2781
SPH0                             CODE     0C29      3289
SPH1                             CODE     0C2B      3291
SPINT                            BIT        1F       427
SPOP                             CODE     0A7D      2911
SPOP1                            CODE     0A85      2916
SPRINT                           CODE     0C2D      3293

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 165



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
SPRINT1                          CODE     0C31      3295
SPRINT2                          CODE     0C38      3300
SPSAV                            NUMBER   003E       492
SPUSH                            CODE     0A76      2905
SPV                              XDATA    0124      8032
SP_H                             NUMBER   004B       504
SP_L                             NUMBER   004C       505
SQ                               CODE     0C7C      3340
SQR1                             CODE     12A3      4664
SQR2                             CODE     12AA      4671
SQR4                             CODE     12AD      4676
SQR41                            CODE     12BE      4685
SQ_ERR                           CODE     128A      4643
SR0                              CODE     0B14      3073
SR01                             CODE     0B24      3083
SRD                              CODE     0BE9      3245
SRD0                             CODE     0BE5      3242
SRD1                             CODE     0BF2      3250
SRD2                             CODE     0BF4      3252
SRD21                            CODE     0BFE      3257
SRD4                             CODE     0BFF      3259
SRD5                             CODE     0C06      3263
SRD51                            CODE     0C09      3264
SRD6                             CODE     0C11      3269
SREAD                            CODE     0BE3      3240
SRESTR                           CODE     0BCE      3217
SRESTR1                          CODE     0BD0      3218
SRETI                            CODE     0B0E      3062
SRETRN                           CODE     0B10      3070
SRT                              CODE     1219      4546
SS                               CODE     0D12      3445
SS7                              CODE     1E89      7676
SSOOP                            CODE     099D      2739
SSTOP                            CODE     0858      2510
SSTOP0                           CODE     0860      2514
STACKTP                          NUMBER   00FE       515
STATD                            CODE     0123       733
STDIG                            CODE     1D38      7398
STDIG1                           CODE     1D47      7409
STEROT                           CODE     070F      2269
STESIZ                           NUMBER   0009       548
STJ                              CODE     0020       302
STK                              CODE     0041       345
STONE                            CODE     1686      5630
STONE1                           CODE     168B      5637
STOPBIT                          BIT        20       428
STORE2                           CODE     1B69      6940
STORE_ALIGN_TEST_AND_EXIT        CODE     1B63      6930
STP                              CODE     00EE       694
STQ                              CODE     0033       337
STRING                           CODE     060C      2004
STRIP                            CODE     11DA      4491
STR_AL                           XDATA    0122      8031
STS                              CODE     003E       343
STU                              CODE     0044       348
ST_A                             CODE     0FE5      4032
ST_ALL                           XDATA    0106      8020
SUBLP                            CODE     19FB      6560
SUI                              CODE     192E      6159

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 166



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
SUNTIL                           CODE     0B01      3039
SUO                              CODE     1933      6169
SWAP_AND_EXIT                    CODE     199B      6442
SWAP_ASTKA                       CODE     145A      5072
SWHILE                           CODE     0AFC      3035
SX                               CODE     0C81      3343
SX1                              CODE     0C97      3352
S_0                              CODE     0982      2722
S_1                              CODE     09B2      2753
S_11                             CODE     09BA      2757
S_3                              CODE     0991      2732
S_4                              CODE     099F      2741
S_41                             CODE     09A6      2744
S_5                              CODE     09AD      2750
S_C                              CODE     0EBF      3752
S_C_1                            CODE     0E72      3675
S_DO                             CODE     0F05      3848
S_E                              CODE     098C      2728
S_L                              CODE     1461      5082
S_LEN                            NUMBER   003F       493
S_N                              CODE     1FD3      7978
S_ON                             CODE     0CEB      3419
S_WU                             CODE     0B03      3041
T0                               BIT        B4
T1                               BIT        B5
T2CON                            NUMBER   00C8       193
T2MOD                            NUMBER   00C9       198
TB                               CODE     15B5      5431
TB8                              BIT        9B
TBR                              CODE     1599      5391
TBYTE                            CODE     1596      5388
TCON                             DATA       88
TEMP1                            NUMBER   000B       377
TEMP2                            NUMBER   000C       378
TEMP3                            NUMBER   000D       379
TEMP4                            NUMBER   000E       380
TEMP5                            NUMBER   000F       381
TEMPD                            CODE     1854      5994
TEMP_COMP                        CODE     131C      4749
TEROT                            CODE     0711      2271
TEROT01                          CODE     0717      2274
TEROT02                          CODE     071E      2277
TEROT03                          CODE     0727      2281
TEROT04                          CODE     072F      2284
TEROT1                           CODE     0766      2313
TEROT11                          CODE     076C      2316
TEROT2                           CODE     0773      2320
TEST_USER                        CODE     17E0      5907
TF0                              BIT        8D
TF1                              BIT        8F
TH0                              DATA       8C
TH1                              DATA       8D
TH2                              NUMBER   00CD       195
THREE                            CODE     0E78      3681
TI                               BIT        99
TIMER_LOAD                       CODE     052D      1737
TIMER_LOAD1                      CODE     052F      1742
TIV                              XDATA    0126      8033
TL0                              DATA       8A

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 167



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
TL1                              DATA       8B
TL2                              NUMBER   00CC       194
TMOD                             DATA       89
TMR0                             NUMBER   00C8      1083
TMR1                             NUMBER   00C9      1087
TMR2                             NUMBER   00CA      1091
TM_TOP                           XDATA    012C      8044
TOKTAB                           CODE     0175       781
TR                               CODE     1913      6125
TR0                              BIT        8C
TR1                              BIT        8E
TRC2                             NUMBER   00CE      1111
TT2C                             NUMBER   00CB      1099
TTC                              NUMBER   00CC      1103
TTIME                            CODE     1167      4383
TTM                              NUMBER   00CD      1107
TVH                              NUMBER   0048       501
TVL                              NUMBER   0049       502
TWO                              CODE     0E85      3694
TWOL                             CODE     14A1      5150
TWO_EX                           CODE     14B3      5169
TWO_EY                           CODE     14B4      5172
TWO_R2                           CODE     14B1      5166
TXAH                             NUMBER   000A       373
TXAL                             NUMBER   0008       371
TXD                              BIT        B1
TXX                              CODE     075F      2309
T_1                              CODE     073A      2289
T_ADD                            NUMBER   00E3       964
T_ASC                            NUMBER   00D1      1123
T_BIT                            BIT        92       478
T_BUF                            CODE     176C      5815
T_CHR                            NUMBER   00D3      1133
T_CMND                           NUMBER   00F0      1137
T_CMP                            CODE     07E3      2426
T_CR                             NUMBER   00AA       933
T_DATA                           NUMBER   009C       881
T_DIR                            NUMBER   0090       845
T_DP                             CODE     0EB8      3746
T_ELSE                           NUMBER   00A8       925
T_EQU                            NUMBER   00EA       986
T_F1                             CODE     0A9E      2937
T_GOSB                           NUMBER   009F       891
T_GOTO                           NUMBER   0083       796
T_HH                             NUMBER   0040       494
T_IE                             NUMBER   00C6      1075
T_IP                             NUMBER   00C7      1079
T_L                              CODE     196C      6393
T_LAST                           NUMBER   00A4       907
T_LL                             NUMBER   0041       495
T_LPAR                           NUMBER   00E0       954
T_MTOP                           NUMBER   00C4      1071
T_NEG                            NUMBER   00E9       984
T_P1                             NUMBER   00CF      1115
T_PC                             NUMBER   00D0      1119
T_REM                            NUMBER   0096       862
T_SPC                            NUMBER   00A9       929
T_STEP                           NUMBER   00A7       921
T_STOP                           NUMBER   0090       841

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 168



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
T_SUB                            NUMBER   00E5       971
T_T                              CODE     08B0      2586
T_T01                            CODE     08BE      2593
T_T1                             CODE     08CE      2600
T_T2                             CODE     08DF      2617
T_TAB                            NUMBER   00A4       909
T_THEN                           NUMBER   00A5       913
T_TIME                           NUMBER   00C5      1095
T_TO                             NUMBER   00A6       917
T_TRAP                           CODE     08E5      2623
T_ULAST                          NUMBER   00BE      1050
T_UOP                            NUMBER   00B0      1006
T_USE                            NUMBER   00D2      1127
T_XTAL                           NUMBER   00C3      1067
T_X_S                            CODE     0B39      3105
U3                               CODE     0C9B      3355
U4                               CODE     0C9F      3358
U5                               CODE     0CA9      3363
U5A                              CODE     0CC0      3376
U6                               CODE     0CCD      3388
U7                               CODE     0CCF      3390
U8                               CODE     0CC9      3385
U8A                              CODE     0CC4      3380
U8B                              CODE     0CC6      3382
UBIT                             BIT        2A       448
UE                               CODE     1513      5263
ULOOP                            CODE     1B82      6968
UNDERFLOW                        NUMBER   0000      6340
UNDERFLOW_AND_EXIT               CODE     1BA5      7005
UNDER_MD                         CODE     1B4D      6906
UNPACK_R0                        CODE     1B7E      6961
UOPBOL                           CODE     00E0       673
UPB                              BIT        27       435
UPP0                             CODE     10AE      4204
UPP01                            CODE     10B1      4205
UPP02                            CODE     10BC      4211
UPP03                            CODE     10C1      4213
UPP04                            CODE     10C6      4215
UPP1                             CODE     10DD      4229
UPP11                            CODE     10E3      4232
UPP1A                            CODE     10D9      4226
UPP2                             CODE     10EC      4236
UPP3                             CODE     1101      4249
UPP4                             CODE     110D      4257
UPP41                            CODE     1115      4261
UPP42                            CODE     1119      4263
UPP7                             CODE     1121      4269
UPP7A                            CODE     111F      4267
UPP8                             CODE     1123      4271
UPP81                            CODE     1125      4273
UPP9                             CODE     10CD      4219
UPP91                            CODE     10D5      4223
UPPL                             CODE     10A3      4184
UPPL0                            CODE     10A0      4175
UPRNT                            CODE     06BF      2191
UP_2                             CODE     10F7      4243
UP_3                             CODE     10FA      4245
UP_4                             CODE     10FD      4246
USENT                            CODE     0047       559

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 169



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
USING0                           CODE     1DB0      7507
USING1                           CODE     1DB6      7512
USING2                           CODE     1DC8      7525
USINGX                           CODE     1DC6      7523
USINGY                           CODE     1DC3      7520
U_ID1                            CODE     1860      6007
U_IDL                            BIT        21       429
U_RET                            CODE     1E4A      7618
V4                               CODE     0DB4      3550
VAR                              CODE     0D65      3497
VAR1                             CODE     0D67      3499
VAR11                            CODE     0D71      3504
VAR2                             CODE     0D9A      3531
VARB                             CODE     0A0D      2825
VARCOP                           CODE     1472      5105
VARD                             CODE     0A10      2827
VARTOP                           XDATA    0104      8019
VAR_ER                           CODE     0F01      3838
VX                               CODE     0D80      3518
VY                               CODE     0D74      3508
V_C                              CODE     1474      5107
WCR                              CODE     0EFC      3828
WE                               CODE     0F41      3904
WR                               BIT        B6
X3120                            CODE     0DAD      3542
X31DP                            CODE     0579      1813
XBILT                            CODE     0FB8      3989
XBILT1                           CODE     0FC2      3993
XBIT                             BIT        2D       451
XLPAR                            CODE     0FC4      3995
XOP                              CODE     0F86      3954
XOP1                             CODE     0F90      3959
XOP11                            CODE     0FA3      3970
XOP12                            CODE     0FAD      3978
XOP2                             CODE     0FAF      3982
XOP3                             CODE     0FCA      3999
XOUT0                            CODE     1E23      7590
XOUT2                            CODE     1E28      7594
XOUT3                            CODE     1E30      7599
XOUT4                            CODE     1E34      7603
XPOP                             CODE     0FD1      4003
XSIGN                            BIT        50      6359
XTALV                            CODE     17EC      5919
XXI                              CODE     0B67      3142
XXI1                             CODE     0B76      3152
XXI2                             CODE     0BAB      3179
XXI3                             CODE     0BAF      3181
X_TR                             CODE     0BD6      3224
Z7R7                             CODE     1E80      7668
ZERO                             NUMBER   0002      6342
ZERO7                            CODE     1E81      7670
ZERO_AND_EXIT                    CODE     1BAB      7016
ZERO_DIVIDE                      NUMBER   0003      6343
ZOUT                             CODE     1E96      7687
ZRO                              CODE     04E0      1665
ZSURP                            BIT        36       467
ZT0                              CODE     1E5F      7638
ZT1                              CODE     1E66      7643
ZTEST                            CODE     1E5D      7636

C51ASM V1.2            Copyright (c) 2009 Atmel Corp.           PAGE 170



SYMBOL                           TYPE     VALUE     LINE
--------------------------------------------------------
